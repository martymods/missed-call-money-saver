<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grid Starter — PJM • EIA-930 (Free Tier)</title>
  <meta name="description" content="Free-tier grid dashboard using EIA-930: demand vs forecast, fuel time-series, interchange, revenue, local weather + alerts, plus basic environment signals (beta).">
  <meta name="theme-color" content="#0f1a3d">
  <style>
    :root{
      --ink:#0f1a3d; --muted:#6b7280; --edge:#e6eafb; --bg:#f7f8ff;
      --brand:#1955ff; --brand2:#0f3ed6; --card:#fff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --shadow:0 14px 34px rgba(16,30,80,.12)
    }
    *{box-sizing:border-box} html,body{margin:0}
    body{font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--ink);background:linear-gradient(180deg,#fff,#fbfcff)}
    header{max-width:1280px;margin:0 auto;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .badge{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand2),var(--brand));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}

    /* MAIN LAYOUT — allow columns to actually shrink */
    .wrap{
      max-width:1280px;margin:10px auto 40px;padding:0 18px;
      display:grid;grid-template-columns:320px minmax(0,1fr);gap:12px;
      min-width:0;
    }
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .card>*{min-width:0}

    h1{font-size:24px;margin:0} h2{font-size:16px;margin:0 0 8px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    input,select,button{padding:10px;border:1px solid #e1e7ff;border-radius:10px;font:inherit}
    button{background:#f6f8ff;font-weight:800;cursor:pointer}
    button.primary{background:var(--brand);border-color:#194df7;color:#fff}
    .hint{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border:1px solid #e0e6ff;border-radius:999px;background:#f6f8ff;font-weight:800}

    /* CHARTS ROW — both columns shrinkable */
    .grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px;min-width:0}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .grid>*{min-width:0}

    canvas{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:8px;max-width:100%}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .tile{background:#fff;border:1px solid var(--edge);border-radius:12px;padding:12px}
    .kpi .big{font-weight:900;font-size:22px}
    .kpi .good{color:var(--ok)} .kpi .warn{color:var(--warn)}
    footer{max-width:1280px;margin:8px auto 30px;padding:0 18px;color:#5b6272;font-size:12px}

    /* CHART BOX — lock height, clip overflow so intrinsic canvas size never pushes layout */
    .chartbox{ position:relative; height:320px; width:100%; min-width:0; overflow:hidden; }
    @media (max-width:600px){ .chartbox{ height:260px; } }
    .chartbox canvas{ height:100% !important; width:100% !important; display:block; }

    /* FUEL CARDS */
    .fuels{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:1000px){.fuels{grid-template-columns:repeat(2,1fr)}}
    .fuel{display:flex;flex-direction:column;gap:6px;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#fff}
    .fuel .row{display:flex;align-items:center;justify-content:space-between}
    .badge2{display:inline-grid;place-items:center;width:26px;height:26px;border-radius:8px;background:#f0f4ff;border:1px solid #e1e8ff;font-weight:800}
    .money{font-weight:900}
    .sub{font-size:12px;color:var(--muted)}
    .mini{font-size:11px;color:var(--muted)}
    .sep{height:1px;background:#eef2ff;margin:4px 0}
    .priceCtl{display:flex;align-items:center;gap:8px}
    .priceCtl input[type=range]{flex:1}

    /* WEATHER ROW — make chart column shrinkable */
    .wx{display:grid;grid-template-columns:360px minmax(0,1fr);gap:12px;min-width:0}
    @media (max-width:1000px){.wx{grid-template-columns:1fr}}
    .wx>*{min-width:0}
    .wxNow{display:flex;gap:12px;align-items:center;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#fff}
    .wxNow img{width:64px;height:64px}
    .wxNums{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .wxTile{border:1px solid var(--edge);border-radius:10px;padding:8px;background:#fff}
    .wxAlerts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .alert{border-left:4px solid var(--warn);padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #e1f0ff}
    .alert.bad{border-left-color:var(--bad)}
    .badgeS{display:inline-block;padding:2px 6px;border-radius:999px;background:#f2f4ff;border:1px solid #e5eafe;font-size:12px;font-weight:800}

    /* ENVIRONMENT beta */
    .envGrid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px}
    @media (max-width:900px){.envGrid{grid-template-columns:1fr}}
    .tileSm{background:#fff;border:1px solid var(--edge);border-radius:12px;padding:12px}
  </style>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="brand"><div class="badge">⚡</div><div>Grid Starter<br><small style="color:var(--muted);font-weight:700">PJM • EIA-930 (Free)</small></div></div>
    <a href="/legal.html" class="pill">← Back to Packages</a>
  </header>

  <main class="wrap">
    <aside class="card">
      <h1>Setup</h1>
      <div class="field">
        <label><b>EIA API Key</b></label>
        <input id="eiaKey" placeholder="paste your EIA key" autocomplete="off">
        <div class="hint">Get one free in 1 minute at <a href="https://www.eia.gov/opendata/" target="_blank">EIA Open Data</a>. (Stored only in this browser.)</div>
      </div>
      <div class="field">
        <label><b>Balancing Authority</b></label>
        <select id="ba">
          <option value="PJM" selected>PJM (Mid-Atlantic)</option>
          <option value="ISNE">ISO-NE (New England)</option>
          <option value="NYIS">NYISO (New York)</option>
          <option value="CISO">CAISO (California)</option>
          <option value="ERCO">ERCOT (Texas)</option>
          <option value="MISO">MISO (Midcontinent)</option>
          <option value="SWPP">SPP (Southwest Power Pool)</option>
          <option value="TVA">TVA (Tennessee Valley)</option>
        </select>
        <div class="hint">Data is BA / zone level (not literal city).</div>
      </div>
      <div class="field">
        <label><b>Window</b></label>
        <select id="win">
          <option value="24" selected>Last 24 hours</option>
          <option value="48">Last 48 hours</option>
          <option value="168">Last 7 days</option>
        </select>
      </div>

      <div class="field">
        <label><b>Price ($/MWh)</b></label>
        <div class="priceCtl">
          <input id="price" type="range" min="10" max="250" step="5" value="75">
          <input id="priceNum" type="number" min="0" step="1" value="75" style="width:90px">
        </div>
        <div class="mini">Used for revenue estimates (Revenue/h ≈ Price × Current Load). Real nodal/zone LMPs require PJM credentials.</div>
      </div>

      <div class="field"><button id="btnLoad" class="primary">Fetch data</button></div>
      <div class="field"><div id="status" class="pill">Idle</div></div>
    </aside>

    <section class="card">
      <div class="kpi" style="margin-bottom:10px">
        <div class="tile"><div class="hint">Current Demand</div><div class="big" id="kpiDemand">—</div></div>
        <div class="tile"><div class="hint">Last Updated (local)</div><div class="big" id="kpiTime">—</div></div>
        <div class="tile"><div class="hint">Net Imports</div><div class="big" id="kpiInterchg">—</div><div class="mini">(+ import / − export)</div></div>
        <div class="tile"><div class="hint">Est. Revenue / hour</div><div class="big money" id="kpiRev">$—</div><div class="mini">Price × Load</div></div>
      </div>

      <div class="grid">
        <div>
          <h2>Load vs Day-Ahead Forecast</h2>
          <div class="chartbox"><canvas id="chartDemand"></canvas></div>
        </div>
        <div>
          <h2>Fuel mix — stacked (MW)</h2>
          <div class="chartbox"><canvas id="chartFuelTS"></canvas></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h2>“Assets” by fuel (live split)</h2>
        <div class="fuels" id="fuelCards"></div>
      </div>
    </section>

    <section class="card">
      <h2>Weather & Alerts for selected BA</h2>
      <div class="wx">
        <div>
          <div class="wxNow">
            <img id="wxIcon" alt="weather icon" onerror="this.style.display='none'">
            <div>
              <div id="wxTitle" style="font-weight:900">—</div>
              <div class="sub" id="wxPlace">—</div>
              <div class="mini" id="wxMeta">—</div>
            </div>
          </div>
          <div class="wxNums" style="margin-top:10px">
            <div class="wxTile"><div class="sub">Temperature now</div><div class="big" id="wxTemp">—</div></div>
            <div class="wxTile"><div class="sub">Wind</div><div class="big" id="wxWind">—</div></div>
          </div>
          <div class="wxAlerts" id="wxAlerts"></div>
        </div>

        <div>
          <div class="chartbox"><canvas id="chartWX"></canvas></div>
          <div class="mini" style="margin-top:6px">Source: Open-Meteo (no key). Alerts: U.S. National Weather Service.</div>
        </div>
      </div>
    </section>

    <!-- Environment (beta) -->
    <section class="card">
      <h2>Environment (beta) — near your BA</h2>
      <div class="envGrid">
        <div>
          <h3 style="margin:4px 0 8px">Air quality (PM2.5, US AQI)</h3>
          <div class="chartbox"><canvas id="chartAQ"></canvas></div>
        </div>
        <div>
          <h3 style="margin:4px 0 8px">Water (nearest USGS station — °C)</h3>
          <div class="chartbox"><canvas id="chartWater"></canvas></div>
        </div>
      </div>
      <div class="envTiles" style="margin-top:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        <div class="tileSm"><div class="sub">Air: latest US AQI</div><div class="big" id="aqiNow">—</div></div>
        <div class="tileSm"><div class="sub">Water station</div><div class="big" id="usgsStation">—</div></div>
        <div class="tileSm"><div class="sub">Nearby TRI facilities (EPA)</div><div class="big" id="echoCount">—</div></div>
        <div class="tileSm"><div class="sub">Notes</div><div class="big" style="font-size:14px">Noise is model-based; use DOT map for context</div></div>
      </div>
      <div class="mini" style="margin-top:6px">Soil/ground & noise lack universal live APIs. For context, combine TRI/Superfund + DOT noise maps with local data.</div>
    </section>
  </main>

<div class="tileSm">
  <div class="sub">Modeled transportation noise</div>
  <div class="big" id="noiseNow">—</div>
</div>


  <footer>
    <div>Sources: EIA Form 930 (free). Weather via Open-Meteo; alerts via api.weather.gov. Air via Open-Meteo Air-Quality. Water via USGS NWIS (nearest station). TRI counts via EPA ECHO. Revenue is an estimate; for trading/ops use ISO LMPs and settlement rules.</div>
  </footer>

  <script>
  // ---------- helpers
  const $ = s => document.querySelector(s);
  const fmtNum = n => (n==null? '—' : Number(n).toLocaleString());
  const fmtMoney = n => (isFinite(n)? '$' + Number(n).toLocaleString(undefined,{maximumFractionDigits:0}) : '$—');
  const pad = n => (n<10?'0'+n:n);
  function toEIAISO(d){ const z = new Date(d.getTime()); z.setUTCMinutes(0,0,0); return `${z.getUTCFullYear()}-${pad(z.getUTCMonth()+1)}-${pad(z.getUTCDate())}T${pad(z.getUTCHours())}`; }
  function parseEIAPeriod(p){
    if(!p) return null;
    if (/^\d{4}-\d{2}-\d{2}T\d{2}$/.test(p)) { const [Y,M,D,H]=p.replace('T','-').split('-').map(Number); return new Date(Date.UTC(Y,M-1,D,H,0,0)); }
    const s = p.replace(' ', 'T'); const d = new Date(s); return isNaN(d) ? null : d;
  }

  // ---------- persist
  const store = {
    get k(){ return localStorage.getItem('eia_key')||'' },
    set k(v){ localStorage.setItem('eia_key', v||'') },
    get ba(){ return localStorage.getItem('eia_ba')||'PJM' },
    set ba(v){ localStorage.setItem('eia_ba', v||'PJM') },
    get win(){ return localStorage.getItem('eia_win')||'24' },
    set win(v){ localStorage.setItem('eia_win', v||'24') },
    get price(){ return Number(localStorage.getItem('price_mwh')||'75') },
    set price(v){ localStorage.setItem('price_mwh', String(v)) },
  };
  $('#eiaKey').value = store.k; $('#ba').value = store.ba; $('#win').value = store.win;
  $('#price').value = store.price; $('#priceNum').value = store.price;
  $('#eiaKey').addEventListener('input', e=> store.k = e.target.value.trim());
  $('#ba').addEventListener('change', e=> store.ba = e.target.value);
  $('#win').addEventListener('change', e=> store.win = e.target.value);
  $('#price').addEventListener('input', e=> { $('#priceNum').value = e.target.value; store.price = e.target.value; updateMoney(); });
  $('#priceNum').addEventListener('input', e=> { $('#price').value = e.target.value||0; store.price = e.target.value||0; updateMoney(); });

  // ---------- charts
  let demandChart, fuelTSChart, wxChart, aqChart, waterChart;

  // stable box helper to avoid “crunched” canvases before layout settles
function waitForStableBox(box, minW=160, minH=120, timeoutMs=1500){
  return new Promise(resolve=>{
    const t0 = performance.now();
    function check(){
      const r1 = box.getBoundingClientRect();
      if((performance.now()-t0)>timeoutMs || (r1.width>=minW && r1.height>=minH)){
        // one extra frame to settle
        return requestAnimationFrame(()=> resolve());
      }
      requestAnimationFrame(check);
    }
    check();
  });
}

  async function ensureCharts(){
    await Promise.all([
      waitForStableBox($('#chartDemand').parentElement),
      waitForStableBox($('#chartFuelTS').parentElement),
      waitForStableBox($('#chartWX').parentElement),
      waitForStableBox($('#chartAQ').parentElement),
      waitForStableBox($('#chartWater').parentElement),
    ]);

    if(!demandChart){
      demandChart = new Chart($('#chartDemand'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'Demand (MW)', data:[], borderWidth:2, tension:.25 },
          { label:'Forecast (MW)', data:[], borderWidth:2, tension:.25, borderDash:[6,6] }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
          scales:{ x:{ ticks:{ maxRotation:0 }}, y:{ beginAtZero:true } }
        }
      });
    }
    if(!fuelTSChart){
      fuelTSChart = new Chart($('#chartFuelTS'), {
        type:'line',
        data:{ labels:[], datasets:[] },
        options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ x:{ stacked:true }, y:{ beginAtZero:true, stacked:true } }
        }
      });
    }
    if(!wxChart){
      wxChart = new Chart($('#chartWX'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'Temperature (°F)', data:[], yAxisID:'temp', borderWidth:2, tension:.25 },
          { label:'Precip (in/hr)',   data:[], yAxisID:'precip', borderWidth:2, borderDash:[6,6], tension:.25 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ temp:{ type:'linear', position:'left', beginAtZero:false },
                  precip:{ type:'linear', position:'right', beginAtZero:true } }
        }
      });
    }
    if(!aqChart){
      aqChart = new Chart($('#chartAQ'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'PM2.5 (µg/m³)', data:[], borderWidth:2, tension:.25 },
          { label:'US AQI', data:[], borderWidth:2, tension:.25, borderDash:[6,6], yAxisID:'aqi' }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ y:{ beginAtZero:true }, aqi:{ position:'right', beginAtZero:true, suggestedMax:150 } }
        }
      });
    }
    if(!waterChart){
      waterChart = new Chart($('#chartWater'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'Water temp (°C)', data:[], borderWidth:2, tension:.25 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ y:{ beginAtZero:false } }
        }
      });
    }
  }

  // keep canvases correct after any grid reflow
  const ro = new ResizeObserver(()=>{ demandChart?.resize(); fuelTSChart?.resize(); wxChart?.resize(); aqChart?.resize(); waterChart?.resize(); });
  ro.observe(document.body);

  // ---------- EIA fetchers
  async function eiaFetchRegion(key, ba, hours, typeCode){
    const end = new Date(); const start = new Date(end.getTime() - Number(hours)*3600*1000);
    const url = new URL('https://api.eia.gov/v2/electricity/rto/region-data/data/');
    url.searchParams.set('api_key', key); url.searchParams.set('frequency','hourly');
    url.searchParams.append('data[0]','value'); url.searchParams.append('facets[respondent][]', ba); url.searchParams.append('facets[type][]', typeCode);
    url.searchParams.set('start', toEIAISO(start)); url.searchParams.set('end', toEIAISO(end));
    const r = await fetch(url); if(!r.ok) throw new Error('EIA region '+typeCode+' failed');
    const j = await r.json(); return (j?.response?.data||[]).sort((a,b)=> new Date(a.period)-new Date(b.period));
  }
  async function eiaFetchFuelTimeSeries(key, ba, hours){
    const end = new Date(); const start = new Date(end.getTime() - Number(hours)*3600*1000);
    const url = new URL('https://api.eia.gov/v2/electricity/rto/fuel-type-data/data/');
    url.searchParams.set('api_key', key); url.searchParams.set('frequency','hourly');
    url.searchParams.append('data[0]','value'); url.searchParams.append('facets[respondent][]', ba);
    url.searchParams.set('start', toEIAISO(start)); url.searchParams.set('end', toEIAISO(end));
    const r = await fetch(url); if(!r.ok) throw new Error('EIA fuel series failed');
    const rows = (await r.json())?.response?.data || []; rows.sort((a,b)=> new Date(a.period)-new Date(b.period));
    const fuelset = new Set(); const map = new Map();
    for(const row of rows){ const t=row.period, f=row.fueltype||'OTH'; fuelset.add(f); if(!map.has(t)) map.set(t,{}); map.get(t)[f]=(map.get(t)[f]||0)+Number(row.value||0); }
    const times = Array.from(map.keys()); const fuels = Array.from(fuelset); const byFuel={}; for(const f of fuels){ byFuel[f]=times.map(t=> (map.get(t)[f]||0)); }
    return { times, fuels, byFuel };
  }
  async function eiaFetchInterchangeNet(key, ba, hours){
    const end = new Date(); const start = new Date(end.getTime() - Number(hours)*3600*1000);
    const url = new URL('https://api.eia.gov/v2/electricity/rto/interchange-data/data/');
    url.searchParams.set('api_key', key); url.searchParams.set('frequency','hourly'); url.searchParams.append('data[0]','value');
    url.searchParams.set('start', toEIAISO(start)); url.searchParams.set('end', toEIAISO(end));
    const r = await fetch(url); if(!r.ok) throw new Error('EIA interchange failed');
    const rows = (await r.json())?.response?.data || [];
    let imp=0, exp=0; for(const row of rows){ const v=Number(row.value||0); if(row.toba===ba) imp+=v; if(row.fromba===ba) exp+=v; }
    return { net: imp-exp };
  }

  // ---------- Weather & alerts
  const BA_COORDS = {
    PJM:{lat:39.9526, lon:-75.1652, place:'Philadelphia, PA'},
    ISNE:{lat:42.3601, lon:-71.0589, place:'Boston, MA'},
    NYIS:{lat:42.6526, lon:-73.7562, place:'Albany, NY'},
    CISO:{lat:38.5816, lon:-121.4944, place:'Sacramento, CA'},
    ERCO:{lat:30.2672, lon:-97.7431, place:'Austin, TX'},
    MISO:{lat:38.6270, lon:-90.1994, place:'St. Louis, MO'},
    SWPP:{lat:34.7465, lon:-92.2896, place:'Little Rock, AR'},
    TVA:{lat:35.0456, lon:-85.3097, place:'Chattanooga, TN'}
  };
  function weatherIconInfo(code){
    const map = [
      {codes:[0], icon:'clear-day', label:'Clear'},
      {codes:[1,2], icon:'partly-cloudy-day', label:'Partly cloudy'},
      {codes:[3], icon:'overcast', label:'Overcast'},
      {codes:[45,48], icon:'fog', label:'Fog'},
      {codes:[51,53,55,56,57], icon:'drizzle', label:'Drizzle'},
      {codes:[61,63,65,66,67,80,81,82], icon:'rain', label:'Rain'},
      {codes:[71,73,75,77,85,86], icon:'snow', label:'Snow'},
      {codes:[95], icon:'thunderstorms', label:'Thunderstorm'},
      {codes:[96,99], icon:'thunderstorms-day-extreme', label:'Storm + hail'}
    ];
    for(const m of map){ if(m.codes.includes(Number(code))) return m; }
    return {icon:'unknown', label:'—'};
  }
  const iconURL = i => `https://cdn.jsdelivr.net/npm/@open-meteo/weather-icons@1.7.0/production/fill/${i}.svg`;

  async function fetchWeather(lat, lon, hours){
    const pastDays = Math.max(1, Math.ceil(hours/24));
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = [
      `latitude=${lat}`, `longitude=${lon}`,
      'hourly=temperature_2m,precipitation,wind_speed_10m,weathercode',
      'temperature_unit=fahrenheit','windspeed_unit=mph','precipitation_unit=inch',
      `past_days=${pastDays}`, 'forecast_days=2', 'timezone=auto'
    ].join('&');
    const r = await fetch(url); if(!r.ok) throw new Error('Weather failed');
    const j = await r.json();
    const H = j.hourly || {};
    const times = H.time?.map(t => new Date(t)) || [];
    const endIdx = times.length;
    const startIdx = Math.max(0, endIdx - hours);
    const slice = (arr)=> (arr||[]).slice(startIdx, endIdx);
    return {
      place: j.timezone_abbreviation || '',
      times: times.slice(startIdx, endIdx),
      tempF: slice(H.temperature_2m),
      precipIn: slice(H.precipitation),
      windMph: slice(H.wind_speed_10m),
      code: slice(H.weathercode),
      now: { tempF: H.temperature_2m?.[endIdx-1], windMph: H.wind_speed_10m?.[endIdx-1], code: H.weathercode?.[endIdx-1] }
    };
  }
  async function fetchNOAAAlerts(lat, lon){
    try{
      const r = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`);
      if(!r.ok) throw new Error();
      const j = await r.json();
      const feats = Array.isArray(j.features) ? j.features : [];
      return feats.slice(0,4).map(f => ({
        event: f.properties?.event || 'Alert',
        severity: (f.properties?.severity || '').toLowerCase(),
        area: f.properties?.areaDesc || '',
        starts: f.properties?.effective || f.properties?.onset || '',
        ends: f.properties?.ends || f.properties?.expires || ''
      }));
    }catch{ return []; }
  }
  function renderWeather(wx, placeLabel){
    const info = weatherIconInfo(wx.now.code);
    $('#wxIcon').src = iconURL(info.icon);
    $('#wxTitle').textContent = `${info.label}`;
    $('#wxPlace').textContent = placeLabel || '—';
    $('#wxMeta').textContent = `Last hour • temp ${Math.round(wx.now.tempF)}°F • wind ${Math.round(wx.now.windMph)} mph`;
    $('#wxTemp').textContent = `${Math.round(wx.now.tempF)}°F`;
    $('#wxWind').textContent = `${Math.round(wx.now.windMph)} mph`;

    const labels = wx.times.map(d=> `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`);
    wxChart.data.labels = labels;
    wxChart.data.datasets[0].data = wx.tempF;
    wxChart.data.datasets[1].data = wx.precipIn;
    wxChart.update();
  }
  function renderAlerts(list){
    const box = $('#wxAlerts'); box.innerHTML = '';
    if(!list.length){ box.innerHTML = '<div class="wxTile"><span class="badgeS">No active alerts</span></div>'; return; }
    for(const a of list){
      const el = document.createElement('div');
      const cls = a.severity.includes('severe') || a.severity.includes('extreme') ? 'alert bad' : 'alert';
      el.className = cls;
      const when = [a.starts?.slice(0,16)?.replace('T',' '), a.ends? ' → '+a.ends.slice(0,16).replace('T',' '):''].join('');
      el.innerHTML = `<div><span class="badgeS">${a.event}</span> <span class="mini">(${a.severity||'unknown'})</span></div>
                      <div class="mini">${a.area}</div>
                      <div class="mini">${when}</div>`;
      box.appendChild(el);
    }
  }

  // ---------- Environment (air, water, TRI)
  async function fetchAirQuality(lat, lon, hours){
    const pastDays = Math.max(1, Math.ceil(hours/24));
    const url = new URL('https://air-quality-api.open-meteo.com/v1/air-quality');
    url.search = [
      `latitude=${lat}`, `longitude=${lon}`,
      'hourly=pm2_5,us_aqi', `past_days=${pastDays}`, 'timezone=auto'
    ].join('&');
    const r = await fetch(url); if(!r.ok) throw new Error('Air quality failed');
    const j = await r.json();
    const H = j.hourly || {};
    const times = H.time?.map(t => new Date(t)) || [];
    const endIdx = times.length, startIdx = Math.max(0, endIdx-hours);
    const slice = a => (a||[]).slice(startIdx,endIdx);
    return {
      times: times.slice(startIdx,endIdx),
      pm25: slice(H.pm2_5),
      aqi:  slice(H.us_aqi),
      aqiNow: H.us_aqi?.[endIdx-1] ?? null
    };
  }

  async function fetchUSGSWater(lat, lon, hours){
    try{
      // find nearest site with water temperature (00010), within 50 km
      const r1 = await fetch(`https://waterservices.usgs.gov/nwis/site/?format=rjson&hasDataTypeCd=iv&parameterCd=00010&lat=${lat}&lon=${lon}&siteType=ST&distance=50`);
      const s1 = await r1.json();
      const site = s1?.site?.[0]?.siteCode?.[0]?.value;
      if(!site) throw new Error('no site');
      const period = `PT${hours}H`;
      const r2 = await fetch(`https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${site}&parameterCd=00010&period=${period}`);
      const s2 = await r2.json();
      const ts = s2?.value?.timeSeries?.[0]?.values?.[0]?.value || [];
      const labels = ts.map(v => new Date(v.dateTime));
      const vals   = ts.map(v => Number(v.value));
      return { site, labels, vals };
    }catch{
      return { site:null, labels:[], vals:[] };
    }
  }

  // EPA ECHO: count nearby TRI facilities (proxy for potential ground pollution)
  async function fetchTRICount(lat, lon, miles=25){
    try{
      const u = `https://echodata.epa.gov/echo/RestServices/echo_rest_services.get_facilities?output=JSON&p_program=TRI&p_lat=${lat}&p_long=${lon}&p_radius=${miles}`;
      const r = await fetch(u);
      const j = await r.json();
      // try a couple likely shapes
      const count = j?.Results?.QueryRows ?? j?.Results?.ResultCount ?? j?.Results?.Facilities?.length ?? null;
      return count==null ? null : Number(count);
    }catch{ return null; }
  }

  // ---------- UI builders (energy)
  const FUEL_NAMES = {NG:'Gas', COL:'Coal', NUC:'Nuclear', WND:'Wind', SUN:'Solar', WAT:'Hydro', OIL:'Oil', OTH:'Other'};
  const FUEL_ORDER = ['NG','COL','NUC','WND','SUN','WAT','OIL','OTH'];
  function renderFuelCards(mixObj, totalMW, price){
    const el = $('#fuelCards'); el.innerHTML = '';
    const fuels = Object.keys(mixObj).sort((a,b)=> FUEL_ORDER.indexOf(a)-FUEL_ORDER.indexOf(b));
    for(const f of fuels){
      const mw = mixObj[f]||0; const share = totalMW>0 ? (mw/totalMW) : 0;
      const revH = share * price * totalMW;
      const card = document.createElement('div'); card.className = 'fuel';
      card.innerHTML = `
        <div class="row"><div><span class="badge2">${FUEL_NAMES[f]?.[0]||'?'}</span> <b>${FUEL_NAMES[f]||f}</b></div>
             <div class="money">${fmtNum(mw)} MW</div></div>
        <div class="row sub"><div>${(share*100).toFixed(1)}% share</div><div>${fmtMoney(revH)}/h</div></div>
        <div class="sep"></div>
        <div class="mini">Assumes uniform price $/MWh across fuels for an at-a-glance revenue split.</div>`;
      el.appendChild(card);
    }
  }
  function updateMoney(){
    const price = Number($('#priceNum').value||0);
    const txt = $('#kpiDemand').textContent.replace(/[, MW]/g,'');
    const load = Number(txt)||0;
    $('#kpiRev').textContent = fmtMoney(price * load);
    if(window.__lastMix && load>0){ renderFuelCards(window.__lastMix, load, price); }
  }


// ---------- Environment helpers (TRI / Noise / USGS already in your file? replace these)

/* EPA ECHO TRI (facilities within N miles)
   The old /RestServices/echo_rest_services.get_facilities path 404s.
   Current production paths are under /echo (er_rest_services OR facility_rest_services).
   We try the modern endpoint first and gracefully fall back.
*/
async function fetchTRICount(lat, lon, radiusMiles=25){
  const qs = p => Object.entries(p).map(([k,v])=> `${k}=${encodeURIComponent(v)}`).join('&');

  // Candidate endpoints (first that returns JSON wins)
  const bases = [
    'https://echodata.epa.gov/echo/er_rest_services.get_facilities',        // primary
    'https://echodata.epa.gov/echo/facility_rest_services.get_facilities'   // fallback
  ];
  const params = {
    output: 'JSON',
    p_program: 'TRI',      // restrict to TRI reporters
    p_lat: lat.toFixed(3),
    p_long: lon.toFixed(3),
    p_radius: radiusMiles  // miles
  };

  for(const base of bases){
    try{
      const r = await fetch(`${base}?${qs(params)}`);
      if(!r.ok) continue;
      const j = await r.json();
      // ECHO returns { Results: { QueryRows: [ ... ] } } or similar — be tolerant
      const rows = j?.Results?.QueryRows || j?.Results || j?.facilities || [];
      const n = Array.isArray(rows) ? rows.length : (Number(j?.Results?.TotalFacilities) || 0);
      if(n>0 || r.ok) return n;
    }catch(e){ /* try next */ }
  }

  // Last-ditch: report 0 and don’t blow up the UI
  console.warn('ECHO TRI lookup failed; showing 0.');
  return 0;
}

/* DOT Transportation Noise Map — modeled DNL (day–night level) at a point.
   Uses ArcGIS MapServer/identify. This is a modeled (static) exposure number (dB).
   Not time-series, but useful as context beside your tiles.
*/
async function fetchNoiseDNL(lat, lon){
  // Known public service (BTS Transportation Noise). If DOT rotates layers, we handle errors.
  const url = 'https://gis.dot.gov/arcgis/rest/services/BTS/Transportation_Noise/MapServer/identify';
  const body = new URLSearchParams({
    f: 'json',
    sr: '4326',
    tolerance: '3',
    returnGeometry: 'false',
    mapExtent: `${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}`,
    imageDisplay: '400,400,96',
    geometry: JSON.stringify({ x: lon, y: lat, spatialReference:{ wkid:4326 }}),
    geometryType: 'esriGeometryPoint',
    layers: 'all'  // search all sublayers for a hit
  });

  try{
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    if(!r.ok) throw new Error('DOT noise identify failed');
    const j = await r.json();
    const first = (j?.results||[]).find(v => typeof v?.attributes?.DNL === 'number' || typeof v?.attributes?.dnl === 'number');
    const dnl = first?.attributes?.DNL ?? first?.attributes?.dnl;
    if(Number.isFinite(dnl)) return Math.round(dnl);
  }catch(e){
    console.warn('DOT noise identify error', e);
  }
  return null; // no value at this point (rural areas often have no polygon/return)
}

/* USGS — pick nearest station with recent *temperature* (00010) and pull daily mean (°C) to keep it stable.
   If no candidate, we leave tile/chart blank. (Your previous USGS 400s were from a radius query that
   sometimes returns no station; this version tries a stricter filter and guards every step.)
*/
async function fetchUSGSWater(lat, lon, radiusKm=80){
  const siteURL = new URL('https://waterservices.usgs.gov/nwis/site/');
  siteURL.search = new URLSearchParams({
    format: 'json',
    parameterCd: '00010',   // water temperature
    hasDataTypeCd: 'dv',    // daily values
    siteType: 'ST',
    latitude: lat,
    longitude: lon,
    distance: (radiusKm*0.621371).toFixed(0)  // USGS expects miles in this endpoint
  }).toString();

  try{
    const sResp = await fetch(siteURL);
    if(!sResp.ok) throw new Error('site search failed');
    const sj = await sResp.json();
    const sites = sj?.value?.sites || [];
    if(!sites.length) return { site: 'No station', times:[], vals:[] };

    // pick the closest
    const best = sites[0];
    const site = best?.siteCode?.[0]?.value || best?.sourceInfo?.siteCode?.[0]?.value;
    if(!site) return { site: 'No station', times:[], vals:[] };

    // daily values (last 14–30 days) for temperature (°C)
    const now = new Date(); const start = new Date(now.getTime() - 30*86400e3);
    const dvURL = new URL('https://waterservices.usgs.gov/nwis/dv/');
    dvURL.search = new URLSearchParams({
      format: 'json',
      sites: site,
      parameterCd: '00010',
      startDT: start.toISOString().slice(0,10),
      endDT: now.toISOString().slice(0,10)
    }).toString();

    const dResp = await fetch(dvURL);
    if(!dResp.ok) throw new Error('dv fetch failed');
    const dj = await dResp.json();
    const ts = dj?.value?.timeSeries?.[0];
    const pts = ts?.values?.[0]?.value || [];
    const times = pts.map(p => new Date(p.dateTime));
    const vals  = pts.map(p => Number(p.value));

    return { site, times, vals };
  }catch(e){
    console.warn('USGS water fallback', e);
    return { site: 'Unavailable', times:[], vals:[] };
  }
}

// --- Environment (beta)
const [triCount, dnl, water] = await Promise.all([
  fetchTRICount(loc.lat, loc.lon, 25),
  fetchNoiseDNL(loc.lat, loc.lon),
  fetchUSGSWater(loc.lat, loc.lon, 80) // ~50 miles
]);

// TRI tile
document.getElementById('echoCount').textContent = triCount ? triCount.toLocaleString() : '—';

// Noise tile (DNL dB)
const noiseTile = document.getElementById('noiseNow');
if(noiseTile){
  noiseTile.textContent = (dnl!=null) ? `${dnl} dB DNL` : '—';
  noiseTile.parentElement.title = 'DOT modeled day–night sound level at point';
}

// Water chart + station label
document.getElementById('usgsStation').textContent = water.site || '—';
if(waterChart){
  const labels = water.times.map(d => `${d.getMonth()+1}/${d.getDate()}`);
  waterChart.data.labels = labels;
  waterChart.data.datasets[0].label = 'Water temp (°C)';
  waterChart.data.datasets[0].data = water.vals;
  waterChart.update();
}

  
  // ---------- main
  async function loadAll(){
    const key = ($('#eiaKey').value||'').trim();
    const ba = $('#ba').value;
    const hours = +$('#win').value;
    if(!key){ $('#status').textContent = 'Add your EIA key to start'; return; }

    $('#status').textContent = 'Loading…';
    await ensureCharts();

    try{
      // demand + forecast
      const [act, fcast] = await Promise.all([
        eiaFetchRegion(key, ba, hours, 'D'),
        eiaFetchRegion(key, ba, hours, 'DF')
      ]);
      const labels = act.map(r=> parseEIAPeriod(r.period)).map(d=> d ? `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00` : '');
      const valsAct = act.map(r=> Number(r.value||0));
      const fMap = new Map(fcast.map(r=> [r.period, Number(r.value||0)]));
      const valsFc = act.map(r=> fMap.get(r.period) ?? null);

      demandChart.data.labels = labels;
      demandChart.data.datasets[0].data = valsAct;
      demandChart.data.datasets[1].data = valsFc;
      demandChart.update();

      const last = act[act.length-1];
      $('#kpiDemand').textContent = last? `${fmtNum(last.value)} MW` : '—';
      const lastDt = parseEIAPeriod(last?.period);
      $('#kpiTime').textContent = lastDt ? lastDt.toLocaleString() : '—';

      // fuel TS
      const fuelTS = await eiaFetchFuelTimeSeries(key, ba, hours);
      const fuelLabels = fuelTS.times.map(t=> { const d=parseEIAPeriod(t); return d? `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`:''; });
      fuelTSChart.data.labels = fuelLabels;
      fuelTSChart.data.datasets = FUEL_ORDER.filter(f=> fuelTS.fuels.includes(f)).map(f=>({ label:FUEL_NAMES[f]||f, data:fuelTS.byFuel[f]||[], borderWidth:1, fill:true, tension:.2 }));
      fuelTSChart.update();

      const lastIdx = fuelTS.times.length - 1;
      const lastMix = {}; for(const f of fuelTS.fuels){ lastMix[f] = (fuelTS.byFuel[f]||[])[lastIdx]||0; }
      window.__lastMix = lastMix;
      renderFuelCards(lastMix, Number(last?.value||0), Number($('#priceNum').value||0));

      // interchange
      const inter = await eiaFetchInterchangeNet(key, ba, hours);
      $('#kpiInterchg').textContent = (inter.net>=0? '+' : '−') + fmtNum(Math.abs(inter.net)) + ' MW';

      // weather + alerts
      const loc = BA_COORDS[ba] || BA_COORDS.PJM;
      const [wx, alerts] = await Promise.all([ fetchWeather(loc.lat, loc.lon, hours), fetchNOAAAlerts(loc.lat, loc.lon) ]);
      renderWeather(wx, loc.place);
      renderAlerts(alerts);

      // Environment (beta)
      const [air, water, triCount] = await Promise.all([
        fetchAirQuality(loc.lat, loc.lon, hours),
        fetchUSGSWater(loc.lat, loc.lon, hours),
        fetchTRICount(loc.lat, loc.lon, 25)
      ]);
      // Air
      const airLabels = air.times.map(d => `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`);
      aqChart.data.labels = airLabels;
      aqChart.data.datasets[0].data = air.pm25;
      aqChart.data.datasets[1].data = air.aqi;
      aqChart.update();
      $('#aqiNow').textContent = air.aqiNow!=null ? Math.round(air.aqiNow) : '—';

      // Water
      waterChart.data.labels = water.labels.map(d => `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`);
      waterChart.data.datasets[0].data = water.vals;
      waterChart.update();
      $('#usgsStation').textContent = water.site || '—';

      // TRI count
      $('#echoCount').textContent = triCount!=null ? fmtNum(triCount) : '—';

      // mirror the DevTools “resize” effect once everything is drawn
      requestAnimationFrame(()=>{ demandChart?.resize(); fuelTSChart?.resize(); wxChart?.resize(); aqChart?.resize(); waterChart?.resize(); });

      $('#status').textContent = 'OK';
      updateMoney();
    }catch(e){
      console.error(e);
      $('#status').textContent = 'Error fetching data (check keys / network)';
    }
  }

  document.getElementById('btnLoad').addEventListener('click', loadAll);
  const qsKey = new URLSearchParams(location.search).get('eia');
  if(qsKey){ document.getElementById('eiaKey').value = qsKey; store.k = qsKey; }
  if(document.getElementById('eiaKey').value){ loadAll(); }
  </script>
</body>
</html>
