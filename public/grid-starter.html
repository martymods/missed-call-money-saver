<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Grid Starter — PJM • EIA-930 (Free Tier)</title>
  <meta name="description" content="Free-tier grid dashboard using EIA-930: demand vs forecast, fuel time-series, interchange, revenue, local weather + alerts, environment, citizens & tourism snapshots.">
  <meta name="theme-color" content="#0f1a3d">
  <style>
    :root{ --ink:#0f1a3d; --muted:#6b7280; --edge:#e6eafb; --bg:#f7f8ff; --brand:#1955ff; --brand2:#0f3ed6; --card:#fff; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --shadow:0 14px 34px rgba(16,30,80,.12) }
    *{box-sizing:border-box} html,body{margin:0}
    body{font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--ink);background:linear-gradient(180deg,#fff,#fbfcff)}
    header{max-width:1280px;margin:0 auto;padding:16px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .badge{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand2),var(--brand));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}

    /* MAIN LAYOUT — allow columns to shrink */
    .wrap{max-width:1280px;margin:10px auto 40px;padding:0 18px;display:grid;grid-template-columns:320px minmax(0,1fr);gap:12px;min-width:0}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .card>*{min-width:0}

    h1{font-size:24px;margin:0} h2{font-size:16px;margin:0 0 8px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    input,select,button{padding:10px;border:1px solid #e1e7ff;border-radius:10px;font:inherit}
    button{background:#f6f8ff;font-weight:800;cursor:pointer}
    button.primary{background:var(--brand);border-color:#194df7;color:#fff}
    .hint{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border:1px solid #e0e6ff;border-radius:999px;background:#f6f8ff;font-weight:800}

    /* CHARTS ROW */
    .grid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px;min-width:0}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .grid>*{min-width:0}

    canvas{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:8px;max-width:100%}

    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .tile{background:#fff;border:1px solid var(--edge);border-radius:12px;padding:12px}
    .kpi .big{font-weight:900;font-size:22px}
    .kpi .good{color:var(--ok)} .kpi .warn{color:var(--warn)}

    footer{max-width:1280px;margin:8px auto 30px;padding:0 18px;color:#5b6272;font-size:12px}

    /* CHART BOX — lock height */
    .chartbox{ position:relative; height:320px; width:100%; min-width:0; overflow:hidden; }
    @media (max-width:600px){ .chartbox{ height:260px; } }
    .chartbox canvas{ height:100% !important; width:100% !important; display:block; }

    /* FUEL CARDS */
    .fuels{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:1000px){.fuels{grid-template-columns:repeat(2,1fr)}}
    .fuel{display:flex;flex-direction:column;gap:6px;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#fff}
    .fuel .row{display:flex;align-items:center;justify-content:space-between}
    .badge2{display:inline-grid;place-items:center;width:26px;height:26px;border-radius:8px;background:#f0f4ff;border:1px solid #e1e8ff;font-weight:800}
    .money{font-weight:900}
    .sub{font-size:12px;color:var(--muted)}
    .mini{font-size:11px;color:var(--muted)}
    .sep{height:1px;background:#eef2ff;margin:4px 0}
    .priceCtl{display:flex;align-items:center;gap:8px}
    .priceCtl input[type=range]{flex:1}

    /* WEATHER ROW */
    .wx{display:grid;grid-template-columns:360px minmax(0,1fr);gap:12px;min-width:0}
    @media (max-width:1000px){.wx{grid-template-columns:1fr}}
    .wx>*{min-width:0}
    .wxNow{display:flex;gap:12px;align-items:center;border:1px solid var(--edge);border-radius:12px;padding:12px;background:#fff}
    .wxNow img{width:64px;height:64px}
    .wxNums{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .wxTile{border:1px solid var(--edge);border-radius:10px;padding:8px;background:#fff}
    .wxAlerts{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .alert{border-left:4px solid var(--warn);padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #e1f0ff}
    .alert.bad{border-left-color:var(--bad)}
    .badgeS{display:inline-block;padding:2px 6px;border-radius:999px;background:#f2f4ff;border:1px solid #e5eafe;font-size:12px;font-weight:800}

    /* MISC TILES */
    .envGrid{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px}
    @media (max-width:900px){.envGrid{grid-template-columns:1fr}}
    .tileSm{background:#fff;border:1px solid var(--edge);border-radius:12px;padding:12px}
    .note{margin-top:8px;font-size:12px;color:#374151}

    /* TOURISM */
    .tourGrid{display:grid;grid-template-columns:320px minmax(0,1fr);gap:12px}
    @media (max-width:900px){.tourGrid{grid-template-columns:1fr}}
    .tourTiles{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:1100px){.tourTiles{grid-template-columns:repeat(2,1fr)}}
  </style>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="brand"><div class="badge">⚡</div><div>Grid Starter<br><small style="color:var(--muted);font-weight:700">PJM • EIA-930 (Free)</small></div></div>
    <a href="/legal.html" class="pill">← Back to Packages</a>
  </header>

  <main class="wrap">
    <aside class="card">
      <h1>Setup</h1>
      <div class="field">
        <label><b>EIA API Key</b></label>
        <input id="eiaKey" placeholder="paste your EIA key" autocomplete="off">
        <div class="hint">Get one free in 1 minute at <a href="https://www.eia.gov/opendata/" target="_blank">EIA Open Data</a>. (Stored only in this browser.)</div>
      </div>
      <div class="field">
        <label><b>Balancing Authority</b></label>
        <select id="ba">
          <option value="PJM" selected>PJM (Mid-Atlantic)</option>
          <option value="ISNE">ISO-NE (New England)</option>
          <option value="NYIS">NYISO (New York)</option>
          <option value="CISO">CAISO (California)</option>
          <option value="ERCO">ERCOT (Texas)</option>
          <option value="MISO">MISO (Midcontinent)</option>
          <option value="SWPP">SPP (Southwest Power Pool)</option>
          <option value="TVA">TVA (Tennessee Valley)</option>
        </select>
        <div class="hint">Data is BA / zone level (not literal city).</div>
      </div>
      <div class="field">
        <label><b>Window</b></label>
        <select id="win">
          <option value="24" selected>Last 24 hours</option>
          <option value="48">Last 48 hours</option>
          <option value="168">Last 7 days</option>
        </select>
      </div>

      <div class="field">
        <label><b>Price ($/MWh)</b></label>
        <div class="priceCtl">
          <input id="price" type="range" min="10" max="250" step="5" value="75">
          <input id="priceNum" type="number" min="0" step="1" value="75" style="width:90px">
        </div>
        <div class="mini">Used for revenue estimates (Revenue/h ≈ Price × Current Load). Real nodal/zone LMPs require ISO credentials.</div>
      </div>

      <div class="field">
        <label class="hint"><input type="checkbox" id="noiseOn"> Try DOT transportation noise (beta)</label>
      </div>

      <div class="field"><button id="btnLoad" class="primary">Fetch data</button></div>
      <div class="field"><div id="status" class="pill">Idle</div></div>
    </aside>

    <section class="card">
      <div class="kpi" style="margin-bottom:10px">
        <div class="tile"><div class="hint">Current Demand</div><div class="big" id="kpiDemand">—</div></div>
        <div class="tile"><div class="hint">Last Updated (local)</div><div class="big" id="kpiTime">—</div></div>
        <div class="tile"><div class="hint">Net Imports</div><div class="big" id="kpiInterchg">—</div><div class="mini">(+ import / − export)</div></div>
        <div class="tile"><div class="hint">Est. Revenue / hour</div><div class="big money" id="kpiRev">$—</div><div class="mini">Price × Load</div></div>
      </div>

      <div class="grid">
        <div>
          <h2>Load vs Day-Ahead Forecast</h2>
          <div class="chartbox"><canvas id="chartDemand"></canvas></div>
        </div>
        <div>
          <h2>Fuel mix — stacked (MW)</h2>
          <div class="chartbox"><canvas id="chartFuelTS"></canvas></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h2>“Assets” by fuel (live split)</h2>
        <div class="fuels" id="fuelCards"></div>
      </div>
    </section>

    <section class="card">
      <h2>Weather & Alerts for selected BA</h2>
      <div class="wx">
        <div>
          <div class="wxNow">
            <img id="wxIcon" alt="weather icon" onerror="this.style.display='none'">
            <div>
              <div id="wxTitle" style="font-weight:900">—</div>
              <div class="sub" id="wxPlace">—</div>
              <div class="mini" id="wxMeta">—</div>
            </div>
          </div>
          <div class="wxNums" style="margin-top:10px">
            <div class="wxTile"><div class="sub">Temperature now</div><div class="big" id="wxTemp">—</div></div>
            <div class="wxTile"><div class="sub">Wind</div><div class="big" id="wxWind">—</div></div>
          </div>

          <div class="wxAlerts" id="wxAlerts"></div>
        </div>

        <div>
          <div class="chartbox"><canvas id="chartWX"></canvas></div>
          <div class="mini" style="margin-top:6px">Source: Open-Meteo (no key). Alerts: U.S. National Weather Service.</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Environment (beta) — near your BA</h2>
      <div class="envGrid">
        <div>
          <h3 style="margin:4px 0 8px">Air quality (PM2.5 & US AQI)</h3>
          <div class="chartbox"><canvas id="chartAQ"></canvas></div>
        </div>
        <div>
          <h3 style="margin:4px 0 8px">Water (nearest USGS station — °C)</h3>
          <div class="chartbox"><canvas id="chartWater"></canvas></div>
        </div>
      </div>
      <div class="envTiles" style="margin-top:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        <div class="tileSm"><div class="sub">Nearby permitted dischargers (EPA TRI/ECHO)</div><div class="big" id="echoCount">—</div></div>
        <div class="tileSm"><div class="sub">Air: latest US AQI</div><div class="big" id="aqiNow">—</div></div>
        <div class="tileSm"><div class="sub">Water: station used</div><div class="big" id="usgsStation">—</div></div>
        <div class="tileSm"><div class="sub">Modeled transportation noise</div><div class="big" id="noiseNow">—</div></div>
      </div>
      <div class="note">Soil/ground & noise lack universal live APIs. For context, combine TRI/Superfund & DOT Noise Map with local data.</div>
    </section>

    <section class="card">
      <h2>Citizens (beta) — county near your BA</h2>
      <div class="envTiles" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        <div class="tileSm"><div class="sub">County</div><div class="big" id="c_county">—</div></div>
        <div class="tileSm"><div class="sub">Population</div><div class="big" id="c_pop">—</div></div>
        <div class="tileSm"><div class="sub">Median age</div><div class="big" id="c_age">—</div></div>
        <div class="tileSm"><div class="sub">Bachelor’s+ (%)</div><div class="big" id="c_bach">—</div></div>
        <div class="tileSm"><div class="sub">Unemployment (%)</div><div class="big" id="c_unemp">—</div></div>
      </div>
      <div class="mini" style="margin-top:6px">Sources: FCC Block Finder (county), U.S. Census ACS 5-year Data Profile.</div>
    </section>

    <section class="card">
      <h2>Tourism (beta) — within ~10 km of BA center</h2>
      <div class="tourGrid">
        <div>
          <div class="chartbox" style="height:260px"><canvas id="chartTour"></canvas></div>
        </div>
        <div class="tourTiles">
          <div class="tileSm"><div class="sub">Attractions</div><div class="big" id="t_attract">—</div></div>
          <div class="tileSm"><div class="sub">Hotels & lodging</div><div class="big" id="t_hotels">—</div></div>
          <div class="tileSm"><div class="sub">Parks & nature</div><div class="big" id="t_parks">—</div></div>
          <div class="tileSm"><div class="sub">Gateways</div><div class="big" id="t_gate">—</div></div>
          <div class="tileSm"><div class="sub">Attractiveness (score)</div><div class="big" id="t_score">—</div></div>
        </div>
      </div>
      <div class="mini" style="margin-top:6px">Source: OpenStreetMap via Overpass API (CORS-friendly POST, mirror fallback). If rate-limited, tiles show “—”.</div>
    </section>
  </main>

  <footer>
    <div>Sources: EIA Form 930 (free). Weather via Open-Meteo; alerts via api.weather.gov. Air quality via Open-Meteo Air-Quality. Water via USGS NWIS. Dischargers via EPA ECHO/Facility API. Citizens via FCC & U.S. Census. Tourism via OpenStreetMap/Overpass. Revenue is an estimate; for real trading/ops use ISO LMPs and settlement rules.</div>
  </footer>

  <script>
  // ---------- helpers
  const $ = s => document.querySelector(s);
  const fmtNum = n => (n==null? '—' : Number(n).toLocaleString());
  const fmtMoney = n => (isFinite(n)? '$' + Number(n).toLocaleString(undefined,{maximumFractionDigits:0}) : '$—');
  const pad = n => (n<10?'0'+n:n);
  function toEIAISO(d){ const z = new Date(d.getTime()); z.setUTCMinutes(0,0,0); return `${z.getUTCFullYear()}-${pad(z.getUTCMonth()+1)}-${pad(z.getUTCDate())}T${pad(z.getUTCHours())}`; }
  function parseEIAPeriod(p){
    if(!p) return null;
    if (/^\d{4}-\d{2}-\d{2}T\d{2}$/.test(p)) { const [Y,M,D,H]=p.replace('T','-').split('-').map(Number); return new Date(Date.UTC(Y,M-1,D,H,0,0)); }
    const s = p.replace(' ', 'T'); const d = new Date(s); return isNaN(d) ? null : d;
  }

  // Wait for a box to have stable non-zero width & height across a few frames
  function waitForStableBox(box, minW=160, minH=120, timeoutMs=1500){
    return new Promise(resolve=>{
      const t0 = performance.now();
      function check(){
        const r1 = box.getBoundingClientRect();
        if(r1.width>=minW && r1.height>=minH) return resolve();
        if(performance.now()-t0>timeoutMs) return resolve();
        requestAnimationFrame(check);
      }
      check();
    });
  }

  // ---------- persist
  const store = {
    get k(){ return localStorage.getItem('eia_key')||'' },
    set k(v){ localStorage.setItem('eia_key', v||'') },
    get ba(){ return localStorage.getItem('eia_ba')||'PJM' },
    set ba(v){ localStorage.setItem('eia_ba', v||'PJM') },
    get win(){ return localStorage.getItem('eia_win')||'24' },
    set win(v){ localStorage.setItem('eia_win', v||'24') },
    get price(){ return Number(localStorage.getItem('price_mwh')||'75') },
    set price(v){ localStorage.setItem('price_mwh', String(v)) },
    get noise(){ return localStorage.getItem('noise_on')==='1' },
    set noise(v){ localStorage.setItem('noise_on', v?'1':'0') },
  };
  $('#eiaKey').value = store.k; $('#ba').value = store.ba; $('#win').value = store.win;
  $('#price').value = store.price; $('#priceNum').value = store.price; $('#noiseOn').checked = store.noise;
  $('#eiaKey').addEventListener('input', e=> store.k = e.target.value.trim());
  $('#ba').addEventListener('change', e=> store.ba = e.target.value);
  $('#win').addEventListener('change', e=> store.win = e.target.value);
  $('#price').addEventListener('input', e=> { $('#priceNum').value = e.target.value; store.price = e.target.value; updateMoney(); });
  $('#priceNum').addEventListener('input', e=> { $('#price').value = e.target.value||0; store.price = e.target.value||0; updateMoney(); });
  $('#noiseOn').addEventListener('change', e=> store.noise = e.target.checked);

  // ---------- charts
  let demandChart, fuelTSChart, wxChart, aqChart, waterChart, tourChart;

  
  async function ensureCharts(){
    // wait for Chart.js if it loaded deferred
    if (typeof Chart === 'undefined') {
      await new Promise(r=>{ const t=setInterval(()=>{ if (typeof Chart!=='undefined'){ clearInterval(t); r(); } }, 50); });
    }
    // Wait for tiles to be visible and Chart to exist
    await Promise.all([
      waitForStableBox($('#chartDemand').parentElement),
      waitForStableBox($('#chartFuelTS').parentElement),
      waitForStableBox($('#chartWX').parentElement),
      waitForStableBox($('#chartAQ').parentElement),
      waitForStableBox($('#chartWater').parentElement),
    ]);
    if(typeof Chart === 'undefined'){ await new Promise(r=> window.addEventListener('load', r, {once:true})); }
    // charts...
    await waitForStableBox($('#chartDemand').parentElement);
    await waitForStableBox($('#chartFuelTS').parentElement);
    await waitForStableBox($('#chartWX').parentElement);

    if(!demandChart){
      demandChart = new Chart($('#chartDemand'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'Demand (MW)', data:[], borderWidth:2, tension:.25 },
          { label:'Forecast (MW)', data:[], borderWidth:2, tension:.25, borderDash:[6,6] }
        ]},
        options:{ responsive:true, interaction:{ mode:'index', intersect:false },
          scales:{ x:{ ticks:{ maxRotation:0 }}, y:{ beginAtZero:true } }
        }
      });
    }
    if(!fuelTSChart){
      fuelTSChart = new Chart($('#chartFuelTS'), {
        type:'line',
        data:{ labels:[], datasets:[] },
        options:{ responsive:true, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ x:{ stacked:true }, y:{ beginAtZero:true, stacked:true } }
        }
      });
    }
    if(!wxChart){
      wxChart = new Chart($('#chartWX'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'Temperature (°F)', data:[], yAxisID:'temp', borderWidth:2, tension:.25 },
          { label:'Precip (in/hr)',   data:[], yAxisID:'precip', borderWidth:2, borderDash:[6,6], tension:.25 }
        ]},
        options:{ responsive:true, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ temp:{ type:'linear', position:'left', beginAtZero:false },
                  precip:{ type:'linear', position:'right', beginAtZero:true } }
        }
      });
    }
    if(!aqChart){
      aqChart = new Chart($('#chartAQ'), {
        type:'line',
        data:{ labels:[], datasets:[
          { label:'PM2.5 (µg/m³)', data:[], borderWidth:2, tension:.25 },
          { label:'US AQI', data:[], borderWidth:2, tension:.25, borderDash:[6,6], yAxisID:'aqi' }
        ]},
        options:{ responsive:true, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ position:'bottom' }},
          scales:{ y:{ beginAtZero:true }, aqi:{ position:'right', beginAtZero:true, suggestedMax:150 } }
        }
      });
    }
    if(!waterChart){
      waterChart = new Chart($('#chartWater'), {
        type:'line',
        data:{ labels:[], datasets:[ { label:'Water temp (°C)', data:[], borderWidth:2, tension:.25 } ]},
        options:{ responsive:true, interaction:{mode:'index',intersect:false}, plugins:{ legend:{ position:'bottom' }},
          scales:{ y:{ beginAtZero:false } }
        }
      });
    }
    if(!tourChart){
      tourChart = new Chart($('#chartTour'), {
        type:'doughnut',
        data:{ labels:['Attractions','Hotels','Parks/Nature','Gateways'],
          datasets:[{ data:[0,0,0,0] }]},
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' }} }
      });
    }
  }

  // resize on layout change
  new ResizeObserver(()=>{ demandChart?.resize(); fuelTSChart?.resize(); wxChart?.resize(); aqChart?.resize(); waterChart?.resize(); tourChart?.resize(); }).observe(document.body);

  // ---------- BA coordinates (representative)
  const BA_COORDS = {
    PJM:{lat:39.9526, lon:-75.1652, place:'Philadelphia, PA'},
    ISNE:{lat:42.3601, lon:-71.0589, place:'Boston, MA'},
    NYIS:{lat:42.6526, lon:-73.7562, place:'Albany, NY'},
    CISO:{lat:38.5816, lon:-121.4944, place:'Sacramento, CA'},
    ERCO:{lat:30.2672, lon:-97.7431, place:'Austin, TX'},
    MISO:{lat:38.6270, lon:-90.1994, place:'St. Louis, MO'},
    SWPP:{lat:34.7465, lon:-92.2896, place:'Little Rock, AR'},
    TVA:{lat:35.0456, lon:-85.3097, place:'Chattanooga, TN'}
  };

  // ---------- EIA 930
  async function eiaFetchRegion(key, ba, hours, typeCode){
    const end = new Date(); const start = new Date(end.getTime() - Number(hours)*3600*1000);
    const url = new URL('https://api.eia.gov/v2/electricity/rto/region-data/data/');
    url.searchParams.set('api_key', key); url.searchParams.set('frequency','hourly');
    url.searchParams.append('data[0]','value'); url.searchParams.append('facets[respondent][]', ba); url.searchParams.append('facets[type][]', typeCode);
    url.searchParams.set('start', toEIAISO(start)); url.searchParams.set('end', toEIAISO(end));
    const r = await fetch(url); if(!r.ok) throw new Error('EIA region '+typeCode+' failed');
    const j = await r.json(); return (j?.response?.data||[]).sort((a,b)=> new Date(a.period)-new Date(b.period));
  }
  async function eiaFetchFuelTimeSeries(key, ba, hours){
    const end = new Date(); const start = new Date(end.getTime() - Number(hours)*3600*1000);
    const url = new URL('https://api.eia.gov/v2/electricity/rto/fuel-type-data/data/');
    url.searchParams.set('api_key', key); url.searchParams.set('frequency','hourly');
    url.searchParams.append('data[0]','value'); url.searchParams.append('facets[respondent][]', ba);
    url.searchParams.set('start', toEIAISO(start)); url.searchParams.set('end', toEIAISO(end));
    const r = await fetch(url); if(!r.ok) throw new Error('EIA fuel series failed');
    const rows = (await r.json())?.response?.data || []; rows.sort((a,b)=> new Date(a.period)-new Date(b.period));
    const fuelset = new Set(); const map = new Map();
    for(const row of rows){ const t=row.period, f=row.fueltype||'OTH'; fuelset.add(f); if(!map.has(t)) map.set(t,{}); map.get(t)[f]=(map.get(t)[f]||0)+Number(row.value||0); }
    const times = Array.from(map.keys()); const fuels = Array.from(fuelset); const byFuel={}; for(const f of fuels){ byFuel[f]=times.map(t=> (map.get(t)[f]||0)); }
    return { times, fuels, byFuel };
  }
  async function eiaFetchInterchangeNet(key, ba, hours){
    const end = new Date(); const start = new Date(end.getTime() - Number(hours)*3600*1000);
    const url = new URL('https://api.eia.gov/v2/electricity/rto/interchange-data/data/');
    url.searchParams.set('api_key', key); url.searchParams.set('frequency','hourly'); url.searchParams.append('data[0]','value');
    url.searchParams.append('facets[fromba][]', ba); url.searchParams.append('facets[toba][]', ba);
    url.searchParams.set('start', toEIAISO(start)); url.searchParams.set('end', toEIAISO(end));
    const r = await fetch(url); if(!r.ok) throw new Error('EIA interchange failed');
    const rows = (await r.json())?.response?.data || [];
    let imp=0, exp=0; for(const row of rows){ const v=Number(row.value||0); if(row.toba===ba) imp+=v; else if(row.fromba===ba) exp+=v; }
    return { net: imp-exp };
  }

  // ---------- Weather (Open-Meteo + NOAA alerts)
  function weatherIconInfo(code){
    const map = [
      {codes:[0], icon:'clear-day', label:'Clear'},
      {codes:[1,2], icon:'partly-cloudy-day', label:'Partly cloudy'},
      {codes:[3], icon:'overcast', label:'Overcast'},
      {codes:[45,48], icon:'fog', label:'Fog'},
      {codes:[51,53,55,56,57], icon:'drizzle', label:'Drizzle'},
      {codes:[61,63,65,66,67,80,81,82], icon:'rain', label:'Rain'},
      {codes:[71,73,75,77,85,86], icon:'snow', label:'Snow'},
      {codes:[95], icon:'thunderstorms', label:'Thunderstorm'},
      {codes:[96,99], icon:'thunderstorms-day-extreme', label:'Storm + hail'}
    ];
    for(const m of map){ if(m.codes.includes(Number(code))) return m; }
    return {icon:'unknown', label:'—'};
  }
  const iconURL = i => `https://cdn.jsdelivr.net/npm/@open-meteo/weather-icons@1.7.0/production/fill/${i}.svg`;

  async function fetchWeather(lat, lon, hours){
    const pastDays = Math.max(1, Math.ceil(hours/24));
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = [
      `latitude=${lat}`, `longitude=${lon}`,
      'hourly=temperature_2m,precipitation,wind_speed_10m,weathercode',
      'temperature_unit=fahrenheit','windspeed_unit=mph','precipitation_unit=inch',
      `past_days=${pastDays}`, 'forecast_days=2', 'timezone=auto'
    ].join('&');
    const r = await fetch(url); if(!r.ok) throw new Error('Weather failed');
    const j = await r.json();
    const H = j.hourly || {};
    const times = H.time?.map(t => new Date(t)) || [];
    const endIdx = times.length;
    const startIdx = Math.max(0, endIdx - hours);
    const slice = (arr)=> (arr||[]).slice(startIdx, endIdx);
    return {
      times: times.slice(startIdx, endIdx),
      tempF: slice(H.temperature_2m),
      precipIn: slice(H.precipitation),
      windMph: slice(H.wind_speed_10m),
      now: { tempF: H.temperature_2m?.[endIdx-1], windMph: H.wind_speed_10m?.[endIdx-1], code: H.weathercode?.[endIdx-1] }
    };
  }

  async function fetchNOAAAlerts(lat, lon){
    try{
      const r = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`);
      if(!r.ok) throw new Error();
      const j = await r.json();
      const feats = Array.isArray(j.features) ? j.features : [];
      return feats.slice(0,4).map(f => ({
        event: f.properties?.event || 'Alert',
        severity: (f.properties?.severity || '').toLowerCase(),
        area: f.properties?.areaDesc || '',
        starts: f.properties?.effective || f.properties?.onset || '',
        ends: f.properties?.ends || f.properties?.expires || ''
      }));
    }catch{ return []; }
  }

  function renderWeather(wx, placeLabel){
    const info = weatherIconInfo(wx.now.code||0);
    $('#wxIcon').src = iconURL(info.icon);
    $('#wxTitle').textContent = `${info.label}`;
    $('#wxPlace').textContent = placeLabel || '—';
    $('#wxMeta').textContent = `Last hour • temp ${Math.round(wx.now.tempF)}°F • wind ${Math.round(wx.now.windMph)} mph`;
    $('#wxTemp').textContent = `${Math.round(wx.now.tempF)}°F`;
    $('#wxWind').textContent = `${Math.round(wx.now.windMph)} mph`;

    const labels = wx.times.map(d=> `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`);
    wxChart.data.labels = labels;
    wxChart.data.datasets[0].data = wx.tempF;
    wxChart.data.datasets[1].data = wx.precipIn;
    wxChart.update();
  }

  function renderAlerts(list){
    const box = $('#wxAlerts'); box.innerHTML = '';
    if(!list.length){ box.innerHTML = '<div class="wxTile"><span class="badgeS">No active alerts</span></div>'; return; }
    for(const a of list){
      const el = document.createElement('div');
      const cls = a.severity.includes('severe') || a.severity.includes('extreme') ? 'alert bad' : 'alert';
      el.className = cls;
      const when = [a.starts?.slice(0,16)?.replace('T',' '), a.ends? ' → '+a.ends.slice(0,16).replace('T',' '):''].join('');
      el.innerHTML = `<div><span class="badgeS">${a.event}</span> <span class="mini">(${a.severity||'unknown'})</span></div>
                      <div class="mini">${a.area}</div>
                      <div class="mini">${when}</div>`;
      box.appendChild(el);
    }
  }

  // ---------- Environment: Air (Open-Meteo AQ) & Water (USGS)
  async function fetchAir(lat, lon, hours){
    const pastDays = Math.max(1, Math.ceil(hours/24));
    const u = new URL('https://air-quality-api.open-meteo.com/v1/air-quality');
    u.search = [`latitude=${lat}`,`longitude=${lon}`,`hourly=pm2_5,us_aqi`,`past_days=${pastDays}`,`forecast_days=2`,`timezone=auto`].join('&');
    const r = await fetch(u); if(!r.ok) throw new Error('AQ failed'); const j = await r.json();
    const H=j.hourly||{}; const times=(H.time||[]).map(t=>new Date(t));
    const endIdx = times.length, startIdx = Math.max(0,endIdx-hours);
    return {
      labels: times.slice(startIdx,endIdx).map(d=> `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00`),
      pm25: (H.pm2_5||[]).slice(startIdx,endIdx),
      aqi: (H.us_aqi||[]).slice(startIdx,endIdx),
      aqiNow: H.us_aqi?.[endIdx-1] ?? null
    };
  }

  
  // USGS — nearest active stream station with daily water temp, last 30 days
  async function fetchUSGSWater(lat, lon){
    try{
      // Find nearby stream site with water temperature (00010) using site service (RDB output)
      const bbox = [ (lon-0.5).toFixed(4), (lat-0.45).toFixed(4), (lon+0.5).toFixed(4), (lat+0.45).toFixed(4) ].join(',');
      const siteURL = `https://waterservices.usgs.gov/nwis/site/?bBox=${bbox}&siteType=ST&siteStatus=active&hasDataTypeCd=dv&parameterCd=00010&format=rdb`;
      const sResp = await fetch(siteURL);
      if(!sResp.ok) throw new Error('site search failed');
      const txt = await sResp.text();
      // Parse RDB (skip comment lines starting with #)
      const rowsAll = txt.split(/
?
/).filter(l=>l && !l.startsWith('#'));
      if(rowsAll.length < 3) throw new Error('no rdb rows');
      const header = rowsAll[0].split('	');
      const records = rowsAll.slice(2).map(l=>Object.fromEntries(l.split('	').map((v,i)=>[header[i], v])))
                                 .filter(o => o.site_no && o.station_nm);
      if(!records.length) throw new Error('no site');
      // choose the first (closest in bbox order)
      const site_no = records[0].site_no;
      const station_nm = records[0].station_nm;
      const site = { id: site_no, name: station_nm };

      // Now pull daily values (DV) last ~30 days (or 'hours' window if larger)
      const end = new Date();
      const start = new Date(end.getTime() - Math.max(24, hours)*3600*1000);
      const startStr = start.toISOString().slice(0,10);
      const endStr   = end.toISOString().slice(0,10);
      const dvURL = `https://waterservices.usgs.gov/nwis/dv/?format=json&sites=${encodeURIComponent(site_no)}&parameterCd=00010&startDT=${startStr}&endDT=${endStr}`;
      const dvResp = await fetch(dvURL);
      if(!dvResp.ok) throw new Error('DV failed');
      const dj = await dvResp.json();
      const points = dj?.value?.timeSeries?.[0]?.values?.[0]?.value || [];
      const labels = points.map(v=> v.dateTime?.slice(0,10) || '');
      const vals = points.map(v=> Number(v.value));
      return { labels, vals, site };
    }catch(e){
      console.warn('USGS error', e);
    }

    // DV daily fallback (7 days) if above fails
    try{
      const end = new Date();
      const start = new Date(end.getTime() - Math.max(24, hours)*3600*1000);
      const u2 = new URL('https://waterservices.usgs.gov/nwis/dv/');
      u2.search = new URLSearchParams({ format: 'json', sites: '', parameterCd: '00010', startDT: start.toISOString().slice(0,10), endDT: end.toISOString().slice(0,10) });
      const r2 = await fetch(u2);
      if(!r2.ok) throw new Error('DV failed');
      const j2 = await r2.json();
      const rows = j2?.value?.timeSeries?.[0]?.values?.[0]?.value || [];
      const labels = rows.map(v=> v.dateTime.slice(0,10));
      const vals = rows.map(v=> Number(v.value));
      return {labels, vals, site: null};
    }catch(e){
      console.error('USGS fallback failed', e);
      return {labels:[], vals:[], site:null};
    }
}

}

    } catch(e) {}
    // DV daily fallback (last 7 days window)
    const end = new Date(); const start = new Date(end.getTime() - Math.max(24,hours)*3600*1000);
    const u2 = new URL('https://waterservices.usgs.gov/nwis/dv/');
    u2.search = new URLSearchParams({format:'json', sites:site.id, parameterCd:'00010', startDT:start.toISOString().slice(0,10), endDT:end.toISOString().slice(0,10)});
    const r2 = await fetch(u2); if(!r2.ok) throw new Error('DV failed');
    const j2 = await r2.json();
    const rows = j2?.value?.timeSeries?.[0]?.values?.[0]?.value || [];
    const labels = rows.map(v=> v.dateTime.slice(0,10));
    const vals = rows.map(v=> Number(v.value));
    return {labels, vals, site};
  }

  // EPA ECHO TRI count (simple bbox/latlon search). Use Facility REST which supports lat/long.
  
  async function fetchTRICount(lat, lon, miles=25){
    const qs = p => Object.entries(p).map(([k,v])=> `${k}=${encodeURIComponent(v)}`).join('&');
    const params = { output:'JSON', p_program:'TRI', p_lat:lat.toFixed(3), p_long:lon.toFixed(3), p_radius:miles };
    // First try ECHO data (supports CORS)
    const tries = [
      'https://echodata.epa.gov/echo/echo_rest_services.get_facilities',
      'https://echodata.epa.gov/echo/er_rest_services.get_facilities'
    ];
    for(const base of tries){
      try{
        const r = await fetch(`${base}?${qs(params)}`);
        if(!r.ok) continue;
        const j = await r.json();
        const rows = j?.Results?.QueryRows || j?.Results?.Facilities || [];
        if(Array.isArray(rows)) return rows.length;
      } catch(e) { /*try next*/ }
    }
    // Fallback to FRS JSONP (bypasses CORS)
    try{
      const j = await jsonp('https://ofmpub.epa.gov/frs_public2/frs_rest_services.get_facilities', {
        output:'JSONP', callback:'', latitude83:lat.toFixed(3), longitude83:lon.toFixed(3), search_radius:Math.min(25, miles), pgm_sys_acrnm:'TRIS'
      }, 8000);
      const rows = j?.FRSFacility || j?.Results || j?.rows || [];
      if(Array.isArray(rows)) return rows.length;
    } catch(e) {}
    return null;
  }

  // JSONP helper (with optional params & timeout)
  function jsonp(url, params={}, timeout=12000){
    return new Promise((resolve,reject)=>{
      const cb='__cb_'+Math.random().toString(36).slice(2);
      const q = Object.entries(params).map(([k,v])=> k+'='+encodeURIComponent(v)).join('&');
      const full = url + (url.includes('?')?'&':'?') + (q? (q+'&') : '') + 'callback='+cb;
      let to;
      window[cb]=(d)=>{ clearTimeout(to); resolve(d); cleanup(); };
      function cleanup(){ delete window[cb]; s.remove(); }
      const s=document.createElement('script');
      s.onerror=()=>{ clearTimeout(to); reject(new Error('jsonp error')); cleanup(); };
      s.src = full;
      document.body.appendChild(s);
      to = setTimeout(()=>{ reject(new Error('jsonp timeout')); cleanup(); }, timeout);
    });
  }
;
      function cleanup(){ delete window[cb]; s.remove(); }
      const s=document.createElement('script');
      s.onerror=()=>{ reject(new Error('jsonp error')); cleanup(); };
      s.src = url + (url.includes('?')?'&':'?') + 'callback='+cb;
      document.body.appendChild(s);
    });
  }
  async function fetchNoiseDNL(lat, lon){
    try{
      const base='https://maps.dot.gov/arcgis/rest/services/BTS/Transportation_Noise/MapServer/identify';
      const qp = new URLSearchParams({
        f:'pjson',
        geometry: JSON.stringify({x:lon, y:lat, spatialReference:{wkid:4326}}),
        geometryType:'esriGeometryPoint',
        sr:'4326',
        mapExtent:'-180,-90,180,90',
        imageDisplay:'800,600,96',
        tolerance:'3',
        layers:'all'
      }).toString();
      const j = await jsonp(base+'?'+qp);
      const res = j?.results||[];
      let val = null;
      for(const r of res){
        const a=r?.attributes||{};
        val = a.DNL || a.dnl || a.GRIDCODE || a.Value || val;
      }
      return val==null? null : Number(val);
    }catch{ return null; }
  }

  // ---------- Citizens (FCC + Census ACS)
  async function fetchCounty(lat, lon){
    const u = new URL('https://geo.fcc.gov/api/census/area');
    u.search = new URLSearchParams({lat, lon, format:'json'});
    const r = await fetch(u); if(!r.ok) throw new Error();
    const j = await r.json();
    const c = j?.results?.[0];
    if(!c) throw new Error('no county');
    return { name: c.name, statefp: c.state_fips, countyfp: c.county_fips };
  }
  async function fetchACS(statefp, countyfp){
    // NAME, population, median age, BA+ %, Unemployment %
    const vars = ['NAME','DP05_0001E','DP05_0018E','DP02_0068PE','DP03_0009PE'];
    const u = new URL('https://api.census.gov/data/2022/acs/acs5/profile');
    u.search = new URLSearchParams({ get: vars.join(','), for:`county:${countyfp}`, in:`state:${statefp}` });
    const r = await fetch(u); if(!r.ok) throw new Error();
    const j = await r.json();
    const row = j?.[1]; if(!row) throw new Error();
    return { name: row[0], pop: row[1], age: row[2], bach: row[3], unemp: row[4] };
  }

  // ---------- Tourism (OSM / Overpass)
  async function overpassQuery(q){
    const endpoints=[
      'https://overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter'
    ];
    for(const ep of endpoints){
      try{
        const r = await fetch(ep,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:'data='+encodeURIComponent(q)});
        if(r.ok){ const j = await r.json(); return j?.elements||[]; }
      }catch(e){}
    }
    return [];
  }
  async function fetchTourism(lat, lon){
    const r10=10000, r15=15000, r20=20000;
    function Q(body){ return `[out:json][timeout:25];(${body});out ids;`; }
    const qAttr = Q(`nwr["tourism"~"^(attraction|museum|gallery|theme_park|artwork|zoo|aquarium|viewpoint)$"](around:${r10},${lat},${lon})`);
    const qHotel= Q(`nwr["tourism"~"^(hotel|motel|hostel|guest_house|apartment|chalet|camp_site)$"](around:${r10},${lat},${lon})`);
    const qParks= Q(`nwr["leisure"~"^(park|garden|nature_reserve)$"](around:${r10},${lat},${lon});nwr["boundary"="national_park"](around:${r20},${lat},${lon})`);
    const qGate = Q(`nwr["aeroway"="aerodrome"](around:${r20},${lat},${lon});nwr["railway"="station"](around:${r10},${lat},${lon});nwr["amenity"="ferry_terminal"](around:${r15},${lat},${lon})`);
    const [a,h,p,g] = await Promise.all([overpassQuery(qAttr),overpassQuery(qHotel),overpassQuery(qParks),overpassQuery(qGate)]);
    const A=a.length, H=h.length, P=p.length, G=g.length;
    return {A,H,P,G, score: 3*A + 2*P + 2*G + 1*H};
  }

  // ---------- UI build: fuel cards & revenue KPI
  const FUEL_NAMES = {NG:'Gas', COL:'Coal', NUC:'Nuclear', WND:'Wind', SUN:'Solar', WAT:'Hydro', OIL:'Oil', OTH:'Other'};
  const FUEL_ORDER = ['NG','COL','NUC','WND','SUN','WAT','OIL','OTH'];

  function renderFuelCards(mixObj, totalMW, price){
    const el = $('#fuelCards'); el.innerHTML = '';
    const fuels = Object.keys(mixObj).sort((a,b)=> FUEL_ORDER.indexOf(a)-FUEL_ORDER.indexOf(b));
    for(const f of fuels){
      const mw = mixObj[f]||0; const share = totalMW>0 ? (mw/totalMW) : 0;
      const revH = share * price * totalMW;
      const card = document.createElement('div'); card.className = 'fuel';
      card.innerHTML = `
        <div class="row"><div><span class="badge2">${FUEL_NAMES[f]?.[0]||'?'}</span> <b>${FUEL_NAMES[f]||f}</b></div>
             <div class="money">${fmtNum(mw)} MW</div></div>
        <div class="row sub"><div>${(share*100).toFixed(1)}% share</div><div>${fmtMoney(revH)}/h</div></div>
        <div class="sep"></div>
        <div class="mini">Assumes uniform price $/MWh across fuels for an at-a-glance revenue split.</div>`;
      el.appendChild(card);
    }
  }

  function updateMoney(){
    const price = Number($('#priceNum').value||0);
    const txt = $('#kpiDemand').textContent.replace(/[, MW]/g,'');
    const load = Number(txt)||0;
    $('#kpiRev').textContent = fmtMoney(price * load);
    if(window.__lastMix && load>0){ renderFuelCards(window.__lastMix, load, price); }
  }

  // ---------- main loader
  async function loadAll(){
    const key = ($('#eiaKey').value||'').trim();
    const ba = $('#ba').value;
    const hours = +$('#win').value;
    if(!key){ $('#status').textContent = 'Add your EIA key to start'; return; }

    $('#status').textContent = 'Loading…';
    await ensureCharts();

    try{
      // Energy: region + forecast
      const [act, fcast] = await Promise.all([
        eiaFetchRegion(key, ba, hours, 'D'),
        eiaFetchRegion(key, ba, hours, 'DF')
      ]);

      const labels = act.map(r=> parseEIAPeriod(r.period)).map(d=> d ? `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00` : '');
      const valsAct = act.map(r=> Number(r.value||0));
      const fMap = new Map(fcast.map(r=> [r.period, Number(r.value||0)]));
      const valsFc = act.map(r=> fMap.get(r.period) ?? null);

      demandChart.data.labels = labels;
      demandChart.data.datasets[0].data = valsAct;
      demandChart.data.datasets[1].data = valsFc;
      demandChart.update();

      const last = act[act.length-1];
      $('#kpiDemand').textContent = last? `${fmtNum(last.value)} MW` : '—';
      const lastDt = parseEIAPeriod(last?.period);
      $('#kpiTime').textContent = lastDt ? lastDt.toLocaleString() : '—';

      // Fuel time-series
      const fuelTS = await eiaFetchFuelTimeSeries(key, ba, hours);
      const fuelLabels = fuelTS.times.map(t=> { const d = parseEIAPeriod(t); return d ? `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:00` : ''; });
      fuelTSChart.data.labels = fuelLabels;
      fuelTSChart.data.datasets = FUEL_ORDER
        .filter(f => fuelTS.fuels.includes(f))
        .map(f => ({ label: FUEL_NAMES[f] || f, data: fuelTS.byFuel[f] || [], borderWidth: 1, fill: true, tension: .2 }));
      fuelTSChart.update();

      // Last fuel mix snapshot for cards + revenue split
      const lastIdx = fuelTS.times.length - 1;
      const lastMix = {};
      for (const f of fuelTS.fuels) { lastMix[f] = (fuelTS.byFuel[f] || [])[lastIdx] || 0; }
      window.__lastMix = lastMix;
      renderFuelCards(lastMix, Number(last?.value || 0), Number($('#priceNum').value || 0));

      // Interchange KPI
      const inter = await eiaFetchInterchangeNet(key, ba, hours);
      $('#kpiInterchg').textContent = (inter.net >= 0 ? '+' : '−') + fmtNum(Math.abs(inter.net)) + ' MW';

      // Weather + alerts (location by BA)
      const loc = BA_COORDS[ba] || BA_COORDS.PJM;
      const [wx, alerts] = await Promise.all([
        fetchWeather(loc.lat, loc.lon, hours),
        fetchNOAAAlerts(loc.lat, loc.lon)
      ]);
      renderWeather(wx, loc.place);
      renderAlerts(alerts);

      // Environment: Air quality + Water
      const [aq, water] = await Promise.all([
        fetchAir(loc.lat, loc.lon, hours).catch(() => null),
        fetchUSGSWater(loc.lat, loc.lon, hours).catch(() => null)
      ]);

      if (aq) {
        aqChart.data.labels = aq.labels;
        aqChart.data.datasets[0].data = aq.pm25;
        aqChart.data.datasets[1].data = aq.aqi;
        aqChart.update();
        $('#aqiNow').textContent = aq.aqiNow == null ? '—' : Math.round(aq.aqiNow);
      } else {
        aqChart.data.labels = []; aqChart.data.datasets[0].data = []; aqChart.data.datasets[1].data = []; aqChart.update();
        $('#aqiNow').textContent = '—';
      }

      if (water) {
        waterChart.data.labels = water.labels;
        waterChart.data.datasets[0].data = water.vals;
        waterChart.update();
        $('#usgsStation').textContent = water.site?.name || water.site?.id || 'Unknown';
      } else {
        waterChart.data.labels = []; waterChart.data.datasets[0].data = []; waterChart.update();
        $('#usgsStation').textContent = 'Unavailable';
      }

      // EPA TRI/ECHO (nearby permitted dischargers)
      const triCount = await fetchTRICount(loc.lat, loc.lon, 25);
      $('#echoCount').textContent = triCount == null ? '—' : fmtNum(triCount);

      // Optional DOT transportation noise (JSONP; behind toggle)
      if (store.noise) {
        const dnl = await fetchNoiseDNL(loc.lat, loc.lon).catch(() => null);
        $('#noiseNow').textContent = dnl == null ? '—' : `${Math.round(dnl)} dB DNL`;
      } else {
        $('#noiseNow').textContent = '—';
      }

      // Citizens (county snapshot via FCC + Census ACS)
      try {
        const cty = await fetchCounty(loc.lat, loc.lon);
        const acs = await fetchACS(cty.statefp, cty.countyfp);
        $('#c_county').textContent = acs.name || cty.name || '—';
        $('#c_pop').textContent = fmtNum(acs.pop);
        $('#c_age').textContent = isFinite(+acs.age) ? Number(acs.age).toFixed(1) : '—';
        $('#c_bach').textContent = isFinite(+acs.bach) ? Number(acs.bach).toFixed(1) : '—';
        $('#c_unemp').textContent = isFinite(+acs.unemp) ? Number(acs.unemp).toFixed(1) : '—';
      } catch {
        $('#c_county').textContent = '—';
        $('#c_pop').textContent = '—';
        $('#c_age').textContent = '—';
        $('#c_bach').textContent = '—';
        $('#c_unemp').textContent = '—';
      }

      // Tourism (OSM / Overpass)
      try {
        const t = await fetchTourism(loc.lat, loc.lon);
        $('#t_attract').textContent = fmtNum(t.A);
        $('#t_hotels').textContent  = fmtNum(t.H);
        $('#t_parks').textContent   = fmtNum(t.P);
        $('#t_gate').textContent    = fmtNum(t.G);
        $('#t_score').textContent   = fmtNum(t.score);
        tourChart.data.datasets[0].data = [t.A, t.H, t.P, t.G];
        tourChart.update();
      } catch {
        $('#t_attract').textContent = '—';
        $('#t_hotels').textContent  = '—';
        $('#t_parks').textContent   = '—';
        $('#t_gate').textContent    = '—';
        $('#t_score').textContent   = '—';
        tourChart.data.datasets[0].data = [0,0,0,0];
        tourChart.update();
      }

      // Nudge Chart.js to re-measure after DOM fills in
      requestAnimationFrame(() => {
        demandChart?.resize(); fuelTSChart?.resize(); wxChart?.resize();
        aqChart?.resize(); waterChart?.resize(); tourChart?.resize();
      });

      $('#status').textContent = 'OK';
      updateMoney();
    } catch (e) {
      console.error(e);
      $('#status').textContent = 'Error fetching data (check keys / network)';
    }
  }

  // Hook up UI + auto-load
  document.getElementById('btnLoad').addEventListener('click', () => loadAll());
  const qsKey = new URLSearchParams(location.search).get('eia');
  if (qsKey) { document.getElementById('eiaKey').value = qsKey; store.k = qsKey; }
  window.addEventListener('DOMContentLoaded', () => { if (document.getElementById('eiaKey').value) { loadAll(); } });
</script>
