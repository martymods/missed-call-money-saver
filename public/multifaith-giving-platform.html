<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Multi-Faith Giving Platform</title>
  <meta name="description" content="Give and manage faith-specific donations across every region with a single secure platform."/>
  <style>
    :root {
      --bg: #050918;
      --bg-soft: #0a1124;
      --bg-glass: rgba(255, 255, 255, 0.05);
      --card: rgba(9, 18, 40, 0.82);
      --ink: #f5f7ff;
      --muted: #9ea8d6;
      --accent: #7c4dff;
      --accent-2: #37c79a;
      --accent-3: #4a8bff;
      --danger: #ff5684;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, rgba(76, 71, 143, 0.45), transparent 60%), var(--bg);
      color: var(--ink);
      font: 16px/1.6 "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    img {
      max-width: 100%;
      display: block;
    }

    a {
      color: #cde0ff;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(180deg, rgba(5, 9, 24, 0.92), rgba(5, 9, 24, 0.6));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav {
      max-width: 1160px;
      margin: 0 auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: baseline;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }

    .brand span {
      font-size: 13px;
      color: var(--muted);
    }

    .nav a.btn {
      text-decoration: none;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 18px;
      border-radius: 12px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: 0 16px 40px rgba(76, 71, 143, 0.4);
      cursor: pointer;
    }

    .btn.ghost {
      background: transparent;
      color: #dbe2ff;
      border-color: rgba(255, 255, 255, 0.16);
      box-shadow: none;
    }

    main {
      max-width: 1160px;
      margin: 0 auto;
      padding: 28px 20px 100px;
      display: grid;
      gap: 70px;
    }

    .hero {
      display: grid;
      gap: 24px;
      align-items: center;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(36px, 6vw, 58px);
      line-height: 1.1;
      font-weight: 900;
      letter-spacing: -0.5px;
    }

    .hero p {
      margin: 14px 0 26px;
      color: var(--muted);
      font-size: 18px;
      max-width: 580px;
    }

    .hero-media {
      position: relative;
      border-radius: 30px;
      overflow: hidden;
      background: var(--card);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
      min-height: 260px;
    }

    .hero-media:before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(124, 77, 255, 0.32), transparent 50%);
      pointer-events: none;
    }

    .hero-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 12px;
    }

    .hero-list li {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 14px 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-weight: 600;
      color: #e9edff;
    }

    .hero-list li span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: rgba(124, 77, 255, 0.2);
      color: #fff;
      font-weight: 700;
    }

    section h2 {
      margin: 0 0 18px;
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 900;
      letter-spacing: -0.3px;
    }

    section p.lead {
      margin: 0 0 24px;
      color: var(--muted);
      max-width: 720px;
      font-size: 17px;
    }

    .region-slider {
      position: relative;
      background: var(--bg-soft);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.45);
    }

    .region-track {
      display: flex;
      transition: transform 0.6s ease;
      width: 100%;
    }

    .region-slide {
      min-width: 100%;
      padding: 26px;
      display: grid;
      gap: 22px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: center;
    }

    .region-slide img {
      width: 100%;
      height: 260px;
      object-fit: cover;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.38);
    }

    .region-meta h3 {
      margin: 0;
      font-size: 26px;
      font-weight: 800;
    }

    .region-meta ul {
      margin: 16px 0 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 10px;
    }

    .region-meta ul li {
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 14px;
      color: #d9e3ff;
    }

    .slider-controls {
      position: absolute;
      inset: auto 0 14px 0;
      display: flex;
      justify-content: space-between;
      padding: 0 22px;
      pointer-events: none;
    }

    .slider-btn {
      pointer-events: all;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(9, 18, 40, 0.78);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    .slider-dots {
      position: absolute;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      display: inline-flex;
      gap: 10px;
    }

    .slider-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.22);
      cursor: pointer;
    }

    .slider-dot.active {
      background: var(--accent-2);
    }

    .sector-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .sector-card {
      background: var(--card);
      padding: 20px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: grid;
      gap: 10px;
      box-shadow: 0 18px 44px rgba(0, 0, 0, 0.35);
    }

    .sector-card h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      color: #f1f4ff;
    }

    .sector-card p {
      margin: 0;
      color: #bac3ec;
      font-size: 14px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .form-card {
      background: linear-gradient(180deg, rgba(124, 77, 255, 0.18), rgba(9, 18, 40, 0.94));
      border-radius: 24px;
      border: 1px solid rgba(124, 77, 255, 0.32);
      padding: 26px;
      box-shadow: 0 24px 58px rgba(0, 0, 0, 0.42);
    }

    .form-card h3 {
      margin: 0 0 14px;
      font-size: 22px;
      font-weight: 800;
    }

    .form-row {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 720px) {
      .form-row.double {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .form-row.triple {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    label {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      color: #dce3ff;
    }

    input, select, textarea {
      margin-top: 6px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(5, 10, 25, 0.86);
      color: #f6f9ff;
      padding: 12px;
      font-size: 15px;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid rgba(124, 77, 255, 0.6);
      outline-offset: 1px;
    }

    .status {
      border-radius: 16px;
      padding: 14px 16px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: #dde5ff;
    }

    .status.success {
      background: rgba(55, 199, 154, 0.22);
      border-color: rgba(55, 199, 154, 0.6);
      color: #ecfff7;
    }

    .status.error {
      background: rgba(255, 86, 132, 0.22);
      border-color: rgba(255, 86, 132, 0.55);
      color: #ffe9f0;
    }

    .status a {
      color: #fff;
      word-break: break-all;
    }

    .inline-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .inline-actions .btn {
      flex: none;
    }

    footer {
      margin-top: 60px;
      padding: 40px 0 60px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .result-block {
      margin-top: 12px;
      padding: 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: grid;
      gap: 8px;
    }

    .result-block pre {
      margin: 0;
      font-family: "JetBrains Mono", Consolas, monospace;
      font-size: 12px;
      color: #d2dbff;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .empty-note {
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 640px) {
      .hero-media {
        min-height: 200px;
      }

      .region-slide {
        padding: 20px;
      }

      .slider-controls {
        display: none;
      }
    }
  </style>
</head>
<body>
<header>
  <nav class="nav">
    <div class="brand">
      <strong>Orbital Collective</strong>
      <span>Multi-faith giving platform</span>
    </div>
    <div class="inline-actions">
      <a class="btn ghost" href="#regions">Explore regions</a>
      <a class="btn" href="#give">Start giving</a>
    </div>
  </nav>
</header>

<main>
  <section class="hero">
    <div>
      <h1>One place to give, across every faith community.</h1>
      <p>Launch fully-configured donation flows for churches, mosques, synagogues, temples, and sanghas in minutes. No waiting for a build plan—connect your organizations, publish campaigns, and accept gifts right now.</p>
      <div class="inline-actions">
        <a class="btn" href="#give">Create a donation</a>
        <a class="btn ghost" href="#manage">Manage organizations</a>
      </div>
    </div>
    <div class="hero-media">
      <ul class="hero-list">
        <li><span>1</span> Multi-region currency, tax, and receipt language out of the box.</li>
        <li><span>2</span> Faith-specific donation types with calculators and metadata.</li>
        <li><span>3</span> Instant Stripe Payment Links you can share the moment you hit submit.</li>
      </ul>
    </div>
  </section>

  <section id="regions">
    <h2>Regional gallery</h2>
    <p class="lead">Preview the localized experience for every launch territory. Each slide shows live copy, receipt preferences, and sector highlights donors will see.</p>
    <div class="region-slider">
      <div class="region-track" id="region-track"></div>
      <div class="slider-controls">
        <button class="slider-btn" id="prev-slide" type="button" aria-label="Previous region">‹</button>
        <button class="slider-btn" id="next-slide" type="button" aria-label="Next region">›</button>
      </div>
      <div class="slider-dots" id="slider-dots"></div>
    </div>
  </section>

  <section id="sectors">
    <h2>Sectors we fund together</h2>
    <p class="lead">Pair every gift with a sector so donors understand the impact: community relief, education, food security, and more. Sectors appear on receipts and in compliance exports automatically.</p>
    <div class="sector-grid" id="sector-grid"></div>
  </section>

  <section id="give">
    <h2>Give right now</h2>
    <p class="lead">Use the form below to choose a faith tradition, region, campaign, and sector. Submit to mint a secure Stripe checkout link instantly.</p>
    <div class="form-card">
      <h3>Donation builder</h3>
      <form id="donation-form">
        <div class="form-row double">
          <label>Region
            <select id="donation-region" required></select>
          </label>
          <label>Faith tradition
            <select id="donation-faith" required></select>
          </label>
        </div>
        <div class="form-row double">
          <label>Organization
            <select id="donation-org" required></select>
          </label>
          <label>Campaign
            <select id="donation-campaign" required></select>
          </label>
        </div>
        <div class="form-row double">
          <label>Sector / Fund focus
            <select id="donation-sector" required></select>
          </label>
          <label>Donation type
            <select id="donation-type" required></select>
          </label>
        </div>
        <div class="form-row triple">
          <label>Amount (local currency)
            <input id="donation-amount" type="number" min="1" step="1" placeholder="50" required/>
          </label>
          <label>Frequency
            <select id="donation-frequency" required>
              <option value="one_time">One-time</option>
              <option value="week">Weekly</option>
              <option value="month" selected>Monthly</option>
              <option value="year">Annual</option>
            </select>
          </label>
          <label>Promo codes allowed?
            <select id="donation-promo" required>
              <option value="true" selected>Yes</option>
              <option value="false">No</option>
            </select>
          </label>
        </div>
        <div class="form-row double">
          <label>Donor name
            <input id="donation-name" type="text" placeholder="Jordan Malik" required/>
          </label>
          <label>Email for receipt
            <input id="donation-email" type="email" placeholder="jordan@example.org" required/>
          </label>
        </div>
        <div class="form-row">
          <label>Notes for receipt (optional)
            <textarea id="donation-notes" placeholder="Dedicate this gift to..."></textarea>
          </label>
        </div>
        <button class="btn" type="submit">Generate secure checkout</button>
      </form>
      <div class="status" id="donation-status" hidden></div>
      <div class="result-block" id="donation-result" hidden>
        <strong>Payment link</strong>
        <a id="donation-link" href="#" target="_blank" rel="noreferrer"></a>
        <pre id="donation-meta"></pre>
      </div>
      <div class="empty-note" id="org-empty" hidden>No organizations found yet. Add one below to start collecting gifts.</div>
    </div>
  </section>

  <section id="manage">
    <h2>Organization &amp; campaign management</h2>
    <p class="lead">Connect as many communities as you need. As soon as you save an organization and campaign, they are available in the donation builder.</p>
    <div class="form-card">
      <h3>Add an organization</h3>
      <form id="setup-org-form">
        <div class="form-row double">
          <label>Organization name
            <input id="setup-org-name" type="text" placeholder="Bethany Center" required/>
          </label>
          <label>Region
            <select id="setup-org-region" required></select>
          </label>
        </div>
        <div class="form-row double">
          <label>Faith tradition
            <select id="setup-org-faith" required></select>
          </label>
          <label>Locales (comma separated)
            <input id="setup-org-locales" type="text" placeholder="en-US, es-US"/>
          </label>
        </div>
        <div class="form-row double">
          <label>Timezone
            <input id="setup-org-timezone" type="text" placeholder="America/New_York"/>
          </label>
          <label>Stripe Account ID (optional)
            <input id="setup-org-stripe" type="text" placeholder="acct_123"/>
          </label>
        </div>
        <button class="btn" type="submit">Save organization</button>
      </form>
      <div class="status" id="setup-org-status" hidden></div>
    </div>
    <div class="form-card">
      <h3>Add a campaign</h3>
      <form id="setup-campaign-form">
        <div class="form-row double">
          <label>Organization
            <select id="setup-campaign-org" required></select>
          </label>
          <label>Campaign name
            <input id="setup-campaign-name" type="text" placeholder="Community Relief" required/>
          </label>
        </div>
        <div class="form-row double">
          <label>Campaign code (optional)
            <input id="setup-campaign-code" type="text" placeholder="community_relief"/>
          </label>
          <label>Donation types (comma separated)
            <input id="setup-campaign-types" type="text" placeholder="tithe, zakat, dana"/>
          </label>
        </div>
        <button class="btn" type="submit">Save campaign</button>
      </form>
      <div class="status" id="setup-campaign-status" hidden></div>
    </div>
  </section>
</main>

<footer>
  © <span id="year"></span> Orbital Collective. Multi-faith donations, ready the moment you sign in.
</footer>

<script>
  const SLIDES = [
    {
      id: 'NA',
      name: 'North America',
      image: 'religion/christianity5.jpg',
      copy: 'US and Canada support ACH, cards, Apple Pay, and bilingual receipts with IRS and CRA-compliant summaries.',
      sectors: ['Community relief & shelters', 'Food security networks', 'Youth programming', 'Capital campaigns'],
      currencies: 'USD · CAD'
    },
    {
      id: 'EU',
      name: 'Europe',
      image: 'religion/judaism2.jpg',
      copy: 'Localized SEPA payments with automatic Gift Aid statements and multilingual GDPR consent flows.',
      sectors: ['Refugee welcome centers', 'Cultural preservation', 'Winter energy assistance', 'Education bursaries'],
      currencies: 'EUR · GBP · SEK'
    },
    {
      id: 'MENA',
      name: 'Middle East & North Africa',
      image: 'religion/islam5.jpg',
      copy: 'Arabic-first experiences with Ramadan scheduling, zakat calculators, and regional banking partners.',
      sectors: ['Ramadan food parcels', 'Water & sanitation', 'Scholarships for girls', 'Mosque restoration'],
      currencies: 'AED · SAR · EGP'
    },
    {
      id: 'SA',
      name: 'South Asia',
      image: 'religion/hinduism4.jpg',
      copy: 'Handle INR, LKR, and NPR gifts with PAN capture, festival campaign presets, and WhatsApp confirmations.',
      sectors: ['Disaster recovery', 'Temple seva programs', 'Health outreach', 'Education for children'],
      currencies: 'INR · LKR · NPR'
    },
    {
      id: 'APAC',
      name: 'Asia Pacific',
      image: 'religion/buddhism3.jpg',
      copy: 'From Singapore to Sydney: cards, BECS, and PayNow support with retreat management baked in.',
      sectors: ['Retreat scholarships', 'Environmental care', 'Elder support services', 'Community kitchens'],
      currencies: 'AUD · SGD · NZD'
    }
  ];

  const SECTORS = [
    { value: 'relief', title: 'Community Relief', desc: 'Rapid response funds for housing, energy, and crisis needs.' },
    { value: 'education', title: 'Education', desc: 'Scholarships, after-school programs, and language classes.' },
    { value: 'health', title: 'Health & Wellness', desc: 'Clinics, counseling, and elder care tailored to each faith.' },
    { value: 'food', title: 'Food Security', desc: 'Food banks, Ramadan baskets, langar kitchens, and pantry drives.' },
    { value: 'youth', title: 'Youth & Families', desc: 'Child check-in, camps, and youth mentorship funding.' },
    { value: 'capital', title: 'Facilities & Capital', desc: 'Building restoration, accessibility upgrades, and mortgages.' }
  ];

  const DEFAULT_ORGS = [
    {
      _id: 'org_dreamworld',
      name: 'Dreamworld',
      region: 'APAC',
      religion: 'buddhist',
      locales: ['en-SG', 'zh-SG'],
      timezone: 'Asia/Singapore'
    },
    {
      _id: 'org_one_brain_world',
      name: 'One Brain World',
      region: 'NA',
      religion: 'christian',
      locales: ['en-US', 'es-US'],
      timezone: 'America/Los_Angeles'
    },
    {
      _id: 'org_new_bright_water',
      name: 'New Bright Water',
      region: 'MENA',
      religion: 'islam',
      locales: ['en-AE', 'ar-AE'],
      timezone: 'Asia/Dubai'
    }
  ];

  const DEFAULT_CAMPAIGNS = new Map([
    ['org_dreamworld', [
      {
        _id: 'camp_dreamworld_retreat',
        orgId: 'org_dreamworld',
        name: 'Retreat Scholarships · Education Fund',
        sectorFocus: 'education',
        donationTypes: ['dana', 'retreat']
      },
      {
        _id: 'camp_dreamworld_environment',
        orgId: 'org_dreamworld',
        name: 'Environmental Care · Health & Wellness',
        sectorFocus: 'health',
        donationTypes: ['dana']
      },
      {
        _id: 'camp_dreamworld_kitchens',
        orgId: 'org_dreamworld',
        name: 'Community Kitchens · Food Security',
        sectorFocus: 'food',
        donationTypes: ['dana']
      }
    ]],
    ['org_one_brain_world', [
      {
        _id: 'camp_one_brain_relief',
        orgId: 'org_one_brain_world',
        name: 'Community Relief · Neighbor Support',
        sectorFocus: 'relief',
        donationTypes: ['tithe', 'offering']
      },
      {
        _id: 'camp_one_brain_youth',
        orgId: 'org_one_brain_world',
        name: 'Youth & Families · Mentorship Fund',
        sectorFocus: 'youth',
        donationTypes: ['pledge', 'offering']
      },
      {
        _id: 'camp_one_brain_capital',
        orgId: 'org_one_brain_world',
        name: 'Facilities & Capital · Renewal Campaign',
        sectorFocus: 'capital',
        donationTypes: ['pledge']
      }
    ]],
    ['org_new_bright_water', [
      {
        _id: 'camp_new_bright_relief',
        orgId: 'org_new_bright_water',
        name: 'Ramadan Food Parcels · Food Security',
        sectorFocus: 'food',
        donationTypes: ['zakat', 'sadaqah']
      },
      {
        _id: 'camp_new_bright_scholarship',
        orgId: 'org_new_bright_water',
        name: 'Scholarships for Girls · Education Access',
        sectorFocus: 'education',
        donationTypes: ['zakat']
      },
      {
        _id: 'camp_new_bright_restoration',
        orgId: 'org_new_bright_water',
        name: 'Mosque Restoration · Facilities & Capital',
        sectorFocus: 'capital',
        donationTypes: ['zakat', 'sadaqah']
      }
    ]]
  ]);

  const FAITH_TYPES = {
    christian: ['tithe', 'offering', 'pledge', 'mission'],
    islam: ['zakat', 'sadaqah', 'fidya', 'zakat-al-fitr'],
    hindu: ['daan', 'dakshina', 'seva'],
    buddhist: ['dana', 'retreat', 'merit'],
    jewish: ['tzedakah', 'maaser', 'aliyah', 'yahrzeit']
  };

  const FAITH_OPTIONS = [
    { value: 'christian', label: 'Christianity' },
    { value: 'islam', label: 'Islam' },
    { value: 'hindu', label: 'Hinduism' },
    { value: 'buddhist', label: 'Buddhism' },
    { value: 'jewish', label: 'Judaism' }
  ];

  const state = {
    orgs: [],
    campaignsByOrg: new Map(),
    campaignFetchAttempts: new Set(),
    slideIndex: 0,
    autoTimer: null
  };

  const SECTOR_TITLE_LOOKUP = new Map(SECTORS.map(sector => [sector.value, sector.title]));

  const els = {
    regionTrack: document.getElementById('region-track'),
    sliderDots: document.getElementById('slider-dots'),
    prevSlide: document.getElementById('prev-slide'),
    nextSlide: document.getElementById('next-slide'),
    sectorGrid: document.getElementById('sector-grid'),
    donationForm: document.getElementById('donation-form'),
    donationRegion: document.getElementById('donation-region'),
    donationFaith: document.getElementById('donation-faith'),
    donationOrg: document.getElementById('donation-org'),
    donationCampaign: document.getElementById('donation-campaign'),
    donationSector: document.getElementById('donation-sector'),
    donationType: document.getElementById('donation-type'),
    donationAmount: document.getElementById('donation-amount'),
    donationFrequency: document.getElementById('donation-frequency'),
    donationPromo: document.getElementById('donation-promo'),
    donationName: document.getElementById('donation-name'),
    donationEmail: document.getElementById('donation-email'),
    donationNotes: document.getElementById('donation-notes'),
    donationStatus: document.getElementById('donation-status'),
    donationResult: document.getElementById('donation-result'),
    donationLink: document.getElementById('donation-link'),
    donationMeta: document.getElementById('donation-meta'),
    orgEmpty: document.getElementById('org-empty'),
    setupOrgForm: document.getElementById('setup-org-form'),
    setupOrgStatus: document.getElementById('setup-org-status'),
    setupOrgName: document.getElementById('setup-org-name'),
    setupOrgRegion: document.getElementById('setup-org-region'),
    setupOrgFaith: document.getElementById('setup-org-faith'),
    setupOrgLocales: document.getElementById('setup-org-locales'),
    setupOrgTimezone: document.getElementById('setup-org-timezone'),
    setupOrgStripe: document.getElementById('setup-org-stripe'),
    setupCampaignForm: document.getElementById('setup-campaign-form'),
    setupCampaignStatus: document.getElementById('setup-campaign-status'),
    setupCampaignOrg: document.getElementById('setup-campaign-org'),
    setupCampaignName: document.getElementById('setup-campaign-name'),
    setupCampaignCode: document.getElementById('setup-campaign-code'),
    setupCampaignTypes: document.getElementById('setup-campaign-types')
  };

  function setStatus(el, message, type = 'info') {
    if (!el) return;
    el.hidden = false;
    el.textContent = message;
    el.classList.remove('success', 'error');
    if (type === 'success') el.classList.add('success');
    if (type === 'error') el.classList.add('error');
  }

  function clearStatus(el) {
    if (!el) return;
    el.hidden = true;
    el.textContent = '';
    el.classList.remove('success', 'error');
  }

  function option(label, value) {
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = label;
    return opt;
  }

  function renderSlides() {
    els.regionTrack.innerHTML = '';
    els.sliderDots.innerHTML = '';
    SLIDES.forEach((slide, index) => {
      const slideEl = document.createElement('article');
      slideEl.className = 'region-slide';
      slideEl.dataset.index = index;
      slideEl.innerHTML = `
        <img src="${slide.image}" alt="${slide.name} faith communities" loading="lazy"/>
        <div class="region-meta">
          <h3>${slide.name}</h3>
          <p>${slide.copy}</p>
          <p><strong>Currencies:</strong> ${slide.currencies}</p>
          <ul>
            ${slide.sectors.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
      `;
      els.regionTrack.appendChild(slideEl);

      const dot = document.createElement('div');
      dot.className = 'slider-dot';
      dot.dataset.index = index;
      dot.addEventListener('click', () => showSlide(index, true));
      els.sliderDots.appendChild(dot);
    });
    showSlide(0, true);
  }

  function showSlide(index, manual = false) {
    state.slideIndex = (index + SLIDES.length) % SLIDES.length;
    const offset = -state.slideIndex * 100;
    els.regionTrack.style.transform = `translateX(${offset}%)`;
    Array.from(els.sliderDots.children).forEach((dot, idx) => {
      dot.classList.toggle('active', idx === state.slideIndex);
    });
    if (manual) {
      resetAutoSlide();
    }
  }

  function nextSlide() {
    showSlide(state.slideIndex + 1);
  }

  function prevSlide() {
    showSlide(state.slideIndex - 1, true);
  }

  function resetAutoSlide() {
    if (state.autoTimer) {
      clearInterval(state.autoTimer);
    }
    state.autoTimer = setInterval(nextSlide, 8000);
  }

  function renderSectors() {
    els.sectorGrid.innerHTML = '';
    SECTORS.forEach(sector => {
      const card = document.createElement('article');
      card.className = 'sector-card';
      card.innerHTML = `<h3>${sector.title}</h3><p>${sector.desc}</p>`;
      els.sectorGrid.appendChild(card);
    });
  }

  function populateSelect(select, values, placeholder) {
    if (!select) return;
    const current = select.value;
    select.innerHTML = '';
    if (placeholder) {
      const opt = option(placeholder, '');
      opt.disabled = true;
      opt.selected = true;
      select.appendChild(opt);
    }
    values.forEach(item => {
      if (typeof item === 'string') {
        select.appendChild(option(item, item));
      } else if (item && typeof item === 'object') {
        const opt = option(item.label ?? item.name ?? item.value, item.value ?? item._id);
        if (item._id) {
          opt.dataset.json = JSON.stringify(item);
        }
        select.appendChild(opt);
      }
    });
    if (current && Array.from(select.options).some(o => o.value === current)) {
      select.value = current;
    }
  }

  function cloneDefaultCampaigns(list) {
    return list.map(campaign => ({
      ...campaign,
      donationTypes: Array.isArray(campaign.donationTypes) ? [...campaign.donationTypes] : undefined
    }));
  }

  function ensureDefaultOrganizations() {
    const seen = new Set(state.orgs.map(org => (org && (org._id ? `id:${org._id}` : `name:${(org.name || '').toLowerCase()}:${org.region || ''}`))));
    DEFAULT_ORGS.forEach(org => {
      const key = org._id ? `id:${org._id}` : `name:${(org.name || '').toLowerCase()}:${org.region || ''}`;
      if (!seen.has(key)) {
        state.orgs.push({
          ...org,
          locales: Array.isArray(org.locales) ? [...org.locales] : []
        });
        seen.add(key);
      }
      if (org._id && DEFAULT_CAMPAIGNS.has(org._id) && !state.campaignsByOrg.has(org._id)) {
        state.campaignsByOrg.set(org._id, cloneDefaultCampaigns(DEFAULT_CAMPAIGNS.get(org._id)));
      }
    });
  }

  function populateFaithSelects() {
    populateSelect(els.donationFaith, FAITH_OPTIONS.map(f => ({ label: f.label, value: f.value })), 'Choose a faith');
    populateSelect(els.setupOrgFaith, FAITH_OPTIONS.map(f => ({ label: f.label, value: f.value })), 'Choose a faith');
  }

  function populateRegionSelects() {
    const regions = SLIDES.map(slide => ({ label: `${slide.name}`, value: slide.id }));
    populateSelect(els.donationRegion, regions, 'Choose a region');
    populateSelect(els.setupOrgRegion, regions, 'Choose a region');
  }

  function populateSectorSelects() {
    populateSelect(els.donationSector, SECTORS.map(s => ({ label: s.title, value: s.value })), 'Select a sector');
  }

  function setDonationTypeOptions(religion) {
    const values = FAITH_TYPES[religion] ?? [];
    const items = values.length ? values : ['general'];
    populateSelect(els.donationType, items.map(v => ({ label: v.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()), value: v })), 'Select donation type');
  }

  function updateOrgOptions() {
    const region = els.donationRegion.value;
    const faith = els.donationFaith.value;
    const list = state.orgs.filter(org => {
      const regionMatch = !region || org.region === region;
      const faithMatch = !faith || org.religion === faith;
      return regionMatch && faithMatch;
    });
    populateSelect(els.donationOrg, list.map(org => ({ ...org, label: `${org.name} · ${org.region}/${org.religion}`, value: org._id })), 'Choose an organization');
    populateSelect(els.setupCampaignOrg, state.orgs.map(org => ({ ...org, label: `${org.name} (${org.region})`, value: org._id })), 'Choose an organization');
    els.orgEmpty.hidden = list.length > 0 || state.orgs.length === 0;
  }

  function updateCampaignOptions(orgId) {
    const campaigns = state.campaignsByOrg.get(orgId) ?? [];
    populateSelect(
      els.donationCampaign,
      campaigns.map(campaign => ({
        ...campaign,
        label: campaign.sectorFocus
          ? `${campaign.name} (${SECTOR_TITLE_LOOKUP.get(campaign.sectorFocus) || campaign.sectorFocus})`
          : campaign.name,
        value: campaign._id
      })),
      'Choose a campaign'
    );
  }

  function hydrateDonationTypesFromCampaign(campaign) {
    if (!campaign) return;
    const donationTypes = Array.isArray(campaign.donationTypes) && campaign.donationTypes.length ? campaign.donationTypes : undefined;
    if (donationTypes) {
      populateSelect(els.donationType, donationTypes.map(v => ({ label: v.replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase()), value: v })), 'Select donation type');
    }
    if (campaign.sectorFocus) {
      const hasSectorOption = Array.from(els.donationSector.options).some(opt => opt.value === campaign.sectorFocus);
      if (hasSectorOption) {
        els.donationSector.value = campaign.sectorFocus;
      }
    }
  }

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) {
      throw new Error(res.statusText || 'Request failed');
    }
    return res.json();
  }

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || res.statusText || 'Request failed');
    }
    return res.json();
  }

  async function loadOrganizations() {
    try {
      const data = await fetchJSON('/api/giving/organizations');
      const orgs = Array.isArray(data) ? data : data.organizations ?? data.data ?? [];
      if (Array.isArray(orgs)) {
        state.orgs = orgs.slice();
      }
    } catch (err) {
      console.warn('Unable to load organizations', err);
      state.orgs = [];
    }
    ensureDefaultOrganizations();
    updateOrgOptions();
  }

  async function loadCampaigns(orgId) {
    if (!orgId) return;
    if (!state.campaignsByOrg.has(orgId) && DEFAULT_CAMPAIGNS.has(orgId)) {
      state.campaignsByOrg.set(orgId, cloneDefaultCampaigns(DEFAULT_CAMPAIGNS.get(orgId)));
    }
    if (state.campaignFetchAttempts.has(orgId)) return;
    state.campaignFetchAttempts.add(orgId);
    try {
      const data = await fetchJSON(`/api/giving/campaigns?orgId=${encodeURIComponent(orgId)}`);
      const campaigns = Array.isArray(data) ? data : data.campaigns ?? data.data ?? [];
      if (Array.isArray(campaigns)) {
        state.campaignsByOrg.set(orgId, campaigns);
      }
    } catch (err) {
      console.warn('Unable to load campaigns', err);
      if (!state.campaignsByOrg.has(orgId) || !state.campaignsByOrg.get(orgId)?.length) {
        state.campaignsByOrg.set(orgId, cloneDefaultCampaigns(DEFAULT_CAMPAIGNS.get(orgId) ?? []));
      }
    }
  }

  function handleOrgSelection() {
    const select = els.donationOrg;
    const option = select.options[select.selectedIndex];
    if (option?.dataset?.json) {
      try {
        const org = JSON.parse(option.dataset.json);
        if (org.region) {
          els.donationRegion.value = org.region;
        }
        if (org.religion) {
          els.donationFaith.value = org.religion;
          setDonationTypeOptions(org.religion);
        }
      } catch (err) {
        console.warn('Unable to parse organization option', err);
      }
    }
  }

  function extractCampaignFromSelect() {
    const select = els.donationCampaign;
    const option = select.options[select.selectedIndex];
    if (option?.dataset?.json) {
      try {
        return JSON.parse(option.dataset.json);
      } catch (err) {
        console.warn('Unable to parse campaign option', err);
      }
    }
    return null;
  }

  function prepareDonationPayload() {
    const orgId = els.donationOrg.value;
    const campaignId = els.donationCampaign.value;
    if (!orgId || !campaignId) {
      throw new Error('Select an organization and campaign.');
    }
    const frequency = els.donationFrequency.value;
    const interval = frequency === 'one_time' ? undefined : frequency;
    const amount = Number(els.donationAmount.value);
    if (!amount || Number.isNaN(amount)) {
      throw new Error('Enter a donation amount.');
    }
    const payload = {
      orgId,
      campaignId,
      region: els.donationRegion.value,
      religion: els.donationFaith.value,
      donationType: els.donationType.value,
      sector: els.donationSector.value,
      amount,
      interval,
      allowPromo: els.donationPromo.value === 'true',
      donor: {
        name: els.donationName.value,
        email: els.donationEmail.value,
        notes: els.donationNotes.value.trim() || undefined
      }
    };
    return payload;
  }

  function attachEvents() {
    els.prevSlide.addEventListener('click', () => prevSlide());
    els.nextSlide.addEventListener('click', () => { showSlide(state.slideIndex + 1, true); });
    resetAutoSlide();

    els.donationFaith.addEventListener('change', () => {
      setDonationTypeOptions(els.donationFaith.value);
      updateOrgOptions();
    });
    els.donationRegion.addEventListener('change', () => {
      updateOrgOptions();
    });
    els.donationOrg.addEventListener('change', async () => {
      handleOrgSelection();
      const orgId = els.donationOrg.value;
      await loadCampaigns(orgId);
      updateCampaignOptions(orgId);
    });
    els.donationCampaign.addEventListener('change', () => {
      const campaign = extractCampaignFromSelect();
      hydrateDonationTypesFromCampaign(campaign);
    });

    els.donationForm.addEventListener('submit', async event => {
      event.preventDefault();
      clearStatus(els.donationStatus);
      els.donationResult.hidden = true;
      try {
        const payload = prepareDonationPayload();
        setStatus(els.donationStatus, 'Generating Stripe checkout…');
        const data = await postJSON('/api/giving/payment-link', payload);
        const url = data?.url;
        if (!url) {
          throw new Error('Payment link not returned.');
        }
        setStatus(els.donationStatus, 'Payment link ready!', 'success');
        els.donationLink.href = url;
        els.donationLink.textContent = url;
        els.donationMeta.textContent = JSON.stringify(data.meta ?? payload, null, 2);
        els.donationResult.hidden = false;
        try {
          window.open(url, '_blank', 'noopener');
        } catch (err) {
          console.warn('Popup blocked', err);
        }
      } catch (err) {
        setStatus(els.donationStatus, err.message || 'Unable to generate payment link', 'error');
      }
    });

    els.setupOrgForm.addEventListener('submit', async event => {
      event.preventDefault();
      clearStatus(els.setupOrgStatus);
      try {
        const payload = {
          name: els.setupOrgName.value,
          region: els.setupOrgRegion.value,
          religion: els.setupOrgFaith.value,
          locales: els.setupOrgLocales.value.split(',').map(x => x.trim()).filter(Boolean),
          timezone: els.setupOrgTimezone.value || undefined,
          stripeAccountId: els.setupOrgStripe.value || undefined
        };
        setStatus(els.setupOrgStatus, 'Saving organization…');
        const data = await postJSON('/api/giving/organizations', payload);
        const org = data?.organization ?? data;
        if (!org?._id) {
          throw new Error('Organization was not returned.');
        }
        state.orgs.push(org);
        updateOrgOptions();
        setStatus(els.setupOrgStatus, `${org.name} is ready for donations.`, 'success');
        els.setupOrgForm.reset();
      } catch (err) {
        setStatus(els.setupOrgStatus, err.message || 'Unable to save organization', 'error');
      }
    });

    els.setupCampaignForm.addEventListener('submit', async event => {
      event.preventDefault();
      clearStatus(els.setupCampaignStatus);
      try {
        const orgId = els.setupCampaignOrg.value;
        if (!orgId) {
          throw new Error('Select an organization first.');
        }
        const donationTypes = els.setupCampaignTypes.value.split(',').map(x => x.trim()).filter(Boolean);
        const payload = {
          orgId,
          name: els.setupCampaignName.value,
          code: els.setupCampaignCode.value || undefined,
          donationTypes: donationTypes.length ? donationTypes : undefined
        };
        setStatus(els.setupCampaignStatus, 'Saving campaign…');
        const data = await postJSON('/api/giving/campaigns', payload);
        const campaign = data?.campaign ?? data;
        if (!campaign?._id) {
          throw new Error('Campaign was not returned.');
        }
        const list = state.campaignsByOrg.get(orgId) ?? [];
        list.push(campaign);
        state.campaignsByOrg.set(orgId, list);
        updateCampaignOptions(orgId);
        setStatus(els.setupCampaignStatus, `${campaign.name} is ready for donors.`, 'success');
        els.setupCampaignForm.reset();
      } catch (err) {
        setStatus(els.setupCampaignStatus, err.message || 'Unable to save campaign', 'error');
      }
    });
  }

  function init() {
    renderSlides();
    renderSectors();
    populateRegionSelects();
    populateFaithSelects();
    populateSectorSelects();
    setDonationTypeOptions(els.donationFaith.value);
    attachEvents();
    ensureDefaultOrganizations();
    updateOrgOptions();
    loadOrganizations();
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  init();
</script>
</body>
</html>
