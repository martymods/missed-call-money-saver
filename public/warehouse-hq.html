<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Warehouse HQ – Logistics Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --bg-panel: rgba(15, 23, 42, 0.85);
      --bg-panel-light: rgba(248, 250, 252, 0.9);
      --bg-surface: rgba(15, 23, 42, 0.95);
      --bg-surface-light: rgba(255, 255, 255, 0.95);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --accent-strong: rgba(56, 189, 248, 0.35);
      --border: rgba(148, 163, 184, 0.2);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --danger: #f87171;
      --success: #4ade80;
      --warning: #facc15;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at center, rgba(14, 116, 144, 0.1), transparent 65%),
        radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.12), transparent 70%),
        #020617;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 60;
      backdrop-filter: blur(16px);
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.8));
      border-bottom: 1px solid var(--border);
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem;
    }

    h1 {
      font-size: clamp(1.75rem, 2.2vw, 2.5rem);
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    h2 {
      margin: 1.5rem 0 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
    }

    p {
      color: var(--text-muted);
    }

    nav {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    nav button {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, border 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    nav button:hover,
    nav button.active {
      background: var(--accent-strong);
      border-color: rgba(56, 189, 248, 0.6);
      transform: translateY(-1px);
    }

    .global-freight {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .global-freight-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .global-freight-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 1.25rem;
    }

    .global-map-shell {
      position: relative;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      overflow: hidden;
      min-height: 380px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.32);
    }

    #global-map {
      width: 100%;
      height: 100%;
      min-height: 380px;
    }

    .global-map-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.05), transparent 35%, rgba(15, 23, 42, 0.25));
    }

    .leaflet-control-attribution {
      background: rgba(15, 23, 42, 0.6) !important;
      color: var(--text-muted) !important;
      font-size: 0.68rem !important;
      border-radius: 0.5rem !important;
      padding: 0.15rem 0.45rem !important;
    }

    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.4) !important;
      border-radius: 0.75rem !important;
      overflow: hidden !important;
    }

    .global-map-legend {
      position: absolute;
      bottom: 0.85rem;
      left: 0.85rem;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
      background: rgba(2, 6, 23, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 0.75rem;
      padding: 0.6rem 0.75rem;
      backdrop-filter: blur(6px);
    }

    .global-map-legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.78rem;
      color: var(--text);
    }

    .legend-key {
      width: 1.5rem;
      height: 0.35rem;
      border-radius: 999px;
      display: inline-block;
    }

    .legend-key.sea { background: rgba(56, 189, 248, 0.85); }
    .legend-key.air { background: rgba(251, 191, 36, 0.9); }
    .legend-key.rail { background: rgba(168, 85, 247, 0.85); }
    .legend-key.truck { background: rgba(249, 115, 22, 0.9); }

    .global-activity-panel {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1.25rem;
      padding: 1.25rem;
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.28);
    }

    .global-activity-head {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .global-activity {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .global-activity li {
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 1rem;
      padding: 0.85rem 1rem;
      background: rgba(15, 23, 42, 0.55);
      transition: border 0.2s ease, transform 0.2s ease, background 0.2s ease;
    }

    .global-activity li[data-mode="sea"] { border-color: rgba(56, 189, 248, 0.45); }
    .global-activity li[data-mode="air"] { border-color: rgba(251, 191, 36, 0.45); }
    .global-activity li[data-mode="rail"] { border-color: rgba(168, 85, 247, 0.45); }
    .global-activity li[data-mode="truck"] { border-color: rgba(249, 115, 22, 0.45); }

    .global-activity li:hover {
      transform: translateY(-2px);
      background: rgba(148, 163, 184, 0.12);
    }

    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.92rem;
    }

    .activity-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.4rem 0.75rem;
      margin-top: 0.4rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .activity-status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: var(--text);
    }

    .badge-mode {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.25rem 0.65rem;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(148, 163, 184, 0.18);
      color: var(--text);
    }

    .badge-mode::before {
      content: '';
      display: inline-block;
      width: 0.55rem;
      height: 0.55rem;
      border-radius: 50%;
      background: currentColor;
    }

    .badge-mode[data-mode="sea"] { color: rgba(56, 189, 248, 0.95); }
    .badge-mode[data-mode="air"] { color: rgba(251, 191, 36, 0.95); }
    .badge-mode[data-mode="rail"] { color: rgba(168, 85, 247, 0.95); }
    .badge-mode[data-mode="truck"] { color: rgba(249, 115, 22, 0.95); }

    .global-datasets {
      border-top: 1px solid rgba(148, 163, 184, 0.18);
      padding-top: 0.75rem;
    }

    .global-datasets ul {
      list-style: none;
      margin: 0.5rem 0 0;
      padding: 0;
      display: grid;
      gap: 0.35rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .global-cargo-icons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .global-cargo-icons figure {
      margin: 0;
      padding: 0.65rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 0.9rem;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
      text-align: center;
    }

    .global-cargo-icons img {
      width: 54px;
      height: 54px;
      object-fit: contain;
      filter: drop-shadow(0 8px 12px rgba(15, 23, 42, 0.45));
    }

    .global-cargo-icons figcaption {
      font-size: 0.72rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .global-sourcing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.25rem;
      margin-top: 1.5rem;
    }

    .provider-card {
      border: 1px solid var(--border);
      border-radius: 1.1rem;
      padding: 1.25rem;
      background: linear-gradient(140deg, rgba(15, 23, 42, 0.78), rgba(30, 41, 59, 0.6));
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      position: relative;
    }

    .provider-card h3 {
      margin: 0;
      font-size: 1.05rem;
    }

    .provider-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(148, 163, 184, 0.15);
      border-radius: 999px;
      padding: 0.25rem 0.6rem;
    }

    .provider-card ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.45rem;
      font-size: 0.82rem;
    }

    .provider-card footer {
      margin-top: auto;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .automation-cta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.4rem;
      text-align: right;
    }

    .automation-cta small {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .automation-intro {
      margin-top: 1.25rem;
      display: grid;
      gap: 0.65rem;
      color: var(--text-muted);
    }

    .automation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.25rem;
      margin-top: 1.5rem;
    }

    .automation-card {
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.82), rgba(56, 189, 248, 0.18));
      border: 1px solid rgba(56, 189, 248, 0.28);
      box-shadow: 0 18px 34px rgba(15, 23, 42, 0.32);
    }

    .automation-card .price-range {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--accent);
    }

    .automation-card ul li {
      line-height: 1.45;
    }

    .automation-support {
      margin-top: 1.75rem;
      padding: 1.25rem;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(15, 23, 42, 0.6);
      display: grid;
      gap: 1.25rem;
    }

    .automation-support-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
    }

    .automation-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.55rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .automation-list li strong {
      color: var(--text);
    }

    .automation-note {
      font-size: 0.78rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .sourcing-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1.25rem;
    }

    .sourcing-actions .cta {
      flex-shrink: 0;
    }

    #supplier-order-form {
      display: grid;
      gap: 0.75rem;
      margin-top: 1.5rem;
      background: rgba(248, 250, 252, 0.03);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 1rem;
      padding: 1.25rem;
    }

    #supplier-order-form label {
      display: grid;
      gap: 0.35rem;
      font-size: 0.85rem;
    }

    #supplier-order-form input,
    #supplier-order-form select,
    #supplier-order-form textarea {
      width: 100%;
      border-radius: 0.65rem;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(15, 23, 42, 0.65);
      color: var(--text);
      padding: 0.6rem 0.75rem;
      font-size: 0.85rem;
    }

    #supplier-order-form textarea {
      min-height: 90px;
      resize: vertical;
    }

    .supplier-order-log {
      margin-top: 1rem;
      list-style: none;
      padding: 0;
      display: grid;
      gap: 0.6rem;
      font-size: 0.82rem;
    }

    .supplier-order-log li {
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 0.9rem;
      padding: 0.75rem 0.9rem;
      background: rgba(15, 23, 42, 0.55);
      display: grid;
      gap: 0.25rem;
    }

    .supplier-order-log strong {
      font-size: 0.9rem;
    }

    .supplier-order-log span {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .route-node {
      background: rgba(226, 232, 240, 0.95);
      border-radius: 50%;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(15, 23, 42, 0.8);
      box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.35);
    }

    .route-node--sea { background: rgba(56, 189, 248, 0.9); }
    .route-node--air { background: rgba(251, 191, 36, 0.95); }
    .route-node--rail { background: rgba(168, 85, 247, 0.95); }
    .route-node--truck { background: rgba(249, 115, 22, 0.95); }

    .route-pulse {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid currentColor;
      animation: routePulse 2.6s infinite;
      background: rgba(255, 255, 255, 0.15);
    }

    @keyframes routePulse {
      0% { transform: scale(0.6); opacity: 0.85; }
      70% { transform: scale(1.35); opacity: 0.35; }
      100% { transform: scale(1.6); opacity: 0; }
    }

    .global-refresh {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    .global-refresh:hover {
      color: var(--text);
    }

    @media (max-width: 1024px) {
      .global-freight-grid {
        grid-template-columns: 1fr;
      }

      .global-activity-panel {
        order: -1;
      }
    }

    @media (max-width: 720px) {
      .global-map-shell {
        min-height: 320px;
      }

      .global-map-legend {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    .shopify-logo-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .shopify-logo-pill::before {
      content: "";
      display: inline-block;
      width: 1.1rem;
      height: 1.1rem;
      background-image: url('/image/apiLogos/shopify.png');
      background-repeat: no-repeat;
      background-size: contain;
    }

    button.shopify-logo-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #shopify-warnings {
      display: none;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    #shopify-warnings .shopify-logo-pill {
      width: 100%;
      justify-content: flex-start;
      gap: 0.5rem;
    }

    .nav-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1100;
    }

    .nav-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    body.nav-open {
      overflow: hidden;
    }

    main {
      flex: 1;
      width: 100%;
    }

    section {
      display: none;
      animation: fade 0.3s ease forwards;
    }

    section.active {
      display: block;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(12px);
    }

    .panel.light {
      background: var(--bg-panel-light);
      color: #0f172a;
      border-color: rgba(30, 41, 59, 0.15);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.9rem;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }

    .stat-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(56, 189, 248, 0.15));
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .stat-card:hover::after {
      opacity: 1;
    }

    .stat-card h3 {
      margin: 0 0 0.25rem;
      font-size: 0.95rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-card strong {
      font-size: 1.65rem;
      font-weight: 700;
      display: block;
    }

    .stat-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    form {
      display: grid;
      gap: 0.8rem;
      margin-top: 0.5rem;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    input, select, textarea {
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: inherit;
      padding: 0.6rem 0.75rem;
      font-size: 0.95rem;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .hint.warning {
      color: var(--warning);
      font-weight: 600;
    }

    .hint.success {
      color: var(--success);
      font-weight: 600;
    }

    .table-scroll.small {
      max-height: 220px;
      overflow-y: auto;
      overflow-x: auto;
    }

    .shopify-warning {
      margin-top: 0.5rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      background: rgba(250, 204, 21, 0.08);
      border: 1px solid rgba(250, 204, 21, 0.3);
      color: var(--warning);
      font-size: 0.8rem;
    }

    button.cta {
      background: linear-gradient(135deg, #38bdf8, #2563eb);
      border: none;
      color: white;
      padding: 0.65rem 1.1rem;
      border-radius: 0.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      justify-self: start;
      box-shadow: 0 15px 30px rgba(37, 99, 235, 0.35);
    }

    button.secondary,
    a.secondary {
      background: transparent;
      color: inherit;
      border: 1px solid var(--border);
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
    }

    th, td {
      padding: 0.65rem 0.75rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }

    tbody tr {
      position: relative;
    }

    tbody tr.colorized::before {
      content: "";
      position: absolute;
      left: 0.35rem;
      top: 0.35rem;
      bottom: 0.35rem;
      width: 0.35rem;
      border-radius: 999px;
      background: var(--row-color, transparent);
      box-shadow: 0 0 18px rgba(15, 23, 42, 0.18);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .tag.low { color: var(--warning); border-color: rgba(250, 204, 21, 0.6); }
    .tag.ok { color: var(--success); border-color: rgba(74, 222, 128, 0.6); }
    .tag.risk { color: var(--danger); border-color: rgba(248, 113, 113, 0.6); }

    .color-field {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .color-field input[type="color"] {
      -webkit-appearance: none;
      appearance: none;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(15, 23, 42, 0.25);
      background: transparent;
      cursor: pointer;
      padding: 0;
    }

    .panel.light .color-field input[type="color"] {
      border-color: rgba(148, 163, 184, 0.35);
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.12) inset;
    }

    .color-field input[type="color"]::-webkit-color-swatch {
      border-radius: 0.65rem;
      border: none;
    }

    .color-field input[type="color"]::-moz-color-swatch {
      border-radius: 0.65rem;
      border: none;
    }

    .color-field-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .panel.light .color-field-toggle {
      color: rgba(30, 41, 59, 0.65);
    }

    .color-field-toggle input {
      margin: 0;
    }

    .color-field .link-button {
      font-size: 0.75rem;
    }

    .color-hint {
      display: block;
      margin-top: 0.35rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .panel.light .color-hint {
      color: rgba(30, 41, 59, 0.55);
    }

    .table-scroll {
      overflow-x: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .color-chip {
      display: inline-flex;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 999px;
      background: var(--chip-color, #38bdf8);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.35);
    }

    .panel.light .color-chip {
      box-shadow: 0 0 0 1px rgba(30, 41, 59, 0.25);
    }

    .product-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .product-label strong {
      display: block;
    }

    #inventory-toolbar {
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    #inventory-toolbar select {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text);
      border-radius: 0.75rem;
      padding: 0.45rem 0.75rem;
      font-size: 0.85rem;
    }

    .panel.light #inventory-toolbar select {
      background: rgba(248, 250, 252, 0.9);
      border-color: rgba(148, 163, 184, 0.45);
      color: #0f172a;
    }

    .badge {
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent);
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .shipping-hero {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: center;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(14, 165, 233, 0.12));
    }

    .shipping-hero h3 {
      margin: 0;
      font-size: 1.4rem;
    }

    .shipping-hero p {
      margin: 0.35rem 0 0;
      color: #f8fafc;
    }

    .shipping-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.5rem;
    }

    .shipping-list li {
      padding: 0.65rem 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .shipping-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.75rem;
      background: rgba(56, 189, 248, 0.15);
      font-size: 1.2rem;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    .shipping-list li > div {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .shipping-list strong {
      display: block;
      font-weight: 600;
    }

    .flex {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

.flex-space {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .menu-toggle {
      display: none;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(56, 189, 248, 0.45);
      background: rgba(2, 6, 23, 0.85);
      color: #f8fafc;
      position: relative;
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease;
      box-shadow: 0 10px 24px rgba(2, 6, 23, 0.45);
      backdrop-filter: blur(6px);
      z-index: 1300;
    }

    .menu-toggle:hover,
    .menu-toggle:focus-visible {
      border-color: rgba(56, 189, 248, 0.7);
      background: rgba(56, 189, 248, 0.16);
      outline: none;
    }

    .menu-toggle .line {
      display: block;
      width: 1.4rem;
      height: 2px;
      background: currentColor;
      border-radius: 999px;
      position: absolute;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .menu-toggle .line:nth-of-type(1) { transform: translateY(-0.45rem); }
    .menu-toggle .line:nth-of-type(2) { transform: translateY(0); }
    .menu-toggle .line:nth-of-type(3) { transform: translateY(0.45rem); }

    .menu-toggle[aria-expanded="true"] .line:nth-of-type(1) {
      transform: translateY(0) rotate(45deg);
    }

    .menu-toggle[aria-expanded="true"] .line:nth-of-type(2) {
      opacity: 0;
      transform: translateY(0);
    }

    .menu-toggle[aria-expanded="true"] .line:nth-of-type(3) {
      transform: translateY(0) rotate(-45deg);
    }

    .actions button {
      border-radius: 999px;
      padding: 0.3rem 0.85rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
      cursor: pointer;
    }

    .actions button:hover {
      border-color: rgba(56, 189, 248, 0.7);
      color: var(--accent);
    }

    .summary-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      margin-top: 1.2rem;
    }

    .summary-tile {
      padding: 1rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.75);
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .summary-tile h3 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 600;
    }

    .summary-tile p {
      margin: 0.2rem 0 0;
      font-size: 0.85rem;
    }

    .list {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.9rem;
    }

    .list li {
      margin-bottom: 0.3rem;
    }

    footer {
      padding: 2rem 1.25rem 3rem;
      border-top: 1px solid var(--border);
      margin-top: 2rem;
      background: rgba(15, 23, 42, 0.9);
    }

    footer small {
      color: var(--text-muted);
    }

    .toolbar {
      display: inline-flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar button,
    .toolbar a,
    button.toolbar,
    a.toolbar {
      padding: 0.55rem 0.85rem;
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.75);
      color: inherit;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
    }

    .brand-highlight {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .brand-highlight-content {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .brand-highlight-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.6rem 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(15, 23, 42, 0.6);
      box-shadow: 0 18px 32px rgba(2, 6, 23, 0.35);
      min-height: 52px;
    }

    .brand-highlight-badge img {
      width: 38px;
      height: 38px;
      border-radius: 0.9rem;
      object-fit: cover;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    .brand-highlight-emoji {
      font-size: 1.6rem;
      display: inline-flex;
    }

    .brand-highlight-badge img[hidden] {
      display: none;
    }

    .brand-highlight-badge[data-has-logo="true"] .brand-highlight-emoji {
      display: none;
    }

    .brand-highlight-name {
      font-weight: 600;
      font-size: 1rem;
    }
    .integrations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .integration-card { border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.82); box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25); display: flex; flex-direction: column; gap: 0.6rem; }
    .integration-card img { width: 46px; height: 46px; border-radius: 0.75rem; background: rgba(56, 189, 248, 0.12); padding: 0.4rem; }
    .integration-card .tagline { font-size: 0.8rem; color: var(--text-muted); }
    .integration-card button { align-self: flex-start; }
    .account-status { margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-muted); }
    .demo-credentials { margin-top: 0.75rem; font-size: 0.9rem; background: rgba(15, 23, 42, 0.78); border: 1px solid var(--border); border-radius: 0.85rem; padding: 0.75rem 1rem; }
    .demo-credentials ul { margin: 0.35rem 0 0.35rem 1.1rem; padding: 0; }
    .demo-credentials code { font-family: var(--font-mono, 'JetBrains Mono', monospace); font-size: 0.85rem; }
    .account-actions { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-top: 0.75rem; }
    .brand-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .brand-preview { border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.75); display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px; }
    .brand-preview .preview-card { border: 1px solid rgba(148, 163, 184, 0.18); border-radius: 0.85rem; padding: 0.75rem; background: rgba(56, 189, 248, 0.08); }
    .brand-preview .preview-hero { font-weight: 700; font-size: 1.05rem; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
    .gallery img { width: 100%; height: 110px; object-fit: cover; border-radius: 0.85rem; border: 1px solid rgba(148, 163, 184, 0.25); box-shadow: 0 18px 30px rgba(2, 6, 23, 0.35); }
    .reward-badge { margin-top: 1rem; display: none; align-items: center; gap: 0.6rem; font-weight: 600; background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(99, 102, 241, 0.2)); border: 1px solid rgba(56, 189, 248, 0.4); padding: 0.75rem 1rem; border-radius: 0.9rem; box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35); }
    .reward-badge.show { display: flex; animation: pop 0.6s ease; }
    @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .support-response { margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-muted); }
    .one-click-tag { font-size: 0.7rem; padding: 0.15rem 0.45rem; border-radius: 999px; background: rgba(56, 189, 248, 0.16); color: var(--accent); text-transform: uppercase; letter-spacing: 0.04em; }
    .integration-table-empty { color: var(--text-muted); text-align: center; padding: 1rem 0; }
    .brand-identity { display: flex; gap: 1rem; align-items: center; }
    .brand-logo-shell { width: 68px; height: 68px; border-radius: 1.1rem; background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(99, 102, 241, 0.22)); border: 1px solid rgba(148, 163, 184, 0.35); display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 45px rgba(2, 6, 23, 0.35); overflow: hidden; flex-shrink: 0; }
    .brand-logo-shell[hidden] { display: none; }
    .brand-logo-shell img { width: 100%; height: 100%; object-fit: cover; }
    .badge-emoji { width: 3.25rem; height: 3.25rem; border-radius: 0.9rem; background: rgba(56, 189, 248, 0.14); display: inline-flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; position: relative; box-shadow: inset 0 0 0 1px rgba(56, 189, 248, 0.2); }
    .badge-emoji[data-has-logo="true"] { background: rgba(15, 23, 42, 0.9); box-shadow: 0 18px 32px rgba(2, 6, 23, 0.45); }
    .badge-emoji img { width: 100%; height: 100%; object-fit: cover; }
    .badge-emoji span { display: inline-flex; }
    .badge-emoji[data-has-logo="true"] span { display: none; }
    .brand-upload { position: relative; overflow: hidden; border-radius: 1rem; border: 1px dashed rgba(148, 163, 184, 0.45); padding: 0.85rem 1rem; display: flex; align-items: center; gap: 0.85rem; cursor: pointer; background: linear-gradient(135deg, rgba(56, 189, 248, 0.16), rgba(14, 116, 144, 0.18)); transition: transform 0.25s ease, box-shadow 0.25s ease; }
    .brand-upload:hover { transform: translateY(-2px); box-shadow: 0 18px 38px rgba(2, 6, 23, 0.35); border-color: rgba(56, 189, 248, 0.55); }
    .brand-upload:focus-within { outline: 2px solid rgba(56, 189, 248, 0.6); outline-offset: 3px; border-color: rgba(56, 189, 248, 0.6); }
    .brand-upload input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .brand-upload-icon { font-size: 1.75rem; line-height: 1; }
    .brand-upload strong { display: block; font-size: 0.95rem; }
    .brand-upload small { display: block; font-size: 0.75rem; color: var(--text-muted); }
    .brand-upload-hint { margin-top: 0.35rem; }
    .link-button { background: none; border: none; color: var(--accent); padding: 0; font-size: 0.8rem; cursor: pointer; text-decoration: underline; margin-top: 0.25rem; }
    .link-button:hover { color: #e0f2fe; }
    .mini-input { font-size: 0.8rem; color: var(--text-muted); }

    .toolbar input[type="file"] {
      display: none;
    }

    .upload-label {
      border: 1px dashed rgba(148, 163, 184, 0.4);
      padding: 0.65rem 0.9rem;
      border-radius: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
    }

    .upload-label span {
      white-space: normal;
    }

    .upload-label.drag-hover {
      border-color: rgba(56, 189, 248, 0.7);
      background: rgba(56, 189, 248, 0.12);
      color: #38bdf8;
    }

    .callout {
      border-left: 3px solid var(--accent);
      padding-left: 1rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .status-pill {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    @media (max-width: 768px) {
      #inventory-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }

      #inventory-toolbar > * {
        width: 100%;
      }

      #inventory-toolbar .toolbar,
      #inventory-toolbar .secondary,
      #inventory-toolbar .upload-label,
      #inventory-toolbar input[type="search"],
      #inventory-toolbar select {
        width: 100%;
      }

      #inventory-toolbar .upload-label {
        justify-content: center;
        text-align: center;
        padding: 0.85rem;
        flex-wrap: wrap;
      }

      #inventory-toolbar .upload-label span {
        display: block;
      }
    }

    .status-open { background: rgba(56, 189, 248, 0.18); color: #38bdf8; }
    .status-picking { background: rgba(129, 140, 248, 0.2); color: #818cf8; }
    .status-packed { background: rgba(45, 212, 191, 0.2); color: #14b8a6; }
    .status-shipped { background: rgba(22, 163, 74, 0.2); color: #22c55e; }
    .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 2rem;
      padding: 0.85rem 1.1rem;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 0.8rem;
      border: 1px solid rgba(56, 189, 248, 0.45);
      color: #f1f5f9;
      box-shadow: 0 20px 40px rgba(2, 6, 23, 0.45);
      transform: translateY(120%);
      opacity: 0;
      transition: transform 0.35s ease, opacity 0.35s ease;
      z-index: 20;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .oauth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(8px);
      display: grid;
      place-items: center;
      z-index: 40;
    }

    .oauth-overlay[hidden] {
      display: none !important;
    }

    .oauth-dialog {
      display: flex;
      gap: 1rem;
      align-items: center;
      padding: 1.5rem 1.75rem;
      border-radius: 1rem;
      border: 1px solid rgba(56, 189, 248, 0.45);
      background: rgba(15, 23, 42, 0.92);
      box-shadow: 0 28px 60px rgba(2, 6, 23, 0.55);
      max-width: min(420px, 90vw);
    }

    .oauth-spinner {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 3px solid rgba(56, 189, 248, 0.25);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }

    .oauth-dialog h4 {
      margin: 0;
      font-size: 1.05rem;
    }

    .oauth-dialog p {
      margin: 0.25rem 0 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 960px) {
      header .flex-space {
        align-items: flex-start;
      }

      .menu-toggle {
        display: inline-flex;
      }

      nav {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: min(320px, 85vw);
        margin-top: 0;
        background: rgba(15, 23, 42, 0.92);
        backdrop-filter: blur(18px);
        border-left: 1px solid var(--border);
        box-shadow: -20px 0 40px rgba(2, 6, 23, 0.55);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        pointer-events: none;
        visibility: hidden;
        z-index: 1200;
      }

      nav[data-open="true"] {
        transform: translateX(0);
        pointer-events: auto;
        visibility: visible;
      }

      nav button {
        width: 100%;
        justify-content: flex-start;
      }

      .wrap {
        padding: 1rem 1rem 1.5rem;
      }

      table {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 720px) {
      header .wrap {
        padding: 0.75rem 1rem;
      }

      .brand-identity {
        gap: 0.5rem;
      }

      .brand-identity p {
        display: none;
      }

      header h1 {
        font-size: 1.3rem;
      }

      .brand-logo-shell {
        width: 44px;
        height: 44px;
      }

      .header-actions .badge {
        display: none;
      }

      .header-actions {
        justify-content: flex-end;
        flex: 1;
      }

      nav {
        width: min(280px, 80vw);
        padding: 1.25rem;
      }

      #inventory-toolbar {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        gap: 0.65rem;
      }

      #inventory-toolbar > * {
        flex: 1 1 100%;
        width: 100%;
      }

      #inventory-toolbar input[type="search"],
      #inventory-toolbar select {
        width: 100%;
      }

      #inventory-toolbar button,
      #inventory-toolbar a,
      #inventory-toolbar label {
        width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
    }
    /* --- Warehouse "Flowboard" Kanban + Conveyor --- */
    .wh-wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto;
    }

    .wh-kpis {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }

    .wh-kpi {
      background: #0b122a;
      color: #e9edff;
      border: 1px solid #223063;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(12, 24, 80, 0.15);
    }

    .wh-kpi h4 {
      margin: 0 0 4px;
      font-size: 12px;
      opacity: 0.8;
    }

    .wh-kpi .num {
      font-weight: 900;
      font-size: 24px;
      letter-spacing: 0.2px;
    }

    .wh-kpi canvas {
      width: 100%;
      height: 32px;
      display: block;
      margin-top: 6px;
      filter: contrast(1.2) saturate(1.2);
    }

    .wh-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .wh-col {
      background: #0f1430;
      border: 1px solid #253069;
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .wh-col h3 {
      margin: 0;
      padding: 12px 14px;
      font-size: 13px;
      letter-spacing: 0.2px;
      color: #aab7ff;
      border-bottom: 1px solid #223063;
      background: linear-gradient(180deg, #11173a, #0e1534);
    }

    .wh-lane {
      flex: 1;
      min-height: 180px;
      padding: 10px;
      display: grid;
      gap: 10px;
      align-content: start;
    }

    .wh-card {
      background: #11183b;
      border: 1px solid #2a3876;
      border-radius: 12px;
      padding: 10px;
      color: #e9edff;
      box-shadow: 0 10px 24px rgba(12, 24, 80, 0.18);
    }

    .wh-card small {
      opacity: 0.8;
    }

    .wh-card .badge {
      display: inline-block;
      background: #e4ffef;
      color: #085c2c;
      border: 1px solid #bff3cd;
      padding: 2px 6px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 11px;
    }

    .wh-ghost {
      position: fixed;
      left: 0;
      top: 0;
      translate: -50% -50%;
      pointer-events: none;
      z-index: 99;
    }

    .wh-ghost.animate {
      animation: wh-move var(--dur, 700ms) cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    @keyframes wh-move {
      to {
        transform: translate(var(--dx, 0px), var(--dy, 0px));
      }
    }

    .wh-conveyor {
      margin: 16px 0;
      background: linear-gradient(180deg, #0a1026, #080e22);
      border: 1px solid #202a5a;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 12px 30px rgba(12, 24, 80, 0.15);
    }

    .belt {
      height: 10px;
      border-radius: 999px;
      background: repeating-linear-gradient(90deg, #15204c 0 28px, #0f1a3f 28px 56px);
      position: relative;
      overflow: hidden;
      border: 1px solid #223063;
    }

    .belt::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
      animation: shine 2.4s linear infinite;
    }

    @keyframes shine {
      from {
        translate: -100% 0;
      }

      to {
        translate: 100% 0;
      }
    }

    .pallets {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .pallet {
      width: 100px;
      height: 50px;
      border-radius: 10px;
      background: #11183b;
      border: 1px solid #2a3876;
      box-shadow: 0 10px 24px rgba(12, 24, 80, 0.18);
      color: #e9edff;
      display: grid;
      place-items: center;
    }

    .pallet.run {
      animation: roll 7s linear infinite;
    }

    @keyframes roll {
      from {
        transform: translateX(-10%);
      }

      to {
        transform: translateX(110%);
      }
    }


    @media (max-width: 1000px) {
      .wh-board,
      .wh-kpis {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 640px) {
      .wh-board,
      .wh-kpis {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex-space">
        <div class="brand-identity">
          <div class="brand-logo-shell" id="brand-logo-shell" hidden>
            <img id="brand-logo-display" alt="Brand logo" />
          </div>
          <div>
            <h1 id="brand-heading">Warehouse HQ</h1>
            <p>The logistics mission control for omni-channel merchants, from indie resellers to enterprise hubs.</p>
          </div>
        </div>
        <div class="flex header-actions">
          <div class="badge">Multi-tenant • Cloud-Ready • Free Forever Core</div>
          <button class="menu-toggle" type="button" aria-expanded="false" aria-controls="hq-navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="line" aria-hidden="true"></span>
            <span class="line" aria-hidden="true"></span>
            <span class="line" aria-hidden="true"></span>
          </button>
        </div>
      </div>
      <nav id="hq-navigation" data-open="false">
        <button data-target="overview" class="active">Mission Control</button>
        <button data-target="inventory">Inventory</button>
        <button data-target="orders">Orders & Fulfillment</button>
        <button data-target="receiving">Inbound</button>
        <button data-target="shipping">Shipping & Returns</button>
        <button data-target="automation">Warehouse AI & Robotics</button>
        <button data-target="sourcing">Global Sourcing</button>
        <button data-target="labor">Teams & Tasks</button>
        <button data-target="settings">Data & Settings</button>
        <button data-target="account">My Account</button>
        <button data-link="/scanner.html" class="scanner-link">Scan Anything</button>
      </nav>
      <div class="nav-overlay" hidden></div>
    </div>
  </header>

  <main class="wrap">
    <section id="overview" class="active">
      <div class="panel">
        <h2>Live Command Dashboard</h2>
        <p>Stay ahead of the floor: review health signals, SLA watch-outs, and AI nudges to guide your next move.</p>
        <div class="stats" id="stat-cards"></div>
      </div>

      <section class="wh-wrap" id="warehouse-visual">
        <div class="wh-kpis" id="kpis">
          <div class="wh-kpi">
            <h4>Orders Today</h4>
            <div class="num" data-kpi="orders">0</div>
            <canvas data-spark="orders"></canvas>
          </div>
          <div class="wh-kpi">
            <h4>Avg. Pick Time</h4>
            <div class="num" data-kpi="pickTime">0m</div>
            <canvas data-spark="pickTime"></canvas>
          </div>
          <div class="wh-kpi">
            <h4>On-Time Ship</h4>
            <div class="num" data-kpi="ots">0%</div>
            <canvas data-spark="ots"></canvas>
          </div>
          <div class="wh-kpi">
            <h4>Backorders</h4>
            <div class="num" data-kpi="bo">0</div>
            <canvas data-spark="bo"></canvas>
          </div>
        </div>

        <div class="wh-board" id="flowboard" aria-label="Warehouse flow">
          <div class="wh-col" data-col="new">
            <h3>New</h3>
            <div class="wh-lane" id="lane-new"></div>
          </div>
          <div class="wh-col" data-col="picking">
            <h3>Picking</h3>
            <div class="wh-lane" id="lane-picking"></div>
          </div>
          <div class="wh-col" data-col="packing">
            <h3>Packing</h3>
            <div class="wh-lane" id="lane-packing"></div>
          </div>
          <div class="wh-col" data-col="shipped">
            <h3>Shipped</h3>
            <div class="wh-lane" id="lane-shipped"></div>
          </div>
        </div>

        <div class="wh-conveyor" aria-label="Conveyor">
          <div class="belt"></div>
          <div class="pallets">
            <div class="pallet run">ORD-1842</div>
            <div class="pallet run" style="animation-delay: .8s">ORD-1843</div>
            <div class="pallet run" style="animation-delay: 1.6s">ORD-1844</div>
          </div>
        </div>

        <div class="scan-wrap" id="scanner">
          <video class="scan-video" id="scanVideo" playsinline></video>
          <div class="scan-line" id="scanLine"></div>
          <div class="scan-ui">
            <button class="btn" id="btnScan">Start Camera</button>
            <button class="btn ghost" id="btnFakeScan">Fake Scan</button>
          </div>
        </div>
      </section>

      <section class="panel global-freight" aria-label="China to USA freight intelligence">
        <div class="global-freight-header">
          <div>
            <h3>China → USA Freight Intelligence</h3>
            <p class="hint">Live routes powered by free AIS, ADS-B, rail, and ELD snapshots to spotlight apparel, electronics, and produce flows.</p>
          </div>
          <div class="sourcing-actions">
            <button class="secondary" type="button" id="global-network-refresh">Refresh activity</button>
            <button class="cta" type="button" id="launch-sourcing">Coordinate Supplier Order</button>
          </div>
        </div>
        <div class="global-freight-grid">
          <div class="global-map-shell">
            <div id="global-map" role="presentation" aria-label="Global freight network"></div>
            <div class="global-map-overlay" aria-hidden="true"></div>
            <div class="global-map-legend">
              <span><span class="legend-key sea"></span> Sea freight</span>
              <span><span class="legend-key air"></span> Air freight</span>
              <span><span class="legend-key rail"></span> Rail legs</span>
              <span><span class="legend-key truck"></span> Truck transfer</span>
            </div>
          </div>
          <div class="global-activity-panel">
            <div class="global-activity-head">
              <h4>Active lanes &amp; ETAs</h4>
              <span class="hint">Timestamps update from community feeds and port advisories.</span>
            </div>
            <ul class="global-activity" id="global-activity-list" aria-live="polite"></ul>
            <div class="global-cargo-icons">
              <figure>
                <img src="/image/icon_freight_boat.png" alt="Container vessel icon" />
                <figcaption>Stacked apparel containers heading to Los Angeles.</figcaption>
              </figure>
              <figure>
                <img src="/image/icon_freight_plane.png" alt="Cargo aircraft icon" />
                <figcaption>Chartered freighter moving electronics and footwear.</figcaption>
              </figure>
              <figure>
                <img src="/image/icon_freight_train.png" alt="Freight train icon" />
                <figcaption>Double-stack rail pushing transloaded textiles inland.</figcaption>
              </figure>
              <figure>
                <img src="/image/icon_freight_truck.png" alt="Freight truck icon" />
                <figcaption>Temperature-controlled trucking for fruit imports.</figcaption>
              </figure>
            </div>
            <div class="global-datasets">
              <h5>Realtime sources used</h5>
              <ul>
                <li>AIS relays via AISHub / MarineTraffic community tiers</li>
                <li>ADS-B telemetry from OpenSky Network &amp; ADS-B Exchange</li>
                <li>Port of LA / Long Beach rail departure &amp; customs bulletins</li>
                <li>ELD pings &amp; traffic overlays for drayage and linehaul legs</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <div class="summary-grid">
        <div class="summary-tile">
          <div>
            <h3>Today&apos;s Priorities</h3>
            <ul class="list" id="priority-list"></ul>
          </div>
          <p class="hint">Automated by your Warehouse HQ assistant. Refresh as priorities evolve.</p>
        </div>
        <div class="summary-tile">
          <div>
            <h3>Integration Pulse</h3>
            <ul class="list">
              <li><strong>Commerce:</strong> <span class="shopify-logo-pill">Shopify</span>, Amazon, eBay, Faire, POS</li>
              <li><strong>Accounting:</strong> QuickBooks, Xero, NetSuite, Odoo</li>
              <li><strong>Automation:</strong> Zebra scanners, RFID gateways, Locus bots</li>
            </ul>
          </div>
          <p class="hint">Connect via Settings → Integrations. No-code connectors included.</p>
        </div>
        <div class="summary-tile">
          <div>
            <h3>Monetize & Gamify</h3>
            <ul class="list">
              <li>Dynamic subscription bundler for your ops scale.</li>
              <li>Unlock premium AI slotting when KPIs trend up.</li>
              <li>Seasonal power-ups keep teams motivated.</li>
            </ul>
          </div>
          <p class="hint">Stripe-powered marketplace makes upgrades feel like a game night.</p>
        </div>
      </div>

      <div class="panel brand-highlight">
        <h3>Brand Spotlight</h3>
        <div class="brand-highlight-content">
          <div class="brand-highlight-badge" id="brand-highlight-badge" data-has-logo="false">
            <img id="brand-highlight-logo" alt="Company logo spotlight" hidden />
            <span class="brand-highlight-emoji" id="brand-highlight-emoji" aria-hidden="true">🚚</span>
            <span class="brand-highlight-name" id="brand-highlight-name">Warehouse HQ</span>
          </div>
          <p class="hint" id="brand-highlight-hint">Upload your company logo in Data &amp; Settings → Branding to personalize this hub.</p>
        </div>
      </div>
    </section>

    <section id="inventory">
      <div class="panel">
        <div class="flex-space">
          <div>
            <h2>Inventory Catalogue</h2>
            <p>Unified visibility by warehouse, zone, variant and compliance lot.</p>
          </div>
          <div class="toolbar">
            <label class="upload-label">
              <span>⬆︎ Import JSON</span>
              <input type="file" id="import-input" accept="application/json" />
            </label>
            <button class="toolbar" id="export-btn">⬇︎ Export Backup</button>
            <button class="toolbar" id="reset-btn">Reset Workspace</button>
          </div>
        </div>
        <div class="grid grid-2">
          <form id="warehouse-form" class="panel light">
            <h3>New Warehouse / Zone</h3>
            <label>Name
              <input type="text" name="name" required placeholder="Delco Fulfillment East" />
            </label>
            <label>Type
              <select name="type">
                <option value="Fulfillment Center">Fulfillment Center</option>
                <option value="3PL Client">3PL Client</option>
                <option value="Retail Store">Retail Store</option>
                <option value="Pop-up">Pop-up</option>
                <option value="Cold Storage">Cold Storage</option>
              </select>
            </label>
            <label>Capacity (pallets)
              <input type="number" name="capacity" min="0" placeholder="1200" />
            </label>
            <label>Address / Notes
              <textarea name="notes" placeholder="123 Market St, Philadelphia, PA"></textarea>
            </label>
            <button class="cta" type="submit">Add Warehouse</button>
          </form>

          <form id="item-form" class="panel light">
            <h3>Create / Update SKU</h3>
            <label>SKU / Barcode
              <input type="text" name="sku" required placeholder="SKU-ABC-001" />
            </label>
            <label>Product Name
              <input type="text" name="name" required placeholder="Wing Ding Hoodie" />
            </label>
            <label>Variant (size, color, etc.)
              <input type="text" name="variant" placeholder="XL / Black" />
            </label>
            <label>Category
              <input type="text" name="category" placeholder="Apparel" />
            </label>
            <label>Warehouse
              <select name="warehouse" id="item-warehouse"></select>
            </label>
            <label>Bin / Location
              <input type="text" name="location" placeholder="Aisle 4 → Bay B → Level 2" />
            </label>
            <label>On-hand Qty
              <input type="number" name="quantity" min="0" value="0" />
            </label>
            <label>Reorder Point
              <input type="number" name="reorder" min="0" value="10" />
            </label>
            <label class="color-lane">Color lane (optional)
              <div class="color-field">
                <input type="color" id="item-color" value="#38bdf8" data-default="#38bdf8" aria-label="Select color lane" />
                <span class="color-field-toggle">
                  <input type="checkbox" id="item-color-toggle" aria-label="Enable color lane" />
                  <span>Highlight inventory rows with this color</span>
                </span>
                <button type="button" class="link-button" id="item-color-clear">Clear</button>
              </div>
              <span class="color-hint">Match the color coding teams use across handheld apps.</span>
            </label>
            <label>Lot / Batch
              <input type="text" name="lot" placeholder="LOT-2025-04" />
            </label>
            <label>Expiry (if applicable)
              <input type="date" name="expiry" />
            </label>
            <label>Unit Cost (optional)
              <input type="number" name="unitCost" min="0" step="0.01" placeholder="12.50" />
            </label>
            <button class="cta" type="submit">Save SKU</button>
          </form>
        </div>

        <div class="panel">
          <div class="flex-space">
            <div>
              <h3>Inventory Snapshot</h3>
              <p class="hint shopify-logo-pill" id="shopify-sync-status">Connect Shopify to sync your catalogue.</p>
            </div>
            <div class="flex" id="inventory-toolbar">
              <button class="secondary shopify-logo-pill" type="button" id="shopify-sync-btn">Sync Shopify</button>
              <label class="upload-label shopify-logo-pill">
                <span>⬆︎ Import Shopify CSV</span>
                <input type="file" id="shopify-csv-input" accept=".csv,text/csv" multiple />
              </label>
              <button class="toolbar" type="button" id="print-stickers-btn">🖨 Print Stickers</button>
              <a class="toolbar scanner-link" href="/scanner-inventory.html" target="_blank" rel="noopener">Inventory Scanner</a>
              <input type="search" id="inventory-search" placeholder="Search SKU, name, lot…" />
              <select id="warehouse-filter"></select>
              <select id="inventory-sort" aria-label="Sort inventory">
                <option value="sku">Sort: SKU (A→Z)</option>
                <option value="status">Sort: Status (priority)</option>
                <option value="qty">Sort: Quantity (high→low)</option>
                <option value="color">Sort: Color lanes</option>
              </select>
            </div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th>Warehouse</th>
                  <th>Location</th>
                  <th>Qty</th>
                  <th>Reorder</th>
                  <th>Lot / Exp</th>
                  <th>Status</th>
                  <th>Sticker</th>
                </tr>
              </thead>
              <tbody id="inventory-body"></tbody>
            </table>
          </div>
          <div id="shopify-warnings" class="shopify-warning" style="display:none;"></div>
        </div>

        <div class="grid grid-2">
          <div class="panel light">
            <div class="flex-space">
              <h3 class="shopify-logo-pill">Shopify Collections</h3>
              <span class="hint" id="collections-count">—</span>
            </div>
            <div class="table-scroll small">
              <table>
                <thead>
                  <tr>
                    <th>Collection</th>
                    <th>Type</th>
                    <th>Products</th>
                    <th>Updated</th>
                  </tr>
                </thead>
                <tbody id="collections-body"></tbody>
              </table>
            </div>
          </div>

          <div class="panel light">
            <div class="flex-space">
              <h3>Gift Cards</h3>
              <span class="hint" id="gift-cards-count">—</span>
            </div>
            <div class="table-scroll small">
              <table>
                <thead>
                  <tr>
                    <th>Last 4</th>
                    <th>Balance</th>
                    <th>Customer</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="gift-cards-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="orders">
      <div class="panel">
        <h2>Orders & Fulfillment</h2>
        <p>Unify B2C drops, wholesale and store replenishment. Control picking waves and shipping promises from one screen.</p>
        <div class="grid grid-2">
          <form id="order-form" class="panel light">
            <h3>Create Order</h3>
            <label>Order ID / Reference
              <input type="text" name="orderId" required placeholder="WEB-10045" />
            </label>
            <label>Customer / Channel
              <input type="text" name="customer" placeholder="Shopify – Jane Smith" />
            </label>
            <label>Warehouse Fulfilling
              <select name="warehouse" id="order-warehouse"></select>
            </label>
            <label>Due Date
              <input type="date" name="dueDate" />
            </label>
            <label>Priority
              <select name="priority">
                <option value="Standard">Standard</option>
                <option value="Rush">Rush</option>
                <option value="Same Day">Same Day</option>
              </select>
            </label>
            <label>Shipping Method
              <input type="text" name="shipping" placeholder="UPS Ground" />
            </label>
            <label>Items (SKU:Qty per line)
              <textarea name="lines" required placeholder="SKU-ABC-001:3\nSKU-FTW-002:1"></textarea>
            </label>
            <button class="cta" type="submit">Create Order</button>
          </form>

          <div class="panel light">
            <h3>Mobile Pick Assist</h3>
            <label>Scan / Enter SKU
              <input type="text" id="pick-scan" placeholder="Scan barcode" />
            </label>
            <div id="pick-result" class="callout">Awaiting scan…</div>
            <h4>Order Queue Health</h4>
            <ul class="list" id="order-health"></ul>
          </div>
        </div>

        <div class="panel">
          <div class="flex-space">
            <h3>Open Orders</h3>
            <div class="flex">
              <a class="secondary scanner-link" href="/scanner-orders.html" target="_blank" rel="noopener">Orders Scanner</a>
              <select id="order-status-filter">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="picking">Picking</option>
                <option value="packed">Packed</option>
                <option value="shipped">Shipped</option>
              </select>
            </div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Order</th>
                  <th>Warehouse</th>
                  <th>Lines</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Progress</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="order-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="receiving">
      <div class="panel">
        <h2>Inbound, Put-away & Compliance</h2>
        <p>Automate ASN matching, directed put-away and QA holds. Cycle counts and audits stay synced.</p>
        <div class="grid grid-2">
          <form id="receipt-form" class="panel light">
            <h3>Receive Inventory</h3>
            <label>Reference / ASN
              <input type="text" name="reference" placeholder="ASN-5541" />
            </label>
            <label>Supplier
              <input type="text" name="supplier" placeholder="Delco Apparel Mfg" />
            </label>
            <label>Warehouse
              <select name="warehouse" id="receipt-warehouse"></select>
            </label>
            <label>SKU
              <input type="text" name="sku" required placeholder="SKU-ABC-001" />
            </label>
            <label>Quantity Received
              <input type="number" name="quantity" min="1" required value="1" />
            </label>
            <label>Put-away Location
              <input type="text" name="location" placeholder="Aisle 5 → Bay C → Level 1" />
            </label>
            <label>Lot / Batch
              <input type="text" name="lot" placeholder="LOT-APR-2025" />
            </label>
            <label>Expiry Date
              <input type="date" name="expiry" />
            </label>
            <label>Notes
              <textarea name="notes" placeholder="QA hold for inspection"></textarea>
            </label>
            <button class="cta" type="submit">Receive & Put-away</button>
          </form>

          <div class="panel light">
            <h3>Cycle Count Scheduler</h3>
            <label>Warehouse / Zone
              <select id="cycle-warehouse"></select>
            </label>
            <label>Count Focus
              <select id="cycle-focus">
                <option value="velocity">High velocity SKUs</option>
                <option value="aging">Aging / slow movers</option>
                <option value="highValue">High value items</option>
                <option value="compliance">Compliance (lot / expiry)</option>
              </select>
            </label>
            <button class="cta" type="button" id="plan-cycle">Plan Cycle Count</button>
            <div class="callout" id="cycle-plan">Plan a cycle count to reduce stockouts by 22%.</div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="panel light">
            <div class="flex-space">
              <h3>Purchase Orders</h3>
              <span class="hint" id="purchase-orders-count">—</span>
            </div>
            <div class="table-scroll small">
              <table>
                <thead>
                  <tr>
                    <th>PO</th>
                    <th>Vendor</th>
                    <th>Due</th>
                    <th>Status</th>
                    <th>Lines</th>
                  </tr>
                </thead>
                <tbody id="purchase-orders-body"></tbody>
              </table>
            </div>
          </div>

          <div class="panel light">
            <div class="flex-space">
              <h3>Transfers</h3>
              <span class="hint" id="transfers-count">—</span>
            </div>
            <div class="table-scroll small">
              <table>
                <thead>
                  <tr>
                    <th>Transfer</th>
                    <th>Route</th>
                    <th>ETA</th>
                    <th>Status</th>
                    <th>Lines</th>
                  </tr>
                </thead>
                <tbody id="transfers-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="flex-space">
            <h3>Inbound Activity Log</h3>
            <a class="secondary scanner-link" href="/scanner-inbound.html" target="_blank" rel="noopener">Inbound Scanner</a>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Reference</th>
                  <th>Warehouse</th>
                  <th>SKU</th>
                  <th>Qty</th>
                  <th>Location</th>
                  <th>Lot / Exp</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="receipts-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="shipping">
      <div class="panel">
        <h2>Shipping Control & Reverse Logistics</h2>
        <p>Confirm labels, track carrier SLAs and manage returns without leaving the cockpit.</p>
        <div class="panel shipping-hero">
          <div>
            <h3>Everything you need to ship, where you need it</h3>
            <p>Trusted by modern warehouses to orchestrate same-day dispatch and painless returns.</p>
          </div>
          <ul class="shipping-list">
            <li>
              <span class="shipping-icon" aria-hidden="true">🏷️</span>
              <div>
                <strong>Up to 87% off shipping labels</strong>
                Carrier-direct rates with automatic comparison shopping.
              </div>
            </li>
            <li>
              <span class="shipping-icon" aria-hidden="true">🛒</span>
              <div>
                <strong>All your sales channels in one queue</strong>
                <span class="shopify-logo-pill">Shopify</span>, Faire, Amazon, POS and more feed a unified pick plan.
              </div>
            </li>
            <li>
              <span class="shipping-icon" aria-hidden="true">🖨️</span>
              <div>
                <strong>Batch printing for up to 250 labels</strong>
                Launch massive waves without rekeying order IDs.
              </div>
            </li>
            <li>
              <span class="shipping-icon" aria-hidden="true">📍</span>
              <div>
                <strong>Custom pick lists with bin locations</strong>
                Surface smart routes that match how your floor is laid out.
              </div>
            </li>
            <li>
              <span class="shipping-icon" aria-hidden="true">🛡️</span>
              <div>
                <strong>$200 insurance on every shipment</strong>
                Peace of mind baked into every parcel you confirm.
              </div>
            </li>
          </ul>
        </div>
        <div class="grid grid-2">
          <form id="shipment-form" class="panel light">
            <h3>Confirm Shipment</h3>
            <label>Order ID
              <input type="text" name="orderId" required placeholder="WEB-10045" />
            </label>
            <label>Carrier / Service
              <input type="text" name="carrier" placeholder="UPS Ground" />
            </label>
            <label>Tracking #
              <input type="text" name="tracking" placeholder="1Z999AA10123456784" />
            </label>
            <label>Packages
              <input type="number" name="packages" min="1" value="1" />
            </label>
            <label>Freight Cost
              <input type="number" name="cost" min="0" step="0.01" placeholder="12.45" />
            </label>
            <button class="cta" type="submit">Close Shipment</button>
          </form>

          <form id="return-form" class="panel light">
            <h3>Process Return</h3>
            <label>Order ID
              <input type="text" name="orderId" placeholder="WEB-10045" />
            </label>
            <label>SKU
              <input type="text" name="sku" placeholder="SKU-ABC-001" />
            </label>
            <label>Quantity
              <input type="number" name="quantity" min="1" value="1" />
            </label>
            <label>Reason
              <select name="reason">
                <option value="damaged">Damaged</option>
                <option value="wrongItem">Wrong Item</option>
                <option value="buyerRemorse">Buyer Remorse</option>
                <option value="warranty">Warranty / Repair</option>
              </select>
            </label>
            <label>Disposition
              <select name="disposition">
                <option value="restock">Restock</option>
                <option value="scrap">Scrap</option>
                <option value="refurbish">Refurbish</option>
                <option value="rtv">Return to Vendor</option>
              </select>
            </label>
            <button class="cta" type="submit">Record Return</button>
          </form>
        </div>

        <div class="grid grid-2">
          <div class="panel">
            <div class="flex-space">
              <h3>Shipments</h3>
              <a class="secondary scanner-link" href="/scanner-shipments.html" target="_blank" rel="noopener">Shipping Scanner</a>
            </div>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Order</th>
                    <th>Carrier</th>
                    <th>Tracking</th>
                    <th>Packages</th>
                    <th>Cost</th>
                  </tr>
                </thead>
                <tbody id="shipments-body"></tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <div class="flex-space">
              <h3>Returns</h3>
              <a class="secondary scanner-link" href="/scanner-returns.html" target="_blank" rel="noopener">Returns Scanner</a>
            </div>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Order</th>
                    <th>SKU</th>
                    <th>Qty</th>
                    <th>Reason</th>
                    <th>Disposition</th>
                  </tr>
                </thead>
                <tbody id="returns-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="automation">
      <div class="panel">
        <div class="flex-space">
          <div>
            <h2>Warehouse AI &amp; Robotics (USA Focus)</h2>
            <p>Deploy revenue-generating robotics with U.S. distributors, partner APIs, and affiliate commissions baked into every deal.</p>
          </div>
          <div class="automation-cta">
            <button class="cta" type="button" id="robotics-checkout">Launch Stripe Robotics Order</button>
            <small>We collect deposits via Stripe, fulfill hardware, and coordinate U.S.-based integrators on your behalf.</small>
          </div>
        </div>

        <div class="automation-intro">
          <p>Warehouses now rely on AMRs, automated forklifts, cobots, and patrol robots to move inventory, package orders, and secure the floor around the clock. We curate the vendors that offer commissions or reseller pricing, plus developer-friendly APIs so your Warehouse HQ can orchestrate every mission.</p>
          <p>Bundle robots, scanners, and labeling in one checkout: we handle payment through Stripe, drop-ship from U.S. inventory, and include integration kits so operators can go live without managed services.</p>
        </div>

        <div class="automation-grid">
          <article class="provider-card automation-card" data-focus="amr">
            <span class="provider-pill">AMRs · Affiliate &amp; API ready</span>
            <h3>Autonomous Mobile Robots</h3>
            <p class="price-range">Typical investment: $10K – $100K+ per robot</p>
            <ul>
              <li>Locus Robotics totes runners (~$35K) keep humans in pick zones and pay partner commissions on fleet expansions.</li>
              <li>Fetch Robotics (Sevens) Freight AMRs (~$100K) and MiR payload bots ($10K–$15K entry) expose REST/ROS for task dispatch.</li>
              <li>Boston Dynamics Spot (~$75K) patrols and inspects aisles with a robust SDK for payloads and analytics.</li>
            </ul>
            <footer>
              <a href="https://locusrobotics.com/partners/" target="_blank" rel="noopener" class="link-button">Locus partner</a>
              <a href="https://fetchrobotics.com/platform/fetch-freight/" target="_blank" rel="noopener" class="link-button">Fetch Freight</a>
              <a href="https://www.bostondynamics.com/spot/developers" target="_blank" rel="noopener" class="link-button">Spot SDK</a>
            </footer>
          </article>

          <article class="provider-card automation-card" data-focus="forklifts">
            <span class="provider-pill">Automated forklifts · Reseller margin</span>
            <h3>Guided Forklifts &amp; AGVs</h3>
            <p class="price-range">Typical investment: $50K – $150K+ per vehicle</p>
            <ul>
              <li>Vecna Robotics autonomous pallet forks lift and stage loads while sharing revenue on closed projects.</li>
              <li>OTTO Motors and Seegrid fleets retrofit or replace forklifts with LiDAR navigation and REST/ROS control.</li>
              <li>Offer Robot-as-a-Service financing so customers pay monthly while you keep integrator rebates.</li>
            </ul>
            <footer>
              <a href="https://www.vecnarobotics.com/" target="_blank" rel="noopener" class="link-button">Vecna Robotics</a>
              <a href="https://ottomotors.com/partners" target="_blank" rel="noopener" class="link-button">OTTO partner</a>
              <a href="https://seegrid.com/" target="_blank" rel="noopener" class="link-button">Seegrid programs</a>
            </footer>
          </article>

          <article class="provider-card automation-card" data-focus="cobots">
            <span class="provider-pill">Cobots · Turnkey pick/pack</span>
            <h3>Collaborative Robot Arms</h3>
            <p class="price-range">Typical investment: $33K – $65K per cell</p>
            <ul>
              <li>Standard Bots RO1 (18kg payload) with pick/pack station ($45K–$65K) includes built-in vision and AI.</li>
              <li>Universal Robots UR series ($33K–$49K) ship with U.S. support, UR+ marketplace grippers, and safety certifications.</li>
              <li>Bundle grippers, conveyors, and QA cameras for higher affiliate payouts and faster ROI.</li>
            </ul>
            <footer>
              <a href="https://standardbots.com/ro1" target="_blank" rel="noopener" class="link-button">RO1 details</a>
              <a href="https://standardbots.com/partner-program" target="_blank" rel="noopener" class="link-button">Standard Bots partners</a>
              <a href="https://www.universal-robots.com/urplus/" target="_blank" rel="noopener" class="link-button">UR+ ecosystem</a>
            </footer>
          </article>

          <article class="provider-card automation-card" data-focus="packaging">
            <span class="provider-pill">Packaging automation · Add-on margin</span>
            <h3>Conveyors, Case Packers &amp; Labeling</h3>
            <p class="price-range">Typical investment: $5K – $150K+ per line</p>
            <ul>
              <li>Automated case-packing cells (robot + vision) reach $150K+ with healthy reseller commissions.</li>
              <li>Modular conveyors, baggers, and box formers start at a few thousand dollars for quick win-upsells.</li>
              <li>Zebra Print DNA &amp; Honeywell labelers plug into Warehouse HQ for API-driven shipping documents.</li>
            </ul>
            <footer>
              <a href="https://www.packsize.com/solutions/" target="_blank" rel="noopener" class="link-button">Packsize on-demand</a>
              <a href="https://www.paxiom.com/" target="_blank" rel="noopener" class="link-button">Paxiom automation</a>
              <a href="https://techdocs.zebra.com/" target="_blank" rel="noopener" class="link-button">Zebra Print DNA</a>
            </footer>
          </article>

          <article class="provider-card automation-card" data-focus="security">
            <span class="provider-pill">Security robots · Subscription share</span>
            <h3>Autonomous Patrol &amp; Inspection</h3>
            <p class="price-range">Typical investment: $6 – $12/hr or ~$75K/yr</p>
            <ul>
              <li>Boston Dynamics Spot with cameras or thermal payloads surveys aisles and docks on programmable routes.</li>
              <li>Knightscope K5 indoor patrol robot leases for $7–$12/hr with referral payouts.</li>
              <li>Cobalt Robotics subscriptions (~$75K/yr) cover robot, support, and analytics—bundle with your monitoring fees.</li>
            </ul>
            <footer>
              <a href="https://www.bostondynamics.com/spot" target="_blank" rel="noopener" class="link-button">Spot overview</a>
              <a href="https://www.knightscope.com/" target="_blank" rel="noopener" class="link-button">Knightscope leasing</a>
              <a href="https://www.cobaltrobotics.com/" target="_blank" rel="noopener" class="link-button">Cobalt security</a>
            </footer>
          </article>

          <article class="provider-card automation-card" data-focus="scanning">
            <span class="provider-pill">Scanning · Drop-ship friendly</span>
            <h3>Handheld Scanners &amp; RFID</h3>
            <p class="price-range">Typical investment: $500 – $1,500 per device</p>
            <ul>
              <li>Zebra TC22/TC53e and Honeywell CT47 rugged Android handhelds stream barcode/RFID data via DataWedge or Mobility SDK.</li>
              <li>Pair with Zebra/Honeywell label printers for frictionless shipping paperwork and recurring media sales.</li>
              <li>Offer entry-level bundles alongside our "$5 barcode packs" to capture budget buyers and upsell to enterprise kits.</li>
            </ul>
            <footer>
              <a href="https://www.zebra.com/us/en/partners.html" target="_blank" rel="noopener" class="link-button">Zebra partner</a>
              <a href="https://techdocs.zebra.com/datawedge/latest/guide/api/" target="_blank" rel="noopener" class="link-button">DataWedge API</a>
              <a href="https://sps.honeywell.com/us/en/support/partners" target="_blank" rel="noopener" class="link-button">Honeywell programs</a>
            </footer>
          </article>
        </div>

        <div class="automation-support">
          <div class="automation-support-grid">
            <div>
              <h3>What You Need On-Site</h3>
              <ul class="automation-list">
                <li><strong>Connectivity &amp; maps:</strong> Enterprise Wi-Fi or private LTE/5G, plus LiDAR scans or CAD maps for fleet navigation.</li>
                <li><strong>Charging &amp; safety:</strong> 120V charging drops, floor marking, and OSHA-compliant training for mixed robot/human aisles.</li>
                <li><strong>Data layer:</strong> Warehouse HQ + WMS/ERP credentials to sync pick lists, telemetry, and alerts through REST/ROS/MQTT.</li>
                <li><strong>Operator enablement:</strong> Assign a shift supervisor for pre-flight checks—our onboarding kit includes SOPs and remote coaching.</li>
              </ul>
            </div>
            <div>
              <h3>Monetize Every Deployment</h3>
              <ul class="automation-list">
                <li><strong>Stripe-powered deposits:</strong> Use the button above to collect custom retainers; we schedule drop shipments and integrators.</li>
                <li><strong>Affiliate &amp; reseller tiers:</strong> Capture commission from Locus, OTTO, Standard Bots, Zebra, and Honeywell on qualified referrals.</li>
                <li><strong>Robot-as-a-Service upsells:</strong> Lease Knightscope or Cobalt robots ($7–$12/hr or ~$75K/yr) and share recurring revenue.</li>
                <li><strong>DIY support kits:</strong> Provide customers with configuration files, charging plans, and training so they can self-manage without ongoing labor contracts.</li>
              </ul>
            </div>
            <div>
              <h3>APIs &amp; Integration Jumpstarts</h3>
              <ul class="automation-list">
                <li><strong>Fleet control:</strong> Locus, Fetch/Sevens, OTTO, and MiR fleets tie into Warehouse HQ missions through REST and ROS endpoints.</li>
                <li><strong>Vision &amp; safety:</strong> Boston Dynamics Spot SDK and Standard Bots RO1 on-board AI power inspection checklists and hazard detection.</li>
                <li><strong>Scanning &amp; labeling:</strong> Zebra DataWedge intents, Print DNA cloud APIs, and Honeywell Mobility SDK stream barcodes and labels.</li>
                <li><strong>Reporting:</strong> Feed telemetry into our analytics to track uptime, SLA compliance, and commission eligibility.</li>
              </ul>
            </div>
          </div>
          <p class="automation-note">All hardware ships with U.S. compliance docs and remote onboarding. Existing owners can plug their robots into Warehouse HQ using the included configuration kits&mdash;no managed services required unless you request them.</p>
        </div>
      </div>
    </section>

    <section id="sourcing">
      <div class="panel">
        <div class="flex-space">
          <div>
            <h2>Global Sourcing &amp; Freight Desk</h2>
            <p>Source directly from China&apos;s exporters, sync free tracking feeds, and capture commissions on every confirmed buy.</p>
          </div>
          <button class="secondary" type="button" id="sourcing-snapshot">Update vendor intel</button>
        </div>
        <p class="hint">These partner APIs and affiliate programs include free tiers or referral payouts so you can monetize every order routed through Warehouse HQ.</p>
        <div class="global-sourcing-grid">
          <article class="provider-card" data-provider="alibaba">
            <span class="provider-pill">B2B marketplace · Commission eligible</span>
            <h3>Alibaba.com Open Platform</h3>
            <ul>
              <li>API access for catalog sync, RFQ submission, and escrow ordering.</li>
              <li>Free affiliate links earn on purchases within a 15-day cookie window.</li>
              <li>Integrated logistics quotes via Freightos for door-to-door comparisons.</li>
            </ul>
            <footer>
              <a href="https://developer.alibaba.com/" target="_blank" rel="noopener" class="link-button">API docs</a>
              <a href="https://ads.alibaba.com/en/affiliate" target="_blank" rel="noopener" class="link-button">Affiliate sign-up</a>
            </footer>
          </article>
          <article class="provider-card" data-provider="dhgate">
            <span class="provider-pill">Wholesale · High-commission</span>
            <h3>DHgate Partner Network</h3>
            <ul>
              <li>CSV / feed downloads for apparel, electronics, and lifestyle SKUs.</li>
              <li>Commission up to 60% per converted order with free link tracking.</li>
              <li>Supports low MOQ drops for fast-moving campaigns.</li>
            </ul>
            <footer>
              <a href="https://www.dhgate.com/affiliate" target="_blank" rel="noopener" class="link-button">Affiliate hub</a>
              <a href="https://www.dhgate.com/helpcenter/sellerGuide.html" target="_blank" rel="noopener" class="link-button">Seller guide</a>
            </footer>
          </article>
          <article class="provider-card" data-provider="freight">
            <span class="provider-pill">Freight orchestration · API-first</span>
            <h3>Freightos &amp; Flexport Connectors</h3>
            <ul>
              <li>Instant ocean, air, and trucking quotes with no-cost API usage at booking volume.</li>
              <li>Shipment milestones stream via webhook to power map + mission alerts.</li>
              <li>Revenue share or markup your own freight margin on each confirmed move.</li>
            </ul>
            <footer>
              <a href="https://www.freightos.com/freightos-api/" target="_blank" rel="noopener" class="link-button">Freightos API</a>
              <a href="https://www.flexport.com/developers" target="_blank" rel="noopener" class="link-button">Flexport API</a>
            </footer>
          </article>
        </div>
        <div class="sourcing-actions">
          <p class="hint">Use the buttons above to connect supplier catalogs, affiliate tracking, and multimodal freight.</p>
          <a class="secondary" href="https://ads.alibaba.com/en/affiliate" target="_blank" rel="noopener">Alibaba affiliate portal</a>
          <a class="secondary" href="https://creator.dhgate.com/" target="_blank" rel="noopener">DHgate creator portal</a>
          <a class="secondary" href="https://www.opensky-network.org/apidoc/" target="_blank" rel="noopener">OpenSky Network API</a>
          <a class="secondary" href="https://www.aishub.net/ais_api" target="_blank" rel="noopener">AISHub AIS feed</a>
        </div>
        <form id="supplier-order-form">
          <h3>Log Supplier Purchase</h3>
          <p class="hint">Document the supplier, transport mode, and expected arrival so the mission feed and purchase orders stay aligned.</p>
          <label>Supplier Network
            <select name="vendor" required>
              <option value="Alibaba">Alibaba.com</option>
              <option value="DHgate">DHgate</option>
              <option value="AliExpress">AliExpress</option>
              <option value="Freightos">Freightos Marketplace</option>
              <option value="Flexport">Flexport</option>
            </select>
          </label>
          <label>Cargo Focus
            <input type="text" name="focus" placeholder="Athleisure sets, wireless earbuds, citrus fruit" required />
          </label>
          <label>Freight Mode
            <select name="mode" required>
              <option value="sea">Sea freight</option>
              <option value="air">Air freight</option>
              <option value="rail">Rail (intermodal)</option>
              <option value="truck">Truckload / drayage</option>
            </select>
          </label>
          <label>Expected Arrival
            <input type="date" name="expected" required />
          </label>
          <label>Notes / Reference
            <textarea name="notes" placeholder="RFQ #ALB-2048, FOB Shanghai, pair with Freightos tracking"></textarea>
          </label>
          <button class="cta" type="submit">Log Supplier Purchase</button>
        </form>
        <div>
          <h3>Recent Supplier Orders</h3>
          <ul class="supplier-order-log" id="supplier-order-log">
            <li><span class="hint">No supplier orders logged yet. Submit the form above to create your first entry.</span></li>
          </ul>
        </div>
      </div>
    </section>

    <section id="labor">
      <div class="panel">
        <h2>Teams, Labor & Playbooks</h2>
        <p>Drive productivity with mission-based tasks, performance insights and gamified rewards.</p>
        <div class="grid grid-2">
          <form id="task-form" class="panel light">
            <h3>Assign Task</h3>
            <label>Task Title
              <input type="text" name="title" placeholder="Cycle count Aisle 4" required />
            </label>
            <label>Owner / Team
              <input type="text" name="owner" placeholder="Alicia (Inbound)" />
            </label>
            <label>Type
              <select name="type">
                <option value="Receiving">Receiving</option>
                <option value="Picking">Picking</option>
                <option value="Packing">Packing</option>
                <option value="Cycle Count">Cycle Count</option>
                <option value="QA">QA / Compliance</option>
              </select>
            </label>
            <label>Due Date
              <input type="date" name="dueDate" />
            </label>
            <label>Linked Order / SKU
              <input type="text" name="link" placeholder="WEB-10045 / SKU-ABC-001" />
            </label>
            <button class="cta" type="submit">Dispatch Mission</button>
          </form>

          <div class="panel light">
            <h3>Engagement & Gamification</h3>
            <ul class="list" id="gamification-feed"></ul>
          </div>
        </div>

        <div class="panel">
          <h3>Mission Board</h3>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Owner</th>
                  <th>Type</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tasks-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="settings">
      <div class="panel">
        <h2>Data Governance & Marketplace</h2>
        <p>Control tenant-level settings, integrations and growth modules. All core tooling remains free forever.</p>
        <div class="grid grid-3">
          <div class="summary-tile">
            <h3>Marketplace Builder</h3>
            <p>Curate add-ons à la carte. From $5 barcode packs to $5K autonomous robotics orchestration.</p>
            <button class="cta" type="button" id="open-bundler">Launch Dynamic Bundler</button>
          </div>
          <div class="summary-tile">
            <h3>API & Webhooks</h3>
            <p>REST + GraphQL + EDI. Push real-time events to your stack. Docs ready for dev hand-off.</p>
            <button class="secondary" type="button" onclick="alert('API docs open-source: /public/data/api-spec.json')">Download Spec</button>
          </div>
          <div class="summary-tile">
            <h3>Data Residency</h3>
            <p>US, EU, APAC regions with geo-fenced storage. SOC2 Type II on roadmap.</p>
            <span class="hint">Contact support for dedicated clusters.</span>
          </div>
        </div>
        <div class="panel light" id="bundler" style="display:none;margin-top:1.5rem;">
          <h3>Dynamic Pricing Bundler</h3>
          <p class="hint">Toggle modules to craft the perfect stack. Total adjusts with usage-aware AI guardrails.</p>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Module</th>
                  <th>Description</th>
                  <th>Monthly</th>
                  <th>Add</th>
                </tr>
              </thead>
              <tbody id="bundle-body"></tbody>
            </table>
          </div>
          <div class="flex-space" style="margin-top:1rem;">
            <div>
              <strong>Total Monthly:</strong> <span id="bundle-total">$0</span><br />
              <span class="hint" id="bundle-note"></span>
            </div>
            <button class="cta" type="button" id="checkout-bundle">Checkout via Stripe</button>
          </div>
       </div>
      </div>
    </section>

    <section id="account">
      <div class="panel">
        <h2>Commander Access & Security</h2>
        <p>Log in to sync integrations, personalize the interface, and unlock the RTS-style automations built for your brand.</p>
        <div class="grid grid-2">
          <form id="register-form" class="panel light">
            <h3>Create Command Seat</h3>
            <label>Work Email
              <input type="email" name="email" required placeholder="you@warehouse.com" />
            </label>
            <label>Display Name
              <input type="text" name="name" placeholder="Fleet Captain" />
            </label>
            <label>Password
              <input type="password" name="password" minlength="8" required placeholder="At least 8 characters" />
            </label>
            <label class="mini-input"><input type="checkbox" name="enableTotp" /> Enable authenticator set up right away</label>
            <button class="cta" type="submit">Register &amp; Launch</button>
          </form>

          <form id="login-form" class="panel light">
            <h3>Log In</h3>
            <label>Email
              <input type="email" name="email" required placeholder="you@warehouse.com" />
            </label>
            <label>Password
              <input type="password" name="password" required />
            </label>
            <label>Authenticator Code <span class="hint">Only if you enabled 2FA</span>
              <input type="text" name="totpToken" placeholder="123 456" />
            </label>
            <button class="cta" type="submit">Sign In</button>
          </form>
        </div>
        <div class="account-status" id="account-status">Not signed in.</div>
        <div class="demo-credentials" id="demo-credentials">
          <p><strong>Need quick access?</strong> Use the preloaded demo commander:</p>
          <ul>
            <li>Email: <code data-demo="email">captain@warehouse-hq.com</code></li>
            <li>Password: <code data-demo="password">warehouse-demo</code></li>
            <li>Shopify domain: <code data-demo="shop">warehouse-hq.myshopify.com</code></li>
          </ul>
          <p class="hint">Sign in with the credentials above to load integrations and sync the simulated Shopify workspace.</p>
        </div>
        <div class="account-actions">
          <button class="secondary" type="button" id="logout-btn" style="display:none;">Sign out</button>
        </div>
      </div>

      <div class="panel light" id="totp-panel" style="display:none;">
        <h3>Authenticator Shield</h3>
        <p class="hint">Protect access with a second verification step. Works with Google Authenticator, 1Password, Authy and more.</p>
        <div id="totp-content">
          <button class="cta" type="button" id="enable-totp">Generate authenticator secret</button>
          <p class="hint">Scan the QR code we provide or copy the secret into your authenticator app.</p>
        </div>
      </div>

      <div class="panel">
        <h3>Integration Vault</h3>
        <p>Connect the systems you already use. Paste API keys, set webhooks, or trigger one-click OAuth flows.</p>
        <div class="integrations-grid" id="integration-catalog"></div>
        <div class="panel light" id="integration-form-wrapper" style="display:none;">
          <h4 id="integration-form-title">Connect integration</h4>
          <form id="integration-form">
            <input type="hidden" name="serviceId" id="integration-service-id" />
            <label>Friendly label
              <input type="text" name="label" id="integration-label" placeholder="HQ Shopify North America" />
            </label>
            <label>API key or token
              <input type="text" name="apiKey" id="integration-api-key" placeholder="Paste API key or token" />
            </label>
            <label>Secret / Password
              <input type="text" name="secret" id="integration-secret" placeholder="Optional secret or password" />
            </label>
            <label>Webhook URL (optional)
              <input type="url" name="webhook" id="integration-webhook" placeholder="https://your-domain.com/webhooks/provider" />
            </label>
            <label>Notes for your team
              <textarea name="notes" id="integration-notes" placeholder="Share login context, rate limits, etc."></textarea>
            </label>
            <button class="cta" type="submit">Save integration</button>
          </form>
          <p class="hint" id="integration-form-hint">Use this form for manual keys or fallback credentials. One-click providers finish automatically below.</p>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Service</th>
                <th>Status</th>
                <th>Credentials</th>
                <th>Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="integration-table"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>Brand Lab</h3>
        <p>Make the HQ feel like your own RTS hub. Colors, badges and copy sync across every device once you save.</p>
        <div class="brand-grid">
          <form id="brand-form" class="panel light">
            <label>Accent color
              <input type="color" id="brand-accent" name="accent" value="#38bdf8" />
            </label>
            <label>Background theme
              <select id="brand-background" name="background">
                <option value="nebula">Nebula Grid</option>
                <option value="sunrise">Sunrise Deck</option>
                <option value="midnight">Midnight Ops</option>
                <option value="summit">Summit Frost</option>
              </select>
            </label>
            <label>Call sign headline
              <input type="text" id="brand-call-sign" name="callSign" placeholder="Delco Logistics Fleet" />
            </label>
            <label class="brand-upload">
              <input type="file" id="brand-logo-input" name="logo" accept="image/*" capture="environment" />
              <span class="brand-upload-icon" aria-hidden="true">📸</span>
              <span>
                <strong>Brand logo</strong>
                <small>Snap a fresh badge or pick from your camera roll.</small>
              </span>
            </label>
            <p class="hint brand-upload-hint" id="brand-logo-hint">PNG or JPG up to 2MB (auto-optimized for cloud sync).</p>
            <button type="button" class="link-button" id="brand-logo-clear">Remove logo</button>
            <button class="cta" type="submit">Save brand preset</button>
            <p class="hint">Brand presets persist locally and, when signed in, sync to the cloud for your whole squad.</p>
          </form>
          <div class="brand-preview" id="brand-preview">
            <div class="preview-hero" id="brand-preview-title">Warehouse HQ</div>
            <div class="preview-card">
              <div id="brand-preview-badge" class="badge-emoji" aria-hidden="true">
                <img id="brand-preview-logo" alt="Brand logo preview" hidden />
                <span id="brand-preview-fallback">🚚</span>
              </div>
              <div class="mini-input" id="brand-preview-caption">Personalized ops skin active • Warehouse HQ</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel light">
        <h3>Report an Issue</h3>
        <p>Our OpenAI co-pilot guides the report and launches an email to rb@dreamworld.co so nothing gets lost in transit.</p>
        <form id="support-form">
          <label>Subject
            <input type="text" name="subject" required placeholder="Packing station tablet offline" />
          </label>
          <label>Category
            <select name="category">
              <option value="inventory">Inventory &amp; slotting</option>
              <option value="orders">Orders &amp; fulfillment</option>
              <option value="integrations">Integrations</option>
              <option value="billing">Billing</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>Description
            <textarea name="description" required placeholder="Share what happened, any order IDs, and when you noticed it."></textarea>
          </label>
          <label>Your email (for updates)
            <input type="email" name="email" placeholder="you@warehouse.com" />
          </label>
          <button class="cta" type="submit">Send report</button>
        </form>
        <div id="support-response" class="support-response" style="display:none;"></div>
        <div id="support-reward" class="reward-badge" role="status" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <small>Warehouse HQ is a free-to-use command center. Export your data anytime, integrate with your existing tech stack, and upgrade only when you&apos;re ready for more automation.</small>
    </div>
  </footer>


  <div class="toast" id="toast"></div>
  <div class="oauth-overlay" id="oauth-overlay" hidden aria-hidden="true">
    <div class="oauth-dialog" role="status" aria-live="polite">
      <div class="oauth-spinner" aria-hidden="true"></div>
      <div>
        <h4 id="oauth-heading">Connecting…</h4>
        <p id="oauth-subheading">Authorizing secure access to your provider.</p>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'warehouse-hq-state-v1';
    const state = loadState();
    const warehouseSelects = ['item-warehouse', 'order-warehouse', 'receipt-warehouse', 'cycle-warehouse'];
    const AUTH_KEY = 'warehouse-hq-auth-v1';
    const DEMO_EMAIL = 'captain@warehouse-hq.com';
    const DEMO_PASSWORD = 'warehouse-demo';
    const DEMO_SHOP_DOMAIN = 'warehouse-hq.myshopify.com';
    let authState = loadAuth();
    let integrationCatalog = [];
    let integrationRows = [];
    const chartInstances = {};
    const SHOPIFY_SYNC_CACHE_MS = 5 * 60 * 1000;
    const SHOPIFY_SERVICE_ID = 'shopify';
    const shopifySyncState = { loading: false, lastAttempt: 0 };
    const shopifyCsvBuffer = { inventory: [], products: [] };
    const BRAND_LOGO_MAX_LENGTH = 240000; // ~180KB payload cap for safe API uploads
    const MANUAL_FORM_HINT = 'Use this form for manual keys or fallback credentials. One-click providers finish automatically below.';
    const integrationFormHint = document.getElementById('integration-form-hint');
    const HEX_COLOR_REGEX = /^#(?:[0-9a-f]{3}|[0-9a-f]{6})$/i;
    let lastInventoryRows = [];
    const SCAN_CHANNEL_NAME = 'warehouse-hq-scan';
    const SCAN_STORAGE_EVENT_KEY = 'warehouse-hq-scan-payload';
    const SCAN_QUEUE_KEY = 'warehouse-hq-scan-queue';
    const processedScanIds = new Set();
    if (integrationFormHint) {
      integrationFormHint.textContent = MANUAL_FORM_HINT;
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          if (!data.branding) {
            data.branding = seedState().branding;
          }
          if (!Array.isArray(data.items)) data.items = [];
          data.items.forEach(item => {
            item.color = sanitizeColor(item.color);
          });
          if (!Array.isArray(data.collections)) data.collections = [];
          if (!Array.isArray(data.giftCards)) data.giftCards = [];
          if (!Array.isArray(data.purchaseOrders)) data.purchaseOrders = [];
          if (!Array.isArray(data.transfers)) data.transfers = [];
          if (!Array.isArray(data.shopifyWarnings)) data.shopifyWarnings = [];
          if (!('lastShopifySync' in data)) data.lastShopifySync = null;
          if (!('lastShopifySyncSource' in data)) data.lastShopifySyncSource = null;
          return data;
        }
      } catch (err) {
        console.warn('Failed to load state', err);
      }
      return seedState();
    }

    function loadScanQueue() {
      try {
        const raw = localStorage.getItem(SCAN_QUEUE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.filter(item => item && typeof item === 'object');
      } catch (err) {
        console.warn('Failed to load buffered scans', err);
        return [];
      }
    }

    function saveScanQueue(queue) {
      try {
        if (queue && queue.length) {
          localStorage.setItem(SCAN_QUEUE_KEY, JSON.stringify(queue));
        } else {
          localStorage.removeItem(SCAN_QUEUE_KEY);
        }
      } catch (err) {
        console.warn('Failed to persist scan queue', err);
      }
    }

    function loadAuth(){
      try {
        const raw = localStorage.getItem(AUTH_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.token && parsed.user) {
            return parsed;
          }
        }
      } catch (err){
        console.warn('Failed to load auth state', err);
      }
      return { token: null, user: null };
    }

    function sanitizeColor(value) {
      if (typeof value !== 'string') return '';
      const trimmed = value.trim();
      if (!HEX_COLOR_REGEX.test(trimmed)) return '';
      if (trimmed.length === 4) {
        const expanded = trimmed
          .slice(1)
          .split('')
          .map(ch => ch + ch)
          .join('');
        return `#${expanded.toLowerCase()}`;
      }
      return trimmed.toLowerCase();
    }

    function acknowledgeScanPayload(payload = {}) {
      const id = payload && typeof payload === 'object' ? payload.id : null;
      if (!id) return;
      try {
        const queue = loadScanQueue();
        if (!queue.length) return;
        const next = queue.filter(item => item && item.id !== id);
        if (next.length !== queue.length) {
          saveScanQueue(next);
        }
      } catch (err) {
        console.warn('Failed to acknowledge buffered scan', err);
      }
    }

    function drainStoredScanQueue() {
      const queue = loadScanQueue();
      if (!queue.length) return;
      const ordered = queue
        .slice()
        .sort((a, b) => (Number(a?.timestamp) || 0) - (Number(b?.timestamp) || 0));
      ordered.forEach(payload => {
        try {
          processScannerPayload(payload, { announce: false });
        } catch (err) {
          console.warn('Failed to apply buffered scan payload', err);
        }
      });
    }

    function isAuthenticated(){
      return Boolean(authState?.token && authState?.user);
    }

    function persistAuth(){
      try {
        localStorage.setItem(AUTH_KEY, JSON.stringify(authState));
      } catch (err){
        console.warn('Failed to persist auth', err);
      }
    }

    function seedState() {
      const now = new Date().toISOString();
          return {
        generatedAt: now,
        warehouses: [
          { id: crypto.randomUUID(), name: 'Delco Fulfillment East', type: 'Fulfillment Center', capacity: 1200, notes: 'Philadelphia, PA – robotics ready' },
          { id: crypto.randomUUID(), name: 'SoCal Climate Hub', type: 'Cold Storage', capacity: 600, notes: 'Los Angeles, CA – FEFO picking enforced' }
        ],
        items: [],
        orders: [],
        receipts: [],
        shipments: [],
        returns: [],
        collections: [],
        purchaseOrders: [],
        transfers: [],
        giftCards: [],
        shopifyWarnings: [],
        lastShopifySync: null,
        lastShopifySyncSource: null,
        tasks: [],
        gamification: [
          { id: crypto.randomUUID(), message: '🏅 Team Inbound earned "5-Star Receiver" for 99.6% accuracy this week.' },
          { id: crypto.randomUUID(), message: '🚀 Picking squad unlocked Rush Wave Boost after meeting SLA five days straight.' }
        ],
        branding: {
          accent: '#38bdf8',
          background: 'nebula',
          callSign: 'Warehouse HQ',
          emoji: '🚚',
          logoData: '',
        }
      };
    }

    function persist() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (err) {
        console.warn('Failed to persist state', err);
      }
    }

    function syncState(nextState) {
      if (!nextState || typeof nextState !== 'object') {
        return;
      }
      const keys = new Set([...Object.keys(state), ...Object.keys(nextState)]);
      keys.forEach(key => {
        if (Object.prototype.hasOwnProperty.call(nextState, key)) {
          state[key] = nextState[key];
        } else {
          delete state[key];
        }
      });
    }

    function hexToRgba(hex, alpha) {
      const clean = hex.replace('#', '');
      if (clean.length !== 6) return `rgba(56,189,248,${alpha})`;
      const r = parseInt(clean.slice(0, 2), 16);
      const g = parseInt(clean.slice(2, 4), 16);
      const b = parseInt(clean.slice(4, 6), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function applyBranding() {
      const branding = state.branding || {};
      const accent = branding.accent || '#38bdf8';
      document.documentElement.style.setProperty('--accent', accent);
      document.documentElement.style.setProperty('--accent-soft', hexToRgba(accent, 0.18));
      document.documentElement.style.setProperty('--accent-strong', hexToRgba(accent, 0.36));
      document.documentElement.style.setProperty('--accent-border', hexToRgba(accent, 0.6));

      const theme = branding.background || 'nebula';
      const body = document.body;
      if (theme === 'sunrise') {
        body.style.background = 'radial-gradient(circle at top, rgba(255, 140, 66, 0.18), transparent 55%), radial-gradient(circle at 80% 20%, rgba(255, 203, 105, 0.18), transparent 60%), #0f172a';
      } else if (theme === 'midnight') {
        body.style.background = 'radial-gradient(circle at top, rgba(56, 189, 248, 0.08), transparent 45%), radial-gradient(circle at center, rgba(12, 74, 110, 0.18), transparent 65%), #020617';
      } else if (theme === 'summit') {
        body.style.background = 'radial-gradient(circle at top, rgba(148, 163, 184, 0.15), transparent 50%), radial-gradient(circle at 30% 70%, rgba(226, 232, 240, 0.1), transparent 65%), #0f172a';
      } else {
        body.style.background = 'radial-gradient(circle at top, rgba(56, 189, 248, 0.12), transparent 55%), radial-gradient(circle at center, rgba(14, 116, 144, 0.1), transparent 65%), radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.12), transparent 70%), #020617';
      }

      const callSign = branding.callSign || 'Warehouse HQ';
      const emoji = branding.emoji || '🚚';
      const logoData = branding.logoData || '';
      const hasLogo = Boolean(logoData);
      const previewTitle = document.getElementById('brand-preview-title');
      if (previewTitle) previewTitle.textContent = callSign;
      const previewBadge = document.getElementById('brand-preview-badge');
      const previewLogo = document.getElementById('brand-preview-logo');
      const previewFallback = document.getElementById('brand-preview-fallback');
      if (previewBadge) {
        previewBadge.dataset.hasLogo = hasLogo ? 'true' : 'false';
      }
      if (previewLogo) {
        if (hasLogo) {
          previewLogo.src = logoData;
          previewLogo.alt = `${callSign} logo preview`;
          previewLogo.hidden = false;
        } else {
          previewLogo.hidden = true;
          previewLogo.removeAttribute('src');
        }
      }
      if (previewFallback) {
        previewFallback.textContent = emoji;
      }
      const previewCaption = document.getElementById('brand-preview-caption');
      if (previewCaption) {
        previewCaption.textContent = `Personalized ops skin active • ${callSign}`;
      }

      const headerHeading = document.getElementById('brand-heading');
      if (headerHeading) {
        headerHeading.textContent = callSign;
      }
      const headerLogoShell = document.getElementById('brand-logo-shell');
      const headerLogo = document.getElementById('brand-logo-display');
      if (headerLogoShell && headerLogo) {
        if (hasLogo) {
          headerLogo.src = logoData;
          headerLogo.alt = `${callSign} logo`;
          headerLogoShell.hidden = false;
        } else {
          headerLogo.src = '';
          headerLogo.alt = 'Brand logo';
          headerLogoShell.hidden = true;
        }
      }

      const highlightBadge = document.getElementById('brand-highlight-badge');
      const highlightLogo = document.getElementById('brand-highlight-logo');
      const highlightEmoji = document.getElementById('brand-highlight-emoji');
      const highlightName = document.getElementById('brand-highlight-name');
      const highlightHint = document.getElementById('brand-highlight-hint');

      if (highlightBadge) {
        highlightBadge.dataset.hasLogo = hasLogo ? 'true' : 'false';
      }
      if (highlightLogo) {
        if (hasLogo) {
          highlightLogo.src = logoData;
          highlightLogo.alt = `${callSign} logo spotlight`;
          highlightLogo.hidden = false;
        } else {
          highlightLogo.removeAttribute('src');
          highlightLogo.alt = '';
          highlightLogo.hidden = true;
        }
      }
      if (highlightEmoji) {
        highlightEmoji.textContent = emoji;
        highlightEmoji.hidden = hasLogo;
      }
      if (highlightName) {
        highlightName.textContent = callSign;
      }
      if (highlightHint) {
        highlightHint.textContent = hasLogo
          ? 'Logo connected across command center experiences.'
          : 'Upload your company logo in Data & Settings → Branding to personalize this hub.';
      }

      const callSignInput = document.getElementById('brand-call-sign');
      if (callSignInput && callSignInput.value !== callSign) {
        callSignInput.value = callSign;
      }
      const accentInput = document.getElementById('brand-accent');
      if (accentInput && accentInput.value !== accent) {
        accentInput.value = accent;
      }
      const logoHint = document.getElementById('brand-logo-hint');
      if (logoHint) {
        logoHint.textContent = logoData ? 'Logo active. Tap upload to replace or remove.' : 'PNG, JPG, or SVG up to 2MB.';
      }
      const logoClearBtn = document.getElementById('brand-logo-clear');
      if (logoClearBtn) {
        logoClearBtn.style.display = logoData ? 'inline-flex' : 'none';
      }
      const backgroundSelect = document.getElementById('brand-background');
      if (backgroundSelect && backgroundSelect.value !== theme) {
        backgroundSelect.value = theme;
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return dateStr;
      return date.toLocaleDateString();
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '—';
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return dateStr;
      return date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value).replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[char]);
    }

    function buildStickerCard(item) {
      const quantity = Number(item.quantity) || 0;
      const reorder = Number(item.reorder) || 0;
      const status = quantity <= reorder
        ? 'Reorder'
        : quantity < reorder * 1.5
          ? 'Monitor'
          : 'Healthy';
      const expiry = item.expiry ? formatDate(item.expiry) : '—';
      const warehouseName = getWarehouseName(item.warehouseId);
      const location = item.location || '—';
      const lot = item.lot || '—';
      const category = item.category || '—';
      const variant = item.variant ? `<div class="sticker-variant">${escapeHtml(item.variant)}</div>` : '';
      return `
        <section class="sticker">
          <div class="sticker-top">
            <span class="sticker-sku">${escapeHtml(item.sku)}</span>
            <span class="sticker-warehouse">${escapeHtml(warehouseName)}</span>
          </div>
          <div class="sticker-name">${escapeHtml(item.name || item.sku)}</div>
          ${variant}
          <div class="sticker-meta"><span><strong>Bin</strong> ${escapeHtml(location)}</span><span><strong>Qty</strong> ${escapeHtml(quantity)}</span></div>
          <div class="sticker-meta"><span><strong>Lot</strong> ${escapeHtml(lot)}</span><span><strong>Exp</strong> ${escapeHtml(expiry)}</span></div>
          <div class="sticker-meta"><span><strong>Category</strong> ${escapeHtml(category)}</span><span><strong>Status</strong> ${escapeHtml(status)}</span></div>
          <div class="sticker-barcode" aria-hidden="true">${escapeHtml(item.sku)}</div>
        </section>
      `;
    }

    function openStickerPrint(items) {
      const printableItems = (items || []).filter(Boolean);
      if (!printableItems.length) {
        showToast('No stickers to print. Adjust your filters and try again.');
        return;
      }
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        alert('Please enable pop-ups to print stickers.');
        return;
      }
      const callSign = state.branding?.callSign || 'Warehouse HQ';
      const printedAt = new Date().toLocaleString();
      const safeCallSign = escapeHtml(callSign);
      const safePrintedAt = escapeHtml(printedAt);
      const stickerCount = printableItems.length;
      const stickerLabel = stickerCount === 1 ? 'SKU' : 'SKUs';
      const stickersHtml = printableItems.map(buildStickerCard).join('');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>${safeCallSign} Stickers</title>
            <style>
              *, *::before, *::after { box-sizing: border-box; }
              @page { margin: 0.5in; }
              body {
                margin: 0;
                font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                background: #ffffff;
                color: #0f172a;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
              }
              .print-header {
                padding: 1.25rem 1.5rem 0;
              }
              .print-header h1 {
                margin: 0;
                font-size: 1.35rem;
              }
              .print-header p {
                margin: 0.25rem 0 0;
                color: #475569;
                font-size: 0.9rem;
              }
              .sticker-sheet {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 0.75rem;
                padding: 1rem 1.5rem 1.5rem;
              }
              .sticker {
                border: 1px dashed #94a3b8;
                border-radius: 0.75rem;
                padding: 0.85rem 0.9rem;
                display: flex;
                flex-direction: column;
                gap: 0.45rem;
                min-height: 180px;
              }
              .sticker-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: #1e293b;
              }
              .sticker-name {
                font-size: 1.1rem;
                font-weight: 600;
                color: #0f172a;
              }
              .sticker-variant {
                font-size: 0.9rem;
                color: #334155;
              }
              .sticker-meta {
                display: flex;
                justify-content: space-between;
                gap: 0.75rem;
                font-size: 0.8rem;
                color: #475569;
              }
              .sticker-meta strong {
                font-weight: 600;
                color: #1e293b;
                margin-right: 0.25rem;
              }
              .sticker-barcode {
                margin-top: auto;
                padding-top: 0.6rem;
                border-top: 1px dashed #cbd5f5;
                font-family: 'Courier New', Courier, monospace;
                letter-spacing: 0.3em;
                font-size: 0.95rem;
                text-align: center;
                color: #1f2937;
              }
            </style>
          </head>
          <body>
            <header class="print-header">
              <h1>${safeCallSign} Stickers</h1>
              <p>Printed ${safePrintedAt} • ${stickerCount} ${stickerLabel}</p>
            </header>
            <main class="sticker-sheet">
              ${stickersHtml}
            </main>
            <script>
              window.addEventListener('load', () => {
                window.focus();
                window.print();
              });
              window.addEventListener('afterprint', () => window.close());
            </scr` + `ipt>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2600);
    }

    function showOauthOverlay(title, message) {
      const overlay = document.getElementById('oauth-overlay');
      const heading = document.getElementById('oauth-heading');
      const subheading = document.getElementById('oauth-subheading');
      if (!overlay) return;
      if (heading && title) heading.textContent = title;
      if (subheading && message) subheading.textContent = message;
      overlay.hidden = false;
      overlay.setAttribute('aria-hidden', 'false');
    }

    function updateOauthOverlay(message) {
      const subheading = document.getElementById('oauth-subheading');
      if (subheading && message) {
        subheading.textContent = message;
      }
    }

    function hideOauthOverlay() {
      const overlay = document.getElementById('oauth-overlay');
      if (!overlay) return;
      overlay.hidden = true;
      overlay.setAttribute('aria-hidden', 'true');
    }

    (function registerOauthOverlayDismiss(){
      const overlay = document.getElementById('oauth-overlay');
      if (!overlay) return;
      overlay.addEventListener('click', evt => {
        if (evt.target === overlay) {
          hideOauthOverlay();
        }
      });
      document.addEventListener('keydown', evt => {
        if (evt.key === 'Escape') {
          hideOauthOverlay();
        }
      });
    })();

    function wait(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    const OAUTH_TIMEOUT_MS = 15000;

    async function fetchWithTimeout(resource, options = {}) {
      const { timeout = OAUTH_TIMEOUT_MS, ...rest } = options;
      if (typeof AbortController === 'undefined') {
        return fetch(resource, rest);
      }
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        return await fetch(resource, { ...rest, signal: controller.signal });
      } catch (err) {
        if (err.name === 'AbortError') {
          const timeoutError = new Error('timeout');
          timeoutError.code = 'timeout';
          throw timeoutError;
        }
        throw err;
      } finally {
        clearTimeout(id);
      }
    }

    function generateDemoToken(prefix) {
      return `${prefix}-${Math.random().toString(36).slice(2, 8)}-${Date.now().toString(36)}`;
    }

    function normalizeShopDomain(input) {
      if (!input) return '';
      return String(input)
        .trim()
        .replace(/^https?:\/\//i, '')
        .replace(/\/.*$/, '')
        .toLowerCase();
    }

    function friendlyIntegrationStatus(status = '') {
      const map = {
        oauth_pending: 'Awaiting authorization',
        oauth_linked: 'Connected',
        credentials_saved: 'Credentials stored',
        demo_seeded: 'Demo ready',
        connected: 'Connected'
      };
      return map[status] || status;
    }

    function getWarehouseName(id) {
      const warehouse = state.warehouses.find(w => w.id === id);
      return warehouse ? warehouse.name : 'Unassigned';
    }

    function getItemColor(item) {
      if (!item) return '';
      const color = sanitizeColor(item.color);
      if (color !== (item.color || '')) {
        item.color = color;
      }
      return color;
    }

    function getInventoryStatusMeta(item) {
      const quantity = Number(item?.quantity) || 0;
      const reorder = Number(item?.reorder) || 0;
      if (quantity <= reorder) {
        return { label: 'Reorder', className: 'low', priority: 0 };
      }
      if (quantity < reorder * 1.5) {
        return { label: 'Monitor', className: 'risk', priority: 1 };
      }
      return { label: 'Healthy', className: 'ok', priority: 2 };
    }

    function inventoryComparator(a, b, mode = 'sku') {
      if (mode === 'qty') {
        const diff = (Number(b.quantity) || 0) - (Number(a.quantity) || 0);
        if (diff !== 0) return diff;
      } else if (mode === 'status') {
        const diff = getInventoryStatusMeta(a).priority - getInventoryStatusMeta(b).priority;
        if (diff !== 0) return diff;
      } else if (mode === 'color') {
        const colorA = getItemColor(a);
        const colorB = getItemColor(b);
        if (colorA && !colorB) return -1;
        if (!colorA && colorB) return 1;
        if (colorA && colorB) {
          const colorDiff = colorA.localeCompare(colorB);
          if (colorDiff !== 0) return colorDiff;
        }
      }
      return a.sku.localeCompare(b.sku);
    }

    function findOrCreateItem({ sku, name = '', variant = '', category = '' }) {
      let item = state.items.find(it => it.sku.toLowerCase() === sku.toLowerCase());
      if (!item) {
        item = {
          id: crypto.randomUUID(),
          sku,
          name: name || sku,
          variant,
          category,
          warehouseId: state.warehouses[0]?.id || '',
          location: '',
          quantity: 0,
          reorder: 0,
          lot: '',
          expiry: '',
          unitCost: 0,
          color: ''
        };
        state.items.push(item);
      }
      return item;
    }

    function updateWarehouseSelects() {
      const options = state.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
      warehouseSelects.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.innerHTML = '<option value="">Select…</option>' + options;
        }
      });
      const filter = document.getElementById('warehouse-filter');
      if (filter) {
        filter.innerHTML = '<option value="all">All warehouses</option>' + state.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
      }
    }

    function renderInventory() {
      const tbody = document.getElementById('inventory-body');
      const searchInput = document.getElementById('inventory-search');
      const search = (searchInput ? searchInput.value : '').toLowerCase();
      const warehouseFilter = document.getElementById('warehouse-filter').value;
      const sortSelect = document.getElementById('inventory-sort');
      const sortMode = sortSelect ? sortSelect.value : 'sku';
      tbody.innerHTML = '';
      const rows = state.items
        .filter(item => {
          const matchesSearch = [item.sku, item.name, item.variant, item.lot].some(val => (val || '').toLowerCase().includes(search));
          const matchesWarehouse = warehouseFilter === 'all' || warehouseFilter === '' || item.warehouseId === warehouseFilter;
          return matchesSearch && matchesWarehouse;
        })
        .sort((a, b) => inventoryComparator(a, b, sortMode));
      lastInventoryRows = rows.slice();
      rows.forEach(item => {
        const statusMeta = getInventoryStatusMeta(item);
        const status = `<span class="tag ${statusMeta.className}">${statusMeta.label}</span>`;
        const color = getItemColor(item);
        const colorChip = color
          ? `<span class="color-chip" style="--chip-color:${color}" aria-hidden="true"></span><span class="sr-only">Color lane ${color}</span>`
          : '';
        const tr = document.createElement('tr');
        if (color) {
          tr.classList.add('colorized');
          tr.style.setProperty('--row-color', color);
          tr.dataset.color = color;
        }
        tr.innerHTML = `
          <td><strong>${item.sku}</strong><br><span class="hint">${item.category || '—'}</span></td>
          <td>
            <div class="product-label">
              ${colorChip}
              <div>
                ${item.name}
                <br><span class="hint">${item.variant || ''}</span>
              </div>
            </div>
          </td>
          <td>${getWarehouseName(item.warehouseId)}</td>
          <td>${item.location || '—'}</td>
          <td>${item.quantity}</td>
          <td>${item.reorder}</td>
          <td>${item.lot || '—'}<br><span class="hint">${item.expiry ? formatDate(item.expiry) : ''}</span></td>
          <td>${status}</td>
          <td class="actions"><button type="button" class="print-sticker-btn" data-id="${item.id}" title="Print sticker" aria-label="Print sticker">Print</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderOrders() {
      const tbody = document.getElementById('order-body');
      const filter = document.getElementById('order-status-filter').value;
      tbody.innerHTML = '';
      state.orders
        .filter(order => filter === 'all' || order.status === filter)
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach(order => {
          const lines = order.lines.map(line => `${line.sku} × ${line.qty}`).join('<br>');
          const statusClass = `status-${order.status}`;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${order.orderId}</strong><br><span class="hint">${order.customer || '—'}</span></td>
            <td>${getWarehouseName(order.warehouseId)}</td>
            <td>${lines}</td>
            <td>${formatDate(order.dueDate)}</td>
            <td><span class="status-pill ${statusClass}">${order.status}</span></td>
            <td>${order.progress}%</td>
            <td class="actions">
              <button data-action="advance" data-id="${order.id}">Advance</button>
              <button data-action="cancel" data-id="${order.id}">Cancel</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    function renderReceipts() {
      const tbody = document.getElementById('receipts-body');
      tbody.innerHTML = '';
      state.receipts.slice().reverse().forEach(receipt => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(receipt.date)}</td>
          <td>${receipt.reference || '—'}</td>
          <td>${getWarehouseName(receipt.warehouseId)}</td>
          <td>${receipt.sku}</td>
          <td>${receipt.quantity}</td>
          <td>${receipt.location || '—'}</td>
          <td>${receipt.lot || '—'}<br><span class="hint">${receipt.expiry ? formatDate(receipt.expiry) : ''}</span></td>
          <td>${receipt.notes || '—'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderShipments() {
      const tbody = document.getElementById('shipments-body');
      tbody.innerHTML = '';
      state.shipments.slice().reverse().forEach(shipment => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(shipment.date)}</td>
          <td>${shipment.orderId}</td>
          <td>${shipment.carrier || '—'}</td>
          <td>${shipment.tracking || '—'}</td>
          <td>${shipment.packages || 1}</td>
          <td>${shipment.cost ? '$' + shipment.cost.toFixed(2) : '—'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderReturns() {
      const tbody = document.getElementById('returns-body');
      tbody.innerHTML = '';
      state.returns.slice().reverse().forEach(ret => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(ret.date)}</td>
          <td>${ret.orderId || '—'}</td>
          <td>${ret.sku || '—'}</td>
          <td>${ret.quantity}</td>
          <td>${ret.reason}</td>
          <td>${ret.disposition}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderTasks() {
      const tbody = document.getElementById('tasks-body');
      tbody.innerHTML = '';
      state.tasks.slice().reverse().forEach(task => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${task.title}<br><span class="hint">${task.link || ''}</span></td>
          <td>${task.owner || '—'}</td>
          <td>${task.type}</td>
          <td>${formatDate(task.dueDate)}</td>
          <td><span class="status-pill status-${task.status}">${task.status}</span></td>
          <td class="actions">
            <button data-action="progress-task" data-id="${task.id}">Advance</button>
            <button data-action="close-task" data-id="${task.id}">Complete</button>
          </td>
        `;
      tbody.appendChild(tr);
    });
    const feed = document.getElementById('gamification-feed');
    feed.innerHTML = state.gamification.map(entry => `<li>${entry.message}</li>`).join('');
  }

    function addGamificationEvent(message) {
      if (!message) return;
      state.gamification.unshift({ id: crypto.randomUUID(), message });
      if (state.gamification.length > 20) {
        state.gamification = state.gamification.slice(0, 20);
      }
      renderTasks();
    }

    function renderStats() {
      const totalSkus = state.items.length;
      const totalUnits = state.items.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
      const lowStock = state.items.filter(item => item.quantity <= (item.reorder || 0)).length;
      const openOrders = state.orders.filter(o => ['open', 'picking', 'packed'].includes(o.status)).length;
      const shippedOrders = state.orders.filter(o => o.status === 'shipped').length;
      const returnsRate = shippedOrders ? Math.round((state.returns.length / shippedOrders) * 100) : 0;
      const statCards = [
        { title: 'Active SKUs', value: totalSkus, meta: 'Variants live across your network.' },
        { title: 'Units on Hand', value: totalUnits, meta: 'Aggregate across all facilities.' },
        { title: 'Below Reorder', value: lowStock, meta: 'Automate purchase plans to stay ahead.' },
        { title: 'Open Orders', value: openOrders, meta: 'Includes picking, packing & staging.' },
        { title: 'Return Rate', value: returnsRate + '%', meta: 'Rolling ratio of returns vs shipped.' }
      ];
      const container = document.getElementById('stat-cards');
      container.innerHTML = statCards.map(card => `
        <div class="stat-card">
          <h3>${card.title}</h3>
          <strong>${card.value}</strong>
          <div class="stat-meta">${card.meta}</div>
        </div>
      `).join('');

      const health = document.getElementById('order-health');
      health.innerHTML = state.orders.slice(0, 5).map(order => {
        const due = order.dueDate ? new Date(order.dueDate) : null;
        const now = new Date();
        let status = 'On track';
        if (due && due.getTime() < now.getTime() && order.status !== 'shipped') status = '⚠️ Past due';
        if (order.priority === 'Rush' && order.status === 'open') status = '🚀 Rush: assign picker';
        return `<li><strong>${order.orderId}</strong> → ${status}</li>`;
      }).join('');

      const priorities = document.getElementById('priority-list');
      const missions = [];
      if (lowStock > 0) missions.push('Trigger replenishment for low stock SKUs.');
      if (openOrders > 0) missions.push('Wave plan next picking batch to hit SLA.');
      if (!missions.length) missions.push('All clear! Review analytics or schedule a cycle count.');
      priorities.innerHTML = missions.map(m => `<li>${m}</li>`).join('');

      renderCharts();
    }

    function renderCollections() {
      const tbody = document.getElementById('collections-body');
      const count = document.getElementById('collections-count');
      if (!tbody) return;
      const rows = Array.isArray(state.collections) ? state.collections : [];
      if (count) {
        count.textContent = rows.length ? `${rows.length} collections` : 'No collections';
      }
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="4"><span class="hint">No collections synced yet.</span></td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(row => {
        const type = row.type ? row.type.charAt(0).toUpperCase() + row.type.slice(1) : '—';
        return `
          <tr>
            <td><strong>${row.title || 'Untitled'}</strong><br><span class="hint">${row.handle || ''}</span></td>
            <td>${type}</td>
            <td>${row.productsCount ?? '—'}</td>
            <td>${row.updatedAt ? formatDate(row.updatedAt) : '—'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderGiftCards() {
      const tbody = document.getElementById('gift-cards-body');
      const count = document.getElementById('gift-cards-count');
      if (!tbody) return;
      const cards = Array.isArray(state.giftCards) ? state.giftCards : [];
      if (count) {
        count.textContent = cards.length ? `${cards.length} cards` : 'No gift cards';
      }
      if (!cards.length) {
        tbody.innerHTML = '<tr><td colspan="4"><span class="hint">No gift cards available.</span></td></tr>';
        return;
      }
      const now = Date.now();
      tbody.innerHTML = cards.map(card => {
        const balanceNum = Number(card.balance);
        const balance = Number.isFinite(balanceNum) ? `$${balanceNum.toFixed(2)} ${card.currency || 'USD'}` : '—';
        const expires = card.expiresOn ? new Date(card.expiresOn).getTime() : null;
        let status = 'Active';
        if (card.disabledAt) status = 'Disabled';
        else if (expires && expires < now) status = 'Expired';
        return `
          <tr>
            <td>${card.lastCharacters ? `•••• ${card.lastCharacters}` : '—'}<br><span class="hint">${card.createdAt ? formatDate(card.createdAt) : ''}</span></td>
            <td>${balance}</td>
            <td>${card.customerEmail || '—'}</td>
            <td>${status}</td>
          </tr>
        `;
      }).join('');
    }

    function renderPurchaseOrders() {
      const tbody = document.getElementById('purchase-orders-body');
      const count = document.getElementById('purchase-orders-count');
      if (!tbody) return;
      const orders = Array.isArray(state.purchaseOrders) ? state.purchaseOrders : [];
      if (count) {
        count.textContent = orders.length ? `${orders.length} POs` : 'No purchase orders';
      }
      if (!orders.length) {
        tbody.innerHTML = '<tr><td colspan="5"><span class="hint">No purchase orders synced.</span></td></tr>';
        return;
      }
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td><strong>${order.name || 'PO'}</strong><br><span class="hint">${order.createdAt ? formatDate(order.createdAt) : ''}</span></td>
          <td>${order.vendor || '—'}</td>
          <td>${order.expectedAt ? formatDate(order.expectedAt) : '—'}</td>
          <td>${order.status || '—'}</td>
          <td>${order.lineCount ?? '—'}</td>
        </tr>
      `).join('');
      renderSupplierOrders();
    }

    function renderSupplierOrders() {
      const list = document.getElementById('supplier-order-log');
      if (!list) return;
      const orders = Array.isArray(state.purchaseOrders) ? state.purchaseOrders.slice().reverse() : [];
      if (!orders.length) {
        list.innerHTML = '<li><span class="hint">No supplier orders logged yet. Submit the form above to create your first entry.</span></li>';
        return;
      }
      const modeLabels = {
        sea: 'Sea freight',
        air: 'Air freight',
        rail: 'Rail / intermodal',
        truck: 'Trucking'
      };
      list.innerHTML = orders.slice(0, 6).map(order => {
        const eta = order.expectedAt ? formatDate(order.expectedAt) : 'TBD';
        const created = order.createdAt ? formatDateTime(order.createdAt) : '';
        const mode = modeLabels[order.mode] || 'Multimodal';
        const focus = order.focus || order.description || 'Mixed cargo';
        const notes = order.notes ? order.notes : '';
        return `
          <li data-mode="${order.mode || 'sea'}">
            <strong>${order.vendor || 'Supplier'} → ${focus}</strong>
            <span>Freight: ${mode} · ETA ${eta}</span>
            ${created ? `<span>Logged ${created}</span>` : ''}
            ${notes ? `<span>${notes}</span>` : ''}
          </li>
        `;
      }).join('');
    }

    function renderTransfers() {
      const tbody = document.getElementById('transfers-body');
      const count = document.getElementById('transfers-count');
      if (!tbody) return;
      const transfers = Array.isArray(state.transfers) ? state.transfers : [];
      if (count) {
        count.textContent = transfers.length ? `${transfers.length} transfers` : 'No transfers';
      }
      if (!transfers.length) {
        tbody.innerHTML = '<tr><td colspan="5"><span class="hint">No transfers synced.</span></td></tr>';
        return;
      }
      tbody.innerHTML = transfers.map(transfer => {
        const route = [transfer.source, transfer.destination].filter(Boolean).join(' → ') || '—';
        return `
          <tr>
            <td><strong>${transfer.reference || 'Transfer'}</strong><br><span class="hint">${transfer.createdAt ? formatDate(transfer.createdAt) : ''}</span></td>
            <td>${route}</td>
            <td>${transfer.expectedArrival ? formatDate(transfer.expectedArrival) : '—'}</td>
            <td>${transfer.status || '—'}</td>
            <td>${transfer.lineCount ?? '—'}</td>
          </tr>
        `;
      }).join('');
    }

    function renderShopifyWarnings() {
      const panel = document.getElementById('shopify-warnings');
      if (!panel) return;
      const warnings = Array.isArray(state.shopifyWarnings) ? state.shopifyWarnings.filter(Boolean) : [];
      if (!warnings.length) {
        panel.style.display = 'none';
        panel.textContent = '';
        return;
      }
      panel.textContent = '';
      warnings.forEach(message => {
        const row = document.createElement('div');
        row.className = 'shopify-logo-pill';
        row.textContent = message;
        panel.appendChild(row);
      });
      panel.style.display = 'flex';
    }

    function hasShopifyIntegration(){
      return integrationRows.some(row => row.serviceId === SHOPIFY_SERVICE_ID && row.status !== 'oauth_pending');
    }

    function updateShopifySyncUi({ available, syncing = false } = {}){
      const statusEl = document.getElementById('shopify-sync-status');
      const btn = document.getElementById('shopify-sync-btn');
      if (!statusEl || !btn) return;
      if (!available){
        btn.style.display = 'none';
        btn.disabled = true;
        statusEl.textContent = 'Connect Shopify to sync your catalogue.';
        statusEl.classList.remove('success');
        statusEl.classList.remove('warning');
        return;
      }
      btn.style.display = 'inline-flex';
      btn.disabled = !!syncing;
      btn.textContent = syncing ? 'Syncing…' : 'Sync Shopify';
      if (syncing){
        statusEl.textContent = 'Sync in progress…';
        statusEl.classList.remove('success');
        statusEl.classList.remove('warning');
        return;
      }
      if (state.lastShopifySync){
        const source = state.lastShopifySyncSource === 'csv' ? 'Imported from CSV' : 'Synced';
        statusEl.textContent = `${source} ${formatDateTime(state.lastShopifySync)}`;
        if (state.lastShopifySyncSource === 'csv') {
          statusEl.classList.remove('success');
          statusEl.classList.add('warning');
        } else {
          statusEl.classList.add('success');
          statusEl.classList.remove('warning');
        }
      } else {
        statusEl.textContent = 'Ready to pull live data from Shopify.';
        statusEl.classList.remove('success');
        statusEl.classList.remove('warning');
      }
    }

    function handleInventoryScan(code, payload = {}) {
      const normalized = String(code || '').trim().toUpperCase();
      if (!normalized) return null;
      const qty = Math.max(1, Number(payload.quantity) || 1);
      const item = findOrCreateItem({ sku: normalized });
      if (!item.name || item.name === item.sku) {
        item.name = normalized;
      }
      item.quantity = (Number(item.quantity) || 0) + qty;
      persist();
      renderInventory();
      renderStats();
      return `Inventory updated for ${normalized}.`;
    }

    function handleOrderScan(code) {
      const raw = String(code || '').trim();
      if (!raw) return null;
      const orderId = raw.toUpperCase();
      const existing = state.orders.find(order => String(order.orderId || '').toUpperCase() === orderId);
      let message;
      if (existing) {
        existing.status = existing.status && existing.status !== 'cancelled' ? existing.status : 'open';
        existing.progress = Math.min(100, (Number(existing.progress) || 0) + 10);
        if (!Array.isArray(existing.lines) || !existing.lines.length) {
          existing.lines = [{ sku: orderId, qty: 1 }];
        }
        message = `Order ${orderId} updated from scan.`;
      } else {
        const warehouseId = state.warehouses[0]?.id || '';
        const dueDate = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        state.orders.push({
          id: crypto.randomUUID(),
          orderId,
          customer: 'Quick scan',
          warehouseId,
          dueDate,
          priority: 'Standard',
          shipping: 'Standard',
          lines: [{ sku: orderId, qty: 1 }],
          status: 'open',
          progress: 10,
          createdAt: new Date().toISOString()
        });
        message = `Order ${orderId} created from scan.`;
      }
      persist();
      renderOrders();
      renderStats();
      return message;
    }

    function handleReceiptScan(code, payload = {}) {
      const normalized = String(code || '').trim().toUpperCase();
      if (!normalized) return null;
      const qty = Math.max(1, Number(payload.quantity) || 1);
      const item = findOrCreateItem({ sku: normalized });
      item.quantity = (Number(item.quantity) || 0) + qty;
      const receipt = {
        id: crypto.randomUUID(),
        reference: payload.reference || `SCAN-${normalized}`,
        supplier: payload.supplier || 'Quick scan',
        warehouseId: item.warehouseId || state.warehouses[0]?.id || '',
        sku: normalized,
        quantity: qty,
        location: item.location || '',
        lot: item.lot || '',
        expiry: item.expiry || '',
        notes: payload.notes || 'Captured via scanner link',
        date: new Date().toISOString()
      };
      state.receipts.push(receipt);
      persist();
      renderReceipts();
      renderInventory();
      renderStats();
      return `Inbound logged for ${normalized}.`;
    }

    function handleShipmentScan(code, payload = {}) {
      const orderId = String(code || '').trim().toUpperCase();
      if (!orderId) return null;
      const shipment = {
        id: crypto.randomUUID(),
        orderId,
        carrier: payload.carrier || 'Quick scan',
        tracking: payload.tracking || `SCAN-${Math.random().toString(36).slice(2, 10).toUpperCase()}`,
        packages: Math.max(1, Number(payload.packages) || 1),
        cost: Number(payload.cost) || 0,
        date: new Date().toISOString()
      };
      state.shipments.push(shipment);
      const order = state.orders.find(o => String(o.orderId || '').toUpperCase() === orderId);
      if (order) {
        order.status = 'shipped';
        order.progress = 100;
      }
      persist();
      renderShipments();
      renderOrders();
      renderStats();
      return `Shipment captured for ${orderId}.`;
    }

    function handleReturnScan(code, payload = {}) {
      const normalized = String(code || '').trim().toUpperCase();
      if (!normalized) return null;
      const qty = Math.max(1, Number(payload.quantity) || 1);
      const ret = {
        id: crypto.randomUUID(),
        orderId: payload.orderId ? String(payload.orderId).trim() || normalized : normalized,
        sku: normalized,
        quantity: qty,
        reason: payload.reason || 'damaged',
        disposition: payload.disposition || 'restock',
        date: new Date().toISOString()
      };
      state.returns.push(ret);
      const item = findOrCreateItem({ sku: normalized });
      item.quantity = (Number(item.quantity) || 0) + qty;
      persist();
      renderReturns();
      renderInventory();
      renderStats();
      return `Return logged for ${normalized}.`;
    }

    const scanHandlers = {
      inventory: handleInventoryScan,
      orders: handleOrderScan,
      receipts: handleReceiptScan,
      shipments: handleShipmentScan,
      returns: handleReturnScan
    };

    function processScannerPayload(payload = {}, options = {}) {
      if (!payload || typeof payload !== 'object') return;
      const { announce = true } = options;
      const mode = payload.mode;
      const code = payload.code;
      const id = payload.id;
      if (id && processedScanIds.has(id)) {
        acknowledgeScanPayload(payload);
        return;
      }
      if (!mode || !code) {
        acknowledgeScanPayload(payload);
        return;
      }
      const handler = scanHandlers[mode];
      if (!handler) {
        acknowledgeScanPayload(payload);
        return;
      }
      let message = null;
      try {
        message = handler(code, payload);
      } catch (err) {
        console.warn('Failed to handle scan payload', err);
      }
      if (id) {
        processedScanIds.add(id);
      }
      if (message && announce && typeof showToast === 'function') {
        showToast(message);
      }
      acknowledgeScanPayload(payload);
    }

    function normalizeHeader(header = '') {
      return String(header || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/_{2,}/g, '_')
        .replace(/^_|_$/g, '');
    }

    function parseCsv(text = '') {
      text = String(text || '').replace(/^\ufeff/, '');
      const rows = [];
      let currentRow = [];
      let currentValue = '';
      let insideQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (insideQuotes) {
          if (char === '"') {
            if (text[i + 1] === '"') {
              currentValue += '"';
              i++;
            } else {
              insideQuotes = false;
            }
          } else {
            currentValue += char;
          }
        } else if (char === '"') {
          insideQuotes = true;
        } else if (char === ',') {
          currentRow.push(currentValue);
          currentValue = '';
        } else if (char === '\r') {
          continue;
        } else if (char === '\n') {
          currentRow.push(currentValue);
          rows.push(currentRow);
          currentRow = [];
          currentValue = '';
        } else {
          currentValue += char;
        }
      }
      if (insideQuotes) {
        currentRow.push(currentValue);
      } else if (currentValue || currentRow.length) {
        currentRow.push(currentValue);
      }
      if (currentRow.length) {
        rows.push(currentRow);
      }
      return rows;
    }

    function parseCsvToObjects(text = '') {
      const rows = parseCsv(text);
      if (!rows.length) {
        return { headers: [], rows: [] };
      }
      const headers = rows[0];
      const normalizedHeaders = headers.map(normalizeHeader);
      const dataRows = rows.slice(1).map(cells => {
        const row = {};
        headers.forEach((header, idx) => {
          const value = cells[idx] ?? '';
          row[header] = value;
          const normalized = normalizedHeaders[idx];
          if (normalized && !(normalized in row)) {
            row[normalized] = value;
          }
        });
        return row;
      }).filter(row => Object.values(row).some(val => String(val || '').trim()));
      return { headers, rows: dataRows };
    }

    function detectShopifyCsvType(headers = [], fileName = '') {
      const normalized = headers.map(normalizeHeader);
      const normalizedFile = String(fileName || '').toLowerCase();
      if (
        normalized.includes('available_not_editable') ||
        normalized.includes('variant_inventory_qty') ||
        normalized.includes('on_hand_current') ||
        normalized.includes('on_hand') ||
        normalized.includes('inventory_item_sku') ||
        normalized.includes('available') ||
        (normalizedFile && /inventory/.test(normalizedFile))
      ) {
        return 'inventory';
      }
      if (
        normalized.includes('variant_sku') &&
        (normalized.includes('variant_price') || normalized.includes('product_category') || normalized.includes('cost_per_item'))
      ) {
        return 'products';
      }
      if (
        normalizedFile &&
        (/product/.test(normalizedFile) || /catalog/.test(normalizedFile))
      ) {
        return 'products';
      }
      return null;
    }

    function getFirstValue(row, keys = []) {
      if (!row) return '';
      for (const key of keys) {
        if (!key) continue;
        if (key in row && String(row[key]).trim()) {
          return String(row[key]).trim();
        }
        const normalized = normalizeHeader(key);
        if (normalized && normalized in row && String(row[normalized]).trim()) {
          return String(row[normalized]).trim();
        }
      }
      return '';
    }

    function parseNumeric(value) {
      if (value === null || value === undefined || value === '') return NaN;
      if (typeof value === 'number') return Number.isFinite(value) ? value : NaN;
      const cleaned = String(value).replace(/[^0-9.\-]/g, '');
      if (!cleaned) return NaN;
      const parsed = Number(cleaned);
      return Number.isFinite(parsed) ? parsed : NaN;
    }

    function buildVariantLabel(primary = {}, secondary = {}) {
      const variantTitle = getFirstValue(primary, ['Variant Title']) || getFirstValue(secondary, ['Variant Title']);
      if (variantTitle && variantTitle.toLowerCase() !== 'default title') {
        return variantTitle;
      }
      const values = [];
      ['Option1 Value', 'Option2 Value', 'Option3 Value', 'Variant Option1 Value', 'Variant Option2 Value', 'Variant Option3 Value']
        .forEach(key => {
          const val = getFirstValue(primary, [key]) || getFirstValue(secondary, [key]);
          if (val && val.toLowerCase() !== 'default title' && !values.includes(val)) {
            values.push(val);
          }
        });
      return values.join(' / ');
    }

    function buildProductMatchKeys(row = {}) {
      const keys = [];
      const sku = getFirstValue(row, ['Variant SKU', 'SKU', 'Sku']);
      if (sku) keys.push(`sku:${sku.toLowerCase()}`);
      const barcode = getFirstValue(row, ['Variant Barcode', 'Barcode']);
      if (barcode) keys.push(`barcode:${barcode.toLowerCase()}`);
      const handle = getFirstValue(row, ['Handle', 'Product Handle']);
      const title = getFirstValue(row, ['Title', 'Product Title', 'Name']);
      const variantLabel = buildVariantLabel(row, row);
      const normalizedVariant = variantLabel ? variantLabel.toLowerCase() : '';
      if (handle) {
        const handleKey = handle.toLowerCase();
        keys.push(`handle:${handleKey}`);
        if (normalizedVariant) keys.push(`handle:${handleKey}|variant:${normalizedVariant}`);
      }
      if (title) {
        const titleKey = title.toLowerCase();
        keys.push(`title:${titleKey}`);
        if (normalizedVariant) keys.push(`title:${titleKey}|variant:${normalizedVariant}`);
      }
      return keys;
    }

    function findProductMatch(row, productIndex) {
      const keys = buildProductMatchKeys(row);
      for (const key of keys) {
        if (productIndex.has(key)) {
          return productIndex.get(key);
        }
      }
      if (!keys.length && productIndex.size === 1) {
        const [first] = productIndex.values();
        return first;
      }
      return null;
    }

    function applyShopifyCsvUploads({ notify = false, productLoaded = false } = {}) {
      const inventoryRows = Array.isArray(shopifyCsvBuffer.inventory) ? shopifyCsvBuffer.inventory : [];
      if (!inventoryRows.length) {
        if (notify) showToast('No Shopify inventory data found.');
        return;
      }
      if (!Array.isArray(state.warehouses)) {
        state.warehouses = [];
      }
      const warehousesByName = new Map(
        state.warehouses.map(warehouse => [String(warehouse.name || '').trim().toLowerCase(), warehouse])
      );
      const productRows = Array.isArray(shopifyCsvBuffer.products) ? shopifyCsvBuffer.products : [];
      const productIndex = new Map();
      productRows.forEach(row => {
        buildProductMatchKeys(row).forEach(key => {
          if (!productIndex.has(key)) {
            productIndex.set(key, row);
          }
        });
      });
      const items = [];
      const seenKeys = new Set();
      inventoryRows.forEach(row => {
        if (!row) return;
        let productRow = findProductMatch(row, productIndex);
        let sku = getFirstValue(row, ['SKU', 'Variant SKU', 'Variant sku', 'Sku']);
        if ((!sku || !sku.trim()) && productRow) {
          sku = getFirstValue(productRow, ['Variant SKU', 'SKU', 'Sku']);
        }
        const handle = getFirstValue(row, ['Handle', 'Product Handle']) || getFirstValue(productRow, ['Handle', 'Product Handle']);
        const variantLabel = buildVariantLabel(row, productRow);
        if (!sku) {
          if (handle && variantLabel) sku = `${handle} • ${variantLabel}`;
          else if (handle) sku = handle;
          else if (variantLabel) sku = variantLabel;
        }
        if (!sku) {
          sku = `SKU-${items.length + 1}`;
        }
        const normalizedSku = sku.toLowerCase();
        const locationName = getFirstValue(row, ['Location', 'Shop location', 'Shop Location', 'Location Name']);
        const binName = getFirstValue(row, ['Bin name', 'Bin Name', 'Bin']);
        const dedupeKey = [normalizedSku, (locationName || '').toLowerCase(), (binName || '').toLowerCase()].join('|');
        if (seenKeys.has(dedupeKey)) return;
        seenKeys.add(dedupeKey);
        const name =
          getFirstValue(row, ['Title', 'Product Name']) ||
          getFirstValue(productRow, ['Title', 'Product Title']) ||
          sku;
        const category =
          getFirstValue(productRow, ['Product Category', 'Type', 'Product Type']) ||
          getFirstValue(row, ['Product Category', 'Type']);
        const quantity = parseNumeric(
          getFirstValue(row, [
            'Available (not editable)',
            'Variant Inventory Qty',
            'On hand (current)',
            'On hand (new)',
            'On hand',
            'Quantity'
          ])
        );
        const reorder = parseNumeric(getFirstValue(row, ['Reorder Point', 'Reorder point', 'Safety stock']));
        const unitCostRaw =
          parseNumeric(getFirstValue(productRow, ['Cost per item', 'Variant Price', 'Price'])) ||
          parseNumeric(getFirstValue(row, ['Cost per item', 'Variant Price', 'Price']));
        const unitCost = Number.isFinite(unitCostRaw) ? Math.round(unitCostRaw * 100) / 100 : 0;
        let warehouseId = '';
        if (locationName) {
          const key = locationName.toLowerCase();
          let warehouse = warehousesByName.get(key);
          if (!warehouse) {
            warehouse = {
              id: crypto.randomUUID(),
              name: locationName,
              type: 'Shopify Location',
              capacity: 0,
              notes: ''
            };
            warehousesByName.set(key, warehouse);
            state.warehouses.push(warehouse);
          }
          warehouseId = warehouse.id;
        }
        items.push({
          id: crypto.randomUUID(),
          sku,
          name,
          variant: variantLabel,
          category,
          warehouseId,
          location: binName || locationName || '',
          quantity: Number.isFinite(quantity) ? quantity : 0,
          reorder: Number.isFinite(reorder) ? reorder : 0,
          lot: '',
          expiry: '',
          unitCost,
          color: '',
        });
      });
      state.items = items;
      state.shopifyWarnings = [];
      state.lastShopifySync = new Date().toISOString();
      state.lastShopifySyncSource = 'csv';
      persist();
      updateWarehouseSelects();
      renderInventory();
      renderStats();
      renderShopifyWarnings();
      updateShopifySyncUi({ available: hasShopifyIntegration() });
      if (notify) {
        showToast(productLoaded ? 'Shopify CSV imported with product details.' : 'Shopify inventory CSV imported.');
      }
    }

    function applyShopifyData(payload){
      const data = payload?.data || {};
      const meta = payload?.meta || {};
      const locations = Array.isArray(data.locations) ? data.locations : [];
      const inventory = Array.isArray(data.inventory) ? data.inventory : [];
      if (locations.length){
        state.warehouses = locations.map(loc => ({
          id: String(loc.id || crypto.randomUUID()),
          name: loc.name || `Location ${loc.id}`,
          type: loc.active ? 'Shopify Location' : 'Inactive Location',
          capacity: 0,
          notes: [loc.address1, loc.city, loc.country].filter(Boolean).join(', '),
        }));
      }
      state.collections = Array.isArray(data.collections) ? data.collections : [];
      state.giftCards = Array.isArray(data.giftCards) ? data.giftCards : [];
      state.purchaseOrders = Array.isArray(data.purchaseOrders) ? data.purchaseOrders : [];
      state.transfers = Array.isArray(data.transfers) ? data.transfers : [];
      state.shopifyWarnings = Array.isArray(meta.warnings) ? meta.warnings : [];
      state.lastShopifySync = payload?.fetchedAt || new Date().toISOString();
      state.lastShopifySyncSource = 'api';
      const inventoryRows = inventory.map(item => ({
        sku: item.sku,
        name: item.productTitle || item.sku,
        variant: item.variantTitle || '',
        category: item.productType || '',
        warehouseId: item.locationId || '',
        location: item.locationName || '',
        quantity: Number(item.available) || 0,
        reorder: Number(item.reorderPoint) || 0,
        lot: '',
        expiry: '',
        unitCost: item.price != null ? Number(item.price) : 0,
        color: sanitizeColor(item.color),
      }));
      state.items = inventoryRows;
      persist();
      updateWarehouseSelects();
      renderInventory();
      renderCollections();
      renderGiftCards();
      renderPurchaseOrders();
      renderTransfers();
      renderShopifyWarnings();
      renderStats();
      updateShopifySyncUi({ available: true });
    }

    async function syncShopifyIfAvailable(force = false){
      if (!isAuthenticated()) return;
      const available = hasShopifyIntegration();
      updateShopifySyncUi({ available, syncing: shopifySyncState.loading });
      if (!available) return;
      if (!force && state.lastShopifySync){
        const last = new Date(state.lastShopifySync).getTime();
        if (!Number.isNaN(last) && Date.now() - last < SHOPIFY_SYNC_CACHE_MS){
          return;
        }
      }
      if (shopifySyncState.loading) return;
      shopifySyncState.loading = true;
      shopifySyncState.lastAttempt = Date.now();
      updateShopifySyncUi({ available, syncing: true });
      try {
        const res = await fetch('/api/shopify/sync', { headers: authHeaders() });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
        const data = await res.json();
        if (!res.ok){
          throw new Error(data?.message || data?.error || 'Failed to sync Shopify');
        }
        applyShopifyData(data);
        showToast('Shopify data synced.');
      } catch (err){
        console.error('Shopify sync failed', err);
        const warning = err?.message || 'Sync failed.';
        state.shopifyWarnings = state.shopifyWarnings || [];
        if (!state.shopifyWarnings.includes(warning)){
          state.shopifyWarnings.push(warning);
        }
        renderShopifyWarnings();
        showToast('Shopify sync failed.');
      } finally {
        shopifySyncState.loading = false;
        updateShopifySyncUi({ available, syncing: false });
      }
    }

    function ensureChart(id, config){
      if (!window.Chart) {
        setTimeout(renderCharts, 400);
        return;
      }
      const canvas = document.getElementById(id);
      if (!canvas) return;
      if (chartInstances[id]){
        chartInstances[id].data = config.data;
        chartInstances[id].options = config.options;
        chartInstances[id].update();
      } else {
        chartInstances[id] = new Chart(canvas, config);
      }
    }

    function renderCharts(){
      if (!window.Chart) return;
      const accent = state.branding?.accent || '#38bdf8';

      const items = state.items.slice().sort((a, b) => (Number(b.quantity) || 0) - (Number(a.quantity) || 0)).slice(0, 5);
      const invLabels = items.length ? items.map(it => it.sku) : ['Ready'];
      const invData = items.length ? items.map(it => Number(it.quantity) || 0) : [5];
      ensureChart('inventoryChart', {
        type: 'bar',
        data: {
          labels: invLabels,
          datasets: [{
            label: 'Units on hand',
            data: invData,
            backgroundColor: invData.map(() => hexToRgba(accent, 0.35)),
            borderColor: invData.map(() => accent),
            borderWidth: 1.5,
            borderRadius: 8,
          }],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#cbd5f5' } },
            y: { ticks: { color: '#cbd5f5' }, beginAtZero: true },
          },
        },
      });

      const orderStatuses = ['open', 'picking', 'packed', 'shipped', 'cancelled'];
      const orderCounts = orderStatuses.map(status => state.orders.filter(o => o.status === status).length);
      ensureChart('orderChart', {
        type: 'doughnut',
        data: {
          labels: orderStatuses.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
          datasets: [{
            data: orderCounts.map(count => count || 1),
            backgroundColor: [
              hexToRgba(accent, 0.6),
              'rgba(129, 140, 248, 0.6)',
              'rgba(59, 130, 246, 0.6)',
              'rgba(34, 197, 94, 0.6)',
              'rgba(239, 68, 68, 0.4)',
            ],
            borderColor: 'rgba(15, 23, 42, 0.8)',
            borderWidth: 2,
          }],
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { color: '#cbd5f5', boxWidth: 16 },
            },
          },
        },
      });

      const missionTotals = {
        Stocking: state.receipts.length || 1,
        Sorting: state.orders.filter(o => ['open', 'picking'].includes(o.status)).length || 1,
        Labeling: state.tasks.filter(t => t.type === 'Packing').length + state.orders.filter(o => o.status === 'packed').length || 1,
        Dispatch: state.shipments.length || 1,
        Returns: state.returns.length || 1,
      };
      ensureChart('missionChart', {
        type: 'radar',
        data: {
          labels: Object.keys(missionTotals),
          datasets: [{
            label: 'Mission energy',
            data: Object.values(missionTotals),
            backgroundColor: hexToRgba(accent, 0.25),
            borderColor: accent,
            borderWidth: 2,
            pointBackgroundColor: accent,
          }],
        },
        options: {
          scales: {
            r: {
              angleLines: { color: 'rgba(148, 163, 184, 0.25)' },
              grid: { color: 'rgba(148, 163, 184, 0.2)' },
              pointLabels: { color: '#cbd5f5' },
              ticks: { display: false },
            },
          },
          plugins: { legend: { display: false } },
        },
      });
    }

    function authHeaders(){
      return isAuthenticated() ? { Authorization: `Bearer ${authState.token}` } : {};
    }

    function handleUnauthorized(message = 'Session expired. Sign in again to continue.'){
      const wasAuthenticated = isAuthenticated();
      authState = { token: null, user: null };
      persistAuth();
      updateAccountStatus();
      renderTotpUi();
      loadIntegrations();
      restoreSessionFromServer();
      if (wasAuthenticated){
        showToast(message);
      }
    }

    function setAuthState({ token = null, user = null }){
      authState = { token, user };
      persistAuth();
      if (user && user.brandTheme){
        state.branding = { ...state.branding, ...user.brandTheme };
        persist();
        applyBranding();
      }
      updateAccountStatus();
      if (authState.token){
        loadIntegrations();
      }
      renderTotpUi();
    }

    async function restoreSessionFromServer(){
      if (authState.token && authState.user) return;
      try {
        const res = await fetch('/api/users/session', { credentials: 'include' });
        if (res.status === 204){
          return;
        }
        if (!res.ok){
          return;
        }
        const data = await res.json();
        if (data && data.token && data.user){
          setAuthState({ token: data.token, user: data.user });
        }
      } catch (err){
        console.warn('Session restore skipped', err);
      }
    }

    async function hydrateAuth(){
      if (!authState.token || (authState.user && authState.user.email)) return;
      try {
        const res = await fetch('/api/users/me', { headers: authHeaders(), credentials: 'include' });
        if (res.status === 401){
          handleUnauthorized();
          await restoreSessionFromServer();
          return;
        }
        if (!res.ok){
          return;
        }
        const data = await res.json();
        if (data && data.user){
          setAuthState({ token: authState.token, user: data.user });
        }
      } catch (err){
        console.warn('Auth hydrate skipped', err);
      }
    }

    function updateAccountStatus(){
      const status = document.getElementById('account-status');
      const logoutBtn = document.getElementById('logout-btn');
      if (!status || !logoutBtn) return;
      if (authState && authState.user){
        const parts = [`Signed in as ${authState.user.email}`];
        if (authState.user.totpEnabled) parts.push('2FA enabled');
        status.textContent = parts.join(' • ');
        logoutBtn.style.display = 'inline-flex';
      } else {
        status.textContent = 'Not signed in.';
        logoutBtn.style.display = 'none';
      }
    }

    function renderTotpUi(extra){
      const panel = document.getElementById('totp-panel');
      const container = document.getElementById('totp-content');
      if (!panel || !container) return;
      if (!authState || !authState.user || !authState.token){
        panel.style.display = 'none';
        container.innerHTML = '<p class="hint">Sign in to enable authenticator protection.</p>';
        return;
      }
      panel.style.display = '';
      if (extra && extra.secret){
        container.innerHTML = `
          <p><strong>Secret:</strong> <code>${extra.secret}</code></p>
          <p class="hint">Add this to your authenticator. URL: <a href="${extra.otpauth}" target="_blank" rel="noopener">${extra.otpauth}</a></p>
          <button class="secondary" type="button" id="totp-done">Done</button>
        `;
        container.querySelector('#totp-done').addEventListener('click', () => renderTotpUi());
        authState.user.totpEnabled = true;
        persistAuth();
        updateAccountStatus();
        return;
      }
      if (authState.user.totpEnabled){
        container.innerHTML = `
          <p class="hint">Authenticator active. Use your rotating code when logging in.</p>
          <button class="secondary" type="button" id="disable-totp">Disable 2FA</button>
        `;
        container.querySelector('#disable-totp').addEventListener('click', disableTotp);
      } else {
        container.innerHTML = `
          <button class="cta" type="button" id="enable-totp">Generate authenticator secret</button>
          <p class="hint">Scan the QR we generate or copy the secret into your authenticator app.</p>
        `;
        container.querySelector('#enable-totp').addEventListener('click', enableTotp);
      }
    }

    function sanitizeBrandThemeForUpload(){
      const branding = state.branding || {};
      const clean = {
        accent: branding.accent || '#38bdf8',
        background: branding.background || 'nebula',
        callSign: branding.callSign || 'Warehouse HQ',
        emoji: branding.emoji || '🚚',
      };
      if (branding.logoData && typeof branding.logoData === 'string' && branding.logoData.length <= BRAND_LOGO_MAX_LENGTH){
        clean.logoData = branding.logoData;
      }
      return clean;
    }

    async function processLogoFile(file){
      const raw = await readFileAsDataURL(file);
      const optimized = await optimizeLogoData(raw, file.type || 'image/jpeg');
      if (!optimized || optimized.length > BRAND_LOGO_MAX_LENGTH){
        throw new Error('logo_too_large');
      }
      return optimized;
    }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          if (typeof reader.result === 'string'){
            resolve(reader.result);
          } else {
            reject(new Error('logo_invalid'));
          }
        };
        reader.onerror = () => reject(new Error('logo_read_failed'));
        reader.readAsDataURL(file);
      });
    }

    function optimizeLogoData(dataUrl, mimeType){
      if (typeof dataUrl !== 'string'){
        return Promise.reject(new Error('logo_invalid'));
      }
      if (dataUrl.length <= BRAND_LOGO_MAX_LENGTH){
        return Promise.resolve(dataUrl);
      }
      if (!/^data:image\//.test(dataUrl)){
        return Promise.resolve(dataUrl);
      }
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          try {
            const maxDimension = 512;
            const minDimension = 96;
            let { width, height } = img;
            if (!width || !height){
              resolve(dataUrl);
              return;
            }
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (!ctx){
              resolve(dataUrl);
              return;
            }
            const baseScale = Math.min(1, maxDimension / Math.max(width, height));
            let scale = baseScale;
            let exportMime = mimeType === 'image/png' ? 'image/png' : 'image/jpeg';
            let quality = exportMime === 'image/jpeg' ? 0.82 : 1;
            let switchedMime = false;

            for (let attempt = 0; attempt < 12; attempt += 1){
              const targetWidth = Math.max(1, Math.round(width * scale));
              const targetHeight = Math.max(1, Math.round(height * scale));
              canvas.width = targetWidth;
              canvas.height = targetHeight;
              ctx.clearRect(0, 0, targetWidth, targetHeight);
              ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
              const output = canvas.toDataURL(exportMime, exportMime === 'image/jpeg' ? quality : undefined);
              if (output.length <= BRAND_LOGO_MAX_LENGTH){
                resolve(output);
                return;
              }
              if (exportMime === 'image/jpeg' && quality > 0.5){
                quality = Math.max(0.5, +(quality - 0.12).toFixed(2));
                continue;
              }
              if (Math.max(targetWidth, targetHeight) > minDimension){
                scale = Math.max(scale * 0.8, minDimension / Math.max(width, height));
                continue;
              }
              if (exportMime === 'image/png' && !switchedMime){
                exportMime = 'image/jpeg';
                quality = 0.82;
                switchedMime = true;
                continue;
              }
              break;
            }
            reject(new Error('logo_too_large'));
          } catch (err){
            reject(err);
          }
        };
        img.onerror = () => reject(new Error('logo_invalid'));
        img.src = dataUrl;
      });
    }

    async function registerAccount(evt){
      evt.preventDefault();
      const form = evt.target;
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      payload.enableTotp = formData.get('enableTotp') === 'on';
      payload.brandTheme = sanitizeBrandThemeForUpload();
      try {
        const res = await fetch('/api/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Unable to register');
          return;
        }
        setAuthState({ token: data.token, user: data.user });
        renderTotpUi(data.totp);
        showToast('Account created. Welcome aboard!');
        form.reset();
      } catch (err){
        showToast('Registration failed. Try again shortly.');
      }
    }

    async function loginAccount(evt){
      evt.preventDefault();
      const form = evt.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      try {
        const res = await fetch('/api/users/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          const message = data.error === 'totp_required' ? 'Enter your authenticator code.' : (data.error || 'Login failed');
          showToast(message);
          return;
        }
        setAuthState({ token: data.token, user: data.user });
        showToast('Logged in. Systems synced.');
        form.reset();
      } catch (err){
        showToast('Login unavailable right now.');
      }
    }

    async function logoutAccount(){
      try {
        await fetch('/api/users/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          credentials: 'include',
        });
      } catch (err){
        console.warn('Logout request failed', err);
      }
      authState = { token: null, user: null };
      persistAuth();
      updateAccountStatus();
      renderTotpUi();
      loadIntegrations();
      showToast('Signed out.');
    }

    async function enableTotp(){
      try {
        const res = await fetch('/api/users/totp/enable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          credentials: 'include',
          body: JSON.stringify({ label: authState.user?.email || 'Warehouse HQ' }),
        });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Unable to enable 2FA');
          return;
        }
        authState.user.totpEnabled = true;
        persistAuth();
        renderTotpUi(data);
      } catch (err){
        showToast('Authenticator setup failed.');
      }
    }

    async function disableTotp(){
      try {
        const res = await fetch('/api/users/totp/disable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          credentials: 'include',
        });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
        if (!res.ok){
          const data = await res.json();
          showToast(data.error || 'Unable to disable 2FA');
          return;
        }
        authState.user.totpEnabled = false;
        persistAuth();
        renderTotpUi();
        updateAccountStatus();
      } catch (err){
        showToast('Disable failed.');
      }
    }

    async function fetchIntegrationCatalog(){
      try {
        const res = await fetch('/api/integrations/catalog');
        const data = await res.json();
        integrationCatalog = data.catalog || [];
      } catch (err){
        integrationCatalog = [];
      }
      renderIntegrationCatalog();
    }

    function renderIntegrationCatalog(){
      const container = document.getElementById('integration-catalog');
      if (!container) return;
      if (!integrationCatalog.length){
        container.innerHTML = '<div class="integration-table-empty">Catalog loading...</div>';
        return;
      }
      container.innerHTML = integrationCatalog.map(item => {
        const iconSrc = item.icon || `https://api.dicebear.com/7.x/icons/svg?seed=${encodeURIComponent(item.id)}&backgroundColor=transparent`;
        const primaryCta = item.oneClick
          ? `<button class="cta" type="button" data-action="oneclick" data-id="${item.id}">Connect</button>`
          : `<button class="cta" type="button" data-action="connect" data-id="${item.id}">Add credentials</button>`;
        const secondaryCta = item.oneClick
          ? `<button class="secondary" type="button" data-action="connect" data-id="${item.id}">Manual setup</button>`
          : '';
        return `
        <div class="integration-card">
          <img src="${iconSrc}" alt="${item.name} icon" loading="lazy" />
          <div><strong>${item.name}</strong><br><span class="hint">${item.category}</span></div>
          <div class="tagline">${(item.scopes || []).join(' • ')}</div>
          ${item.oneClick ? '<span class="one-click-tag">One-click ready</span>' : ''}
          <div class="account-actions">
            ${primaryCta}
            ${secondaryCta}
          </div>
        </div>
      `;
      }).join('');
      container.querySelectorAll('button[data-action="connect"]').forEach(btn => {
        btn.addEventListener('click', () => showIntegrationForm(btn.dataset.id));
      });
      container.querySelectorAll('button[data-action="oneclick"]').forEach(btn => {
        btn.addEventListener('click', () => startOneClickConnect(btn.dataset.id));
      });
    }

    function showIntegrationForm(serviceId){
      if (!authState.token){
        showToast('Sign in first to save integrations.');
        return;
      }
      const wrapper = document.getElementById('integration-form-wrapper');
      const title = document.getElementById('integration-form-title');
      const inputId = document.getElementById('integration-service-id');
      const labelInput = document.getElementById('integration-label');
      const apiKeyInput = document.getElementById('integration-api-key');
      const secretInput = document.getElementById('integration-secret');
      const webhookInput = document.getElementById('integration-webhook');
      const notesInput = document.getElementById('integration-notes');
      const hint = document.getElementById('integration-form-hint');
      const form = document.getElementById('integration-form');
      if (!wrapper || !inputId) return;
      const meta = integrationCatalog.find(item => item.id === serviceId) || { name: serviceId };
      if (form) {
        form.reset();
      }
      wrapper.style.display = '';
      title.textContent = `Connect ${meta.name}`;
      inputId.value = serviceId;
      if (labelInput && !labelInput.value) labelInput.value = meta.name;
      if (apiKeyInput) apiKeyInput.placeholder = 'Paste API key or token';
      if (secretInput) secretInput.placeholder = 'Optional secret or password';
      if (webhookInput) webhookInput.placeholder = 'https://your-domain.com/webhooks/provider';
      if (notesInput) notesInput.placeholder = 'Share login context, rate limits, etc.';
      if (hint) {
        if (meta.oneClick) {
          hint.textContent = `${meta.name} is one-click ready. Use these fields only if your provider issued backup API keys.`;
        } else {
          hint.textContent = MANUAL_FORM_HINT;
        }
      }
      requestAnimationFrame(() => {
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const firstField = wrapper.querySelector('input:not([type="hidden"])');
        if (firstField) {
          try {
            firstField.focus({ preventScroll: true });
          } catch (err) {
            firstField.focus();
          }
        }
      });
    }

    async function loadIntegrations(){
      const tbody = document.getElementById('integration-table');
      if (!tbody) return;
      if (!authState.token){
        integrationRows = [];
        tbody.innerHTML = '<tr><td colspan="5" class="integration-table-empty">Sign in to manage integrations.</td></tr>';
        updateShopifySyncUi({ available: false });
        renderShopifyWarnings();
        return;
      }
      try {
        const res = await fetch('/api/integrations', { headers: authHeaders() });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
        const data = await res.json();
        if (!res.ok){
          throw new Error(data.error || 'Failed');
        }
        renderIntegrations(data.integrations || []);
      } catch (err){
        tbody.innerHTML = '<tr><td colspan="5" class="integration-table-empty">Unable to load integrations.</td></tr>';
        updateShopifySyncUi({ available: hasShopifyIntegration() });
        renderShopifyWarnings();
      }
    }

    function renderIntegrations(rows){
      const tbody = document.getElementById('integration-table');
      if (!tbody) return;
      integrationRows = rows;
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="5" class="integration-table-empty">No integrations yet. Connect your first platform.</td></tr>';
        updateShopifySyncUi({ available: false });
        renderShopifyWarnings();
        return;
      }
      tbody.innerHTML = rows.map(row => {
        const meta = integrationCatalog.find(item => item.id === row.serviceId) || {};
        const creds = Object.entries(row.credentials || {}).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        const actions = [];
        if (meta.oneClick){
          const actionLabel = row.status === 'oauth_linked' ? 'Refresh link' : 'Launch connect';
          actions.push(`<button data-action="complete-oauth" data-id="${row.id}" data-service="${row.serviceId}" data-status="${row.status}">${actionLabel}</button>`);
        }
        actions.push(`<button data-action="delete" data-id="${row.id}">Remove</button>`);
        return `
          <tr>
            <td><strong>${meta.name || row.serviceId}</strong><br><span class="hint">${meta.category || ''}</span></td>
            <td>${friendlyIntegrationStatus(row.status)}</td>
            <td>${creds || '<span class="hint">Credentials hidden</span>'}</td>
            <td>${row.updatedAt ? formatDate(row.updatedAt) : '—'}</td>
            <td class="actions">${actions.join(' ')}</td>
          </tr>
        `;
      }).join('');
      tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => btn.addEventListener('click', () => deleteIntegration(btn.dataset.id)));
      tbody.querySelectorAll('button[data-action="complete-oauth"]').forEach(btn => btn.addEventListener('click', () => completeOneClick(btn.dataset.id, { serviceId: btn.dataset.service, status: btn.dataset.status })));
      const available = hasShopifyIntegration();
      updateShopifySyncUi({ available, syncing: shopifySyncState.loading });
      if (available) {
        syncShopifyIfAvailable();
      } else {
        state.shopifyWarnings = [];
        renderShopifyWarnings();
      }
    }

    async function saveIntegration(evt){
      evt.preventDefault();
      if (!authState.token){
        showToast('Sign in to save integrations.');
        return;
      }
      const form = evt.target;
      const { serviceId, label, apiKey, secret, webhook, notes } = form.elements;
      const payload = {
        serviceId: serviceId.value,
        label: label.value,
        credentials: {
          apiKey: apiKey.value,
          secret: secret.value,
          webhook: webhook.value,
        },
        notes: notes.value,
      };
      try {
        const res = await fetch('/api/integrations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Could not save integration');
          return;
        }
        showToast('Integration stored.');
        form.reset();
        document.getElementById('integration-form-wrapper').style.display = 'none';
        loadIntegrations();
      } catch (err){
        showToast('Integration save failed.');
      }
    }

    async function startOneClickConnect(serviceId){
      if (!authState.token){
        showToast('Sign in to connect integrations.');
        return;
      }
      const meta = integrationCatalog.find(item => item.id === serviceId) || { name: serviceId, id: serviceId };
      const existing = integrationRows.find(row => row.serviceId === serviceId);
      showOauthOverlay(`Connect ${meta.name}`, 'Launching secure OAuth window…');
      try {
        await wait(400);
        if (existing && existing.status === 'oauth_linked'){
          updateOauthOverlay(`${meta.name} is already connected.`);
          await wait(600);
          hideOauthOverlay();
          showToast(`${meta.name} already linked.`);
          return;
        }
        let integrationId = existing?.id;
        if (!integrationId){
          const payload = {
            serviceId,
            label: meta.name,
            credentials: {},
            notes: ''
          };
          const res = await fetchWithTimeout('/api/integrations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify(payload),
          });
          if (res.status === 401){
            hideOauthOverlay();
            handleUnauthorized();
            return;
          }
          const data = await res.json();
          if (!res.ok){
            throw new Error(data.error || 'Failed to start connection');
          }
          integrationId = data.id;
          updateOauthOverlay('Connection request sent. Awaiting authorization…');
          await wait(500);
        }
        await completeOneClick(integrationId, { serviceId, skipInitialOverlay: true });
      } catch (err){
        console.error('startOneClickConnect error', err);
        hideOauthOverlay();
        if (err?.code === 'timeout') {
          showToast('Connection timed out. Try again in a moment.');
        } else {
          showToast('Could not start one-click connection. Try again.');
        }
        loadIntegrations();
      }
    }

    async function completeOneClick(id, { serviceId, skipInitialOverlay = false } = {}){
      if (!authState.token){
        showToast('Sign in to finish one-click links.');
        hideOauthOverlay();
        return;
      }
      const existingRow = integrationRows.find(row => row.id === id);
      const serviceKey = serviceId || existingRow?.serviceId;
      const meta = integrationCatalog.find(item => item.id === serviceKey) || { name: existingRow?.label || serviceKey || 'Integration', id: serviceKey || 'integration' };
      if (!skipInitialOverlay){
        showOauthOverlay(`Connect ${meta.name || 'Integration'}`, 'Launching secure OAuth window…');
      } else {
        updateOauthOverlay('Authorizing with provider…');
      }
      try {
        await wait(600);
        updateOauthOverlay('Requesting secure tokens…');
        const body = {
          accessToken: generateDemoToken((meta.id || serviceId || 'access') + '-access'),
          refreshToken: generateDemoToken((meta.id || serviceId || 'refresh') + '-refresh'),
          expiresAt: new Date(Date.now() + 1000 * 60 * 60 * 12).toISOString(),
        };
        if ((meta.id || serviceKey) === SHOPIFY_SERVICE_ID) {
          let existingShopDomain = existingRow?.credentials?.shopDomain || existingRow?.credentials?.shop || '';
          if (typeof existingShopDomain === 'string' && existingShopDomain.includes('•••')) {
            existingShopDomain = '';
          }
          let domainToUse = normalizeShopDomain(existingShopDomain);
          if (!domainToUse) {
            const suggested = authState.user?.email
              ? `${authState.user.email.split('@')[0].replace(/[^a-z0-9-]/gi, '').toLowerCase() || 'warehouse-hq'}.myshopify.com`
              : 'warehouse-hq.myshopify.com';
            const input = window.prompt('Enter your Shopify shop domain (e.g. my-store.myshopify.com)', suggested);
            if (input) {
              domainToUse = normalizeShopDomain(input);
            }
          }
          if (!domainToUse) {
            hideOauthOverlay();
            showToast('Shopify needs your shop domain to finish connecting.');
            return;
          }
          body.shopDomain = domainToUse;
        }
        const res = await fetchWithTimeout(`/api/integrations/${id}/one-click`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body),
        });
        if (res.status === 401){
          hideOauthOverlay();
          handleUnauthorized();
          return;
        }
        const data = await res.json();
        if (!res.ok){
          throw new Error(data.error || 'One-click linking failed.');
        }
        updateOauthOverlay('Finalizing sync & webhooks…');
        await wait(500);
        hideOauthOverlay();
        showToast(`${meta.name || 'Integration'} connected.`);
        loadIntegrations();
      } catch (err){
        console.error('completeOneClick error', err);
        hideOauthOverlay();
        if (err?.code === 'timeout') {
          showToast('Linking timed out. Please try again.');
        } else {
          showToast('One-click linking failed. Try again.');
        }
      }
    }

    async function deleteIntegration(id){
      if (!confirm('Remove this integration?')) return;
      try {
        const res = await fetch(`/api/integrations/${id}`, {
          method: 'DELETE',
          headers: authHeaders(),
        });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
        if (!res.ok){
          showToast('Unable to remove integration.');
          return;
        }
        showToast('Integration removed.');
        loadIntegrations();
      } catch (err){
        showToast('Network issue removing integration.');
      }
    }

    let brandSyncTimer = null;
    function scheduleBrandSync(){
      if (!authState.token) return;
      clearTimeout(brandSyncTimer);
      brandSyncTimer = setTimeout(syncBrandToServer, 600);
    }

    async function syncBrandToServer(){
      if (!authState.token) return;
      try {
        const brandTheme = sanitizeBrandThemeForUpload();
        const res = await fetch('/api/users/brand', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          credentials: 'include',
          body: JSON.stringify({ brandTheme }),
        });
        if (res.status === 401){
          handleUnauthorized();
          return;
        }
      } catch (err){
        console.warn('Brand sync skipped', err);
      }
    }

    function initBrandingControls(){
      const form = document.getElementById('brand-form');
      if (!form) return;
      form.addEventListener('submit', evt => {
        evt.preventDefault();
        persist();
        scheduleBrandSync();
        showToast('Brand preset saved.');
      });
      const accentInput = document.getElementById('brand-accent');
      const backgroundSelect = document.getElementById('brand-background');
      const callSignInput = document.getElementById('brand-call-sign');
      const logoInput = document.getElementById('brand-logo-input');
      const logoClear = document.getElementById('brand-logo-clear');
      [accentInput, backgroundSelect, callSignInput].forEach(input => {
        if (!input) return;
        input.addEventListener('input', () => {
          state.branding = {
            ...state.branding,
            accent: accentInput?.value || state.branding.accent,
            background: backgroundSelect?.value || state.branding.background,
            callSign: callSignInput?.value || state.branding.callSign,
          };
          applyBranding();
          persist();
          scheduleBrandSync();
        });
      });
      if (logoInput) {
        logoInput.addEventListener('change', async () => {
          const file = logoInput.files?.[0];
          if (!file) {
            return;
          }
          if (!file.type.startsWith('image/')) {
            showToast('Please choose an image file.');
            logoInput.value = '';
            return;
          }
          if (file.size > 2 * 1024 * 1024) {
            showToast('Logo must be 2MB or less.');
            logoInput.value = '';
            return;
          }
          try {
            const optimized = await processLogoFile(file);
            state.branding = {
              ...state.branding,
              logoData: optimized,
            };
            applyBranding();
            persist();
            scheduleBrandSync();
            showToast('Logo optimized and saved.');
          } catch (err) {
            console.warn('Logo processing failed', err);
            if (err?.message === 'logo_too_large') {
              showToast('Logo is still too large after compression. Please try a simpler image.');
            } else {
              showToast('Unable to process logo. Try another image.');
            }
          } finally {
            logoInput.value = '';
          }
        });
      }
      if (logoClear) {
        logoClear.addEventListener('click', () => {
          state.branding = {
            ...state.branding,
            logoData: '',
          };
          if (logoInput) {
            logoInput.value = '';
          }
          applyBranding();
          persist();
          scheduleBrandSync();
        });
      }
    }

    async function submitSupportReport(evt){
      evt.preventDefault();
      const form = evt.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      payload.metadata = {
        warehouses: state.warehouses.length,
        openOrders: state.orders.length,
        branding: state.branding.callSign,
      };
      try {
        const res = await fetch('/api/support/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Could not send report');
          return;
        }
        const response = document.getElementById('support-response');
        const reward = document.getElementById('support-reward');
        if (response){
          response.style.display = 'block';
          response.textContent = data.assistant || 'Report received.';
        }
        if (reward){
          reward.innerHTML = `<span class="badge-emoji">${data.reward?.icon || '✨'}</span><div>${data.reward?.title || 'Great scout!'}<br><span class="mini-input">${data.reward?.message || ''}</span></div>`;
          reward.classList.add('show');
        }
        const mailLink = `mailto:rb@dreamworld.co?subject=${encodeURIComponent(payload.subject)}&body=${encodeURIComponent(payload.description)}`;
        window.open(mailLink, '_blank');
        showToast('Report sent — thank you!');
        form.reset();
      } catch (err){
        showToast('Support request failed.');
      }
    }

   function handleNavigation() {
      const nav = document.getElementById('hq-navigation') || document.querySelector('header nav');
      if (!nav) return;
      const buttons = Array.from(nav.querySelectorAll('button'));
      const sections = Array.from(document.querySelectorAll('main section'));
      const toggle = document.querySelector('.menu-toggle');
      const overlay = document.querySelector('.nav-overlay');
      const mobileQuery = window.matchMedia('(max-width: 960px)');

      const syncAria = () => {
        if (!mobileQuery.matches) {
          nav.removeAttribute('aria-hidden');
          return;
        }
        const isOpen = nav.getAttribute('data-open') === 'true';
        nav.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
      };

      const setNavOpen = open => {
        nav.setAttribute('data-open', open ? 'true' : 'false');
        if (toggle) {
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        }
        if (overlay) {
          if (open) {
            overlay.classList.add('active');
            overlay.removeAttribute('hidden');
          } else {
            overlay.classList.remove('active');
            overlay.setAttribute('hidden', '');
          }
        }
        document.body.classList.toggle('nav-open', open);
        syncAria();
      };

      syncAria();
      setNavOpen(nav.getAttribute('data-open') === 'true');

      if (toggle) {
        toggle.addEventListener('click', () => {
          const currentlyOpen = nav.getAttribute('data-open') === 'true';
          setNavOpen(!currentlyOpen);
        });
      }

      if (overlay) {
        overlay.addEventListener('click', () => setNavOpen(false));
      }

      const handleQueryChange = event => {
        if (!event.matches) {
          setNavOpen(false);
        } else {
          syncAria();
        }
      };

      if (mobileQuery.addEventListener) {
        mobileQuery.addEventListener('change', handleQueryChange);
      } else if (mobileQuery.addListener) {
        mobileQuery.addListener(handleQueryChange);
      }

      document.addEventListener('keydown', evt => {
        if (evt.key === 'Escape' && nav.getAttribute('data-open') === 'true') {
          setNavOpen(false);
          toggle?.focus();
        }
      });

      const activateSection = (targetId, triggerBtn) => {
        const section = document.getElementById(targetId?.trim?.() ?? '');
        if (!section) {
          console.warn('Requested section not found in Warehouse HQ navigation:', targetId);
          return;
        }
        buttons
          .filter(b => b.dataset.target)
          .forEach(b => b.classList.remove('active'));
        triggerBtn?.classList.add('active');
        sections.forEach(sec => sec.classList.remove('active'));
        section.classList.add('active');
      };

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const linkAttr = btn.getAttribute('data-link');
          if (linkAttr) {
            if (mobileQuery.matches) {
              setNavOpen(false);
            }
            const resolved = (() => {
              if (linkAttr.startsWith('http')) {
                return linkAttr;
              }
              if (linkAttr.startsWith('/')) {
                if (window.location.origin && window.location.origin !== 'null') {
                  return `${window.location.origin}${linkAttr}`;
                }
                const url = new URL(window.location.href);
                url.pathname = linkAttr;
                url.search = '';
                url.hash = '';
                return url.href;
              }
              return new URL(linkAttr, window.location.href).href;
            })();
            window.location.href = resolved;
            return;
          }

          const target = btn.dataset.target;
          if (!target) {
            return;
          }

          activateSection(target, btn);
          if (mobileQuery.matches) {
            setNavOpen(false);
          }
        });
      });

      const defaultBtn = buttons.find(b => b.dataset.target && b.classList.contains('active'));
      if (defaultBtn) {
        activateSection(defaultBtn.dataset.target, defaultBtn);
      }
    }
    
    function parseLines(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => {
          const [sku, qty] = line.split(':');
          return { sku: sku.trim(), qty: Number(qty || 0) };
        })
        .filter(line => line.sku && line.qty > 0);
    }

    function advanceOrder(id) {
      const order = state.orders.find(o => o.id === id);
      if (!order) return;
      const transitions = ['open', 'picking', 'packed', 'shipped'];
      const idx = transitions.indexOf(order.status);
      if (idx < transitions.length - 1) {
        order.status = transitions[idx + 1];
        if (order.status === 'picking') order.progress = 40;
        if (order.status === 'packed') order.progress = 80;
        if (order.status === 'shipped') {
          order.progress = 100;
          order.shippedAt = new Date().toISOString();
          order.lines.forEach(line => {
            const item = findOrCreateItem({ sku: line.sku });
            item.quantity = Math.max(0, (Number(item.quantity) || 0) - line.qty);
          });
          renderInventory();
        }
        persist();
        renderOrders();
        renderStats();
        showToast(`Order ${order.orderId} advanced to ${order.status}.`);
      }
    }

    function cancelOrder(id) {
      const order = state.orders.find(o => o.id === id);
      if (!order) return;
      order.status = 'cancelled';
      order.progress = 0;
      persist();
      renderOrders();
      renderStats();
      showToast(`Order ${order.orderId} cancelled.`);
    }

    function progressTask(id) {
      const task = state.tasks.find(t => t.id === id);
      if (!task) return;
      const transitions = ['open', 'picking', 'packed', 'shipped'];
      const idx = transitions.indexOf(task.status);
      if (idx < transitions.length - 1) {
        task.status = transitions[idx + 1];
        persist();
        renderTasks();
        showToast(`Task ${task.title} set to ${task.status}.`);
      }
    }

    function closeTask(id) {
      const task = state.tasks.find(t => t.id === id);
      if (!task) return;
      task.status = 'shipped';
      persist();
      renderTasks();
      showToast(`Mission completed: ${task.title}.`);
    }

    document.getElementById('warehouse-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.warehouses.push({
        id: crypto.randomUUID(),
        name: data.name,
        type: data.type,
        capacity: Number(data.capacity) || 0,
        notes: data.notes
      });
      form.reset();
      persist();
      updateWarehouseSelects();
      renderStats();
      showToast('Warehouse added.');
    });

    document.getElementById('item-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const sku = data.sku.trim();
      if (!sku) return;
      const item = findOrCreateItem({ sku });
      item.name = data.name;
      item.variant = data.variant;
      item.category = data.category;
      item.warehouseId = data.warehouse || item.warehouseId;
      item.location = data.location;
      item.quantity = Number(data.quantity) || 0;
      item.reorder = Number(data.reorder) || 0;
      item.lot = data.lot;
      item.expiry = data.expiry;
      item.unitCost = Number(data.unitCost) || 0;
      const colorInput = document.getElementById('item-color');
      const colorToggle = document.getElementById('item-color-toggle');
      const selectedColor = colorToggle?.checked ? sanitizeColor(colorInput?.value) : '';
      item.color = selectedColor;
      persist();
      renderInventory();
      renderStats();
      showToast('SKU saved.');
      form.reset();
      if (colorToggle) {
        colorToggle.checked = false;
      }
      if (colorInput) {
        const defaultColor = colorInput.getAttribute('data-default') || '#38bdf8';
        colorInput.value = defaultColor;
      }
    });

    document.getElementById('order-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const lines = parseLines(data.lines);
      if (!lines.length) {
        alert('Add at least one item line (SKU:Qty).');
        return;
      }
      const order = {
        id: crypto.randomUUID(),
        orderId: data.orderId,
        customer: data.customer,
        warehouseId: data.warehouse,
        dueDate: data.dueDate,
        priority: data.priority,
        shipping: data.shipping,
        lines,
        status: 'open',
        progress: 10,
        createdAt: new Date().toISOString()
      };
      state.orders.push(order);
      form.reset();
      persist();
      renderOrders();
      renderStats();
      showToast('Order created. Assign a picker to start.');
    });

    const supplierOrderForm = document.getElementById('supplier-order-form');
    if (supplierOrderForm) {
      supplierOrderForm.addEventListener('submit', evt => {
        evt.preventDefault();
        const form = evt.target;
        const data = Object.fromEntries(new FormData(form).entries());
        const vendor = (data.vendor || 'Supplier').trim();
        const focus = (data.focus || 'Mixed cargo').trim();
        const mode = data.mode || 'sea';
        const expectedAt = data.expected ? new Date(data.expected).toISOString() : null;
        const notes = (data.notes || '').trim();
        const createdAt = new Date().toISOString();
        state.purchaseOrders.push({
          id: crypto.randomUUID(),
          name: `${vendor} PO ${createdAt.slice(0, 10)}`,
          vendor,
          expectedAt,
          status: 'Planned',
          lineCount: focus ? focus.split(',').map(item => item.trim()).filter(Boolean).length || 1 : 1,
          createdAt,
          focus,
          mode,
          notes
        });
        renderPurchaseOrders();
        renderSupplierOrders();
        addGamificationEvent(`🌐 Supplier order queued with ${vendor} covering ${focus}.`);
        persist();
        showToast('Supplier purchase logged and synced to missions.');
        form.reset();
      });
    }

    const launchSourcingBtn = document.getElementById('launch-sourcing');
    if (launchSourcingBtn) {
      launchSourcingBtn.addEventListener('click', () => {
        const navBtn = document.querySelector('nav button[data-target="sourcing"]');
        navBtn?.click();
        showToast('Global sourcing desk armed. Log a supplier order to update missions.');
      });
    }

    const globalRefreshBtn = document.getElementById('global-network-refresh');
    if (globalRefreshBtn) {
      globalRefreshBtn.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('global-network-refresh', { detail: { announce: true } }));
      });
    }

    const sourcingSnapshotBtn = document.getElementById('sourcing-snapshot');
    if (sourcingSnapshotBtn) {
      sourcingSnapshotBtn.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('global-network-refresh', { detail: { announce: true, scope: 'vendors' } }));
        showToast('Vendor intelligence refreshed from free data partners.');
      });
    }

    document.getElementById('order-body').addEventListener('click', evt => {
      const btn = evt.target.closest('button');
      if (!btn) return;
      const { action, id } = btn.dataset;
      if (action === 'advance') advanceOrder(id);
      if (action === 'cancel') cancelOrder(id);
    });

    document.getElementById('inventory-search').addEventListener('input', renderInventory);
    document.getElementById('warehouse-filter').addEventListener('change', renderInventory);
    const inventorySortSelect = document.getElementById('inventory-sort');
    if (inventorySortSelect) {
      inventorySortSelect.addEventListener('change', renderInventory);
    }
    const itemColorClear = document.getElementById('item-color-clear');
    if (itemColorClear) {
      itemColorClear.addEventListener('click', () => {
        const colorInput = document.getElementById('item-color');
        const colorToggle = document.getElementById('item-color-toggle');
        if (colorInput) {
          const defaultColor = colorInput.getAttribute('data-default') || '#38bdf8';
          colorInput.value = defaultColor;
        }
        if (colorToggle) {
          colorToggle.checked = false;
        }
      });
    }
    const printStickersBtn = document.getElementById('print-stickers-btn');
    if (printStickersBtn) {
      printStickersBtn.addEventListener('click', () => openStickerPrint(lastInventoryRows));
    }
    const inventoryBody = document.getElementById('inventory-body');
    if (inventoryBody) {
      inventoryBody.addEventListener('click', evt => {
        const target = evt.target instanceof Element ? evt.target : evt.target.parentElement;
        if (!target) return;
        const btn = target.closest('.print-sticker-btn');
        if (!btn) return;
        const { id } = btn.dataset;
        const item = state.items.find(it => it.id === id);
        if (!item) {
          showToast('Sticker data unavailable. Refresh and try again.');
          return;
        }
        openStickerPrint([item]);
      });
    }
    document.getElementById('order-status-filter').addEventListener('change', renderOrders);

    document.getElementById('receipt-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const item = findOrCreateItem({ sku: data.sku });
      item.quantity = (Number(item.quantity) || 0) + (Number(data.quantity) || 0);
      item.lot = data.lot || item.lot;
      item.expiry = data.expiry || item.expiry;
      if (data.warehouse) item.warehouseId = data.warehouse;
      item.location = data.location || item.location;
      state.receipts.push({
        id: crypto.randomUUID(),
        reference: data.reference,
        supplier: data.supplier,
        warehouseId: data.warehouse,
        sku: data.sku,
        quantity: Number(data.quantity) || 0,
        location: data.location,
        lot: data.lot,
        expiry: data.expiry,
        notes: data.notes,
        date: new Date().toISOString()
      });
      persist();
      renderInventory();
      renderReceipts();
      renderStats();
      showToast('Inventory received and added to stock.');
      form.reset();
    });

    document.getElementById('shipment-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.shipments.push({
        id: crypto.randomUUID(),
        orderId: data.orderId,
        carrier: data.carrier,
        tracking: data.tracking,
        packages: Number(data.packages) || 1,
        cost: Number(data.cost) || 0,
        date: new Date().toISOString()
      });
      const order = state.orders.find(o => o.orderId === data.orderId);
      if (order && order.status !== 'shipped') {
        order.status = 'shipped';
        order.progress = 100;
      }
      persist();
      renderShipments();
      renderOrders();
      renderStats();
      showToast('Shipment confirmed and order closed.');
      form.reset();
    });

    document.getElementById('return-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.returns.push({
        id: crypto.randomUUID(),
        orderId: data.orderId,
        sku: data.sku,
        quantity: Number(data.quantity) || 0,
        reason: data.reason,
        disposition: data.disposition,
        date: new Date().toISOString()
      });
      if (data.disposition === 'restock' && data.sku) {
        const item = findOrCreateItem({ sku: data.sku });
        item.quantity = (Number(item.quantity) || 0) + (Number(data.quantity) || 0);
      }
      persist();
      renderReturns();
      renderInventory();
      renderStats();
      showToast('Return recorded.');
      form.reset();
    });

    document.getElementById('tasks-body').addEventListener('click', evt => {
      const btn = evt.target.closest('button');
      if (!btn) return;
      const { action, id } = btn.dataset;
      if (action === 'progress-task') progressTask(id);
      if (action === 'close-task') closeTask(id);
    });

    document.getElementById('task-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.tasks.push({
        id: crypto.randomUUID(),
        title: data.title,
        owner: data.owner,
        type: data.type,
        dueDate: data.dueDate,
        link: data.link,
        status: 'open'
      });
      persist();
      renderTasks();
      showToast('Task dispatched to floor.');
      form.reset();
    });

    document.getElementById('plan-cycle').addEventListener('click', () => {
      const warehouseId = document.getElementById('cycle-warehouse').value;
      const focus = document.getElementById('cycle-focus').value;
      const warehouseName = warehouseId ? getWarehouseName(warehouseId) : 'all warehouses';
      const messages = {
        velocity: 'Prioritize top sellers to catch velocity drift.',
        aging: 'Audit slow movers to reclaim capacity.',
        highValue: 'Double-count high value inventory for shrink control.',
        compliance: 'Ensure lot & expiry data is ready for auditors.'
      };
      document.getElementById('cycle-plan').textContent = `Cycle count scheduled for ${warehouseName}: ${messages[focus]}`;
      showToast('Cycle count playbook generated.');
    });

    document.getElementById('pick-scan').addEventListener('keyup', evt => {
      if (evt.key === 'Enter') {
        const sku = evt.target.value.trim();
        if (!sku) return;
        const item = state.items.find(it => it.sku.toLowerCase() === sku.toLowerCase());
        const el = document.getElementById('pick-result');
        if (!item) {
          el.textContent = 'SKU not found. Consider creating the item first.';
        } else {
          el.innerHTML = `<strong>${item.name}</strong><br>Location: ${item.location || '—'} | On-hand: ${item.quantity}`;
        }
        evt.target.value = '';
      }
    });

    const shopifyCsvInput = document.getElementById('shopify-csv-input');

    function handleShopifyCsvFiles(fileList = []) {
      const files = Array.from(fileList || []).filter(file => file && file.name);
      if (!files.length) return;
      const nextBuffer = { inventory: [], products: [] };
      const readers = files.map(file => new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = event => {
          try {
            const text = event.target?.result || '';
            const parsed = parseCsvToObjects(text);
            const type = detectShopifyCsvType(parsed.headers, file.name);
            if (!type) {
              resolve({ type: null, fileName: file.name });
              return;
            }
            resolve({ type, rows: parsed.rows, fileName: file.name });
          } catch (err) {
            console.warn('Failed to parse Shopify CSV', err);
            resolve({ type: null, fileName: file.name, error: err });
          }
        };
        reader.onerror = () => resolve({ type: null, fileName: file.name });
        reader.readAsText(file);
      }));
      Promise.all(readers).then(results => {
        let inventoryLoaded = false;
        let productLoaded = false;
        const ignored = [];
        results.forEach(result => {
          if (!result) return;
          if (result.type === 'inventory') {
            nextBuffer.inventory.push(...(result.rows || []));
            inventoryLoaded = true;
          } else if (result.type === 'products') {
            nextBuffer.products.push(...(result.rows || []));
            productLoaded = true;
          } else if (result.fileName) {
            ignored.push(result.fileName);
          }
        });
        if (!inventoryLoaded) {
          showToast('No Shopify inventory data found in CSV.');
          if (ignored.length) {
            console.warn('Ignored CSV uploads:', ignored.join(', '));
          }
          return;
        }
        shopifyCsvBuffer.inventory = nextBuffer.inventory;
        shopifyCsvBuffer.products = productLoaded ? nextBuffer.products : [];
        applyShopifyCsvUploads({ notify: true, productLoaded });
        if (ignored.length) {
          console.warn('Ignored CSV uploads:', ignored.join(', '));
        }
      }).finally(() => {
        if (shopifyCsvInput) {
          shopifyCsvInput.value = '';
        }
      });
    }

    if (shopifyCsvInput) {
      shopifyCsvInput.addEventListener('change', evt => {
        handleShopifyCsvFiles(evt.target.files || []);
      });
    }

    const shopifyCsvDropZone = document.querySelector('label.upload-label.shopify-logo-pill');
    if (shopifyCsvDropZone) {
      const preventDefaults = evt => {
        evt.preventDefault();
        evt.stopPropagation();
      };
      ['dragenter', 'dragover'].forEach(eventName => {
        shopifyCsvDropZone.addEventListener(eventName, evt => {
          preventDefaults(evt);
          shopifyCsvDropZone.classList.add('drag-hover');
        });
      });
      ['dragleave', 'dragend'].forEach(eventName => {
        shopifyCsvDropZone.addEventListener(eventName, evt => {
          preventDefaults(evt);
          shopifyCsvDropZone.classList.remove('drag-hover');
        });
      });
      shopifyCsvDropZone.addEventListener('drop', evt => {
        preventDefaults(evt);
        shopifyCsvDropZone.classList.remove('drag-hover');
        const files = Array.from(evt.dataTransfer?.files || []);
        if (files.length) {
          handleShopifyCsvFiles(files);
        }
      });
    }

    document.getElementById('import-input').addEventListener('change', evt => {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          Object.assign(state, data);
          if (!Array.isArray(state.items)) {
            state.items = [];
          }
          state.items.forEach(item => {
            item.color = sanitizeColor(item.color);
          });
          persist();
          initializeUI();
          showToast('Workspace imported.');
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `warehouse-hq-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Backup exported.');
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm('Reset workspace to starter data?')) {
        Object.assign(state, seedState());
        persist();
        initializeUI();
        showToast('Workspace reset.');
      }
    });

    const bundleModules = [
      { id: 'ai-slotting', name: 'AI Slotting Optimization', price: 249, description: 'Adaptive storage recommendations using velocity & demand forecasting.' },
      { id: 'labor-gamification', name: 'Labor Gamification Suite', price: 99, description: 'XP points, leaderboards and streak-based incentives for teams.' },
      { id: 'rfid', name: 'RFID Control Tower', price: 189, description: 'Real-time read events, zone tracking and EPC compliance exports.' },
      { id: 'automation', name: 'Automation Orchestrator', price: 499, description: 'Connect AMRs, conveyors and sorters with drag-and-drop flows.' },
      { id: 'analytics', name: 'Executive Analytics Pack', price: 79, description: 'Cohort KPIs, demand planning, CFO-ready financial dashboards.' },
      { id: 'edi', name: 'Retail EDI Gateway', price: 149, description: 'Send/receive 850, 856, 940/945 and compliance scorecards.' }
    ];

    const bundleState = { selections: new Set(), total: 0 };

    function renderBundler() {
      const tbody = document.getElementById('bundle-body');
      tbody.innerHTML = bundleModules.map(mod => {
        const checked = bundleState.selections.has(mod.id) ? 'checked' : '';
        return `
          <tr>
            <td>${mod.name}</td>
            <td>${mod.description}</td>
            <td>$${mod.price}</td>
            <td><input type="checkbox" data-module="${mod.id}" ${checked}></td>
          </tr>
        `;
      }).join('');
      document.getElementById('bundle-total').textContent = `$${bundleState.total}`;
      document.getElementById('bundle-note').textContent = bundleState.selections.size
        ? 'Nice build! Stripe-ready checkout when you connect billing.'
        : 'Core platform remains free. Add power-ups when you are ready.';
    }

    document.getElementById('open-bundler').addEventListener('click', () => {
      const panel = document.getElementById('bundler');
      const visible = panel.style.display === 'block';
      panel.style.display = visible ? 'none' : 'block';
      renderBundler();
    });

    document.getElementById('bundle-body').addEventListener('change', evt => {
      const id = evt.target.dataset.module;
      if (!id) return;
      if (evt.target.checked) bundleState.selections.add(id);
      else bundleState.selections.delete(id);
      bundleState.total = Array.from(bundleState.selections)
        .map(sel => bundleModules.find(m => m.id === sel)?.price || 0)
        .reduce((a, b) => a + b, 0);
      renderBundler();
    });

    document.getElementById('checkout-bundle').addEventListener('click', () => {
      alert('Stripe checkout flows live in production. For now, track selections as part of your upgrade strategy.');
    });

    const roboticsCheckoutBtn = document.getElementById('robotics-checkout');
    if (roboticsCheckoutBtn) {
      roboticsCheckoutBtn.addEventListener('click', () => {
        alert('Stripe collects your robotics deployment brief. We confirm inventory and installation windows within one business day.');
        showToast('Stripe link sent to your inbox. Expect a fulfillment call from Warehouse HQ shortly.');
      });
    }

    document.getElementById('bundle-body').addEventListener('click', evt => {
      if (evt.target.tagName === 'INPUT') {
        showToast('Bundle updated. AI will recommend savings once usage is detected.');
      }
    });

    document.getElementById('order-health').addEventListener('click', () => {
      showToast('Tip: Create wave picks from the Orders tab to auto-assign teams.');
    });

    document.getElementById('shopify-sync-btn').addEventListener('click', () => syncShopifyIfAvailable(true));

    const loginForm = document.getElementById('login-form');
    if (loginForm){
      const emailInput = loginForm.querySelector('input[name="email"]');
      const passwordInput = loginForm.querySelector('input[name="password"]');
      if (emailInput && !emailInput.value){
        emailInput.value = DEMO_EMAIL;
      }
      if (passwordInput && !passwordInput.value){
        passwordInput.value = DEMO_PASSWORD;
      }
    }

    const demoCredentialsBlock = document.getElementById('demo-credentials');
    if (demoCredentialsBlock){
      const emailEl = demoCredentialsBlock.querySelector('code[data-demo="email"]');
      const passEl = demoCredentialsBlock.querySelector('code[data-demo="password"]');
      const shopEl = demoCredentialsBlock.querySelector('code[data-demo="shop"]');
      if (emailEl) emailEl.textContent = DEMO_EMAIL;
      if (passEl) passEl.textContent = DEMO_PASSWORD;
      if (shopEl) shopEl.textContent = DEMO_SHOP_DOMAIN;
    }

    document.getElementById('register-form').addEventListener('submit', registerAccount);
    document.getElementById('login-form').addEventListener('submit', loginAccount);
    document.getElementById('logout-btn').addEventListener('click', logoutAccount);
    document.getElementById('integration-form').addEventListener('submit', saveIntegration);
    document.getElementById('support-form').addEventListener('submit', submitSupportReport);

    function initializeUI() {
      updateWarehouseSelects();
      renderInventory();
      renderOrders();
      renderReceipts();
      renderShipments();
      renderReturns();
      renderTasks();
      renderCollections();
      renderGiftCards();
      renderPurchaseOrders();
      renderSupplierOrders();
      renderTransfers();
      renderShopifyWarnings();
      renderStats();
      renderBundler();
    }

    applyBranding();
    initBrandingControls();
    updateAccountStatus();
    renderTotpUi();
    fetchIntegrationCatalog();
    loadIntegrations();
    (async () => {
      await restoreSessionFromServer();
      await hydrateAuth();
    })();

    (function(){
      const wrap = document.getElementById('warehouse-visual');
      if (!wrap) return;

      const flowOrders = [
        { id: 'ORD-1842', items: 3, eta: 'Today', status: 'new' },
        { id: 'ORD-1843', items: 1, eta: 'Today', status: 'new' },
        { id: 'ORD-1844', items: 5, eta: 'Today', status: 'new' },
        { id: 'ORD-1845', items: 2, eta: 'Today', status: 'new' }
      ];
      const flowLanes = ['new', 'picking', 'packing', 'shipped'];

      const laneById = id => document.getElementById(`lane-${id}`);

      function makeCard(order) {
        const el = document.createElement('div');
        el.className = 'wh-card';
        el.setAttribute('data-id', order.id);
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <b>${order.id}</b> <span class="badge">${order.items} items</span>
          </div>
          <small>ETA: ${order.eta}</small>
        `;
        return el;
      }

      function renderFlow() {
        flowLanes.forEach(lane => {
          const laneEl = laneById(lane);
          if (laneEl) laneEl.innerHTML = '';
        });
        flowOrders.forEach(order => {
          const laneEl = laneById(order.status);
          if (laneEl) laneEl.appendChild(makeCard(order));
        });
      }

      function flyCard(fromEl, toEl) {
        if (!fromEl || !toEl) return;
        const ghost = fromEl.cloneNode(true);
        const rectFrom = fromEl.getBoundingClientRect();
        const rectTo = toEl.getBoundingClientRect();
        ghost.classList.add('wh-ghost');
        ghost.style.left = `${rectFrom.left + rectFrom.width / 2}px`;
        ghost.style.top = `${rectFrom.top + rectFrom.height / 2}px`;
        document.body.appendChild(ghost);
        const dx = rectTo.left + rectTo.width / 2 - (rectFrom.left + rectFrom.width / 2);
        const dy = rectTo.top + rectTo.height / 2 - (rectFrom.top + rectFrom.height / 2);
        ghost.style.setProperty('--dx', `${dx}px`);
        ghost.style.setProperty('--dy', `${dy}px`);
        ghost.classList.add('animate');
        setTimeout(() => ghost.remove(), 720);
      }

      renderFlow();

      let cursor = 0;
      function advanceFlow() {
        const order = flowOrders[cursor % flowOrders.length];
        const currentIndex = flowLanes.indexOf(order.status);
        if (currentIndex < flowLanes.length - 1) {
          const fromLane = laneById(flowLanes[currentIndex]);
          const fromCard = fromLane?.querySelector(`.wh-card[data-id="${order.id}"]`);
          order.status = flowLanes[currentIndex + 1];
          renderFlow();
          const toLane = laneById(flowLanes[currentIndex + 1]);
          const toCard = toLane?.querySelector(`.wh-card[data-id="${order.id}"]`);
          flyCard(fromCard, toCard);
          if (order.status === 'picking') incrementKpi('orders', 1);
          if (order.status === 'shipped') incrementKpi('ots', Math.random() < 0.9 ? 1 : 0);
        } else {
          order.status = 'new';
          renderFlow();
        }
        cursor += 1;
      }

      const kpiValues = { orders: 0, pickTime: 9, ots: 92, bo: 3 };
      const sparkHistory = { orders: [], pickTime: [], ots: [], bo: [] };

      function drawSpark(name) {
        const canvas = document.querySelector(`canvas[data-spark="${name}"]`);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const width = (canvas.width = canvas.clientWidth * window.devicePixelRatio);
        const height = (canvas.height = canvas.clientHeight * window.devicePixelRatio);
        const data = sparkHistory[name].slice(-40);
        if (!data.length) return;
        const min = Math.min(...data);
        const max = Math.max(...data);
        ctx.clearRect(0, 0, width, height);
        ctx.lineWidth = 2 * window.devicePixelRatio;
        ctx.strokeStyle = '#6ae3ff';
        ctx.beginPath();
        data.forEach((value, index) => {
          const x = (index / Math.max(1, data.length - 1)) * width;
          const y = height - ((value - min) / Math.max(1, max - min)) * height;
          if (index === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      function animateKpi(name, target, suffix = '') {
        const el = document.querySelector(`.num[data-kpi="${name}"]`);
        if (!el) return;
        const startValue = Number(String(el.textContent).replace(/[^\d]/g, '')) || 0;
        const start = performance.now();
        const duration = 400;
        function step(now) {
          const progress = Math.min(1, (now - start) / duration);
          el.textContent = `${Math.round(startValue + (target - startValue) * progress)}${suffix}`;
          if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      function incrementKpi(name, delta) {
        kpiValues[name] = Math.max(0, (kpiValues[name] || 0) + delta);
        sparkHistory[name].push(kpiValues[name]);
        drawSpark(name);
        const suffix = name === 'pickTime' ? 'm' : name === 'ots' ? '%' : '';
        animateKpi(name, kpiValues[name], suffix);
      }

      ['orders', 'pickTime', 'ots', 'bo'].forEach(key => {
        for (let i = 0; i < 20; i += 1) {
          const base = key === 'ots' ? 88 : key === 'bo' ? 3 : 5;
          sparkHistory[key].push(Math.max(1, Math.round(Math.random() * 10 + base)));
        }
        drawSpark(key);
        const suffix = key === 'pickTime' ? 'm' : key === 'ots' ? '%' : '';
        animateKpi(key, kpiValues[key], suffix);
      });

      setInterval(advanceFlow, 1600);

      const scanButton = document.getElementById('btnScan');
      const fakeButton = document.getElementById('btnFakeScan');
      const scanVideo = document.getElementById('scanVideo');
      const scanLine = document.getElementById('scanLine');

      scanButton?.addEventListener('click', async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
          if (scanVideo) {
            scanVideo.srcObject = stream;
            await scanVideo.play();
          }
          scanLine?.classList.add('animate');
        } catch (error) {
          alert('Camera not available.');
        }
      });

      fakeButton?.addEventListener('click', () => {
        scanLine?.classList.add('animate');
        setTimeout(() => {
          scanLine?.classList.remove('animate');
          alert('✓ Code recognized → Item received');
        }, 1600);
      });
    })();

    (function initGlobalFreightMap() {
      const mapEl = document.getElementById('global-map');
      const activityList = document.getElementById('global-activity-list');
      if (!mapEl || !activityList) return;

      let hasLeaflet = typeof L !== 'undefined';
      const hour = 60 * 60 * 1000;
      const minute = 60 * 1000;
      const now = Date.now();

      const networkRoutes = [
        {
          id: 'sea-apparel',
          mode: 'sea',
          origin: { name: 'Shanghai, CN (CNSHA)', coords: [31.2304, 121.4737] },
          destination: { name: 'Los Angeles, US (USLAX)', coords: [33.7406, -118.2728] },
          goods: 'Apparel & footwear – 8×40′ HQ',
          transportId: 'MV Ever Resolute',
          departureOffsetHours: -72,
          arrivalOffsetHours: 36,
          signalMinutesAgo: 18,
          signalSource: 'AIS • AISHub',
          status: 'Pacific crossing on schedule after Ningbo loadout.',
          nextMilestone: 'Customs pre-clearance review closes in 4h.',
          path: [
            [31.2304, 121.4737],
            [33.9, 140.0],
            [32.5, -140.0],
            [33.7406, -118.2728]
          ]
        },
        {
          id: 'air-electronics',
          mode: 'air',
          origin: { name: 'Guangzhou, CN (CAN)', coords: [23.3924, 113.2988] },
          destination: { name: 'Chicago, US (ORD)', coords: [41.9742, -87.9073] },
          goods: 'Consumer electronics & premium footwear',
          transportId: 'CZ Cargo 747F',
          departureOffsetHours: -6,
          arrivalOffsetHours: 8,
          signalMinutesAgo: 6,
          signalSource: 'ADS-B • OpenSky',
          status: 'Cruising over the Yukon corridor with stable ETD.',
          nextMilestone: 'Cargo transfer to ORD ramp handling in 2h.',
          path: [
            [23.3924, 113.2988],
            [45.0, 135.0],
            [61.1743, -149.9985],
            [49.2827, -123.1207],
            [41.9742, -87.9073]
          ]
        },
        {
          id: 'rail-textiles',
          mode: 'rail',
          origin: { name: 'Seattle, US (TAC)', coords: [47.5998, -122.3343] },
          destination: { name: 'Chicago, US (CIC)', coords: [41.8781, -87.6298] },
          goods: 'Transloaded textiles & small appliances',
          transportId: 'BNSF Stack Train Z-7342',
          departureOffsetHours: -20,
          arrivalOffsetHours: 28,
          signalMinutesAgo: 32,
          signalSource: 'Terminal EDI • Port of Seattle',
          status: 'Departed Seattle on-time with double-stack consist.',
          nextMilestone: 'Interchange to Chicago logistics campus in 7h.',
          path: [
            [47.5998, -122.3343],
            [46.0, -116.5],
            [44.5, -108.5],
            [43.0, -100.0],
            [41.8781, -87.6298]
          ]
        },
        {
          id: 'truck-produce',
          mode: 'truck',
          origin: { name: 'Long Beach, US (LGB)', coords: [33.7676, -118.1957] },
          destination: { name: 'Dallas, US (DFW)', coords: [32.7767, -96.7970] },
          goods: 'Reefer loads – citrus, berries, and greens',
          transportId: 'Reefer Convoy TX-4821',
          departureOffsetHours: -8,
          arrivalOffsetHours: 22,
          signalMinutesAgo: 14,
          signalSource: 'ELD ping • I-10 corridor',
          status: 'Crossed Arizona weigh station with temperature logs stable.',
          nextMilestone: 'Arriving at Dallas cross-dock in 6h.',
          path: [
            [33.7676, -118.1957],
            [34.0407, -117.9090],
            [33.4484, -112.0740],
            [31.7619, -106.4850],
            [32.7767, -96.7970]
          ]
        }
      ];

      const routeStyles = {
        sea: '#38bdf8',
        air: '#fbbf24',
        rail: '#a855f7',
        truck: '#f97316'
      };
      const dashStyles = {
        sea: '12 10',
        air: '6 6',
        rail: '4 8',
        truck: '2 6'
      };

      const statusTemplates = {
        sea: [
          'Anchored off San Pedro Bay awaiting berth assignment.',
          'Cleared Vancouver routing — steering toward Long Beach pilot.',
          'Customs paperwork accepted, steaming toward Pier T discharge.'
        ],
        air: [
          'Cabin crew confirmed on-time handoff to ramp handlers.',
          'Wheels-down at Anchorage tech stop with fuel uplift complete.',
          'Awaiting slot release into ORD cargo ramp.'
        ],
        rail: [
          'Passing through Montana high desert with priority clearance.',
          'Union Pacific interchange confirmed for Chicago Logistics Park.',
          'Crew change at North Platte complete — speed restrictions lifted.'
        ],
        truck: [
          'Departed Albuquerque rest window with reefer temps green.',
          'Cleared Texas DPS inspection — continuing eastbound.',
          'On I-20 east of Midland with light traffic and ample fuel.'
        ]
      };

      const milestoneTemplates = {
        sea: [
          'Rail transfer at ICTF yard planned in 9h.',
          'Drayage appointments staged for 2 shifts out.',
          'USDA sampling to be scheduled upon berth confirmation.'
        ],
        air: [
          'Line-haul truck departs ORD cargo in 3h.',
          'Customs exam window assigned on arrival +1h.',
          'Freight forwarder release to sorter at 18:00 local.'
        ],
        rail: [
          'Chicago ramp slot reserved for 06:30 tomorrow.',
          'Final-mile drayage pairing will be published after interchange.',
          'Cross-dock wave building pallets ahead of arrival.'
        ],
        truck: [
          'Cold storage receiving dock opens in 6h.',
          'Final temperature check scheduled before Dallas arrival.',
          'Distributor allocation file pushes at 04:00 local.'
        ]
      };

      const routeLookup = new Map();

      function haversine(a, b) {
        const toRad = deg => (deg * Math.PI) / 180;
        const R = 6371;
        const dLat = toRad(b[0] - a[0]);
        const dLng = toRad(b[1] - a[1]);
        const lat1 = toRad(a[0]);
        const lat2 = toRad(b[0]);
        const sinLat = Math.sin(dLat / 2);
        const sinLng = Math.sin(dLng / 2);
        const h = sinLat * sinLat + Math.cos(lat1) * Math.cos(lat2) * sinLng * sinLng;
        return 2 * R * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
      }

      function computeSegments(route) {
        const coords = Array.isArray(route.path) ? route.path : [];
        const segments = [];
        let total = 0;
        for (let i = 0; i < coords.length - 1; i += 1) {
          const dist = haversine(coords[i], coords[i + 1]);
          segments.push(dist);
          total += dist;
        }
        route.segmentLengths = segments;
        route.totalLength = total || 1;
      }

      function interpolate(route, ratio) {
        const coords = route.path || [];
        if (!coords.length) return [0, 0];
        if (coords.length === 1) return coords[0];
        const target = Math.max(0, Math.min(1, ratio)) * route.totalLength;
        let traveled = 0;
        for (let i = 0; i < route.segmentLengths.length; i += 1) {
          const seg = route.segmentLengths[i];
          if (traveled + seg >= target) {
            const portion = seg ? (target - traveled) / seg : 0;
            const [lat1, lng1] = coords[i];
            const [lat2, lng2] = coords[i + 1];
            return [lat1 + (lat2 - lat1) * portion, lng1 + (lng2 - lng1) * portion];
          }
          traveled += seg;
        }
        return coords[coords.length - 1];
      }

      function getProgress(route, timestamp = Date.now()) {
        const total = route.arrival - route.departure;
        if (total <= 0) return 1;
        if (timestamp <= route.departure) return 0;
        if (timestamp >= route.arrival) return 1;
        return (timestamp - route.departure) / total;
      }

      function formatRelative(deltaMs) {
        if (!Number.isFinite(deltaMs)) return '—';
        const abs = Math.abs(deltaMs);
        if (abs < minute) return deltaMs >= 0 ? 'moments away' : 'just now';
        const minutes = Math.round(abs / minute);
        if (minutes < 60) {
          return deltaMs >= 0 ? `in ${minutes}m` : `${minutes}m ago`;
        }
        const hours = Math.floor(abs / hour);
        const remainingMinutes = Math.round((abs - hours * hour) / minute);
        if (hours < 48) {
          const parts = [`${hours}h`];
          if (remainingMinutes > 0 && remainingMinutes < 60) parts.push(`${remainingMinutes}m`);
          const value = parts.join(' ');
          return deltaMs >= 0 ? `in ${value}` : `${value} ago`;
        }
        const days = Math.round(abs / (24 * hour));
        return deltaMs >= 0 ? `in ${days}d` : `${days}d ago`;
      }

      function buildTooltip(route) {
        const etaText = formatRelative(route.arrival - Date.now());
        return `<strong>${route.transportId}</strong><br>${etaText}`;
      }

      function updateTracker(route) {
        if (!hasLeaflet || !route.marker) return;
        const progress = getProgress(route);
        const coords = interpolate(route, progress);
        route.marker.setLatLng(coords);
        const tooltip = route.marker.getTooltip();
        if (tooltip) {
          tooltip.setContent(buildTooltip(route));
        }
      }

      function formatLastPing(route) {
        if (!route.signalAt) return 'No recent ping';
        return `${formatRelative(route.signalAt - Date.now())} via ${route.signalSource}`;
      }

      function updateActivityList() {
        if (!activityList) return;
        if (!networkRoutes.length) {
          activityList.innerHTML = '<li><span class="hint">No live routes available.</span></li>';
          return;
        }
        activityList.innerHTML = networkRoutes.map(route => {
          const etaText = formatRelative(route.arrival - Date.now());
          const lastPing = formatLastPing(route);
          return `
            <li data-mode="${route.mode}" data-route="${route.id}">
              <div class="activity-header">
                <span class="badge-mode" data-mode="${route.mode}">${route.mode.toUpperCase()}</span>
                <span class="activity-status">${route.origin.name} → ${route.destination.name}</span>
              </div>
              <div class="activity-meta">
                <span>${route.goods}</span>
                <span>${route.transportId}</span>
                <span>ETA ${etaText}</span>
                <span>${lastPing}</span>
              </div>
              <div class="activity-meta">
                <span>Status: ${route.status}</span>
                <span>${route.nextMilestone}</span>
              </div>
            </li>
          `;
        }).join('');

        if (hasLeaflet) {
          activityList.querySelectorAll('li').forEach(li => {
            const route = routeLookup.get(li.dataset.route);
            if (!route || !route.polyline) return;
            li.addEventListener('mouseenter', () => {
              route.polyline.setStyle({ weight: route.baseStyle.weight + 1.5, opacity: 1 });
            });
            li.addEventListener('mouseleave', () => {
              route.polyline.setStyle(route.baseStyle);
            });
            li.addEventListener('click', () => {
              if (!route.marker || !route.marker.getLatLng) return;
              const latLng = route.marker.getLatLng();
              try {
                const targetZoom = Math.max(3, map.getZoom());
                map.flyTo(latLng, targetZoom, { duration: 0.7 });
              } catch (err) {
                map.setView(latLng, 3);
              }
            });
          });
        }
      }

      function refreshNetworkSnapshots(detail = {}) {
        const nowTs = Date.now();
        networkRoutes.forEach(route => {
          route.signalAt = nowTs - ((8 + Math.random() * 40) * minute);
          const statuses = statusTemplates[route.mode] || [];
          const milestones = milestoneTemplates[route.mode] || [];
          if (statuses.length) {
            route.status = statuses[Math.floor(Math.random() * statuses.length)];
          }
          if (milestones.length) {
            route.nextMilestone = milestones[Math.floor(Math.random() * milestones.length)];
          }
          if (route.baseArrival == null) {
            route.baseArrival = route.arrival;
          }
          const jitter = (Math.random() - 0.5) * hour;
          route.arrival = Math.min(route.baseArrival + 4 * hour, Math.max(route.baseArrival - 4 * hour, route.baseArrival + jitter));
          updateTracker(route);
        });
        updateActivityList();
        if (detail?.announce && typeof showToast === 'function') {
          const scope = detail?.scope === 'vendors' ? 'Vendor intelligence refreshed.' : 'Global freight feeds refreshed.';
          showToast(scope);
        }
      }

      let map;
      let trackerIcons = {};
      let mapReady = false;
      let trackerIntervalId = null;

      networkRoutes.forEach(route => {
        route.departure = now + route.departureOffsetHours * hour;
        route.arrival = now + route.arrivalOffsetHours * hour;
        route.label = `${route.origin.name} → ${route.destination.name}`;
        route.baseArrival = route.arrival;
        route.signalAt = now - route.signalMinutesAgo * minute;
        computeSegments(route);
        routeLookup.set(route.id, route);
      });

      function initializeNetworkMap() {
        hasLeaflet = typeof L !== 'undefined';
        if (!hasLeaflet || mapReady) {
          if (!hasLeaflet) {
            mapEl.innerHTML = '<div class="hint">Enable maps to visualize live routes.</div>';
          }
          return;
        }

        mapEl.innerHTML = '';
        map = L.map(mapEl, {
          worldCopyJump: true,
          minZoom: 2,
          maxZoom: 7,
          zoomControl: false,
          inertia: true
        });
        map.setView([28, 20], 2);
        L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles © Esri — Source: Esri, Earthstar Geographics, NOAA, USGS, OpenStreetMap'
        }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        trackerIcons = {
          sea: L.icon({ iconUrl: '/image/icon_freight_boat.png', iconSize: [40, 40], iconAnchor: [20, 20], tooltipAnchor: [0, -20] }),
          air: L.icon({ iconUrl: '/image/icon_freight_plane.png', iconSize: [36, 36], iconAnchor: [18, 18], tooltipAnchor: [0, -18] }),
          rail: L.icon({ iconUrl: '/image/icon_freight_train.png', iconSize: [36, 36], iconAnchor: [18, 18], tooltipAnchor: [0, -18] }),
          truck: L.icon({ iconUrl: '/image/icon_freight_truck.png', iconSize: [34, 34], iconAnchor: [17, 17], tooltipAnchor: [0, -16] })
        };

        networkRoutes.forEach(route => {
          route.baseStyle = { color: routeStyles[route.mode], weight: 3.4, opacity: 0.85, dashArray: dashStyles[route.mode] };
          route.polyline = L.polyline(route.path, route.baseStyle).addTo(map);
          L.circleMarker(route.path[0], { radius: 5, className: `route-node route-node--${route.mode}` }).addTo(map).bindTooltip(`Origin: ${route.origin.name}`);
          L.circleMarker(route.path[route.path.length - 1], { radius: 5, className: `route-node route-node--${route.mode}` }).addTo(map).bindTooltip(`Destination: ${route.destination.name}`);
          const progress = getProgress(route);
          const coords = interpolate(route, progress);
          route.marker = L.marker(coords, { icon: trackerIcons[route.mode], zIndexOffset: 900 }).addTo(map);
          route.marker.bindTooltip(buildTooltip(route), { direction: 'top', opacity: 0.9 });
        });

        mapReady = true;

        if (!trackerIntervalId) {
          trackerIntervalId = setInterval(() => {
            networkRoutes.forEach(updateTracker);
          }, 20000);
        }

        updateActivityList();
      }

      initializeNetworkMap();
      if (!mapReady) {
        window.addEventListener('load', () => {
          if (mapReady) return;
          initializeNetworkMap();
          updateActivityList();
        }, { once: true });
      }

      updateActivityList();
      setInterval(updateActivityList, 60000);

    document.addEventListener('global-network-refresh', evt => refreshNetworkSnapshots(evt?.detail || {}));
  })();

    (function registerScannerSync() {
      if (typeof BroadcastChannel === 'function') {
        const scanChannel = new BroadcastChannel(SCAN_CHANNEL_NAME);
        scanChannel.addEventListener('message', event => {
          if (!event || typeof event.data !== 'object') return;
          processScannerPayload(event.data);
        });
      }

      window.addEventListener('storage', event => {
        if (event.key === SCAN_STORAGE_EVENT_KEY && event.newValue) {
          try {
            const payload = JSON.parse(event.newValue);
            processScannerPayload(payload);
          } catch (err) {
            console.warn('Failed to apply scanner payload from storage', err);
          }
        } else if (event.key === STORAGE_KEY && event.newValue) {
          try {
            const refreshed = loadState();
            syncState(refreshed);
            updateWarehouseSelects();
            renderInventory();
            renderOrders();
            renderReceipts();
            renderShipments();
            renderReturns();
            renderStats();
          } catch (err) {
            console.warn('Failed to refresh dashboard from storage', err);
          }
        }
      });
    })();

    handleNavigation();
    drainStoredScanQueue();
    initializeUI();
  </script>
</body>
</html>
