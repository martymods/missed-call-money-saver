<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warehouse HQ ‚Äì Logistics Command Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --bg-panel: rgba(15, 23, 42, 0.85);
      --bg-panel-light: rgba(248, 250, 252, 0.9);
      --bg-surface: rgba(15, 23, 42, 0.95);
      --bg-surface-light: rgba(255, 255, 255, 0.95);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --accent-strong: rgba(56, 189, 248, 0.35);
      --border: rgba(148, 163, 184, 0.2);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --danger: #f87171;
      --success: #4ade80;
      --warning: #facc15;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at center, rgba(14, 116, 144, 0.1), transparent 65%),
        radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.12), transparent 70%),
        #020617;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(16px);
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.8));
      border-bottom: 1px solid var(--border);
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem;
    }

    h1 {
      font-size: clamp(1.75rem, 2.2vw, 2.5rem);
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    h2 {
      margin: 1.5rem 0 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
    }

    p {
      color: var(--text-muted);
    }

    nav {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    nav button {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, border 0.2s;
    }

    nav button:hover,
    nav button.active {
      background: var(--accent-strong);
      border-color: rgba(56, 189, 248, 0.6);
      transform: translateY(-1px);
    }

    main {
      flex: 1;
      width: 100%;
    }

    section {
      display: none;
      animation: fade 0.3s ease forwards;
    }

    section.active {
      display: block;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(12px);
    }

    .panel.light {
      background: var(--bg-panel-light);
      color: #0f172a;
      border-color: rgba(30, 41, 59, 0.15);
      box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 0.9rem;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }

    .stat-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(56, 189, 248, 0.15));
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .stat-card:hover::after {
      opacity: 1;
    }

    .stat-card h3 {
      margin: 0 0 0.25rem;
      font-size: 0.95rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-card strong {
      font-size: 1.65rem;
      font-weight: 700;
      display: block;
    }

    .stat-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    form {
      display: grid;
      gap: 0.8rem;
      margin-top: 0.5rem;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    input, select, textarea {
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: inherit;
      padding: 0.6rem 0.75rem;
      font-size: 0.95rem;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    button.cta {
      background: linear-gradient(135deg, #38bdf8, #2563eb);
      border: none;
      color: white;
      padding: 0.65rem 1.1rem;
      border-radius: 0.75rem;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      justify-self: start;
      box-shadow: 0 15px 30px rgba(37, 99, 235, 0.35);
    }

    button.secondary {
      background: transparent;
      color: inherit;
      border: 1px solid var(--border);
      padding: 0.6rem 1rem;
      border-radius: 0.75rem;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
    }

    th, td {
      padding: 0.65rem 0.75rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 0.9rem;
    }

    th {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .tag.low { color: var(--warning); border-color: rgba(250, 204, 21, 0.6); }
    .tag.ok { color: var(--success); border-color: rgba(74, 222, 128, 0.6); }
    .tag.risk { color: var(--danger); border-color: rgba(248, 113, 113, 0.6); }

    .table-scroll {
      overflow-x: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .badge {
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent);
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .flex {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .flex-space {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .actions button {
      border-radius: 999px;
      padding: 0.3rem 0.85rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
      cursor: pointer;
    }

    .actions button:hover {
      border-color: rgba(56, 189, 248, 0.7);
      color: var(--accent);
    }

    .summary-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      margin-top: 1.2rem;
    }

    .summary-tile {
      padding: 1rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.75);
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .summary-tile h3 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 600;
    }

    .summary-tile p {
      margin: 0.2rem 0 0;
      font-size: 0.85rem;
    }

    .list {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.9rem;
    }

    .list li {
      margin-bottom: 0.3rem;
    }

    footer {
      padding: 2rem 1.25rem 3rem;
      border-top: 1px solid var(--border);
      margin-top: 2rem;
      background: rgba(15, 23, 42, 0.9);
    }

    footer small {
      color: var(--text-muted);
    }

    .toolbar {
      display: inline-flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar button,
    button.toolbar {
      padding: 0.55rem 0.85rem;
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.75);
      color: inherit;
      cursor: pointer;
    }

    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem; }
    canvas.stat-chart { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 0.85rem; padding: 0.75rem; }
    .integrations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .integration-card { border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.82); box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25); display: flex; flex-direction: column; gap: 0.6rem; }
    .integration-card img { width: 46px; height: 46px; border-radius: 0.75rem; background: rgba(56, 189, 248, 0.12); padding: 0.4rem; }
    .integration-card .tagline { font-size: 0.8rem; color: var(--text-muted); }
    .integration-card button { align-self: flex-start; }
    .account-status { margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-muted); }
    .account-actions { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-top: 0.75rem; }
    .brand-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .brand-preview { border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.75); display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px; }
    .brand-preview .preview-card { border: 1px solid rgba(148, 163, 184, 0.18); border-radius: 0.85rem; padding: 0.75rem; background: rgba(56, 189, 248, 0.08); }
    .brand-preview .preview-hero { font-weight: 700; font-size: 1.05rem; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
    .gallery img { width: 100%; height: 110px; object-fit: cover; border-radius: 0.85rem; border: 1px solid rgba(148, 163, 184, 0.25); box-shadow: 0 18px 30px rgba(2, 6, 23, 0.35); }
    .reward-badge { margin-top: 1rem; display: none; align-items: center; gap: 0.6rem; font-weight: 600; background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(99, 102, 241, 0.2)); border: 1px solid rgba(56, 189, 248, 0.4); padding: 0.75rem 1rem; border-radius: 0.9rem; box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35); }
    .reward-badge.show { display: flex; animation: pop 0.6s ease; }
    @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .support-response { margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-muted); }
    .one-click-tag { font-size: 0.7rem; padding: 0.15rem 0.45rem; border-radius: 999px; background: rgba(56, 189, 248, 0.16); color: var(--accent); text-transform: uppercase; letter-spacing: 0.04em; }
    .integration-table-empty { color: var(--text-muted); text-align: center; padding: 1rem 0; }
    .badge-emoji { font-size: 2rem; }
    .mini-input { font-size: 0.8rem; color: var(--text-muted); }

    .toolbar input[type="file"] {
      display: none;
    }

    .upload-label {
      border: 1px dashed rgba(148, 163, 184, 0.4);
      padding: 0.65rem 0.9rem;
      border-radius: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
    }

    .callout {
      border-left: 3px solid var(--accent);
      padding-left: 1rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .status-pill {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-open { background: rgba(56, 189, 248, 0.18); color: #38bdf8; }
    .status-picking { background: rgba(129, 140, 248, 0.2); color: #818cf8; }
    .status-packed { background: rgba(45, 212, 191, 0.2); color: #14b8a6; }
    .status-shipped { background: rgba(22, 163, 74, 0.2); color: #22c55e; }
    .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 2rem;
      padding: 0.85rem 1.1rem;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 0.8rem;
      border: 1px solid rgba(56, 189, 248, 0.45);
      color: #f1f5f9;
      box-shadow: 0 20px 40px rgba(2, 6, 23, 0.45);
      transform: translateY(120%);
      opacity: 0;
      transition: transform 0.35s ease, opacity 0.35s ease;
      z-index: 20;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    @media (max-width: 720px) {
      nav {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .wrap {
        padding: 1rem 1rem 1.5rem;
      }

      table {
        font-size: 0.85rem;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex-space">
        <div>
          <h1>Warehouse HQ</h1>
          <p>The logistics mission control for omni-channel merchants, from indie resellers to enterprise hubs.</p>
        </div>
        <div class="badge">Multi-tenant ‚Ä¢ Cloud-Ready ‚Ä¢ Free Forever Core</div>
      </div>
      <nav>
        <button data-target="overview" class="active">Mission Control</button>
        <button data-target="inventory">Inventory</button>
        <button data-target="orders">Orders & Fulfillment</button>
        <button data-target="receiving">Inbound</button>
        <button data-target="shipping">Shipping & Returns</button>
        <button data-target="labor">Teams & Tasks</button>
        <button data-target="settings">Data & Settings</button>
        <button data-target="account">My Account</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section id="overview" class="active">
      <div class="panel">
        <h2>Live Command Dashboard</h2>
        <p>Stay ahead of the floor: review health signals, SLA watch-outs, and AI nudges to guide your next move.</p>
        <div class="stats" id="stat-cards"></div>
      </div>

      <div class="summary-grid">
        <div class="summary-tile">
          <div>
            <h3>Today&apos;s Priorities</h3>
            <ul class="list" id="priority-list"></ul>
          </div>
          <p class="hint">Automated by your Warehouse HQ assistant. Refresh as priorities evolve.</p>
        </div>
        <div class="summary-tile">
          <div>
            <h3>Integration Pulse</h3>
            <ul class="list">
              <li><strong>Commerce:</strong> Shopify, Amazon, eBay, Faire, POS</li>
              <li><strong>Accounting:</strong> QuickBooks, Xero, NetSuite, Odoo</li>
              <li><strong>Automation:</strong> Zebra scanners, RFID gateways, Locus bots</li>
            </ul>
          </div>
          <p class="hint">Connect via Settings ‚Üí Integrations. No-code connectors included.</p>
        </div>
        <div class="summary-tile">
          <div>
            <h3>Monetize & Gamify</h3>
            <ul class="list">
              <li>Dynamic subscription bundler for your ops scale.</li>
              <li>Unlock premium AI slotting when KPIs trend up.</li>
              <li>Seasonal power-ups keep teams motivated.</li>
            </ul>
          </div>
          <p class="hint">Stripe-powered marketplace makes upgrades feel like a game night.</p>
        </div>
      </div>

      <div class="panel">
        <h3>Ops Visualizer</h3>
        <p class="hint">See stocking, sorting and labeling in living color. Powered by your command center telemetry.</p>
        <div class="chart-grid">
          <canvas id="inventoryChart" class="stat-chart" height="180" aria-label="Inventory velocity chart"></canvas>
          <canvas id="orderChart" class="stat-chart" height="180" aria-label="Order status chart"></canvas>
          <canvas id="missionChart" class="stat-chart" height="180" aria-label="Mission energy chart"></canvas>
        </div>
      </div>
    </section>

    <section id="inventory">
      <div class="panel">
        <div class="flex-space">
          <div>
            <h2>Inventory Catalogue</h2>
            <p>Unified visibility by warehouse, zone, variant and compliance lot.</p>
          </div>
          <div class="toolbar">
            <label class="upload-label">
              <span>‚¨ÜÔ∏é Import JSON</span>
              <input type="file" id="import-input" accept="application/json" />
            </label>
            <button class="toolbar" id="export-btn">‚¨áÔ∏é Export Backup</button>
            <button class="toolbar" id="reset-btn">Reset Workspace</button>
          </div>
        </div>
        <div class="grid grid-2">
          <form id="warehouse-form" class="panel light">
            <h3>New Warehouse / Zone</h3>
            <label>Name
              <input type="text" name="name" required placeholder="Delco Fulfillment East" />
            </label>
            <label>Type
              <select name="type">
                <option value="Fulfillment Center">Fulfillment Center</option>
                <option value="3PL Client">3PL Client</option>
                <option value="Retail Store">Retail Store</option>
                <option value="Pop-up">Pop-up</option>
                <option value="Cold Storage">Cold Storage</option>
              </select>
            </label>
            <label>Capacity (pallets)
              <input type="number" name="capacity" min="0" placeholder="1200" />
            </label>
            <label>Address / Notes
              <textarea name="notes" placeholder="123 Market St, Philadelphia, PA"></textarea>
            </label>
            <button class="cta" type="submit">Add Warehouse</button>
          </form>

          <form id="item-form" class="panel light">
            <h3>Create / Update SKU</h3>
            <label>SKU / Barcode
              <input type="text" name="sku" required placeholder="SKU-ABC-001" />
            </label>
            <label>Product Name
              <input type="text" name="name" required placeholder="Wing Ding Hoodie" />
            </label>
            <label>Variant (size, color, etc.)
              <input type="text" name="variant" placeholder="XL / Black" />
            </label>
            <label>Category
              <input type="text" name="category" placeholder="Apparel" />
            </label>
            <label>Warehouse
              <select name="warehouse" id="item-warehouse"></select>
            </label>
            <label>Bin / Location
              <input type="text" name="location" placeholder="Aisle 4 ‚Üí Bay B ‚Üí Level 2" />
            </label>
            <label>On-hand Qty
              <input type="number" name="quantity" min="0" value="0" />
            </label>
            <label>Reorder Point
              <input type="number" name="reorder" min="0" value="10" />
            </label>
            <label>Lot / Batch
              <input type="text" name="lot" placeholder="LOT-2025-04" />
            </label>
            <label>Expiry (if applicable)
              <input type="date" name="expiry" />
            </label>
            <label>Unit Cost (optional)
              <input type="number" name="unitCost" min="0" step="0.01" placeholder="12.50" />
            </label>
            <button class="cta" type="submit">Save SKU</button>
          </form>
        </div>

        <div class="panel">
          <div class="flex-space">
            <h3>Inventory Snapshot</h3>
            <div class="flex">
              <input type="search" id="inventory-search" placeholder="Search SKU, name, lot‚Ä¶" />
              <select id="warehouse-filter"></select>
            </div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th>Warehouse</th>
                  <th>Location</th>
                  <th>Qty</th>
                  <th>Reorder</th>
                  <th>Lot / Exp</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="inventory-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="orders">
      <div class="panel">
        <h2>Orders & Fulfillment</h2>
        <p>Unify B2C drops, wholesale and store replenishment. Control picking waves and shipping promises from one screen.</p>
        <div class="grid grid-2">
          <form id="order-form" class="panel light">
            <h3>Create Order</h3>
            <label>Order ID / Reference
              <input type="text" name="orderId" required placeholder="WEB-10045" />
            </label>
            <label>Customer / Channel
              <input type="text" name="customer" placeholder="Shopify ‚Äì Jane Smith" />
            </label>
            <label>Warehouse Fulfilling
              <select name="warehouse" id="order-warehouse"></select>
            </label>
            <label>Due Date
              <input type="date" name="dueDate" />
            </label>
            <label>Priority
              <select name="priority">
                <option value="Standard">Standard</option>
                <option value="Rush">Rush</option>
                <option value="Same Day">Same Day</option>
              </select>
            </label>
            <label>Shipping Method
              <input type="text" name="shipping" placeholder="UPS Ground" />
            </label>
            <label>Items (SKU:Qty per line)
              <textarea name="lines" required placeholder="SKU-ABC-001:3\nSKU-FTW-002:1"></textarea>
            </label>
            <button class="cta" type="submit">Create Order</button>
          </form>

          <div class="panel light">
            <h3>Mobile Pick Assist</h3>
            <label>Scan / Enter SKU
              <input type="text" id="pick-scan" placeholder="Scan barcode" />
            </label>
            <div id="pick-result" class="callout">Awaiting scan‚Ä¶</div>
            <h4>Order Queue Health</h4>
            <ul class="list" id="order-health"></ul>
          </div>
        </div>

        <div class="panel">
          <div class="flex-space">
            <h3>Open Orders</h3>
            <div class="flex">
              <select id="order-status-filter">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="picking">Picking</option>
                <option value="packed">Packed</option>
                <option value="shipped">Shipped</option>
              </select>
            </div>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Order</th>
                  <th>Warehouse</th>
                  <th>Lines</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Progress</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="order-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="receiving">
      <div class="panel">
        <h2>Inbound, Put-away & Compliance</h2>
        <p>Automate ASN matching, directed put-away and QA holds. Cycle counts and audits stay synced.</p>
        <div class="grid grid-2">
          <form id="receipt-form" class="panel light">
            <h3>Receive Inventory</h3>
            <label>Reference / ASN
              <input type="text" name="reference" placeholder="ASN-5541" />
            </label>
            <label>Supplier
              <input type="text" name="supplier" placeholder="Delco Apparel Mfg" />
            </label>
            <label>Warehouse
              <select name="warehouse" id="receipt-warehouse"></select>
            </label>
            <label>SKU
              <input type="text" name="sku" required placeholder="SKU-ABC-001" />
            </label>
            <label>Quantity Received
              <input type="number" name="quantity" min="1" required value="1" />
            </label>
            <label>Put-away Location
              <input type="text" name="location" placeholder="Aisle 5 ‚Üí Bay C ‚Üí Level 1" />
            </label>
            <label>Lot / Batch
              <input type="text" name="lot" placeholder="LOT-APR-2025" />
            </label>
            <label>Expiry Date
              <input type="date" name="expiry" />
            </label>
            <label>Notes
              <textarea name="notes" placeholder="QA hold for inspection"></textarea>
            </label>
            <button class="cta" type="submit">Receive & Put-away</button>
          </form>

          <div class="panel light">
            <h3>Cycle Count Scheduler</h3>
            <label>Warehouse / Zone
              <select id="cycle-warehouse"></select>
            </label>
            <label>Count Focus
              <select id="cycle-focus">
                <option value="velocity">High velocity SKUs</option>
                <option value="aging">Aging / slow movers</option>
                <option value="highValue">High value items</option>
                <option value="compliance">Compliance (lot / expiry)</option>
              </select>
            </label>
            <button class="cta" type="button" id="plan-cycle">Plan Cycle Count</button>
            <div class="callout" id="cycle-plan">Plan a cycle count to reduce stockouts by 22%.</div>
          </div>
        </div>

        <div class="panel">
          <h3>Inbound Activity Log</h3>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Reference</th>
                  <th>Warehouse</th>
                  <th>SKU</th>
                  <th>Qty</th>
                  <th>Location</th>
                  <th>Lot / Exp</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="receipts-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="shipping">
      <div class="panel">
        <h2>Shipping Control & Reverse Logistics</h2>
        <p>Confirm labels, track carrier SLAs and manage returns without leaving the cockpit.</p>
        <div class="grid grid-2">
          <form id="shipment-form" class="panel light">
            <h3>Confirm Shipment</h3>
            <label>Order ID
              <input type="text" name="orderId" required placeholder="WEB-10045" />
            </label>
            <label>Carrier / Service
              <input type="text" name="carrier" placeholder="UPS Ground" />
            </label>
            <label>Tracking #
              <input type="text" name="tracking" placeholder="1Z999AA10123456784" />
            </label>
            <label>Packages
              <input type="number" name="packages" min="1" value="1" />
            </label>
            <label>Freight Cost
              <input type="number" name="cost" min="0" step="0.01" placeholder="12.45" />
            </label>
            <button class="cta" type="submit">Close Shipment</button>
          </form>

          <form id="return-form" class="panel light">
            <h3>Process Return</h3>
            <label>Order ID
              <input type="text" name="orderId" placeholder="WEB-10045" />
            </label>
            <label>SKU
              <input type="text" name="sku" placeholder="SKU-ABC-001" />
            </label>
            <label>Quantity
              <input type="number" name="quantity" min="1" value="1" />
            </label>
            <label>Reason
              <select name="reason">
                <option value="damaged">Damaged</option>
                <option value="wrongItem">Wrong Item</option>
                <option value="buyerRemorse">Buyer Remorse</option>
                <option value="warranty">Warranty / Repair</option>
              </select>
            </label>
            <label>Disposition
              <select name="disposition">
                <option value="restock">Restock</option>
                <option value="scrap">Scrap</option>
                <option value="refurbish">Refurbish</option>
                <option value="rtv">Return to Vendor</option>
              </select>
            </label>
            <button class="cta" type="submit">Record Return</button>
          </form>
        </div>

        <div class="grid grid-2">
          <div class="panel">
            <h3>Shipments</h3>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Order</th>
                    <th>Carrier</th>
                    <th>Tracking</th>
                    <th>Packages</th>
                    <th>Cost</th>
                  </tr>
                </thead>
                <tbody id="shipments-body"></tbody>
              </table>
            </div>
          </div>
          <div class="panel">
            <h3>Returns</h3>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Order</th>
                    <th>SKU</th>
                    <th>Qty</th>
                    <th>Reason</th>
                    <th>Disposition</th>
                  </tr>
                </thead>
                <tbody id="returns-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="labor">
      <div class="panel">
        <h2>Teams, Labor & Playbooks</h2>
        <p>Drive productivity with mission-based tasks, performance insights and gamified rewards.</p>
        <div class="grid grid-2">
          <form id="task-form" class="panel light">
            <h3>Assign Task</h3>
            <label>Task Title
              <input type="text" name="title" placeholder="Cycle count Aisle 4" required />
            </label>
            <label>Owner / Team
              <input type="text" name="owner" placeholder="Alicia (Inbound)" />
            </label>
            <label>Type
              <select name="type">
                <option value="Receiving">Receiving</option>
                <option value="Picking">Picking</option>
                <option value="Packing">Packing</option>
                <option value="Cycle Count">Cycle Count</option>
                <option value="QA">QA / Compliance</option>
              </select>
            </label>
            <label>Due Date
              <input type="date" name="dueDate" />
            </label>
            <label>Linked Order / SKU
              <input type="text" name="link" placeholder="WEB-10045 / SKU-ABC-001" />
            </label>
            <button class="cta" type="submit">Dispatch Mission</button>
          </form>

          <div class="panel light">
            <h3>Engagement & Gamification</h3>
            <ul class="list" id="gamification-feed"></ul>
          </div>
        </div>

        <div class="panel">
          <h3>Mission Board</h3>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Task</th>
                  <th>Owner</th>
                  <th>Type</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tasks-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="settings">
      <div class="panel">
        <h2>Data Governance & Marketplace</h2>
        <p>Control tenant-level settings, integrations and growth modules. All core tooling remains free forever.</p>
        <div class="grid grid-3">
          <div class="summary-tile">
            <h3>Marketplace Builder</h3>
            <p>Curate add-ons √† la carte. From $5 barcode packs to $5K autonomous robotics orchestration.</p>
            <button class="cta" type="button" id="open-bundler">Launch Dynamic Bundler</button>
          </div>
          <div class="summary-tile">
            <h3>API & Webhooks</h3>
            <p>REST + GraphQL + EDI. Push real-time events to your stack. Docs ready for dev hand-off.</p>
            <button class="secondary" type="button" onclick="alert('API docs open-source: /public/data/api-spec.json')">Download Spec</button>
          </div>
          <div class="summary-tile">
            <h3>Data Residency</h3>
            <p>US, EU, APAC regions with geo-fenced storage. SOC2 Type II on roadmap.</p>
            <span class="hint">Contact support for dedicated clusters.</span>
          </div>
        </div>
        <div class="panel light" id="bundler" style="display:none;margin-top:1.5rem;">
          <h3>Dynamic Pricing Bundler</h3>
          <p class="hint">Toggle modules to craft the perfect stack. Total adjusts with usage-aware AI guardrails.</p>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Module</th>
                  <th>Description</th>
                  <th>Monthly</th>
                  <th>Add</th>
                </tr>
              </thead>
              <tbody id="bundle-body"></tbody>
            </table>
          </div>
          <div class="flex-space" style="margin-top:1rem;">
            <div>
              <strong>Total Monthly:</strong> <span id="bundle-total">$0</span><br />
              <span class="hint" id="bundle-note"></span>
            </div>
            <button class="cta" type="button" id="checkout-bundle">Checkout via Stripe</button>
          </div>
       </div>
      </div>
    </section>

    <section id="account">
      <div class="panel">
        <h2>Commander Access & Security</h2>
        <p>Log in to sync integrations, personalize the interface, and unlock the RTS-style automations built for your brand.</p>
        <div class="grid grid-2">
          <form id="register-form" class="panel light">
            <h3>Create Command Seat</h3>
            <label>Work Email
              <input type="email" name="email" required placeholder="you@warehouse.com" />
            </label>
            <label>Display Name
              <input type="text" name="name" placeholder="Fleet Captain" />
            </label>
            <label>Password
              <input type="password" name="password" minlength="8" required placeholder="At least 8 characters" />
            </label>
            <label class="mini-input"><input type="checkbox" name="enableTotp" /> Enable authenticator set up right away</label>
            <button class="cta" type="submit">Register &amp; Launch</button>
          </form>

          <form id="login-form" class="panel light">
            <h3>Log In</h3>
            <label>Email
              <input type="email" name="email" required placeholder="you@warehouse.com" />
            </label>
            <label>Password
              <input type="password" name="password" required />
            </label>
            <label>Authenticator Code <span class="hint">Only if you enabled 2FA</span>
              <input type="text" name="totpToken" placeholder="123 456" />
            </label>
            <button class="cta" type="submit">Sign In</button>
          </form>
        </div>
        <div class="account-status" id="account-status">Not signed in.</div>
        <div class="account-actions">
          <button class="secondary" type="button" id="logout-btn" style="display:none;">Sign out</button>
        </div>
      </div>

      <div class="panel light" id="totp-panel" style="display:none;">
        <h3>Authenticator Shield</h3>
        <p class="hint">Protect access with a second verification step. Works with Google Authenticator, 1Password, Authy and more.</p>
        <div id="totp-content">
          <button class="cta" type="button" id="enable-totp">Generate authenticator secret</button>
          <p class="hint">Scan the QR code we provide or copy the secret into your authenticator app.</p>
        </div>
      </div>

      <div class="panel">
        <h3>Integration Vault</h3>
        <p>Connect the systems you already use. Paste API keys, set webhooks, or trigger one-click OAuth flows.</p>
        <div class="integrations-grid" id="integration-catalog"></div>
        <div class="panel light" id="integration-form-wrapper" style="display:none;">
          <h4 id="integration-form-title">Connect integration</h4>
          <form id="integration-form">
            <input type="hidden" name="serviceId" id="integration-service-id" />
            <label>Friendly label
              <input type="text" name="label" id="integration-label" placeholder="HQ Shopify North America" />
            </label>
            <label>API key or login token
              <input type="text" name="apiKey" id="integration-api-key" placeholder="Paste API key, PAT or login email" />
            </label>
            <label>Secret / Password
              <input type="text" name="secret" id="integration-secret" placeholder="Optional secret or password" />
            </label>
            <label>Webhook URL (optional)
              <input type="url" name="webhook" id="integration-webhook" placeholder="https://your-domain.com/webhooks/provider" />
            </label>
            <label>Notes for your team
              <textarea name="notes" id="integration-notes" placeholder="Share login context, rate limits, etc."></textarea>
            </label>
            <button class="cta" type="submit">Save integration</button>
          </form>
          <p class="hint">Have a one-click button from the provider? Hit ‚ÄúOne-click link‚Äù on the card to finalize tokens.</p>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Service</th>
                <th>Status</th>
                <th>Credentials</th>
                <th>Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="integration-table"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <h3>Brand Lab</h3>
        <p>Make the HQ feel like your own RTS hub. Colors, badges and copy sync across every device once you save.</p>
        <div class="brand-grid">
          <form id="brand-form" class="panel light">
            <label>Accent color
              <input type="color" id="brand-accent" name="accent" value="#38bdf8" />
            </label>
            <label>Background theme
              <select id="brand-background" name="background">
                <option value="nebula">Nebula Grid</option>
                <option value="sunrise">Sunrise Deck</option>
                <option value="midnight">Midnight Ops</option>
                <option value="summit">Summit Frost</option>
              </select>
            </label>
            <label>Call sign headline
              <input type="text" id="brand-call-sign" name="callSign" placeholder="Delco Logistics Fleet" />
            </label>
            <label>Badge emoji
              <input type="text" id="brand-emoji" name="emoji" maxlength="2" placeholder="üöö" />
            </label>
            <button class="cta" type="submit">Save brand preset</button>
            <p class="hint">Brand presets persist locally and, when signed in, sync to the cloud for your whole squad.</p>
          </form>
          <div class="brand-preview" id="brand-preview">
            <div class="preview-hero" id="brand-preview-title">Delco Logistics Fleet</div>
            <div class="preview-card">
              <div id="brand-preview-badge" class="badge-emoji" aria-hidden="true">üöö</div>
              <div class="mini-input" id="brand-preview-caption">Realtime inventory + AI slotting in your colors.</div>
            </div>
            <div class="preview-card">
              <strong>Squad bonuses active</strong>
              <p class="mini-input">Deploy pick-pack boosts, loyalty banners and warehouse skins that mirror your brand.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="panel light">
        <h3>Operations Gallery</h3>
        <p class="hint">Live visuals from community logistics floors. Mix them into your updates to make sorting &amp; labeling feel like a co-op mission.</p>
        <div class="gallery" id="ops-gallery"></div>
      </div>

      <div class="panel light">
        <h3>Report an Issue</h3>
        <p>Our OpenAI co-pilot guides the report and launches an email to rb@dreamworld.co so nothing gets lost in transit.</p>
        <form id="support-form">
          <label>Subject
            <input type="text" name="subject" required placeholder="Packing station tablet offline" />
          </label>
          <label>Category
            <select name="category">
              <option value="inventory">Inventory &amp; slotting</option>
              <option value="orders">Orders &amp; fulfillment</option>
              <option value="integrations">Integrations</option>
              <option value="billing">Billing</option>
              <option value="other">Other</option>
            </select>
          </label>
          <label>Description
            <textarea name="description" required placeholder="Share what happened, any order IDs, and when you noticed it."></textarea>
          </label>
          <label>Your email (for updates)
            <input type="email" name="email" placeholder="you@warehouse.com" />
          </label>
          <button class="cta" type="submit">Send report</button>
        </form>
        <div id="support-response" class="support-response" style="display:none;"></div>
        <div id="support-reward" class="reward-badge" role="status" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <small>Warehouse HQ is a free-to-use command center. Export your data anytime, integrate with your existing tech stack, and upgrade only when you&apos;re ready for more automation.</small>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'warehouse-hq-state-v1';
    const state = loadState();
    const warehouseSelects = ['item-warehouse', 'order-warehouse', 'receipt-warehouse', 'cycle-warehouse'];
    const AUTH_KEY = 'warehouse-hq-auth-v1';
    let authState = loadAuth();
    let integrationCatalog = [];
    const chartInstances = {};

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          if (!data.branding) {
            data.branding = seedState().branding;
          }
          return data;
        }
      } catch (err) {
        console.warn('Failed to load state', err);
      }
      return seedState();
    }

    function loadAuth(){
      try {
        const raw = localStorage.getItem(AUTH_KEY);
        if (raw) return JSON.parse(raw);
      } catch (err){
        console.warn('Failed to load auth state', err);
      }
      return { token: null, user: null };
    }

    function persistAuth(){
      try {
        localStorage.setItem(AUTH_KEY, JSON.stringify(authState));
      } catch (err){
        console.warn('Failed to persist auth', err);
      }
    }

    function seedState() {
      const now = new Date().toISOString();
          return {
        generatedAt: now,
        warehouses: [
          { id: crypto.randomUUID(), name: 'Delco Fulfillment East', type: 'Fulfillment Center', capacity: 1200, notes: 'Philadelphia, PA ‚Äì robotics ready' },
          { id: crypto.randomUUID(), name: 'SoCal Climate Hub', type: 'Cold Storage', capacity: 600, notes: 'Los Angeles, CA ‚Äì FEFO picking enforced' }
        ],
        items: [],
        orders: [],
        receipts: [],
        shipments: [],
        returns: [],
        tasks: [],
        gamification: [
          { id: crypto.randomUUID(), message: 'üèÖ Team Inbound earned "5-Star Receiver" for 99.6% accuracy this week.' },
          { id: crypto.randomUUID(), message: 'üöÄ Picking squad unlocked Rush Wave Boost after meeting SLA five days straight.' }
        ],
        branding: {
          accent: '#38bdf8',
          background: 'nebula',
          callSign: 'Delco Logistics Fleet',
          emoji: 'üöö',
        }
      };
    }

    function persist() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (err) {
        console.warn('Failed to persist state', err);
      }
    }

    function hexToRgba(hex, alpha) {
      const clean = hex.replace('#', '');
      if (clean.length !== 6) return `rgba(56,189,248,${alpha})`;
      const r = parseInt(clean.slice(0, 2), 16);
      const g = parseInt(clean.slice(2, 4), 16);
      const b = parseInt(clean.slice(4, 6), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function applyBranding() {
      const branding = state.branding || {};
      const accent = branding.accent || '#38bdf8';
      document.documentElement.style.setProperty('--accent', accent);
      document.documentElement.style.setProperty('--accent-soft', hexToRgba(accent, 0.18));
      document.documentElement.style.setProperty('--accent-strong', hexToRgba(accent, 0.36));
      document.documentElement.style.setProperty('--accent-border', hexToRgba(accent, 0.6));

      const theme = branding.background || 'nebula';
      const body = document.body;
      if (theme === 'sunrise') {
        body.style.background = 'radial-gradient(circle at top, rgba(255, 140, 66, 0.18), transparent 55%), radial-gradient(circle at 80% 20%, rgba(255, 203, 105, 0.18), transparent 60%), #0f172a';
      } else if (theme === 'midnight') {
        body.style.background = 'radial-gradient(circle at top, rgba(56, 189, 248, 0.08), transparent 45%), radial-gradient(circle at center, rgba(12, 74, 110, 0.18), transparent 65%), #020617';
      } else if (theme === 'summit') {
        body.style.background = 'radial-gradient(circle at top, rgba(148, 163, 184, 0.15), transparent 50%), radial-gradient(circle at 30% 70%, rgba(226, 232, 240, 0.1), transparent 65%), #0f172a';
      } else {
        body.style.background = 'radial-gradient(circle at top, rgba(56, 189, 248, 0.12), transparent 55%), radial-gradient(circle at center, rgba(14, 116, 144, 0.1), transparent 65%), radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.12), transparent 70%), #020617';
      }

      const callSign = branding.callSign || 'Delco Logistics Fleet';
      const emoji = branding.emoji || 'üöö';
      const previewTitle = document.getElementById('brand-preview-title');
      if (previewTitle) previewTitle.textContent = callSign;
      const previewBadge = document.getElementById('brand-preview-badge');
      if (previewBadge) previewBadge.textContent = emoji;
      const previewCaption = document.getElementById('brand-preview-caption');
      if (previewCaption) {
        previewCaption.textContent = `Personalized ops skin active ‚Ä¢ ${callSign}`;
      }

      const callSignInput = document.getElementById('brand-call-sign');
      if (callSignInput && callSignInput.value !== callSign) {
        callSignInput.value = callSign;
      }
      const accentInput = document.getElementById('brand-accent');
      if (accentInput && accentInput.value !== accent) {
        accentInput.value = accent;
      }
      const emojiInput = document.getElementById('brand-emoji');
      if (emojiInput && emojiInput.value !== emoji) {
        emojiInput.value = emoji;
      }
      const backgroundSelect = document.getElementById('brand-background');
      if (backgroundSelect && backgroundSelect.value !== theme) {
        backgroundSelect.value = theme;
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '‚Äî';
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return dateStr;
      return date.toLocaleDateString();
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2600);
    }

    function getWarehouseName(id) {
      const warehouse = state.warehouses.find(w => w.id === id);
      return warehouse ? warehouse.name : 'Unassigned';
    }

    function findOrCreateItem({ sku, name = '', variant = '', category = '' }) {
      let item = state.items.find(it => it.sku.toLowerCase() === sku.toLowerCase());
      if (!item) {
        item = {
          id: crypto.randomUUID(),
          sku,
          name: name || sku,
          variant,
          category,
          warehouseId: state.warehouses[0]?.id || '',
          location: '',
          quantity: 0,
          reorder: 0,
          lot: '',
          expiry: '',
          unitCost: 0
        };
        state.items.push(item);
      }
      return item;
    }

    function updateWarehouseSelects() {
      const options = state.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
      warehouseSelects.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.innerHTML = '<option value="">Select‚Ä¶</option>' + options;
        }
      });
      const filter = document.getElementById('warehouse-filter');
      if (filter) {
        filter.innerHTML = '<option value="all">All warehouses</option>' + state.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
      }
    }

    function renderInventory() {
      const tbody = document.getElementById('inventory-body');
      const search = document.getElementById('inventory-search').value.toLowerCase();
      const warehouseFilter = document.getElementById('warehouse-filter').value;
      tbody.innerHTML = '';
      const rows = state.items
        .filter(item => {
          const matchesSearch = [item.sku, item.name, item.variant, item.lot].some(val => (val || '').toLowerCase().includes(search));
          const matchesWarehouse = warehouseFilter === 'all' || warehouseFilter === '' || item.warehouseId === warehouseFilter;
          return matchesSearch && matchesWarehouse;
        })
        .sort((a, b) => a.sku.localeCompare(b.sku));
      rows.forEach(item => {
        const status = item.quantity <= (item.reorder || 0)
          ? '<span class="tag low">Reorder</span>'
          : item.quantity < (item.reorder || 0) * 1.5
            ? '<span class="tag risk">Monitor</span>'
            : '<span class="tag ok">Healthy</span>';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${item.sku}</strong><br><span class="hint">${item.category || '‚Äî'}</span></td>
          <td>${item.name}<br><span class="hint">${item.variant || ''}</span></td>
          <td>${getWarehouseName(item.warehouseId)}</td>
          <td>${item.location || '‚Äî'}</td>
          <td>${item.quantity}</td>
          <td>${item.reorder}</td>
          <td>${item.lot || '‚Äî'}<br><span class="hint">${item.expiry ? formatDate(item.expiry) : ''}</span></td>
          <td>${status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderOrders() {
      const tbody = document.getElementById('order-body');
      const filter = document.getElementById('order-status-filter').value;
      tbody.innerHTML = '';
      state.orders
        .filter(order => filter === 'all' || order.status === filter)
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .forEach(order => {
          const lines = order.lines.map(line => `${line.sku} √ó ${line.qty}`).join('<br>');
          const statusClass = `status-${order.status}`;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${order.orderId}</strong><br><span class="hint">${order.customer || '‚Äî'}</span></td>
            <td>${getWarehouseName(order.warehouseId)}</td>
            <td>${lines}</td>
            <td>${formatDate(order.dueDate)}</td>
            <td><span class="status-pill ${statusClass}">${order.status}</span></td>
            <td>${order.progress}%</td>
            <td class="actions">
              <button data-action="advance" data-id="${order.id}">Advance</button>
              <button data-action="cancel" data-id="${order.id}">Cancel</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    function renderReceipts() {
      const tbody = document.getElementById('receipts-body');
      tbody.innerHTML = '';
      state.receipts.slice().reverse().forEach(receipt => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(receipt.date)}</td>
          <td>${receipt.reference || '‚Äî'}</td>
          <td>${getWarehouseName(receipt.warehouseId)}</td>
          <td>${receipt.sku}</td>
          <td>${receipt.quantity}</td>
          <td>${receipt.location || '‚Äî'}</td>
          <td>${receipt.lot || '‚Äî'}<br><span class="hint">${receipt.expiry ? formatDate(receipt.expiry) : ''}</span></td>
          <td>${receipt.notes || '‚Äî'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderShipments() {
      const tbody = document.getElementById('shipments-body');
      tbody.innerHTML = '';
      state.shipments.slice().reverse().forEach(shipment => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(shipment.date)}</td>
          <td>${shipment.orderId}</td>
          <td>${shipment.carrier || '‚Äî'}</td>
          <td>${shipment.tracking || '‚Äî'}</td>
          <td>${shipment.packages || 1}</td>
          <td>${shipment.cost ? '$' + shipment.cost.toFixed(2) : '‚Äî'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderReturns() {
      const tbody = document.getElementById('returns-body');
      tbody.innerHTML = '';
      state.returns.slice().reverse().forEach(ret => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(ret.date)}</td>
          <td>${ret.orderId || '‚Äî'}</td>
          <td>${ret.sku || '‚Äî'}</td>
          <td>${ret.quantity}</td>
          <td>${ret.reason}</td>
          <td>${ret.disposition}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderTasks() {
      const tbody = document.getElementById('tasks-body');
      tbody.innerHTML = '';
      state.tasks.slice().reverse().forEach(task => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${task.title}<br><span class="hint">${task.link || ''}</span></td>
          <td>${task.owner || '‚Äî'}</td>
          <td>${task.type}</td>
          <td>${formatDate(task.dueDate)}</td>
          <td><span class="status-pill status-${task.status}">${task.status}</span></td>
          <td class="actions">
            <button data-action="progress-task" data-id="${task.id}">Advance</button>
            <button data-action="close-task" data-id="${task.id}">Complete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      const feed = document.getElementById('gamification-feed');
      feed.innerHTML = state.gamification.map(entry => `<li>${entry.message}</li>`).join('');
    }

    function renderStats() {
      const totalSkus = state.items.length;
      const totalUnits = state.items.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
      const lowStock = state.items.filter(item => item.quantity <= (item.reorder || 0)).length;
      const openOrders = state.orders.filter(o => ['open', 'picking', 'packed'].includes(o.status)).length;
      const shippedOrders = state.orders.filter(o => o.status === 'shipped').length;
      const returnsRate = shippedOrders ? Math.round((state.returns.length / shippedOrders) * 100) : 0;
      const statCards = [
        { title: 'Active SKUs', value: totalSkus, meta: 'Variants live across your network.' },
        { title: 'Units on Hand', value: totalUnits, meta: 'Aggregate across all facilities.' },
        { title: 'Below Reorder', value: lowStock, meta: 'Automate purchase plans to stay ahead.' },
        { title: 'Open Orders', value: openOrders, meta: 'Includes picking, packing & staging.' },
        { title: 'Return Rate', value: returnsRate + '%', meta: 'Rolling ratio of returns vs shipped.' }
      ];
      const container = document.getElementById('stat-cards');
      container.innerHTML = statCards.map(card => `
        <div class="stat-card">
          <h3>${card.title}</h3>
          <strong>${card.value}</strong>
          <div class="stat-meta">${card.meta}</div>
        </div>
      `).join('');

      const health = document.getElementById('order-health');
      health.innerHTML = state.orders.slice(0, 5).map(order => {
        const due = order.dueDate ? new Date(order.dueDate) : null;
        const now = new Date();
        let status = 'On track';
        if (due && due.getTime() < now.getTime() && order.status !== 'shipped') status = '‚ö†Ô∏è Past due';
        if (order.priority === 'Rush' && order.status === 'open') status = 'üöÄ Rush: assign picker';
        return `<li><strong>${order.orderId}</strong> ‚Üí ${status}</li>`;
      }).join('');

      const priorities = document.getElementById('priority-list');
      const missions = [];
      if (lowStock > 0) missions.push('Trigger replenishment for low stock SKUs.');
      if (openOrders > 0) missions.push('Wave plan next picking batch to hit SLA.');
      if (!missions.length) missions.push('All clear! Review analytics or schedule a cycle count.');
      priorities.innerHTML = missions.map(m => `<li>${m}</li>`).join('');

      renderCharts();
    }

    function ensureChart(id, config){
      if (!window.Chart) {
        setTimeout(renderCharts, 400);
        return;
      }
      const canvas = document.getElementById(id);
      if (!canvas) return;
      if (chartInstances[id]){
        chartInstances[id].data = config.data;
        chartInstances[id].options = config.options;
        chartInstances[id].update();
      } else {
        chartInstances[id] = new Chart(canvas, config);
      }
    }

    function renderCharts(){
      if (!window.Chart) return;
      const accent = state.branding?.accent || '#38bdf8';

      const items = state.items.slice().sort((a, b) => (Number(b.quantity) || 0) - (Number(a.quantity) || 0)).slice(0, 5);
      const invLabels = items.length ? items.map(it => it.sku) : ['Ready'];
      const invData = items.length ? items.map(it => Number(it.quantity) || 0) : [5];
      ensureChart('inventoryChart', {
        type: 'bar',
        data: {
          labels: invLabels,
          datasets: [{
            label: 'Units on hand',
            data: invData,
            backgroundColor: invData.map(() => hexToRgba(accent, 0.35)),
            borderColor: invData.map(() => accent),
            borderWidth: 1.5,
            borderRadius: 8,
          }],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#cbd5f5' } },
            y: { ticks: { color: '#cbd5f5' }, beginAtZero: true },
          },
        },
      });

      const orderStatuses = ['open', 'picking', 'packed', 'shipped', 'cancelled'];
      const orderCounts = orderStatuses.map(status => state.orders.filter(o => o.status === status).length);
      ensureChart('orderChart', {
        type: 'doughnut',
        data: {
          labels: orderStatuses.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
          datasets: [{
            data: orderCounts.map(count => count || 1),
            backgroundColor: [
              hexToRgba(accent, 0.6),
              'rgba(129, 140, 248, 0.6)',
              'rgba(59, 130, 246, 0.6)',
              'rgba(34, 197, 94, 0.6)',
              'rgba(239, 68, 68, 0.4)',
            ],
            borderColor: 'rgba(15, 23, 42, 0.8)',
            borderWidth: 2,
          }],
        },
        options: {
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { color: '#cbd5f5', boxWidth: 16 },
            },
          },
        },
      });

      const missionTotals = {
        Stocking: state.receipts.length || 1,
        Sorting: state.orders.filter(o => ['open', 'picking'].includes(o.status)).length || 1,
        Labeling: state.tasks.filter(t => t.type === 'Packing').length + state.orders.filter(o => o.status === 'packed').length || 1,
        Dispatch: state.shipments.length || 1,
        Returns: state.returns.length || 1,
      };
      ensureChart('missionChart', {
        type: 'radar',
        data: {
          labels: Object.keys(missionTotals),
          datasets: [{
            label: 'Mission energy',
            data: Object.values(missionTotals),
            backgroundColor: hexToRgba(accent, 0.25),
            borderColor: accent,
            borderWidth: 2,
            pointBackgroundColor: accent,
          }],
        },
        options: {
          scales: {
            r: {
              angleLines: { color: 'rgba(148, 163, 184, 0.25)' },
              grid: { color: 'rgba(148, 163, 184, 0.2)' },
              pointLabels: { color: '#cbd5f5' },
              ticks: { display: false },
            },
          },
          plugins: { legend: { display: false } },
        },
      });
    }

    function authHeaders(){
      return authState?.token ? { Authorization: `Bearer ${authState.token}` } : {};
    }

    function setAuthState({ token = null, user = null }){
      authState = { token, user };
      persistAuth();
      if (user && user.brandTheme){
        state.branding = { ...state.branding, ...user.brandTheme };
        persist();
        applyBranding();
      }
      updateAccountStatus();
      if (authState.token){
        loadIntegrations();
      }
      renderTotpUi();
    }

    async function hydrateAuth(){
      if (!authState.token || (authState.user && authState.user.email)) return;
      try {
        const res = await fetch('/api/users/me', { headers: authHeaders() });
        const data = await res.json();
        if (res.ok && data.user){
          setAuthState({ token: authState.token, user: data.user });
        }
      } catch (err){
        console.warn('Auth hydrate skipped', err);
      }
    }

    function updateAccountStatus(){
      const status = document.getElementById('account-status');
      const logoutBtn = document.getElementById('logout-btn');
      if (!status || !logoutBtn) return;
      if (authState && authState.user){
        const parts = [`Signed in as ${authState.user.email}`];
        if (authState.user.totpEnabled) parts.push('2FA enabled');
        status.textContent = parts.join(' ‚Ä¢ ');
        logoutBtn.style.display = 'inline-flex';
      } else {
        status.textContent = 'Not signed in.';
        logoutBtn.style.display = 'none';
      }
    }

    function renderTotpUi(extra){
      const panel = document.getElementById('totp-panel');
      const container = document.getElementById('totp-content');
      if (!panel || !container) return;
      if (!authState || !authState.user){
        panel.style.display = 'none';
        container.innerHTML = '<p class="hint">Sign in to enable authenticator protection.</p>';
        return;
      }
      panel.style.display = '';
      if (extra && extra.secret){
        container.innerHTML = `
          <p><strong>Secret:</strong> <code>${extra.secret}</code></p>
          <p class="hint">Add this to your authenticator. URL: <a href="${extra.otpauth}" target="_blank" rel="noopener">${extra.otpauth}</a></p>
          <button class="secondary" type="button" id="totp-done">Done</button>
        `;
        container.querySelector('#totp-done').addEventListener('click', () => renderTotpUi());
        authState.user.totpEnabled = true;
        persistAuth();
        updateAccountStatus();
        return;
      }
      if (authState.user.totpEnabled){
        container.innerHTML = `
          <p class="hint">Authenticator active. Use your rotating code when logging in.</p>
          <button class="secondary" type="button" id="disable-totp">Disable 2FA</button>
        `;
        container.querySelector('#disable-totp').addEventListener('click', disableTotp);
      } else {
        container.innerHTML = `
          <button class="cta" type="button" id="enable-totp">Generate authenticator secret</button>
          <p class="hint">Scan the QR we generate or copy the secret into your authenticator app.</p>
        `;
        container.querySelector('#enable-totp').addEventListener('click', enableTotp);
      }
    }

    async function registerAccount(evt){
      evt.preventDefault();
      const form = evt.target;
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      payload.enableTotp = formData.get('enableTotp') === 'on';
      payload.brandTheme = { ...state.branding };
      try {
        const res = await fetch('/api/users/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Unable to register');
          return;
        }
        setAuthState({ token: data.token, user: data.user });
        renderTotpUi(data.totp);
        showToast('Account created. Welcome aboard!');
        form.reset();
      } catch (err){
        showToast('Registration failed. Try again shortly.');
      }
    }

    async function loginAccount(evt){
      evt.preventDefault();
      const form = evt.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      try {
        const res = await fetch('/api/users/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          const message = data.error === 'totp_required' ? 'Enter your authenticator code.' : (data.error || 'Login failed');
          showToast(message);
          return;
        }
        setAuthState({ token: data.token, user: data.user });
        showToast('Logged in. Systems synced.');
        form.reset();
      } catch (err){
        showToast('Login unavailable right now.');
      }
    }

    function logoutAccount(){
      authState = { token: null, user: null };
      persistAuth();
      updateAccountStatus();
      renderTotpUi();
      loadIntegrations();
      showToast('Signed out.');
    }

    async function enableTotp(){
      try {
        const res = await fetch('/api/users/totp/enable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ label: authState.user?.email || 'Warehouse HQ' }),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Unable to enable 2FA');
          return;
        }
        authState.user.totpEnabled = true;
        persistAuth();
        renderTotpUi(data);
      } catch (err){
        showToast('Authenticator setup failed.');
      }
    }

    async function disableTotp(){
      try {
        const res = await fetch('/api/users/totp/disable', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
        });
        if (!res.ok){
          const data = await res.json();
          showToast(data.error || 'Unable to disable 2FA');
          return;
        }
        authState.user.totpEnabled = false;
        persistAuth();
        renderTotpUi();
        updateAccountStatus();
      } catch (err){
        showToast('Disable failed.');
      }
    }

    async function fetchIntegrationCatalog(){
      try {
        const res = await fetch('/api/integrations/catalog');
        const data = await res.json();
        integrationCatalog = data.catalog || [];
      } catch (err){
        integrationCatalog = [];
      }
      renderIntegrationCatalog();
    }

    function renderIntegrationCatalog(){
      const container = document.getElementById('integration-catalog');
      if (!container) return;
      if (!integrationCatalog.length){
        container.innerHTML = '<div class="integration-table-empty">Catalog loading...</div>';
        return;
      }
      container.innerHTML = integrationCatalog.map(item => `
        <div class="integration-card">
          <img src="https://api.dicebear.com/7.x/icons/svg?seed=${encodeURIComponent(item.id)}&backgroundColor=transparent" alt="${item.name} icon" loading="lazy" />
          <div><strong>${item.name}</strong><br><span class="hint">${item.category}</span></div>
          <div class="tagline">${(item.scopes || []).join(' ‚Ä¢ ')}</div>
          ${item.oneClick ? '<span class="one-click-tag">One-click ready</span>' : ''}
          <div class="account-actions">
            <button class="cta" type="button" data-action="connect" data-id="${item.id}">Add credentials</button>
            ${item.oneClick ? `<button class="secondary" type="button" data-action="oneclick" data-id="${item.id}">One-click link</button>` : ''}
          </div>
        </div>
      `).join('');
      container.querySelectorAll('button[data-action="connect"]').forEach(btn => {
        btn.addEventListener('click', () => showIntegrationForm(btn.dataset.id));
      });
      container.querySelectorAll('button[data-action="oneclick"]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!authState.token){
            showToast('Sign in to complete one-click links.');
            return;
          }
          showIntegrationForm(btn.dataset.id, true);
        });
      });
    }

    function showIntegrationForm(serviceId, focusOauth = false){
      if (!authState.token){
        showToast('Sign in first to save integrations.');
        return;
      }
      const wrapper = document.getElementById('integration-form-wrapper');
      const title = document.getElementById('integration-form-title');
      const inputId = document.getElementById('integration-service-id');
      const labelInput = document.getElementById('integration-label');
      if (!wrapper || !inputId) return;
      const meta = integrationCatalog.find(item => item.id === serviceId) || { name: serviceId };
      wrapper.style.display = '';
      title.textContent = `Connect ${meta.name}`;
      inputId.value = serviceId;
      if (labelInput && !labelInput.value) labelInput.value = meta.name;
      if (focusOauth){
        const note = document.getElementById('integration-notes');
        if (note) note.placeholder = 'Paste tokens from the provider after approving the connection.';
      }
    }

    async function loadIntegrations(){
      const tbody = document.getElementById('integration-table');
      if (!tbody) return;
      if (!authState.token){
        tbody.innerHTML = '<tr><td colspan="5" class="integration-table-empty">Sign in to manage integrations.</td></tr>';
        return;
      }
      try {
        const res = await fetch('/api/integrations', { headers: authHeaders() });
        const data = await res.json();
        if (!res.ok){
          throw new Error(data.error || 'Failed');
        }
        renderIntegrations(data.integrations || []);
      } catch (err){
        tbody.innerHTML = '<tr><td colspan="5" class="integration-table-empty">Unable to load integrations.</td></tr>';
      }
    }

    function renderIntegrations(rows){
      const tbody = document.getElementById('integration-table');
      if (!tbody) return;
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="5" class="integration-table-empty">No integrations yet. Connect your first platform.</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map(row => {
        const meta = integrationCatalog.find(item => item.id === row.serviceId) || {};
        const creds = Object.entries(row.credentials || {}).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        const actions = [];
        if (meta.oneClick){
          actions.push(`<button data-action="complete-oauth" data-id="${row.id}">One-click link</button>`);
        }
        actions.push(`<button data-action="delete" data-id="${row.id}">Remove</button>`);
        return `
          <tr>
            <td><strong>${meta.name || row.serviceId}</strong><br><span class="hint">${meta.category || ''}</span></td>
            <td>${row.status}</td>
            <td>${creds || '<span class="hint">Credentials hidden</span>'}</td>
            <td>${row.updatedAt ? formatDate(row.updatedAt) : '‚Äî'}</td>
            <td class="actions">${actions.join(' ')}</td>
          </tr>
        `;
      }).join('');
      tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => btn.addEventListener('click', () => deleteIntegration(btn.dataset.id)));
      tbody.querySelectorAll('button[data-action="complete-oauth"]').forEach(btn => btn.addEventListener('click', () => completeOneClick(btn.dataset.id)));
    }

    async function saveIntegration(evt){
      evt.preventDefault();
      if (!authState.token){
        showToast('Sign in to save integrations.');
        return;
      }
      const form = evt.target;
      const { serviceId, label, apiKey, secret, webhook, notes } = form.elements;
      const payload = {
        serviceId: serviceId.value,
        label: label.value,
        credentials: {
          apiKey: apiKey.value,
          secret: secret.value,
          webhook: webhook.value,
        },
        notes: notes.value,
      };
      try {
        const res = await fetch('/api/integrations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Could not save integration');
          return;
        }
        showToast('Integration stored.');
        form.reset();
        document.getElementById('integration-form-wrapper').style.display = 'none';
        loadIntegrations();
      } catch (err){
        showToast('Integration save failed.');
      }
    }

    async function completeOneClick(id){
      const accessToken = prompt('Paste the access token from the provider (demo tokens accepted).');
      if (!accessToken) return;
      try {
        const res = await fetch(`/api/integrations/${id}/one-click`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ accessToken, refreshToken: 'refresh-demo', expiresAt: new Date(Date.now() + 3600 * 1000).toISOString() }),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'One-click linking failed.');
          return;
        }
        showToast('One-click tokens saved.');
        loadIntegrations();
      } catch (err){
        showToast('Unable to store tokens.');
      }
    }

    async function deleteIntegration(id){
      if (!confirm('Remove this integration?')) return;
      try {
        const res = await fetch(`/api/integrations/${id}`, {
          method: 'DELETE',
          headers: authHeaders(),
        });
        if (!res.ok){
          showToast('Unable to remove integration.');
          return;
        }
        showToast('Integration removed.');
        loadIntegrations();
      } catch (err){
        showToast('Network issue removing integration.');
      }
    }

    let brandSyncTimer = null;
    function scheduleBrandSync(){
      if (!authState.token) return;
      clearTimeout(brandSyncTimer);
      brandSyncTimer = setTimeout(syncBrandToServer, 600);
    }

    async function syncBrandToServer(){
      if (!authState.token) return;
      try {
        await fetch('/api/users/brand', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ brandTheme: state.branding }),
        });
      } catch (err){
        console.warn('Brand sync skipped', err);
      }
    }

    function initBrandingControls(){
      const form = document.getElementById('brand-form');
      if (!form) return;
      form.addEventListener('submit', evt => {
        evt.preventDefault();
        persist();
        scheduleBrandSync();
        showToast('Brand preset saved.');
      });
      const accentInput = document.getElementById('brand-accent');
      const backgroundSelect = document.getElementById('brand-background');
      const callSignInput = document.getElementById('brand-call-sign');
      const emojiInput = document.getElementById('brand-emoji');
      [accentInput, backgroundSelect, callSignInput, emojiInput].forEach(input => {
        if (!input) return;
        input.addEventListener('input', () => {
          state.branding = {
            accent: accentInput?.value || state.branding.accent,
            background: backgroundSelect?.value || state.branding.background,
            callSign: callSignInput?.value || state.branding.callSign,
            emoji: emojiInput?.value || state.branding.emoji,
          };
          applyBranding();
          persist();
          scheduleBrandSync();
        });
      });
    }

    async function loadOperationsGallery(){
      const container = document.getElementById('ops-gallery');
      if (!container) return;
      container.innerHTML = '<div class="integration-table-empty">Loading gallery‚Ä¶</div>';
      try {
        const res = await fetch('https://picsum.photos/v2/list?limit=6');
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) throw new Error('empty');
        container.innerHTML = data.map((img, idx) => {
          const url = `${img.download_url}?w=260&h=260&fit=crop`;
          return `<img src="${url}" alt="Warehouse inspiration ${idx + 1}" loading="lazy" />`;
        }).join('');
      } catch (err){
        const fallback = [
          'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&w=400&q=80',
          'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=400&q=80',
          'https://images.unsplash.com/photo-1581579186989-421b5f70e22e?auto=format&fit=crop&w=400&q=80',
          'https://images.unsplash.com/photo-1542831371-29b0f74f9713?auto=format&fit=crop&w=400&q=80',
          'https://images.unsplash.com/photo-1515169067865-5387ec356754?auto=format&fit=crop&w=400&q=80',
          'https://images.unsplash.com/photo-1603180465537-0fd7a7d98bc5?auto=format&fit=crop&w=400&q=80',
        ];
        container.innerHTML = fallback.map((url, idx) => `<img src="${url}" alt="Warehouse scene ${idx + 1}" loading="lazy" />`).join('');
      }
    }

    async function submitSupportReport(evt){
      evt.preventDefault();
      const form = evt.target;
      const payload = Object.fromEntries(new FormData(form).entries());
      payload.metadata = {
        warehouses: state.warehouses.length,
        openOrders: state.orders.length,
        branding: state.branding.callSign,
      };
      try {
        const res = await fetch('/api/support/report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok){
          showToast(data.error || 'Could not send report');
          return;
        }
        const response = document.getElementById('support-response');
        const reward = document.getElementById('support-reward');
        if (response){
          response.style.display = 'block';
          response.textContent = data.assistant || 'Report received.';
        }
        if (reward){
          reward.innerHTML = `<span class="badge-emoji">${data.reward?.icon || '‚ú®'}</span><div>${data.reward?.title || 'Great scout!'}<br><span class="mini-input">${data.reward?.message || ''}</span></div>`;
          reward.classList.add('show');
        }
        const mailLink = `mailto:rb@dreamworld.co?subject=${encodeURIComponent(payload.subject)}&body=${encodeURIComponent(payload.description)}`;
        window.open(mailLink, '_blank');
        showToast('Report sent ‚Äî thank you!');
        form.reset();
      } catch (err){
        showToast('Support request failed.');
      }
    }

    function handleNavigation() {
      document.querySelectorAll('nav button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.dataset.target;
          document.querySelectorAll('main section').forEach(sec => sec.classList.remove('active'));
          document.getElementById(target).classList.add('active');
        });
      });
    }

    function parseLines(text) {
      return text
        .split('\n')
        .map(line => line.trim())
        .filter(Boolean)
        .map(line => {
          const [sku, qty] = line.split(':');
          return { sku: sku.trim(), qty: Number(qty || 0) };
        })
        .filter(line => line.sku && line.qty > 0);
    }

    function advanceOrder(id) {
      const order = state.orders.find(o => o.id === id);
      if (!order) return;
      const transitions = ['open', 'picking', 'packed', 'shipped'];
      const idx = transitions.indexOf(order.status);
      if (idx < transitions.length - 1) {
        order.status = transitions[idx + 1];
        if (order.status === 'picking') order.progress = 40;
        if (order.status === 'packed') order.progress = 80;
        if (order.status === 'shipped') {
          order.progress = 100;
          order.shippedAt = new Date().toISOString();
          order.lines.forEach(line => {
            const item = findOrCreateItem({ sku: line.sku });
            item.quantity = Math.max(0, (Number(item.quantity) || 0) - line.qty);
          });
          renderInventory();
        }
        persist();
        renderOrders();
        renderStats();
        showToast(`Order ${order.orderId} advanced to ${order.status}.`);
      }
    }

    function cancelOrder(id) {
      const order = state.orders.find(o => o.id === id);
      if (!order) return;
      order.status = 'cancelled';
      order.progress = 0;
      persist();
      renderOrders();
      renderStats();
      showToast(`Order ${order.orderId} cancelled.`);
    }

    function progressTask(id) {
      const task = state.tasks.find(t => t.id === id);
      if (!task) return;
      const transitions = ['open', 'picking', 'packed', 'shipped'];
      const idx = transitions.indexOf(task.status);
      if (idx < transitions.length - 1) {
        task.status = transitions[idx + 1];
        persist();
        renderTasks();
        showToast(`Task ${task.title} set to ${task.status}.`);
      }
    }

    function closeTask(id) {
      const task = state.tasks.find(t => t.id === id);
      if (!task) return;
      task.status = 'shipped';
      persist();
      renderTasks();
      showToast(`Mission completed: ${task.title}.`);
    }

    document.getElementById('warehouse-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.warehouses.push({
        id: crypto.randomUUID(),
        name: data.name,
        type: data.type,
        capacity: Number(data.capacity) || 0,
        notes: data.notes
      });
      form.reset();
      persist();
      updateWarehouseSelects();
      renderStats();
      showToast('Warehouse added.');
    });

    document.getElementById('item-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const sku = data.sku.trim();
      if (!sku) return;
      const item = findOrCreateItem({ sku });
      item.name = data.name;
      item.variant = data.variant;
      item.category = data.category;
      item.warehouseId = data.warehouse || item.warehouseId;
      item.location = data.location;
      item.quantity = Number(data.quantity) || 0;
      item.reorder = Number(data.reorder) || 0;
      item.lot = data.lot;
      item.expiry = data.expiry;
      item.unitCost = Number(data.unitCost) || 0;
      persist();
      renderInventory();
      renderStats();
      showToast('SKU saved.');
      form.reset();
    });

    document.getElementById('order-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const lines = parseLines(data.lines);
      if (!lines.length) {
        alert('Add at least one item line (SKU:Qty).');
        return;
      }
      const order = {
        id: crypto.randomUUID(),
        orderId: data.orderId,
        customer: data.customer,
        warehouseId: data.warehouse,
        dueDate: data.dueDate,
        priority: data.priority,
        shipping: data.shipping,
        lines,
        status: 'open',
        progress: 10,
        createdAt: new Date().toISOString()
      };
      state.orders.push(order);
      form.reset();
      persist();
      renderOrders();
      renderStats();
      showToast('Order created. Assign a picker to start.');
    });

    document.getElementById('order-body').addEventListener('click', evt => {
      const btn = evt.target.closest('button');
      if (!btn) return;
      const { action, id } = btn.dataset;
      if (action === 'advance') advanceOrder(id);
      if (action === 'cancel') cancelOrder(id);
    });

    document.getElementById('inventory-search').addEventListener('input', renderInventory);
    document.getElementById('warehouse-filter').addEventListener('change', renderInventory);
    document.getElementById('order-status-filter').addEventListener('change', renderOrders);

    document.getElementById('receipt-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const item = findOrCreateItem({ sku: data.sku });
      item.quantity = (Number(item.quantity) || 0) + (Number(data.quantity) || 0);
      item.lot = data.lot || item.lot;
      item.expiry = data.expiry || item.expiry;
      if (data.warehouse) item.warehouseId = data.warehouse;
      item.location = data.location || item.location;
      state.receipts.push({
        id: crypto.randomUUID(),
        reference: data.reference,
        supplier: data.supplier,
        warehouseId: data.warehouse,
        sku: data.sku,
        quantity: Number(data.quantity) || 0,
        location: data.location,
        lot: data.lot,
        expiry: data.expiry,
        notes: data.notes,
        date: new Date().toISOString()
      });
      persist();
      renderInventory();
      renderReceipts();
      renderStats();
      showToast('Inventory received and added to stock.');
      form.reset();
    });

    document.getElementById('shipment-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.shipments.push({
        id: crypto.randomUUID(),
        orderId: data.orderId,
        carrier: data.carrier,
        tracking: data.tracking,
        packages: Number(data.packages) || 1,
        cost: Number(data.cost) || 0,
        date: new Date().toISOString()
      });
      const order = state.orders.find(o => o.orderId === data.orderId);
      if (order && order.status !== 'shipped') {
        order.status = 'shipped';
        order.progress = 100;
      }
      persist();
      renderShipments();
      renderOrders();
      renderStats();
      showToast('Shipment confirmed and order closed.');
      form.reset();
    });

    document.getElementById('return-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.returns.push({
        id: crypto.randomUUID(),
        orderId: data.orderId,
        sku: data.sku,
        quantity: Number(data.quantity) || 0,
        reason: data.reason,
        disposition: data.disposition,
        date: new Date().toISOString()
      });
      if (data.disposition === 'restock' && data.sku) {
        const item = findOrCreateItem({ sku: data.sku });
        item.quantity = (Number(item.quantity) || 0) + (Number(data.quantity) || 0);
      }
      persist();
      renderReturns();
      renderInventory();
      renderStats();
      showToast('Return recorded.');
      form.reset();
    });

    document.getElementById('tasks-body').addEventListener('click', evt => {
      const btn = evt.target.closest('button');
      if (!btn) return;
      const { action, id } = btn.dataset;
      if (action === 'progress-task') progressTask(id);
      if (action === 'close-task') closeTask(id);
    });

    document.getElementById('task-form').addEventListener('submit', evt => {
      evt.preventDefault();
      const form = evt.target;
      const data = Object.fromEntries(new FormData(form).entries());
      state.tasks.push({
        id: crypto.randomUUID(),
        title: data.title,
        owner: data.owner,
        type: data.type,
        dueDate: data.dueDate,
        link: data.link,
        status: 'open'
      });
      persist();
      renderTasks();
      showToast('Task dispatched to floor.');
      form.reset();
    });

    document.getElementById('plan-cycle').addEventListener('click', () => {
      const warehouseId = document.getElementById('cycle-warehouse').value;
      const focus = document.getElementById('cycle-focus').value;
      const warehouseName = warehouseId ? getWarehouseName(warehouseId) : 'all warehouses';
      const messages = {
        velocity: 'Prioritize top sellers to catch velocity drift.',
        aging: 'Audit slow movers to reclaim capacity.',
        highValue: 'Double-count high value inventory for shrink control.',
        compliance: 'Ensure lot & expiry data is ready for auditors.'
      };
      document.getElementById('cycle-plan').textContent = `Cycle count scheduled for ${warehouseName}: ${messages[focus]}`;
      showToast('Cycle count playbook generated.');
    });

    document.getElementById('pick-scan').addEventListener('keyup', evt => {
      if (evt.key === 'Enter') {
        const sku = evt.target.value.trim();
        if (!sku) return;
        const item = state.items.find(it => it.sku.toLowerCase() === sku.toLowerCase());
        const el = document.getElementById('pick-result');
        if (!item) {
          el.textContent = 'SKU not found. Consider creating the item first.';
        } else {
          el.innerHTML = `<strong>${item.name}</strong><br>Location: ${item.location || '‚Äî'} | On-hand: ${item.quantity}`;
        }
        evt.target.value = '';
      }
    });

    document.getElementById('import-input').addEventListener('change', evt => {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const data = JSON.parse(event.target.result);
          Object.assign(state, data);
          persist();
          initializeUI();
          showToast('Workspace imported.');
        } catch (err) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('export-btn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `warehouse-hq-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Backup exported.');
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm('Reset workspace to starter data?')) {
        Object.assign(state, seedState());
        persist();
        initializeUI();
        showToast('Workspace reset.');
      }
    });

    const bundleModules = [
      { id: 'ai-slotting', name: 'AI Slotting Optimization', price: 249, description: 'Adaptive storage recommendations using velocity & demand forecasting.' },
      { id: 'labor-gamification', name: 'Labor Gamification Suite', price: 99, description: 'XP points, leaderboards and streak-based incentives for teams.' },
      { id: 'rfid', name: 'RFID Control Tower', price: 189, description: 'Real-time read events, zone tracking and EPC compliance exports.' },
      { id: 'automation', name: 'Automation Orchestrator', price: 499, description: 'Connect AMRs, conveyors and sorters with drag-and-drop flows.' },
      { id: 'analytics', name: 'Executive Analytics Pack', price: 79, description: 'Cohort KPIs, demand planning, CFO-ready financial dashboards.' },
      { id: 'edi', name: 'Retail EDI Gateway', price: 149, description: 'Send/receive 850, 856, 940/945 and compliance scorecards.' }
    ];

    const bundleState = { selections: new Set(), total: 0 };

    function renderBundler() {
      const tbody = document.getElementById('bundle-body');
      tbody.innerHTML = bundleModules.map(mod => {
        const checked = bundleState.selections.has(mod.id) ? 'checked' : '';
        return `
          <tr>
            <td>${mod.name}</td>
            <td>${mod.description}</td>
            <td>$${mod.price}</td>
            <td><input type="checkbox" data-module="${mod.id}" ${checked}></td>
          </tr>
        `;
      }).join('');
      document.getElementById('bundle-total').textContent = `$${bundleState.total}`;
      document.getElementById('bundle-note').textContent = bundleState.selections.size
        ? 'Nice build! Stripe-ready checkout when you connect billing.'
        : 'Core platform remains free. Add power-ups when you are ready.';
    }

    document.getElementById('open-bundler').addEventListener('click', () => {
      const panel = document.getElementById('bundler');
      const visible = panel.style.display === 'block';
      panel.style.display = visible ? 'none' : 'block';
      renderBundler();
    });

    document.getElementById('bundle-body').addEventListener('change', evt => {
      const id = evt.target.dataset.module;
      if (!id) return;
      if (evt.target.checked) bundleState.selections.add(id);
      else bundleState.selections.delete(id);
      bundleState.total = Array.from(bundleState.selections)
        .map(sel => bundleModules.find(m => m.id === sel)?.price || 0)
        .reduce((a, b) => a + b, 0);
      renderBundler();
    });

    document.getElementById('checkout-bundle').addEventListener('click', () => {
      alert('Stripe checkout flows live in production. For now, track selections as part of your upgrade strategy.');
    });

   document.getElementById('bundle-body').addEventListener('click', evt => {
      if (evt.target.tagName === 'INPUT') {
        showToast('Bundle updated. AI will recommend savings once usage is detected.');
      }
    });

    document.getElementById('order-health').addEventListener('click', () => {
      showToast('Tip: Create wave picks from the Orders tab to auto-assign teams.');
    });

    document.getElementById('register-form').addEventListener('submit', registerAccount);
    document.getElementById('login-form').addEventListener('submit', loginAccount);
    document.getElementById('logout-btn').addEventListener('click', logoutAccount);
    document.getElementById('integration-form').addEventListener('submit', saveIntegration);
    document.getElementById('support-form').addEventListener('submit', submitSupportReport);

    function initializeUI() {
      updateWarehouseSelects();
      renderInventory();
      renderOrders();
      renderReceipts();
      renderShipments();
      renderReturns();
      renderTasks();
      renderStats();
      renderBundler();
    }

    applyBranding();
    initBrandingControls();
    updateAccountStatus();
    renderTotpUi();
    fetchIntegrationCatalog();
    loadIntegrations();
    loadOperationsGallery();
    hydrateAuth();

    handleNavigation();
    initializeUI();
  </script>
</body>
</html>
