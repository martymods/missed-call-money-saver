<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Order Food — Pay Here, Delivered via DoorDash</title>
  <meta name="description" content="Order wings, sandwiches, sides. Pay on-site with Apple Pay/Card; DoorDash delivers.">
  <style>
    :root{ --ink:#0e1226; --muted:#cbd2ef; --edge:rgba(255,255,255,.12);
      --bg:#0a0f25; --card:#0f1631; --glass:rgba(255,255,255,.06);
      --brand:#5a7cff; --brand2:#3b53ff; --ok:#1cd182; --warn:#ffb020; }
    *{box-sizing:border-box} html,body{background:var(--bg);color:#f6f7fd;margin:0;font:16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    a{color:#cfe0ff;text-decoration:none} img{max-width:100%;display:block}
    .top{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,15,37,.9),rgba(10,15,37,.6));backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08)}
    .nav{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:auto;padding:12px 16px;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo{width:34px;height:34px;border-radius:8px;background:#0b1230;border:1px solid rgba(255,255,255,.12);padding:2px;box-shadow:0 8px 28px rgba(75,98,255,.22)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(58,84,255,.35);transition:transform .15s ease, box-shadow .15s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 14px 34px rgba(58,84,255,.45)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.18);color:#dfe7ff}
    .btn.sm{padding:10px 12px;font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);color:#e8ecff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    main{display:grid;grid-template-columns:1fr 380px;gap:16px} @media (max-width:980px){ main{grid-template-columns:1fr} }
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px} @media (max-width:780px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .muted{color:var(--muted);font-size:13px}
    .qty{display:flex;align-items:center;gap:8px;margin-top:8px}
    .qty input{width:64px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#fff;font-weight:800;text-align:center}
    aside{position:sticky;top:76px;height:fit-content}
    .box{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .itm{display:grid;grid-template-columns:1fr auto;gap:8px;border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
    .rm{border:none;background:transparent;color:#ff7280;font-weight:900;cursor:pointer}
    .line{display:flex;justify-content:space-between;margin-top:6px;font-size:14px}
    .h1{font-size:28px;line-height:1.15;margin:10px 0 8px;font-weight:900}
    .sub{color:#cbd2ef;margin-top:-4px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#fff}
    label{font-size:12px;color:#cbd2ef}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .note{color:#bfc7ea;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
<div class="top"><div class="nav">
  <div class="brand"><img class="logo" src="/image/delco-tech-seal.png" alt="" onerror="this.style.display='none'"><span>Delco Tech Division</span></div>
  <div class="row">
    <a class="btn ghost sm" href="/">Home</a>
    <a class="btn sm" href="/hire.html">Hire</a>
  </div>
</div></div>

<section class="wrap">
  <div class="h1">Order Food — Pay Here, Delivered via DoorDash</div>
  <div class="sub">Add items, enter your address, get a live DoorDash delivery quote, then pay with Apple Pay / card.</div>
</section>

<main class="wrap">
  <section>
    <div class="grid" id="menu"></div>
  </section>

  <aside>
    <div class="box">
      <h3>Your Order</h3>
      <div id="cart"></div>
      <div class="line"><span>Subtotal</span><b id="sub">$0</b></div>
      <div class="line"><span>Tax</span><b id="tax">$0</b></div>
      <div class="line"><span>Delivery (DoorDash)</span><b id="deliv">$0</b></div>
      <div class="line"><span>Tip for Dasher</span><b id="tipv">$0</b></div>
      <div class="line" style="border-top:1px solid rgba(255,255,255,.14);padding-top:8px"><span>Total</span><b id="tot">$0</b></div>
      <div class="note" id="eta"></div>
    </div>

    <div class="box" style="margin-top:12px">
      <h3>Delivery Address</h3>
      <div class="two">
        <div><label>First name</label><input id="fname" placeholder="Jane"></div>
        <div><label>Last name</label><input id="lname" placeholder="Doe"></div>
      </div>
      <div class="two" style="margin-top:8px">
        <div><label>Phone (mobile)</label><input id="phone" placeholder="+1 555 123 4567"></div>
        <div><label>Instructions (optional)</label><input id="notes" placeholder="Gate code, leave at door, etc."></div>
      </div>
      <div style="margin-top:8px"><label>Address</label><input id="addr1" placeholder="123 Main St"></div>
      <div class="two" style="margin-top:8px">
        <div><label>Unit</label><input id="addr2" placeholder="Apt / Unit"></div>
        <div><label>City</label><input id="city" placeholder="Philadelphia"></div>
      </div>
      <div class="two" style="margin-top:8px">
        <div><label>State</label><input id="state" placeholder="PA"></div>
        <div><label>ZIP</label><input id="zip" placeholder="19104"></div>
      </div>

      <div style="margin-top:12px" class="row">
        <button class="btn sm" id="btnQuote">Get DoorDash Quote</button>
        <button class="btn ghost sm" id="tip10">Tip 10%</button>
        <button class="btn ghost sm" id="tip15">Tip 15%</button>
        <button class="btn ghost sm" id="tip20">Tip 20%</button>
      </div>
      <div style="margin-top:12px"><button class="btn" id="checkout">Pay & Start Delivery</button></div>
      <div class="note">Your card is charged for food + delivery + tip. After payment we dispatch a Dasher.</div>
    </div>
  </aside>
</main>

<script>
(async function(){
  const money = n => '$' + (Math.round(n*100)/100).toLocaleString();
  const menuEl = document.getElementById('menu'), cartEl = document.getElementById('cart');
  const subEl = document.getElementById('sub'), taxEl = document.getElementById('tax'), delivEl = document.getElementById('deliv'), tipEl = document.getElementById('tipv'), totEl = document.getElementById('tot'), etaEl = document.getElementById('eta');

  const TAX = Number((await fetch('/api/food/menu').then(r=>r.json())).taxRate || 0);
  const menu = (await fetch('/api/food/menu').then(r=>r.json())).items || [];
  const cart = []; let deliveryCents = 0; let externalId = null; let tipCents = 0;

  function renderMenu(){
    menuEl.innerHTML='';
    menu.forEach(it=>{
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<h3>${it.name}</h3><div class="muted">$${it.price.toFixed(2)}</div>
        <div class="qty"><input type="number" min="0" value="0" aria-label="quantity"><button class="btn sm">Add</button></div>`;
      const input = card.querySelector('input');
      card.querySelector('.btn').onclick = ()=>{
        const qty = Math.max(0, parseInt(input.value||'0',10));
        if(!qty) return;
        const exists = cart.find(c=>c.id===it.id);
        if(exists) exists.qty += qty; else cart.push({ ...it, qty });
        input.value = 0; renderCart();
      };
      menuEl.appendChild(card);
    });
  }

  function renderCart(){
    cartEl.innerHTML='';
    cart.forEach((c,i)=>{
      const d = document.createElement('div'); d.className='itm';
      d.innerHTML = `<div><b>${c.name}</b><div class="muted">${c.qty} × $${c.price.toFixed(2)}</div></div>
                     <div><b>${money(c.qty*c.price)}</b><br/><button class="rm">×</button></div>`;
      d.querySelector('.rm').onclick = ()=>{ cart.splice(i,1); renderCart(); };
      cartEl.appendChild(d);
    });
    const sub = cart.reduce((s,c)=>s+c.qty*c.price,0);
    const tax = sub*TAX;
    subEl.textContent = money(sub); taxEl.textContent = money(tax); delivEl.textContent = money(deliveryCents/100); tipEl.textContent = money(tipCents/100);
    totEl.textContent = money(sub+tax+(deliveryCents+tipCents)/100);
  }

  function addr(){
    return {
      first:  document.getElementById('fname').value.trim(),
      last:   document.getElementById('lname').value.trim(),
      phone:  document.getElementById('phone').value.trim(),
      notes:  document.getElementById('notes').value.trim(),
      addr1:  document.getElementById('addr1').value.trim(),
      addr2:  document.getElementById('addr2').value.trim(),
      city:   document.getElementById('city').value.trim(),
      state:  document.getElementById('state').value.trim(),
      zip:    document.getElementById('zip').value.trim(),
    };
  }

  document.getElementById('btnQuote').onclick = async ()=>{
    if(!cart.length) return alert('Add at least one item.');
    const a = addr();
    if(!(a.first && a.last && a.phone && a.addr1 && a.city && a.state && a.zip)) return alert('Please complete name, phone, and address.');
    const items = cart.map(c=>({ name:c.name, qty:c.qty, priceCents: Math.round(c.price*100) }));
    const r = await fetch('/api/food/quote',{ method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ items, address: a }) }).then(r=>r.json());
    if(r.error) return alert('Quote failed.');
    deliveryCents = r.quote?.fee || 0;
    externalId = r.quote?.external_delivery_id || null;
    tipCents = Math.round(deliveryCents*0.2); // default 20% tip suggestion
    etaEl.textContent = r.quote?.dropoff_time ? `Estimated dropoff: ${r.quote.dropoff_time}` : '';
    renderCart();
  };

  document.getElementById('tip10').onclick = ()=>{ tipCents = Math.round((deliveryCents)*0.10); renderCart(); };
  document.getElementById('tip15').onclick = ()=>{ tipCents = Math.round((deliveryCents)*0.15); renderCart(); };
  document.getElementById('tip20').onclick = ()=>{ tipCents = Math.round((deliveryCents)*0.20); renderCart(); };

  document.getElementById('checkout').onclick = async ()=>{
    if(!cart.length) return alert('Add at least one item.');
    if(!externalId || !deliveryCents) return alert('Get a DoorDash quote first.');
    const a = addr();
    const items = cart.map(c=>({ name:c.name, qty:c.qty, priceCents: Math.round(c.price*100) }));
    const r = await fetch('/api/food/checkout',{ method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ items, tipCents, quote: { externalId, feeCents: deliveryCents }, address: a }) }).then(r=>r.json());
    if(r.url) location.href = r.url; else alert('Could not start checkout.');
  };

  renderMenu(); renderCart();
})();
</script>
</body>
</html>
