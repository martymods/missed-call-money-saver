<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DelcoTech Ops Console</title>
  <meta name="description" content="Admin console for DelcoTech automations: launch live cold calls, text follow-ups, and review lead CSVs."/>
  <style>
    :root{
      --bg:#050816;
      --card:#0d142c;
      --panel:#111b38;
      --ink:#f3f5ff;
      --muted:#8d97c4;
      --accent:#5a7cff;
      --accent2:#364dff;
      --success:#19d180;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.12);
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;min-height:100%}
    h1,h2,h3{margin:0 0 8px;font-weight:800;line-height:1.2}
    p{margin:0 0 12px;color:var(--muted)}
    a{color:#cfe0ff}
    .wrap{max-width:1180px;margin:auto;padding:20px 16px 80px;display:flex;flex-direction:column;gap:28px}
    header{display:flex;flex-direction:column;gap:18px;padding:20px;background:linear-gradient(160deg,rgba(90,124,255,.22),rgba(17,27,56,.85));border:1px solid rgba(255,255,255,.14);border-radius:20px;box-shadow:0 25px 80px rgba(23,32,68,.55)}
    header h1{font-size:32px}
    header .intro{max-width:720px;font-size:17px;color:#d6dcff}
    header .stats{display:flex;flex-wrap:wrap;gap:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);padding:6px 12px;border-radius:999px;font-weight:700;font-size:13px;color:#e6ebff;text-transform:uppercase;letter-spacing:.4px}
    section{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:22px 20px;box-shadow:0 22px 60px rgba(0,0,0,.45)}
    section header{background:none;border:none;border-radius:0;padding:0;box-shadow:none}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .section-title h2{font-size:24px}
    .section-title button{margin-left:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    label{display:flex;flex-direction:column;gap:6px;font-weight:600;color:#dfe3ff;font-size:15px}
    input,textarea,select{border-radius:12px;border:1px solid rgba(255,255,255,.14);background:var(--panel);color:var(--ink);padding:11px 12px;font:15px/1.4 "Inter",system-ui,sans-serif;box-shadow:inset 0 0 0 1px rgba(0,0,0,.28)}
    textarea{min-height:90px;resize:vertical}
    input:focus,textarea:focus,select:focus{outline:2px solid rgba(90,124,255,.55);outline-offset:2px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:none;font-weight:700;font-size:15px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:white;cursor:pointer;box-shadow:0 16px 36px rgba(64,94,255,.35);transition:transform .18s ease,box-shadow .18s ease}
    .btn.secondary{background:rgba(255,255,255,.08);box-shadow:none;border:1px solid rgba(255,255,255,.16)}
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;transform:none}
    .btn:not(:disabled):active{transform:translateY(1px);box-shadow:0 6px 18px rgba(64,94,255,.35)}
    .status{margin-top:12px;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);color:#dbe4ff;font-size:14px;white-space:pre-wrap}
    .status.success{border-color:rgba(25,209,128,.4);color:#cafff1;background:rgba(25,209,128,.12)}
    .status.error{border-color:rgba(255,107,107,.4);color:#ffd6d6;background:rgba(255,107,107,.12)}
    .automation-panel{margin-top:12px;padding:16px;border-radius:14px;background:rgba(16,24,52,.72);border:1px solid rgba(255,255,255,.12);display:flex;flex-direction:column;gap:12px}
    .automation-panel[hidden]{display:none}
    .automation-panel-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .automation-panel-title{font-size:18px;font-weight:700;color:#f0f4ff}
    .automation-badge{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.35px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:#dbe4ff}
    .automation-badge.live{border-color:rgba(90,124,255,.45);background:rgba(90,124,255,.16);color:#e8edff}
    .automation-badge.done{border-color:rgba(25,209,128,.45);background:rgba(25,209,128,.16);color:#eafff5}
    .automation-badge.error{border-color:rgba(255,107,107,.45);background:rgba(255,107,107,.18);color:#ffecec}
    .automation-badge.offline{border-color:rgba(255,193,59,.45);background:rgba(255,193,59,.18);color:#fff3d4}
    .automation-log{max-height:220px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:2px}
    .automation-entry{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;gap:6px;font-size:13px;color:#dfe4ff}
    .automation-entry.success{border-color:rgba(25,209,128,.35);background:rgba(25,209,128,.12);color:#e9fff6}
    .automation-entry.error{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12);color:#ffe0e0}
    .automation-entry-meta{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.35px}
    .automation-empty{font-size:13px;color:var(--muted);text-align:center;padding:30px 0}
    .flex{display:flex;flex-direction:column;gap:16px}
    .two-column{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .storyboard{background:var(--panel);border-radius:16px;border:1px solid rgba(255,255,255,.14);padding:16px;min-height:220px;font-family:"SFMono-Regular",Menlo,Consolas,monospace;font-size:13px;line-height:1.4;color:#d0d9ff;white-space:pre-wrap}
    .call-meta{font-size:13px;color:var(--muted);margin-top:8px}
    .call-visual{position:relative;border-radius:16px;overflow:hidden;background:radial-gradient(circle at top,#1e2c68,#0a0f26);border:1px solid rgba(255,255,255,.12);min-height:260px;display:flex;align-items:center;justify-content:center;color:#f0f3ff;text-align:center;padding:18px}
    .call-visual::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(5,8,22,.45),rgba(5,8,22,.75));opacity:0;transition:opacity .3s ease}
    .call-visual.is-live::after{opacity:1}
    .call-visual .overlay{position:absolute;inset:18px;border-radius:14px;border:1px solid rgba(255,255,255,.18);padding:14px;display:flex;flex-direction:column;gap:10px;justify-content:flex-start;overflow:auto;background:rgba(5,8,22,.55)}
    .call-visual-bubble{opacity:0;transform:translateY(6px);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);text-align:left;font-size:14px;transition:opacity .25s ease,transform .25s ease}
    .call-visual-bubble.show{opacity:1;transform:translateY(0)}
    .call-visual-bubble .label{display:block;font-weight:700;color:#9fb6ff;font-size:12px;text-transform:uppercase;letter-spacing:.35px;margin-bottom:4px}
    .call-visual .ended{display:none;position:absolute;inset:auto 18px 18px;background:rgba(16,24,52,.9);border:1px solid rgba(255,255,255,.16);padding:12px;border-radius:12px;font-weight:700}
    .call-visual.is-ended .ended{display:block}
    .csv-browser{display:grid;grid-template-columns:minmax(260px,320px) 1fr;gap:18px}
    @media(max-width:900px){.csv-browser{grid-template-columns:1fr}}
    .csv-tree{background:var(--panel);border-radius:16px;border:1px solid rgba(255,255,255,.12);padding:14px;max-height:440px;overflow:auto;font-size:14px}
    .csv-tree details{padding:6px 0}
    .csv-tree summary{cursor:pointer;font-weight:700;color:#d6dcff}
    .csv-tree ul{list-style:none;padding-left:16px;margin:6px 0}
    .csv-tree li{margin:6px 0;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .csv-tree button{font-size:12px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(90,124,255,.18);color:#e3e9ff;cursor:pointer}
    .csv-viewer{background:var(--panel);border-radius:16px;border:1px solid rgba(255,255,255,.12);padding:16px;min-height:320px;display:flex;flex-direction:column;gap:12px}
    .csv-preview{flex:1 1 auto;overflow:auto;background:rgba(5,8,22,.45);border-radius:12px;border:1px solid rgba(255,255,255,.08);padding:12px;font-family:"Inter",system-ui,sans-serif;font-size:13px;color:#d1dcff;min-height:240px;position:relative}
    .csv-preview.is-loading{display:flex;align-items:center;justify-content:center}
    .csv-preview table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:13px;color:#d1dcff}
    .csv-preview th,.csv-preview td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .csv-preview th{position:sticky;top:0;background:rgba(12,18,40,.96);backdrop-filter:blur(8px);z-index:1;font-weight:700;color:#f0f4ff}
    .csv-preview td{color:#cfd6ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .csv-preview tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    .csv-preview .empty{color:var(--muted);text-align:center;padding:24px 0}
    .csv-meta{font-size:13px;color:var(--muted)}
    .csv-insights{display:none;flex-direction:column;gap:12px;background:rgba(10,16,36,.65);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .csv-insights.is-visible{display:flex}
    .csv-summary{display:flex;flex-wrap:wrap;gap:10px}
    .csv-summary .metric{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:12px;display:flex;flex-direction:column;gap:4px;font-size:12px;color:#cfd6ff;min-width:120px}
    .csv-summary .metric strong{font-size:18px;font-weight:700;color:#f6f8ff}
    .csv-summary .metric.subtle{opacity:.78}
    .csv-summary-note{font-size:12px;color:var(--muted);flex-basis:100%;margin-top:4px}
    .csv-lead-chips{display:flex;flex-wrap:wrap;gap:8px}
    .csv-lead-chips .chip{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px;color:#e2e8ff;display:flex;flex-direction:column;gap:2px;max-width:240px}
    .csv-lead-chips .chip span{font-weight:700;color:#9fb6ff;font-size:11px;text-transform:uppercase;letter-spacing:.35px}
    .csv-lead-chips .chip div{font-size:12px;line-height:1.3}
    .csv-lead-chips .chip .context{font-size:11px;opacity:.72}
    .csv-lead-chips .chip.muted{opacity:.6}
    .csv-actions{display:flex;flex-wrap:wrap;gap:10px}
    .csv-pitch{display:none;flex-direction:column;gap:10px;background:rgba(90,124,255,.14);border:1px solid rgba(90,124,255,.32);border-radius:14px;padding:16px}
    .csv-pitch.is-visible{display:flex}
    .csv-pitch-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .csv-pitch-header h3{margin:0;font-size:18px}
    .csv-pitch-note{font-size:12px;color:var(--muted)}
    .csv-pitch-headline{margin:0;font-size:16px;font-weight:600;color:#f4f6ff}
    .csv-pitch-bullets{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:6px;color:#dbe3ff}
    .csv-pitch-footer{font-size:13px;color:#bec8ff;display:flex;flex-direction:column;gap:6px}
    .csv-pitch-footer p{margin:0}
    .loader{width:38px;height:38px;border-radius:50%;border:3px solid rgba(90,124,255,.25);border-top-color:var(--accent);animation:spin .9s linear infinite}
    .loader.small{width:26px;height:26px;border-width:2px}
    .panel-loader{display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--muted);font-size:13px;padding:24px 0}
    .panel-loader .loader{margin:0}
    .csv-tree button.is-active{background:rgba(90,124,255,.3);border-color:rgba(90,124,255,.55);color:#fff}
    @keyframes spin{to{transform:rotate(360deg)}}
    .refresh-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .refresh-row button{margin:0}
  </style>
  <!-- External libraries -->
  <script
    src="https://unpkg.com/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"
    defer
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
    integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g"
    crossorigin="anonymous"
    defer
  ></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>DelcoTech Concierge Console</h1>
      <p class="intro">Real dialer, real texts, real leads. Launch the lifelike cold caller over Twilio, drop ElevenLabs-powered talk tracks, and push the closer link via SMS without leaving this tab. The CSV browser below stays in sync with <code>public/csvFIles</code> automatically, so drag in new lead lists and refresh here.</p>
      <div class="stats">
        <span class="pill">ElevenLabs voice ready</span>
        <span class="pill">OpenAI pitch composer</span>
        <span class="pill">Twilio direct dial</span>
      </div>
    </header>

    <section id="call-launcher">
      <div class="section-title">
        <h2>Lifelike AI cold caller</h2>
      </div>
      <p>Queue a concierge-style call. Every conversation ends with a texted closer link to <strong>https://www.delcotechdivision.com/</strong> no matter how the lead responds.</p>
      <div class="two-column">
        <form id="callerForm" class="flex">
          <label>Lead name
            <input type="text" name="leadName" placeholder="e.g. Roscoe" autocomplete="name"/>
          </label>
          <label>Lead phone (U.S. E.164)
            <input type="tel" name="toLocal" inputmode="tel" autocomplete="tel" placeholder="6105550199" maxlength="14" required/>
          </label>
          <label>Goal of the call
            <input type="text" name="goal" placeholder="Secure a listing consultation"/>
          </label>
          <label>Opening line
            <textarea name="intro" placeholder="Hi Dana, this is Alex from Delco Realty. Thanks for requesting a valuation."></textarea>
          </label>
          <label>Talking points (one per line)
            <textarea name="script" rows="5" placeholder="We found three buyers already active nearby.
Your consultation holds your price for 48 hours.
Can I send the booking link to lock your time?"></textarea>
          </label>
          <label>Voice preset
            <select name="voice">
              <option value="warm">Warm &amp; friendly (ElevenLabs)</option>
              <option value="bold">Bold &amp; confident (ElevenLabs)</option>
              <option value="calm">Calm &amp; precise (ElevenLabs)</option>
            </select>
          </label>
          <label>Optional live handoff number
            <input type="tel" name="handoffNumber" placeholder="Team mate number"/>
          </label>
          <button type="submit" class="btn">Start live call</button>
          <div id="callerStatus" class="status">Idle — configure the call and press start.</div>
        </form>
        <div class="flex">
          <div class="call-visual" id="callVisual">
            <div class="overlay" id="callOverlay" aria-live="polite"></div>
            <div class="ended" id="callEnded">Call ended</div>
          </div>
          <div>
            <div class="storyboard" id="callerPreview">Adjust inputs to generate the live storyboard.</div>
            <div class="call-meta" id="callerMeta">Warm &amp; friendly (ElevenLabs). No live handoff configured yet — concierge stays on the line. Calls originate from your configured TWILIO_NUMBER.</div>
          </div>
        </div>
      </div>
    </section>

    <section id="text-launcher">
      <div class="section-title">
        <h2>Manual SMS closer</h2>
      </div>
      <p>Fire off a direct text with the closer link appended automatically. Perfect for fast follow-ups or booking confirmations that need a human touch.</p>
      <form id="textForm" class="grid">
        <label>Recipient (U.S. E.164)
          <input type="tel" name="to" placeholder="6105550199" inputmode="tel" required/>
        </label>
        <label>Message body
          <textarea name="message" rows="3" placeholder="Quick follow-up: we can lock in your consultation and automate inbound calls for your team. Reply if you want me to hold a slot."></textarea>
        </label>
        <button type="submit" class="btn">Send text with closer link</button>
      </form>
      <div id="textStatus" class="status">SMS ready. We'll append https://www.delcotechdivision.com/ automatically if you leave it out.</div>
    </section>

    <section id="csv-browser">
      <div class="section-title">
        <h2>CSV intelligence feed</h2>
        <button type="button" id="csvRefresh" class="btn secondary">Refresh folders</button>
      </div>
      <p>Every directory and CSV inside <code>public/csvFIles</code> is listed below. Drop in new files and refresh to inspect the live contents instantly.</p>
      <div class="csv-browser">
        <div>
          <div class="csv-tree" id="csvTree">Scanning folders…</div>
        </div>
        <div class="csv-viewer">
          <div class="csv-meta" id="csvMeta">Select a CSV file to preview the first few hundred rows.</div>
          <div class="csv-insights" id="csvInsights">
            <div class="csv-summary" id="csvSummary"></div>
            <div class="csv-lead-chips" id="csvLeadPreview"></div>
            <div class="csv-actions">
              <button type="button" class="btn" id="csvCallAll" disabled>Launch concierge calls</button>
              <button type="button" class="btn secondary" id="csvSmsAll" disabled>Send SMS follow-ups</button>
            </div>
          </div>
          <div class="csv-pitch" id="csvPitch">
            <div class="csv-pitch-header">
              <h3>AI pitch</h3>
              <span class="csv-pitch-note" id="csvPitchStatus"></span>
            </div>
            <p class="csv-pitch-headline" id="csvPitchHeadline"></p>
            <ul class="csv-pitch-bullets" id="csvPitchBullets"></ul>
            <div class="csv-pitch-footer" id="csvPitchFooter"></div>
          </div>
          <div class="csv-preview" id="csvPreview">Waiting for selection…</div>
          <div class="status" id="csvActionStatus">Automation idle — select a CSV to unlock call &amp; SMS campaigns.</div>
          <div class="automation-panel" id="automationPanel" hidden>
            <div class="automation-panel-header">
              <span class="automation-panel-title" id="automationPanelTitle">Automation activity</span>
              <span class="automation-badge" id="automationPanelBadge">Idle</span>
            </div>
            <div class="automation-log" id="automationLog">
              <div class="automation-empty">Automation updates will appear here in real time.</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const callerForm = document.getElementById('callerForm');
    const callerStatus = document.getElementById('callerStatus');
    const callerPreview = document.getElementById('callerPreview');
    const callerMeta = document.getElementById('callerMeta');
    const callVisual = document.getElementById('callVisual');
    const callOverlay = document.getElementById('callOverlay');
    const callEnded = document.getElementById('callEnded');

    const voicePresets = {
      warm: { label: 'Warm & friendly (ElevenLabs)', variant: 'warm' },
      bold: { label: 'Bold & confident (ElevenLabs)', variant: 'bold' },
      calm: { label: 'Calm & precise (ElevenLabs)', variant: 'calm' }
    };

    const US_PREFIX = '+1';
    let overlayTimers = [];
    let overlayResetTimer = null;

    function sanitizeLocalDigits(value){
      let digits = String(value || '').replace(/[^\d]/g, '');
      if(digits.length === 11 && digits.startsWith('1')) digits = digits.slice(1);
      return digits.slice(0, 10);
    }

    function toE164(local){
      const digits = sanitizeLocalDigits(local);
      return digits.length === 10 ? `${US_PREFIX}${digits}` : '';
    }

    function formatDisplay(value){
      const digits = sanitizeLocalDigits(value);
      if(digits.length < 10) return digits ? `${US_PREFIX} ${digits}` : '';
      return `${US_PREFIX} (${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6,10)}`;
    }

    function getCallerState(){
      const formData = new FormData(callerForm);
      const toLocal = formData.get('toLocal') || '';
      const payload = {
        leadName: formData.get('leadName') || '',
        goal: formData.get('goal') || '',
        intro: formData.get('intro') || '',
        script: formData.get('script') || '',
        voice: formData.get('voice') || 'warm',
        handoffNumber: formData.get('handoffNumber') || '',
        toLocal
      };
      payload.to = toE164(toLocal);
      return payload;
    }

    function buildStoryboard(state){
      const lead = state.leadName?.trim() || 'Lead';
      const intro = state.intro?.trim() || 'Hi there, this is Alex from DelcoTech on a quick concierge call.';
      const talkingPoints = (state.script || '').split(/\n+/).map((line) => line.trim()).filter(Boolean);
      const pointA = talkingPoints[0] || 'We found three prospects already warm in your territory.';
      const pointB = talkingPoints[1] || 'We cover booking, scheduling, and lead capture hands-free.';
      const pointC = talkingPoints[2] || 'I just texted you the DelcoTech automation link to lock your spot.';
      return [
        `Lead: ${lead} (${state.to ? formatDisplay(state.to) : 'add number'})`,
        `Goal: ${state.goal || 'Secure a listing consultation'}`,
        '',
        'Play-by-play:',
        `1. Twilio dials ${state.to ? formatDisplay(state.to) : 'the lead'} from your configured number.`,
        '2. ElevenLabs streams the concierge intro and listens after each beat.',
        `3. Talking points hit:`,
        `   • ${pointA}`,
        `   • ${pointB}`,
        `   • ${pointC}`,
        '4. SMS follow-up fires with https://www.delcotechdivision.com/ as the closer.',
        '',
        'Dialog rehearsal:',
        `Agent (${voicePresets[state.voice]?.label || voicePresets.warm.label}): ${intro}`,
        `${lead}: [Responds]`,
        `Agent: ${pointA}`,
        `${lead}: [Objection or interest logged]`,
        `Agent: ${pointB}`,
        `${lead}: [Signals interest]`,
        `Agent: ${pointC}`,
        `${lead}: [We close with the texted link]`
      ].join('\n');
    }

    function updateStoryboard(){
      const state = getCallerState();
      const preset = voicePresets[state.voice] || voicePresets.warm;
      callerPreview.textContent = buildStoryboard(state);
      const handoffDisplay = state.handoffNumber ? (formatDisplay(state.handoffNumber) || state.handoffNumber) : '';
      callerMeta.textContent = `${preset.label}. ${handoffDisplay ? `Warm handoff ready at ${handoffDisplay}.` : 'No live handoff configured yet — concierge stays on the line.'} Calls originate from your configured TWILIO_NUMBER.`;
    }

    function resetOverlay(){
      overlayTimers.forEach((timer) => window.clearTimeout(timer));
      overlayTimers = [];
      if(overlayResetTimer){
        window.clearTimeout(overlayResetTimer);
        overlayResetTimer = null;
      }
      if(callOverlay){
        callOverlay.innerHTML = '';
      }
      if(callVisual){
        callVisual.classList.remove('is-live','is-ended');
      }
    }

    function showOverlayLines(lines){
      if(!callOverlay || !callVisual) return;
      resetOverlay();
      callVisual.classList.add('is-live');
      lines.forEach((line, index) => {
        const timer = window.setTimeout(() => {
          const bubble = document.createElement('div');
          bubble.className = 'call-visual-bubble';
          const label = document.createElement('span');
          label.className = 'label';
          label.textContent = line.label;
          bubble.appendChild(label);
          bubble.append(line.text);
          callOverlay.appendChild(bubble);
          requestAnimationFrame(() => { bubble.classList.add('show'); });
        }, index * 900);
        overlayTimers.push(timer);
      });
      overlayResetTimer = window.setTimeout(() => {
        callVisual.classList.remove('is-live');
        callVisual.classList.add('is-ended');
      }, Math.max((lines.length * 900) + 2400, 4800));
    }

    async function startCall(){
      const state = getCallerState();
      if(!state.to){
        callerStatus.textContent = 'Add a 10-digit U.S. phone number so we can dial it as +1.';
        callerStatus.className = 'status error';
        return;
      }
      callerStatus.textContent = 'Dialing via Twilio…';
      callerStatus.className = 'status';
      const submitBtn = callerForm.querySelector('button[type="submit"]');
      submitBtn?.setAttribute('disabled','true');
      resetOverlay();
      try{
        const payload = { ...state };
        delete payload.toLocal;
        payload.origin = 'delcotech-admin';
        const response = await fetch('/api/cold-caller/dial', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await response.json().catch(() => ({}));
        if(!response.ok || !data?.sid){
          const errMsg = data?.error ? ` (${data.error})` : '';
          throw new Error(`Unable to start call${errMsg}`);
        }
        callerStatus.textContent = `Call launched! Twilio SID ${data.sid}.`;
        callerStatus.className = 'status success';
        const leadLabel = state.leadName || 'Lead';
        const talking = (state.script || '').split(/\n+/).map((line) => line.trim()).filter(Boolean);
        const lines = [
          { label:'Agent', text: state.intro?.trim() || 'Hi there, this is Alex from DelcoTech.' },
          { label: leadLabel, text: 'Sounds good — what do you have for me?' },
          { label:'Agent', text: talking[0] || 'We already spotted motivated activity in your area.' },
          { label:'Agent', text: 'I just texted you the automation link so you can lock in.' }
        ];
        showOverlayLines(lines);
      }catch(error){
        callerStatus.textContent = `Call failed: ${error.message}`;
        callerStatus.className = 'status error';
        console.error('[Admin] Cold caller failed', error);
        resetOverlay();
      }finally{
        submitBtn?.removeAttribute('disabled');
      }
    }

    if(callerForm){
      callerForm.addEventListener('input', updateStoryboard);
      callerForm.addEventListener('change', updateStoryboard);
      callerForm.addEventListener('submit', (event) => {
        event.preventDefault();
        startCall();
      });
      updateStoryboard();
    }

    const textForm = document.getElementById('textForm');
    const textStatus = document.getElementById('textStatus');
    if(textForm){
      textForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(textForm);
        const to = formData.get('to') || '';
        const message = (formData.get('message') || '').trim();
        textStatus.textContent = 'Sending text via Twilio…';
        textStatus.className = 'status';
        try{
          const response = await fetch('/api/admin/send-text', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ to, message })
          });
          const data = await response.json().catch(() => ({}));
          if(!response.ok || !data?.ok){
            const errMsg = data?.error ? ` (${data.error})` : '';
            throw new Error(`Unable to send SMS${errMsg}`);
          }
          textStatus.textContent = 'SMS sent! Closer link included.';
          textStatus.className = 'status success';
        }catch(error){
          textStatus.textContent = `SMS failed: ${error.message}`;
          textStatus.className = 'status error';
          console.error('[Admin] SMS send failed', error);
        }
      });
    }

    const csvTree = document.getElementById('csvTree');
    const csvPreview = document.getElementById('csvPreview');
    const csvMeta = document.getElementById('csvMeta');
    const csvRefresh = document.getElementById('csvRefresh');
    const csvInsights = document.getElementById('csvInsights');
    const csvSummary = document.getElementById('csvSummary');
    const csvLeadPreview = document.getElementById('csvLeadPreview');
    const csvCallAll = document.getElementById('csvCallAll');
    const csvSmsAll = document.getElementById('csvSmsAll');
    const csvPitch = document.getElementById('csvPitch');
    const csvPitchStatus = document.getElementById('csvPitchStatus');
    const csvPitchHeadline = document.getElementById('csvPitchHeadline');
    const csvPitchBullets = document.getElementById('csvPitchBullets');
    const csvPitchFooter = document.getElementById('csvPitchFooter');
    const csvActionStatus = document.getElementById('csvActionStatus');
    const automationPanel = document.getElementById('automationPanel');
    const automationPanelTitle = document.getElementById('automationPanelTitle');
    const automationPanelBadge = document.getElementById('automationPanelBadge');
    const automationLog = document.getElementById('automationLog');

    let currentCsvFile = null;
    let currentCsvData = null;
    let currentCsvPitch = null;
    let activeCsvButton = null;
    let previewController = null;
    let pitchController = null;
    let activeAutomationRunId = null;
    let automationLogCount = 0;
    let automationStream = null;
    let automationStreamRetryTimer = null;
    let automationStreamOnline = false;
    let automationLiveUpdates = 0;
    const supportsEventSource = typeof window !== 'undefined' && typeof window.EventSource === 'function';

    function formatBytes(bytes){
      const value = Number(bytes);
      if (!value || Number.isNaN(value)) return '';
      if (value < 1024) return `${value} B`;
      const units = ['KB','MB','GB','TB'];
      let size = value;
      let idx = 0;
      while (size >= 1024 && idx < units.length - 1){
        size /= 1024;
        idx += 1;
      }
      const precision = size >= 10 ? 1 : 2;
      return `${size.toFixed(precision)} ${units[idx]}`;
    }

    function formatTimestamp(iso){
      if(!iso) return '';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '';
      return date.toLocaleString();
    }

    function setAutomationBadge(state, label){
      if(!automationPanelBadge) return;
      const classes = ['automation-badge'];
      if(state) classes.push(state);
      automationPanelBadge.className = classes.join(' ');
      if(label){
        automationPanelBadge.textContent = label;
      }else{
        const fallback = state === 'live'
          ? 'Live'
          : state === 'done'
            ? 'Complete'
            : state === 'error'
              ? 'Attention'
              : state === 'offline'
                ? 'Reconnecting…'
                : 'Idle';
        automationPanelBadge.textContent = fallback;
      }
    }

    function resetAutomationLog(){
      automationLogCount = 0;
      if(automationLog){
        automationLog.innerHTML = '<div class="automation-empty">Automation updates will appear here in real time.</div>';
      }
    }

    function appendAutomationLogEntry(level, message){
      if(!automationLog || !message) return;
      if(automationLogCount === 0){
        automationLog.innerHTML = '';
      }
      const entry = document.createElement('div');
      entry.className = ['automation-entry', level === 'success' ? 'success' : level === 'error' ? 'error' : '']
        .filter(Boolean)
        .join(' ');
      const body = document.createElement('div');
      body.className = 'automation-entry-message';
      body.textContent = message;
      entry.appendChild(body);
      const meta = document.createElement('div');
      meta.className = 'automation-entry-meta';
      meta.textContent = new Intl.DateTimeFormat(undefined, {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit'
      }).format(new Date());
      entry.appendChild(meta);
      automationLog.appendChild(entry);
      automationLog.scrollTop = automationLog.scrollHeight;
      automationLogCount += 1;
      while(automationLogCount > 200 && automationLog.firstElementChild){
        automationLog.removeChild(automationLog.firstElementChild);
        automationLogCount -= 1;
      }
    }

    function describeLead(lead){
      if(!lead) return 'Lead';
      const name = lead.name ? String(lead.name) : '';
      const phone = lead.phone ? String(lead.phone) : '';
      if(name && phone) return `${name} (${phone})`;
      return name || phone || 'Lead';
    }

    function beginAutomationRun(kind, label, total){
      if(!automationPanel) return null;
      if(!supportsEventSource){
        activeAutomationRunId = null;
        automationPanel.hidden = false;
        if(automationPanelTitle){
          const prefix = kind === 'sms' ? 'SMS follow-ups' : 'Concierge calls';
          automationPanelTitle.textContent = label ? `${prefix} — ${label}` : prefix;
        }
        setAutomationBadge('offline', 'Log only');
        resetAutomationLog();
        appendAutomationLogEntry('error', 'Live updates require an EventSource-capable browser.');
        automationLiveUpdates = 0;
        return null;
      }
      const runId = `run-${Date.now().toString(36)}-${Math.random().toString(16).slice(2,8)}`;
      activeAutomationRunId = runId;
      automationLiveUpdates = 0;
      automationPanel.hidden = false;
      if(automationPanelTitle){
        const prefix = kind === 'sms' ? 'SMS follow-ups' : 'Concierge calls';
        automationPanelTitle.textContent = label ? `${prefix} — ${label}` : prefix;
      }
      resetAutomationLog();
      const intro = `Launching ${kind === 'sms' ? 'SMS follow-ups' : 'concierge calls'}${total ? ` for ${total} lead${total === 1 ? '' : 's'}` : ''}…`;
      appendAutomationLogEntry('info', intro);
      setAutomationBadge(automationStreamOnline ? 'live' : 'offline', automationStreamOnline ? 'Live' : 'Connecting…');
      ensureAutomationStream();
      return runId;
    }

    function completeAutomationRun(details){
      if(!details) return;
      if(details.message){
        appendAutomationLogEntry(details.failed ? 'error' : 'success', details.message);
      }
      if(details.failed){
        setAutomationBadge('error', 'Needs attention');
      }else{
        setAutomationBadge('done', 'Complete');
      }
      if(details.runId && details.runId === activeAutomationRunId){
        activeAutomationRunId = null;
      }
    }

    function failAutomationRun(details){
      if(details?.runId && activeAutomationRunId && details.runId !== activeAutomationRunId){
        return;
      }
      const message = details?.message || 'Automation failed.';
      appendAutomationLogEntry('error', message);
      setAutomationBadge('error', 'Failed');
      if(details?.runId && details.runId === activeAutomationRunId){
        activeAutomationRunId = null;
      }
    }

    function handleAutomationEvent(event){
      if(!event) return;
      if(event.runId && activeAutomationRunId && event.runId !== activeAutomationRunId){
        return;
      }
      if(event.type === 'automation:start'){
        if(event.runId && event.runId === activeAutomationRunId){
          const total = Number(event.total || 0);
          if(total){
            appendAutomationLogEntry('info', `Processing ${total} lead${total === 1 ? '' : 's'}…`);
          }
          setAutomationBadge('live', 'Live');
        }
        return;
      }
      if(!event.runId || event.runId !== activeAutomationRunId){
        return;
      }
      switch(event.type){
        case 'call:attempt':
          appendAutomationLogEntry('info', `Queueing call for ${describeLead(event.lead)}…`);
          break;
        case 'call:queued':
          appendAutomationLogEntry('success', `Call queued for ${describeLead(event.lead)}.`);
          automationLiveUpdates += 1;
          break;
        case 'call:error':
          appendAutomationLogEntry('error', `Call failed for ${describeLead(event.lead)} — ${event.error?.message || 'Unknown error'}.`);
          automationLiveUpdates += 1;
          break;
        case 'sms:attempt':
          appendAutomationLogEntry('info', `Preparing SMS for ${describeLead(event.lead)}…`);
          break;
        case 'sms:sent':
          appendAutomationLogEntry('success', `SMS sent to ${describeLead(event.lead)}.`);
          automationLiveUpdates += 1;
          break;
        case 'sms:error':
          appendAutomationLogEntry('error', `SMS failed for ${describeLead(event.lead)} — ${event.error?.message || 'Unknown error'}.`);
          automationLiveUpdates += 1;
          break;
        case 'automation:complete':
          completeAutomationRun({
            runId: event.runId,
            failed: Number(event.failed || 0) > 0,
            message: event.message || ''
          });
          break;
        case 'automation:error':
          failAutomationRun({
            runId: event.runId,
            message: event.message || event.error?.message || 'Automation failed.'
          });
          break;
        default:
          break;
      }
    }

    function ensureAutomationStream(){
      if(!supportsEventSource || automationStream) return;
      try{
        const source = new EventSource('/api/activity-stream');
        source.onopen = () => {
          automationStreamOnline = true;
          if(activeAutomationRunId){
            setAutomationBadge('live', 'Live');
          }
        };
        source.onmessage = (event) => {
          if(!event?.data) return;
          try{
            const payload = JSON.parse(event.data);
            handleAutomationEvent(payload);
          }catch(parseError){
            console.warn('[Admin] Failed to parse automation event', parseError);
          }
        };
        source.onerror = () => {
          if(automationStream === source){
            automationStream = null;
          }
          const wasOnline = automationStreamOnline;
          automationStreamOnline = false;
          source.close();
          if(wasOnline && activeAutomationRunId){
            appendAutomationLogEntry('error', 'Live event stream interrupted. Attempting to reconnect…');
            setAutomationBadge('offline', 'Reconnecting…');
          }
          if(!automationStreamRetryTimer){
            automationStreamRetryTimer = setTimeout(() => {
              automationStreamRetryTimer = null;
              ensureAutomationStream();
            }, 4000);
          }
        };
        automationStream = source;
      }catch(streamError){
        console.error('[Admin] Unable to initialize automation stream', streamError);
      }
    }

    function setActiveCsvButton(button){
      if(activeCsvButton && activeCsvButton !== button){
        activeCsvButton.classList.remove('is-active');
      }
      if(button){
        button.classList.add('is-active');
        activeCsvButton = button;
      }
    }

    function resetCsvViewer(message){
      currentCsvData = null;
      currentCsvPitch = null;
      activeAutomationRunId = null;
      if(automationPanel){
        automationPanel.hidden = true;
      }
      if(csvSummary) csvSummary.innerHTML = '';
      if(csvLeadPreview) csvLeadPreview.innerHTML = '';
      csvInsights?.classList.remove('is-visible');
      csvPitch?.classList.remove('is-visible');
      if(csvPitchStatus) csvPitchStatus.textContent = '';
      if(csvPitchHeadline) csvPitchHeadline.textContent = '';
      if(csvPitchBullets) csvPitchBullets.innerHTML = '';
      if(csvPitchFooter) csvPitchFooter.innerHTML = '';
      if(csvCallAll) csvCallAll.disabled = true;
      if(csvSmsAll) csvSmsAll.disabled = true;
      if(csvMeta) csvMeta.textContent = 'Select a CSV file to preview the first few hundred rows.';
      if(csvPreview){
        csvPreview.classList.remove('is-loading');
        csvPreview.textContent = message || 'Waiting for selection…';
      }
      if(csvActionStatus){
        csvActionStatus.textContent = 'Automation idle — select a CSV to unlock call & SMS campaigns.';
        csvActionStatus.className = 'status';
      }
    }

    function showPreviewLoading(label){
      if(!csvPreview) return;
      csvPreview.classList.add('is-loading');
      csvPreview.innerHTML = '';
      const loader = document.createElement('div');
      loader.className = 'loader';
      loader.setAttribute('aria-hidden', 'true');
      csvPreview.appendChild(loader);
      if(label){
        const p = document.createElement('p');
        p.textContent = label;
        p.style.marginTop = '12px';
        p.style.color = 'var(--muted)';
        csvPreview.appendChild(p);
      }
    }

    function renderCsvSummary(data){
      if(!csvSummary) return;
      csvSummary.innerHTML = '';
      const metrics = [
        { label:'Rows', value: Number(data.totalRows || 0).toLocaleString() },
        { label:'Valid leads', value: Number(data.validLeads || 0).toLocaleString() },
        { label:'Skipped', value: Number(data.skippedRows || 0).toLocaleString(), subtle:true },
        { label:'Automation limit', value: Number(data.automationLimit || 0).toLocaleString(), subtle:true },
      ];
      if(Array.isArray(data.rows) && data.truncated){
        metrics.push({ label:'Previewing', value:`${data.rows.length} rows`, subtle:true });
      }
      metrics.forEach((metric) => {
        const block = document.createElement('div');
        block.className = metric.subtle ? 'metric subtle' : 'metric';
        const strong = document.createElement('strong');
        strong.textContent = metric.value;
        block.appendChild(strong);
        block.append(metric.label);
        csvSummary.appendChild(block);
      });
      const reasons = Object.entries(data.skippedByReason || {}).filter(([, count]) => Number(count));
      if(reasons.length){
        const note = document.createElement('div');
        note.className = 'csv-summary-note';
        note.textContent = `Skipped: ${reasons.map(([reason, count]) => `${count} ${reason.replace(/_/g, ' ')}`).join(' • ')}`;
        csvSummary.appendChild(note);
      }
    }

    function renderLeadPreview(leads){
      if(!csvLeadPreview) return;
      csvLeadPreview.innerHTML = '';
      if(!Array.isArray(leads) || !leads.length){
        const chip = document.createElement('div');
        chip.className = 'chip muted';
        chip.textContent = 'No sample leads yet';
        csvLeadPreview.appendChild(chip);
        return;
      }
      leads.forEach((lead) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        if(lead.context) chip.title = lead.context;
        const name = document.createElement('span');
        name.textContent = lead.name || 'Lead';
        chip.appendChild(name);
        if(lead.phone){
          const phone = document.createElement('div');
          phone.textContent = lead.phone;
          chip.appendChild(phone);
        }
        if(lead.context){
          const context = document.createElement('div');
          context.className = 'context';
          context.textContent = lead.context;
          chip.appendChild(context);
        }
        csvLeadPreview.appendChild(chip);
      });
    }

    function renderCsvTable(header, rows){
      if(!csvPreview) return;
      csvPreview.classList.remove('is-loading');
      csvPreview.innerHTML = '';
      if(!header || !header.length){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'CSV header not found — drop in a file with column labels to preview.';
        csvPreview.appendChild(empty);
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      header.forEach((label, index) => {
        const th = document.createElement('th');
        th.textContent = label || `Column ${index + 1}`;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      if(!Array.isArray(rows) || !rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = header.length || 1;
        td.textContent = 'No rows detected within the preview window.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        rows.forEach((row) => {
          const tr = document.createElement('tr');
          for(let i = 0; i < header.length; i += 1){
            const cell = row?.[i] ?? '';
            const td = document.createElement('td');
            td.textContent = cell;
            if(cell) td.title = cell;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody);
      csvPreview.appendChild(table);
    }

    async function requestCsvPitch(file){
      if(!csvPitch) return;
      csvPitch.classList.add('is-visible');
      if(csvPitchStatus) csvPitchStatus.textContent = 'Composing pitch with OpenAI…';
      if(csvPitchHeadline) csvPitchHeadline.textContent = '';
      if(csvPitchBullets) csvPitchBullets.innerHTML = '';
      if(csvPitchFooter) csvPitchFooter.innerHTML = '';
      currentCsvPitch = null;

      if(pitchController){
        pitchController.abort();
      }
      pitchController = new AbortController();
      const { signal } = pitchController;

      try{
        const response = await fetch('/api/csv-files/pitch', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ path: file.path }),
          signal,
        });
        const data = await response.json().catch(() => ({}));
        if(!response.ok){
          const errMsg = data?.error ? data.error : response.statusText;
          throw new Error(errMsg || 'Pitch unavailable');
        }
        if(!currentCsvFile || currentCsvFile.path !== file.path){
          return;
        }
        currentCsvPitch = data.pitch || null;
        if(csvPitchStatus){
          csvPitchStatus.textContent = `Based on ${data.file?.name || file.name}`;
        }
        if(csvPitchHeadline){
          csvPitchHeadline.textContent = currentCsvPitch?.headline || '';
        }
        if(csvPitchBullets){
          csvPitchBullets.innerHTML = '';
          if(Array.isArray(currentCsvPitch?.valueProps)){
            currentCsvPitch.valueProps.forEach((line) => {
              const li = document.createElement('li');
              li.textContent = line;
              csvPitchBullets.appendChild(li);
            });
          }
        }
        if(csvPitchFooter){
          csvPitchFooter.innerHTML = '';
          const footerParts = [];
          if(currentCsvPitch?.callCloser){
            const p = document.createElement('p');
            p.textContent = `Call closer: ${currentCsvPitch.callCloser}`;
            footerParts.push(p);
          }
          const smsLines = [currentCsvPitch?.smsIntro, currentCsvPitch?.smsValue, currentCsvPitch?.smsCloser]
            .filter(Boolean)
            .join(' ')
            .trim();
          if(smsLines){
            const p = document.createElement('p');
            p.textContent = `SMS angle: ${smsLines}`;
            footerParts.push(p);
          }
          if(!footerParts.length){
            const p = document.createElement('p');
            p.textContent = 'Use the automation buttons above to deploy calls or texts with this pitch.';
            footerParts.push(p);
          }
          footerParts.forEach((node) => csvPitchFooter.appendChild(node));
        }
      }catch(error){
        if(error.name === 'AbortError') return;
        currentCsvPitch = null;
        if(csvPitchStatus) csvPitchStatus.textContent = `Pitch unavailable: ${error.message}`;
        if(csvPitchHeadline) csvPitchHeadline.textContent = '';
        if(csvPitchBullets) csvPitchBullets.innerHTML = '';
        if(csvPitchFooter) csvPitchFooter.innerHTML = '';
        console.error('[Admin] CSV pitch failed', error);
      }
    }

    function createTreeList(items){
      const list = document.createElement('ul');
      items.forEach((item) => {
        if(item.type === 'directory'){
          const details = document.createElement('details');
          if(currentCsvFile?.path && item.path && currentCsvFile.path.startsWith(`${item.path}/`)){
            details.open = true;
          }
          const summary = document.createElement('summary');
          summary.textContent = item.name;
          details.appendChild(summary);
          details.appendChild(createTreeList(item.items || []));
          const li = document.createElement('li');
          li.appendChild(details);
          list.appendChild(li);
        } else if(item.type === 'file'){
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.textContent = item.name;
          const metaParts = [];
          if(item.size != null) metaParts.push(formatBytes(item.size));
          if(item.modified) metaParts.push(formatTimestamp(item.modified));
          if(metaParts.length){
            span.title = metaParts.join(' • ');
          }
          li.appendChild(span);
          const button = document.createElement('button');
          button.type = 'button';
          button.textContent = 'Preview';
          button.dataset.path = item.path;
          button.addEventListener('click', () => {
            setActiveCsvButton(button);
            previewCsv(item);
          });
          if(currentCsvFile?.path === item.path){
            setActiveCsvButton(button);
          }
          li.appendChild(button);
          list.appendChild(li);
        }
      });
      if(!list.children.length){
        const empty = document.createElement('li');
        empty.textContent = 'No CSV files yet.';
        list.appendChild(empty);
      }
      return list;
    }

    async function previewCsv(file){
      if(!file) return;
      currentCsvFile = file;
      if(previewController){
        previewController.abort();
      }
      previewController = new AbortController();
      const { signal } = previewController;

      csvMeta.textContent = `Loading ${file.path}…`;
      if(csvActionStatus){
        csvActionStatus.textContent = 'Analyzing CSV…';
        csvActionStatus.className = 'status';
      }
      if(csvCallAll) csvCallAll.disabled = true;
      if(csvSmsAll) csvSmsAll.disabled = true;
      csvInsights?.classList.remove('is-visible');
      csvPitch?.classList.remove('is-visible');
      if(csvPitchStatus) csvPitchStatus.textContent = '';
      if(csvPitchHeadline) csvPitchHeadline.textContent = '';
      if(csvPitchBullets) csvPitchBullets.innerHTML = '';
      if(csvPitchFooter) csvPitchFooter.innerHTML = '';
      showPreviewLoading('Reading CSV…');

      try{
        const response = await fetch('/api/csv-files/preview', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ path: file.path }),
          signal,
        });
        const data = await response.json().catch(() => ({}));
        if(!response.ok){
          const errMsg = data?.error ? data.error : response.statusText;
          throw new Error(errMsg || 'Preview unavailable');
        }
        if(!currentCsvFile || currentCsvFile.path !== file.path){
          return;
        }
        currentCsvData = data;
        const details = [];
        if(file.path) details.push(`Path: ${file.path}`);
        const fileSize = formatBytes(data?.file?.size ?? file.size);
        if(fileSize) details.push(`Size: ${fileSize}`);
        const updated = formatTimestamp(data?.file?.modified ?? file.modified);
        if(updated) details.push(`Updated: ${updated}`);
        csvMeta.textContent = details.join(' • ') || 'Preview ready.';

        renderCsvSummary(data);
        renderLeadPreview(data.leadsPreview || []);
        csvInsights?.classList.add('is-visible');
        renderCsvTable(data.header || [], data.rows || []);

        if(Number(data.validLeads || 0) > 0){
          const readyMessage = `Automation ready — ${Math.min(data.validLeads, data.automationLimit || data.validLeads)} leads within limit.`;
          if(csvActionStatus){
            csvActionStatus.textContent = readyMessage;
            csvActionStatus.className = 'status success';
          }
          if(csvCallAll) csvCallAll.disabled = false;
          if(csvSmsAll) csvSmsAll.disabled = false;
        } else if(csvActionStatus){
          csvActionStatus.textContent = 'No callable leads detected in this CSV.';
          csvActionStatus.className = 'status';
        }

        if(data.pitchAvailable){
          requestCsvPitch(file);
        } else if(csvPitch){
          csvPitch.classList.add('is-visible');
          if(csvPitchStatus){
            csvPitchStatus.textContent = 'Connect an OpenAI API key to generate instant pitches.';
          }
        }
      }catch(error){
        if(error.name === 'AbortError') return;
        currentCsvData = null;
        csvPreview.classList.remove('is-loading');
        csvPreview.textContent = 'Preview unavailable.';
        csvMeta.textContent = `Failed to load ${file.path || file.name}: ${error.message}`;
        if(csvActionStatus){
          csvActionStatus.textContent = `Preview error: ${error.message}`;
          csvActionStatus.className = 'status error';
        }
        console.error('[Admin] CSV preview failed', error);
      }
    }

    async function runCsvCallAutomation(){
      if(!currentCsvFile || !currentCsvData) return;
      const limitValue = Number(currentCsvData?.automationLimit || currentCsvData?.validLeads || 0);
      const targetLeads = Number.isFinite(limitValue) && limitValue > 0
        ? limitValue
        : Number(currentCsvData?.validLeads || 0) || null;
      const runLabel = currentCsvFile?.name || currentCsvFile?.path || 'Selected leads';
      const runId = beginAutomationRun('call', runLabel, targetLeads);
      if(csvActionStatus){
        csvActionStatus.textContent = 'Queuing concierge calls…';
        csvActionStatus.className = 'status';
      }
      if(csvCallAll) csvCallAll.disabled = true;
      if(csvSmsAll) csvSmsAll.disabled = true;

      try{
        const state = typeof getCallerState === 'function' ? getCallerState() : {};
        const payload = {
          path: currentCsvFile.path,
          limit: currentCsvData?.automationLimit || undefined,
          callConfig: {
            goal: state.goal || '',
            intro: state.intro || '',
            script: state.script || '',
            voice: state.voice || 'warm',
            handoffNumber: state.handoffNumber || '',
          },
        };
        if(currentCsvPitch){
          payload.pitch = currentCsvPitch;
        }
        if(runId){
          payload.runId = runId;
        }

        const response = await fetch('/api/csv-files/launch-call', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json().catch(() => ({}));
        if(!response.ok){
          const errMsg = data?.error ? data.error : response.statusText;
          throw new Error(errMsg || 'call_run_failed');
        }
        const queued = Number(data?.queued || 0);
        const attempted = Number(data?.attempted || 0);
        const failed = Number.isFinite(data?.failed) ? Number(data.failed) : Math.max(attempted - queued, 0);
        const summary = attempted
          ? `Calls queued for ${queued}/${attempted} leads${failed ? ` — ${failed} failed.` : '.'}`
          : 'No leads were queued.';
        if(csvActionStatus){
          csvActionStatus.textContent = summary;
          csvActionStatus.className = queued && !failed ? 'status success' : (queued ? 'status' : 'status error');
        }
        if(Array.isArray(data?.results) && console.table){
          console.table(data.results);
        }
        if(!supportsEventSource || !runId || automationLiveUpdates === 0){
          if(Array.isArray(data?.results)){
            data.results.forEach((item) => {
              if(item?.ok){
                appendAutomationLogEntry('success', `Call queued for ${describeLead(item.lead)}.`);
              }else{
                appendAutomationLogEntry('error', `Call failed for ${describeLead(item?.lead)} — ${item?.error?.message || 'Unknown error'}.`);
              }
            });
          }
          completeAutomationRun({
            runId: runId || null,
            failed: failed > 0,
            message: summary,
          });
        }
      }catch(error){
        if(csvActionStatus){
          csvActionStatus.textContent = `Call launch failed: ${error.message}`;
          csvActionStatus.className = 'status error';
        }
        console.error('[Admin] CSV call automation failed', error);
        if(runId){
          failAutomationRun({ runId, message: `Call launch failed: ${error.message}` });
        }else if(automationPanel && !automationPanel.hidden){
          failAutomationRun({ message: `Call launch failed: ${error.message}` });
        }
      } finally {
        if(csvCallAll) csvCallAll.disabled = !currentCsvData || !currentCsvData.validLeads;
        if(csvSmsAll) csvSmsAll.disabled = !currentCsvData || !currentCsvData.validLeads;
      }
    }

    async function runCsvSmsAutomation(){
      if(!currentCsvFile || !currentCsvData) return;
      const limitValue = Number(currentCsvData?.automationLimit || currentCsvData?.validLeads || 0);
      const targetLeads = Number.isFinite(limitValue) && limitValue > 0
        ? limitValue
        : Number(currentCsvData?.validLeads || 0) || null;
      const runLabel = currentCsvFile?.name || currentCsvFile?.path || 'Selected leads';
      const runId = beginAutomationRun('sms', runLabel, targetLeads);
      if(csvActionStatus){
        csvActionStatus.textContent = 'Preparing SMS run…';
        csvActionStatus.className = 'status';
      }
      if(csvCallAll) csvCallAll.disabled = true;
      if(csvSmsAll) csvSmsAll.disabled = true;

      try{
        let message = '';
        if(textForm){
          const formData = new FormData(textForm);
          message = (formData.get('message') || '').trim();
        }
        const payload = {
          path: currentCsvFile.path,
          limit: currentCsvData?.automationLimit || undefined,
          message,
        };
        if(currentCsvPitch){
          payload.pitch = currentCsvPitch;
        }
        if(runId){
          payload.runId = runId;
        }

        const response = await fetch('/api/csv-files/send-sms', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json().catch(() => ({}));
        if(!response.ok){
          const errMsg = data?.error ? data.error : response.statusText;
          throw new Error(errMsg || 'sms_run_failed');
        }
        const sent = Number(data?.sent || 0);
        const attempted = Number(data?.attempted || 0);
        const failed = Number.isFinite(data?.failed) ? Number(data.failed) : Math.max(attempted - sent, 0);
        const summary = attempted
          ? `SMS sent to ${sent}/${attempted} leads${failed ? ` — ${failed} failed.` : '.'}`
          : 'No messages were sent.';
        if(csvActionStatus){
          csvActionStatus.textContent = summary;
          csvActionStatus.className = sent && !failed ? 'status success' : (sent ? 'status' : 'status error');
        }
        if(Array.isArray(data?.results) && console.table){
          console.table(data.results);
        }
        if(!supportsEventSource || !runId || automationLiveUpdates === 0){
          if(Array.isArray(data?.results)){
            data.results.forEach((item) => {
              if(item?.ok){
                appendAutomationLogEntry('success', `SMS sent to ${describeLead(item.lead)}.`);
              }else{
                appendAutomationLogEntry('error', `SMS failed for ${describeLead(item?.lead)} — ${item?.error?.message || 'Unknown error'}.`);
              }
            });
          }
          completeAutomationRun({
            runId: runId || null,
            failed: failed > 0,
            message: summary,
          });
        }
      }catch(error){
        if(csvActionStatus){
          csvActionStatus.textContent = `SMS run failed: ${error.message}`;
          csvActionStatus.className = 'status error';
        }
        console.error('[Admin] CSV SMS automation failed', error);
        if(runId){
          failAutomationRun({ runId, message: `SMS run failed: ${error.message}` });
        }else if(automationPanel && !automationPanel.hidden){
          failAutomationRun({ message: `SMS run failed: ${error.message}` });
        }
      } finally {
        if(csvCallAll) csvCallAll.disabled = !currentCsvData || !currentCsvData.validLeads;
        if(csvSmsAll) csvSmsAll.disabled = !currentCsvData || !currentCsvData.validLeads;
      }
    }

    async function loadCsvTree(){
      if(csvTree){
        csvTree.innerHTML = '<div class="panel-loader"><div class="loader small" aria-hidden="true"></div><span>Scanning folders…</span></div>';
      }
      if(!currentCsvFile){
        resetCsvViewer('Waiting for selection…');
      }
      try{
        const response = await fetch('/api/csv-files', { cache: 'no-store' });
        const data = await response.json().catch(() => ({}));
        if(!response.ok){
          throw new Error(`Unable to scan directories (${response.status})`);
        }
        const items = Array.isArray(data?.items) ? data.items : [];
        if(csvTree){
          csvTree.innerHTML = '';
          csvTree.appendChild(createTreeList(items));
          if(!items.length){
            csvTree.textContent = 'No CSV files detected yet. Drop folders into public/csvFIles and refresh.';
          }
        }
      }catch(error){
        if(csvTree){
          csvTree.textContent = `Failed to scan csvFIles: ${error.message}`;
        }
        console.error('[Admin] CSV scan failed', error);
      }
    }

    resetCsvViewer('Waiting for selection…');

    if(csvCallAll){
      csvCallAll.addEventListener('click', () => runCsvCallAutomation());
    }
    if(csvSmsAll){
      csvSmsAll.addEventListener('click', () => runCsvSmsAutomation());
    }
    if(csvRefresh){
      csvRefresh.addEventListener('click', () => loadCsvTree());
    }

    if(supportsEventSource){
      ensureAutomationStream();
    }

    loadCsvTree();
  </script>
</body>
</html>
