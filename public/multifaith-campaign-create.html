<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Share your story · Multi-faith giving platform</title>
  <meta name="description" content="Create a community campaign with a profile image, goal, and secure Stripe payment link."/>
  <style>
    :root {
      --bg: #050918;
      --bg-soft: #0a1124;
      --card: rgba(9, 18, 40, 0.82);
      --ink: #f5f7ff;
      --muted: #9ea8d6;
      --accent: #7c4dff;
      --accent-2: #37c79a;
      --danger: #ff5684;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, rgba(76, 71, 143, 0.35), transparent 60%), var(--bg);
      color: var(--ink);
      font: 16px/1.6 "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    a {
      color: #cde0ff;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-weight: 700;
      letter-spacing: 0.6px;
      text-transform: uppercase;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 18px;
      border-radius: 12px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: 1px solid rgba(255, 255, 255, 0.16);
      text-decoration: none;
      cursor: pointer;
    }

    .btn.ghost {
      background: transparent;
      color: #dbe2ff;
      box-shadow: none;
    }

    main {
      max-width: 920px;
      margin: 0 auto;
      width: 100%;
      padding: 0 20px 80px;
      flex: 1;
      display: grid;
      gap: 32px;
    }

    .hero {
      margin-top: 20px;
      padding: 28px;
      border-radius: 24px;
      background: linear-gradient(135deg, rgba(124, 77, 255, 0.3), rgba(55, 199, 154, 0.18));
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 28px 60px rgba(5, 10, 30, 0.45);
      display: grid;
      gap: 16px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(34px, 5vw, 48px);
      line-height: 1.1;
      font-weight: 800;
    }

    .lead {
      margin: 0;
      color: var(--muted);
      font-size: 18px;
    }

    form {
      display: grid;
      gap: 18px;
    }

    .form-card {
      background: var(--card);
      border-radius: 24px;
      padding: 28px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 24px 50px rgba(4, 9, 26, 0.46);
      display: grid;
      gap: 24px;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .form-grid.double {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label span.title {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    select,
    textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(12, 18, 36, 0.82);
      color: var(--ink);
      font-size: 15px;
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    input[type="file"] {
      color: var(--muted);
    }

    .file-row {
      display: grid;
      gap: 12px;
    }

    .preview {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .preview img {
      width: 160px;
      height: 160px;
      object-fit: cover;
      border-radius: 20px;
      border: 2px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 18px 36px rgba(4, 10, 30, 0.4);
    }

    .preview .placeholder {
      width: 160px;
      height: 160px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.04);
      border: 2px dashed rgba(255, 255, 255, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
      text-align: center;
      padding: 12px;
    }

    .status {
      padding: 14px 16px;
      border-radius: 14px;
      font-size: 15px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
    }

    .status.success {
      background: rgba(55, 199, 154, 0.18);
      border-color: rgba(55, 199, 154, 0.4);
      color: #d6fff0;
    }

    .status.error {
      background: rgba(255, 86, 132, 0.14);
      border-color: rgba(255, 86, 132, 0.4);
      color: #ffe9f0;
    }

    .result {
      display: grid;
      gap: 10px;
      padding: 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .result a {
      word-break: break-all;
      color: #fff;
    }

    footer {
      margin-top: auto;
      padding: 40px 0 60px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 640px) {
      .hero {
        padding: 22px;
      }

      .form-card {
        padding: 22px;
      }

      .preview img,
      .preview .placeholder {
        width: 120px;
        height: 120px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <strong>New Bright Water</strong>
      <small>Community campaign creator</small>
    </div>
    <div class="actions">
      <a class="btn ghost" href="multifaith-giving-platform.html">⬅ Back to giving platform</a>
    </div>
  </header>

  <main>
    <section class="hero">
      <h1>Tell your story and start receiving support.</h1>
      <p class="lead">Upload a profile photo, describe why you are fundraising, and set a goal. We will compress your image, create a Stripe payment link, and publish your campaign back to the main multifaith-giving-platform page.</p>
    </section>

    <section class="form-card">
      <h2>Campaign details</h2>
      <form id="campaign-form">
        <div class="form-grid double">
          <label>
            <span class="title">Profile name</span>
            <input id="profile-name" type="text" maxlength="90" placeholder="Leah Cohen" required/>
          </label>
          <label>
            <span class="title">Contact email (optional)</span>
            <input id="profile-email" type="email" maxlength="120" placeholder="leah@example.org"/>
          </label>
        </div>
        <div class="form-grid double">
          <label>
            <span class="title">Faith tradition</span>
            <select id="profile-faith" required></select>
          </label>
          <label>
            <span class="title">Region</span>
            <select id="profile-region" required></select>
          </label>
        </div>
        <label>
          <span class="title">Campaign title</span>
          <input id="campaign-name" type="text" maxlength="120" placeholder="Community scholarship support" required/>
        </label>
        <label>
          <span class="title">Short description</span>
          <textarea id="campaign-description" maxlength="500" placeholder="Describe why you are raising funds and how the donations will be used." required></textarea>
        </label>
        <div class="form-grid double">
          <label>
            <span class="title">Goal amount (<span id="goal-currency">USD</span>)</span>
            <input id="campaign-goal" type="number" min="10" step="1" placeholder="5000" required/>
          </label>
          <label>
            <span class="title">Flexible withdrawals</span>
            <select id="campaign-withdrawal" required>
              <option value="true">Allow early withdrawal before goal</option>
              <option value="false" selected>Release funds when goal is met</option>
            </select>
          </label>
        </div>
        <div class="file-row">
          <label>
            <span class="title">Profile image</span>
            <input id="profile-image" type="file" accept="image/*" required/>
          </label>
          <div class="preview" id="image-preview-wrapper">
            <div class="placeholder">Upload an image up to 8MB. We will compress it automatically.</div>
          </div>
        </div>
        <button class="btn" type="submit">Create campaign &amp; Stripe link</button>
      </form>
      <div class="status" id="form-status" hidden></div>
      <div class="result" id="form-result" hidden>
        <strong>Your donation link is ready</strong>
        <a id="result-link" href="#" target="_blank" rel="noreferrer"></a>
        <p id="result-copy"></p>
      </div>
    </section>
  </main>

  <footer>
    Built for multi-faith communities • <span id="year"></span>
  </footer>

  <script>
    const REGION_OPTIONS = [
      { value: 'NA', label: 'North America' },
      { value: 'EU', label: 'Europe' },
      { value: 'MENA', label: 'Middle East & North Africa' },
      { value: 'SA', label: 'South Asia' },
      { value: 'APAC', label: 'Asia Pacific' }
    ];

    const REGION_CURRENCY = new Map([
      ['NA', 'USD'],
      ['EU', 'EUR'],
      ['MENA', 'AED'],
      ['SA', 'INR'],
      ['APAC', 'SGD']
    ]);

    const FAITH_OPTIONS = [
      { value: 'christian', label: 'Christianity' },
      { value: 'islam', label: 'Islam' },
      { value: 'jewish', label: 'Judaism' },
      { value: 'hindu', label: 'Hinduism' },
      { value: 'buddhist', label: 'Buddhism' }
    ];

    const els = {
      form: document.getElementById('campaign-form'),
      status: document.getElementById('form-status'),
      result: document.getElementById('form-result'),
      resultLink: document.getElementById('result-link'),
      resultCopy: document.getElementById('result-copy'),
      profileName: document.getElementById('profile-name'),
      profileEmail: document.getElementById('profile-email'),
      faith: document.getElementById('profile-faith'),
      region: document.getElementById('profile-region'),
      campaignName: document.getElementById('campaign-name'),
      campaignDescription: document.getElementById('campaign-description'),
      campaignGoal: document.getElementById('campaign-goal'),
      campaignWithdrawal: document.getElementById('campaign-withdrawal'),
      profileImage: document.getElementById('profile-image'),
      goalCurrency: document.getElementById('goal-currency'),
      previewWrapper: document.getElementById('image-preview-wrapper')
    };

    function populateSelect(select, options, placeholder) {
      if (!select) return;
      select.innerHTML = '';
      if (placeholder) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = placeholder;
        opt.disabled = true;
        opt.selected = true;
        select.appendChild(opt);
      }
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label;
        select.appendChild(opt);
      });
    }

    function setStatus(message, type = 'info') {
      if (!els.status) return;
      els.status.hidden = false;
      els.status.textContent = message;
      els.status.classList.remove('success', 'error');
      if (type === 'success') els.status.classList.add('success');
      if (type === 'error') els.status.classList.add('error');
    }

    function clearStatus() {
      if (!els.status) return;
      els.status.hidden = true;
      els.status.textContent = '';
      els.status.classList.remove('success', 'error');
    }

    function resetPreview() {
      els.previewWrapper.innerHTML = '<div class="placeholder">Upload an image up to 8MB. We will compress it automatically.</div>';
    }

    function updatePreview(dataUrl) {
      els.previewWrapper.innerHTML = '';
      const img = document.createElement('img');
      img.src = dataUrl;
      img.alt = 'Profile preview';
      els.previewWrapper.appendChild(img);
    }

    function updateCurrencyLabel(region) {
      const currency = REGION_CURRENCY.get(region) || 'USD';
      els.goalCurrency.textContent = currency;
    }

    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('Unable to load image'));
          img.src = reader.result;
        };
        reader.onerror = () => reject(new Error('Unable to read image'));
        reader.readAsDataURL(file);
      });
    }

    async function compressImage(file) {
      const MAX_BYTES = 1.2 * 1024 * 1024;
      const MAX_DIMENSION = 960;
      const image = await loadImage(file);
      const canvas = document.createElement('canvas');
      const ratio = Math.min(1, MAX_DIMENSION / image.width, MAX_DIMENSION / image.height);
      canvas.width = Math.max(1, Math.round(image.width * ratio));
      canvas.height = Math.max(1, Math.round(image.height * ratio));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      let quality = 0.84;
      let dataUrl = canvas.toDataURL('image/jpeg', quality);
      const toBytes = url => {
        const comma = url.indexOf(',');
        const base64Length = comma >= 0 ? url.length - comma - 1 : url.length;
        return Math.ceil(base64Length * 0.75);
      };
      while (toBytes(dataUrl) > MAX_BYTES && quality > 0.5) {
        quality -= 0.08;
        dataUrl = canvas.toDataURL('image/jpeg', Math.max(quality, 0.5));
      }
      if (toBytes(dataUrl) > MAX_BYTES) {
        throw new Error('Compressed image is still too large. Try a smaller file.');
      }
      return dataUrl;
    }

    function extractFile() {
      const file = els.profileImage.files[0];
      if (!file) {
        throw new Error('Select a profile image to continue.');
      }
      if (!file.type.startsWith('image/')) {
        throw new Error('Profile image must be an image file.');
      }
      if (file.size > 8 * 1024 * 1024) {
        throw new Error('Upload an image smaller than 8MB.');
      }
      return file;
    }

    function buildPayload(imageDataUrl) {
      const region = els.region.value;
      return {
        profileName: els.profileName.value.trim(),
        contactEmail: els.profileEmail.value.trim() || undefined,
        religion: els.faith.value,
        region,
        campaignName: els.campaignName.value.trim(),
        description: els.campaignDescription.value.trim(),
        goalAmount: Number(els.campaignGoal.value),
        allowEarlyWithdrawal: els.campaignWithdrawal.value === 'true',
        currency: (REGION_CURRENCY.get(region) || 'USD').toLowerCase(),
        image: imageDataUrl
      };
    }

    async function submitForm(event) {
      event.preventDefault();
      clearStatus();
      els.result.hidden = true;
      try {
        const file = extractFile();
        setStatus('Compressing image…');
        const imageDataUrl = await compressImage(file);
        updatePreview(imageDataUrl);
        setStatus('Creating campaign…');
        const payload = buildPayload(imageDataUrl);
        if (!payload.goalAmount || !Number.isFinite(payload.goalAmount) || payload.goalAmount <= 0) {
          throw new Error('Enter a positive goal amount.');
        }
        const response = await fetch('/api/giving/community-campaigns', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || 'Unable to save campaign');
        }
        const data = await response.json();
        const campaign = data?.campaign ?? data;
        if (!campaign?.paymentLink?.url) {
          throw new Error('Campaign was saved but no payment link was returned.');
        }
        setStatus('Campaign published! Share your link below.', 'success');
        els.result.hidden = false;
        els.resultLink.href = campaign.paymentLink.url;
        els.resultLink.textContent = campaign.paymentLink.url;
        const statusLine = campaign.paymentLink.provider === 'mock'
          ? 'Stripe is not configured in this environment. A demo link was generated instead.'
          : 'Your Stripe payment link is active immediately. Copy and share it with your community.';
        els.resultCopy.textContent = statusLine;
        els.form.reset();
        resetPreview();
        updateCurrencyLabel(els.region.value);
      } catch (error) {
        console.error('Campaign creation failed', error);
        setStatus(error?.message || 'Unable to create campaign right now.', 'error');
      }
    }

    function init() {
      populateSelect(els.faith, FAITH_OPTIONS, 'Choose a faith');
      populateSelect(els.region, REGION_OPTIONS, 'Choose a region');
      updateCurrencyLabel(els.region.value);
      els.region.addEventListener('change', () => updateCurrencyLabel(els.region.value));
      els.profileImage.addEventListener('change', () => {
        try {
          const file = els.profileImage.files[0];
          if (!file) {
            resetPreview();
            return;
          }
          if (!file.type.startsWith('image/')) {
            resetPreview();
            setStatus('Upload a valid image file.', 'error');
            return;
          }
          const reader = new FileReader();
          reader.onload = () => updatePreview(reader.result);
          reader.readAsDataURL(file);
        } catch (err) {
          console.warn('Preview load failed', err);
          resetPreview();
        }
      });
      els.form.addEventListener('submit', submitForm);
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    init();
  </script>
</body>
</html>
